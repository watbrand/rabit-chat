<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RabitChat Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" async onerror="console.log('Chart.js failed to load')"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0f0a1a 0%, #1a1025 50%, #0d0815 100%);
      min-height: 100vh;
      color: #fff;
    }
    
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .login-card {
      background: rgba(139, 92, 246, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 24px;
      padding: 48px;
      width: 100%;
      max-width: 420px;
    }
    
    .login-header {
      text-align: center;
      margin-bottom: 32px;
    }
    
    .login-logo {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #8B5CF6, #A855F7);
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 20px;
      font-size: 32px;
    }
    
    .login-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .login-subtitle {
      color: rgba(255,255,255,0.6);
      font-size: 14px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: rgba(255,255,255,0.8);
    }
    
    .input-wrapper {
      position: relative;
    }
    
    .form-group input {
      width: 100%;
      padding: 14px 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      color: #fff;
      font-size: 15px;
      transition: all 0.2s;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #8B5CF6;
      background: rgba(139, 92, 246, 0.1);
    }
    
    .password-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: rgba(255,255,255,0.5);
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .password-toggle:hover {
      color: #8B5CF6;
    }
    
    .btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #8B5CF6, #A855F7);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .error-message {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #FCA5A5;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }
    
    .admin-container {
      display: none;
      min-height: 100vh;
    }
    
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 260px;
      height: 100vh;
      background: rgba(15, 10, 26, 0.95);
      border-right: 1px solid rgba(139, 92, 246, 0.2);
      padding: 24px 0;
      overflow-y: auto;
    }
    
    .sidebar-header {
      padding: 0 24px 24px;
      border-bottom: 1px solid rgba(139, 92, 246, 0.1);
      margin-bottom: 16px;
    }
    
    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .sidebar-logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, #8B5CF6, #A855F7);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    
    .sidebar-logo-text {
      font-size: 18px;
      font-weight: 700;
    }
    
    .nav-section {
      padding: 0 12px;
      margin-bottom: 24px;
    }
    
    .nav-section-title {
      font-size: 11px;
      text-transform: uppercase;
      color: rgba(255,255,255,0.4);
      padding: 0 12px 8px;
      letter-spacing: 1px;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 10px;
      color: rgba(255,255,255,0.7);
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 4px;
    }
    
    .nav-item:hover {
      background: rgba(139, 92, 246, 0.1);
      color: #fff;
    }
    
    .nav-item.active {
      background: rgba(139, 92, 246, 0.2);
      color: #8B5CF6;
    }
    
    .nav-item svg {
      width: 20px;
      height: 20px;
    }
    
    .nav-badge {
      margin-left: auto;
      background: #EF4444;
      color: #fff;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
    }
    
    .main-content {
      margin-left: 260px;
      padding: 24px;
      min-height: 100vh;
    }
    
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }
    
    .page-title {
      font-size: 28px;
      font-weight: 700;
    }
    
    .page-subtitle {
      color: rgba(255,255,255,0.5);
      font-size: 14px;
      margin-top: 4px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }
    
    .stat-card {
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 16px;
      padding: 20px;
    }
    
    .stat-card h3 {
      font-size: 13px;
      color: rgba(255,255,255,0.6);
      font-weight: 500;
      margin-bottom: 8px;
    }
    
    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
      color: #8B5CF6;
    }
    
    .stat-card .change {
      font-size: 12px;
      color: #10B981;
      margin-top: 4px;
    }
    
    .card {
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }
    
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    
    .card-title {
      font-size: 18px;
      font-weight: 600;
    }
    
    .search-box {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 10px 16px;
      max-width: 300px;
    }
    
    .search-box input {
      background: none;
      border: none;
      color: #fff;
      font-size: 14px;
      width: 100%;
      outline: none;
    }
    
    .search-box svg {
      color: rgba(255,255,255,0.4);
      width: 18px;
      height: 18px;
    }
    
    .filters {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .filter-btn {
      padding: 8px 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: rgba(255,255,255,0.7);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .filter-btn:hover, .filter-btn.active {
      background: rgba(139, 92, 246, 0.2);
      border-color: #8B5CF6;
      color: #8B5CF6;
    }
    
    .table-container {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      text-align: left;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    
    th {
      font-size: 12px;
      text-transform: uppercase;
      color: rgba(255,255,255,0.5);
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    td {
      font-size: 14px;
    }
    
    tr:hover {
      background: rgba(139, 92, 246, 0.05);
    }
    
    .user-cell {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #8B5CF6, #A855F7);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }
    
    .avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .user-info {
      display: flex;
      flex-direction: column;
    }
    
    .user-name {
      font-weight: 500;
    }
    
    .user-email {
      font-size: 12px;
      color: rgba(255,255,255,0.5);
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .badge-admin {
      background: rgba(139, 92, 246, 0.2);
      color: #A78BFA;
    }
    
    .badge-verified {
      background: rgba(16, 185, 129, 0.2);
      color: #34D399;
    }
    
    .badge-suspended {
      background: rgba(239, 68, 68, 0.2);
      color: #FCA5A5;
    }
    
    .badge-pending {
      background: rgba(245, 158, 11, 0.2);
      color: #FBBF24;
    }
    
    .badge-active {
      background: rgba(16, 185, 129, 0.2);
      color: #34D399;
    }
    
    .badge-diamond {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(139, 92, 246, 0.3));
      color: #93C5FD;
    }
    
    .badge-platinum {
      background: rgba(148, 163, 184, 0.2);
      color: #CBD5E1;
    }
    
    .badge-gold {
      background: rgba(234, 179, 8, 0.2);
      color: #FCD34D;
    }
    
    .badge-silver {
      background: rgba(156, 163, 175, 0.2);
      color: #9CA3AF;
    }
    
    .badge-building {
      background: rgba(107, 114, 128, 0.2);
      color: #9CA3AF;
    }
    
    .badge-resolved {
      background: rgba(107, 114, 128, 0.2);
      color: #9CA3AF;
    }
    
    .action-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      margin-right: 4px;
    }
    
    .action-btn-primary {
      background: rgba(139, 92, 246, 0.2);
      color: #A78BFA;
    }
    
    .action-btn-primary:hover {
      background: rgba(139, 92, 246, 0.4);
    }
    
    .action-btn-danger {
      background: rgba(239, 68, 68, 0.2);
      color: #FCA5A5;
    }
    
    .action-btn-danger:hover {
      background: rgba(239, 68, 68, 0.4);
    }
    
    .action-btn-success {
      background: rgba(16, 185, 129, 0.2);
      color: #34D399;
    }
    
    .action-btn-success:hover {
      background: rgba(16, 185, 129, 0.4);
    }
    
    .content-section {
      display: none;
    }
    
    .content-section.active {
      display: block;
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
    }
    
    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .modal {
      background: #1a1025;
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 16px;
      padding: 24px;
      width: 100%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 600;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: rgba(255,255,255,0.5);
      cursor: pointer;
      font-size: 24px;
    }
    
    .modal-close:hover {
      color: #fff;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    
    .form-actions {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }
    
    .form-actions .btn {
      flex: 1;
    }
    
    .btn-secondary {
      background: rgba(255,255,255,0.1);
    }
    
    .btn-secondary:hover {
      background: rgba(255,255,255,0.2);
      box-shadow: none;
      transform: none;
    }
    
    .settings-grid {
      display: grid;
      gap: 16px;
    }
    
    .setting-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: rgba(255,255,255,0.02);
      border-radius: 10px;
    }
    
    .setting-info h4 {
      font-size: 15px;
      margin-bottom: 4px;
    }
    
    .setting-info p {
      font-size: 13px;
      color: rgba(255,255,255,0.5);
    }
    
    .toggle {
      position: relative;
      width: 48px;
      height: 26px;
      background: rgba(255,255,255,0.1);
      border-radius: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .toggle.active {
      background: #8B5CF6;
    }
    
    .toggle::after {
      content: '';
      position: absolute;
      width: 22px;
      height: 22px;
      background: #fff;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: all 0.2s;
    }
    
    .toggle.active::after {
      left: 24px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: rgba(255,255,255,0.5);
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: rgba(255,255,255,0.5);
    }
    
    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.3;
    }
    
    .user-header {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: rgba(255,255,255,0.02);
      border-radius: 12px;
      margin-bottom: 24px;
    }
    
    .user-header .avatar {
      width: 64px;
      height: 64px;
      font-size: 24px;
    }
    
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 12px;
    }
    
    .tab {
      padding: 8px 16px;
      background: none;
      border: none;
      color: rgba(255,255,255,0.5);
      font-size: 14px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .tab:hover {
      color: #fff;
    }
    
    .tab.active {
      background: rgba(139, 92, 246, 0.2);
      color: #8B5CF6;
    }
    
    .tabs-container {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 12px;
    }
    
    .tab-btn {
      padding: 10px 20px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.6);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
    }
    
    .tab-btn:hover {
      background: rgba(139, 92, 246, 0.1);
      border-color: rgba(139, 92, 246, 0.3);
      color: #fff;
    }
    
    .tab-btn.active {
      background: rgba(139, 92, 246, 0.2);
      border-color: #8B5CF6;
      color: #8B5CF6;
    }
    
    .tab-content {
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .logout-btn {
      position: fixed;
      bottom: 24px;
      left: 12px;
      width: 236px;
      padding: 12px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-radius: 10px;
      color: #FCA5A5;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .logout-btn:hover {
      background: rgba(239, 68, 68, 0.2);
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 16px;
    }

    .detail-item {
      background: rgba(255,255,255,0.02);
      padding: 12px;
      border-radius: 8px;
    }

    .detail-item label {
      font-size: 11px;
      color: rgba(255,255,255,0.5);
      text-transform: uppercase;
      display: block;
      margin-bottom: 4px;
    }

    .detail-item span {
      font-size: 14px;
      font-weight: 500;
    }

    .media-preview {
      max-width: 200px;
      max-height: 150px;
      border-radius: 8px;
      object-fit: cover;
    }

    .post-content {
      background: rgba(255,255,255,0.02);
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.5;
      max-height: 100px;
      overflow-y: auto;
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 60px;
        padding: 16px 8px;
      }
      
      .sidebar-header, .nav-section-title, .nav-item span, .logout-btn span {
        display: none;
      }
      
      .nav-item {
        justify-content: center;
        padding: 12px 8px;
      }
      
      .logout-btn {
        width: 44px;
        left: 8px;
      }
      
      .main-content {
        margin-left: 60px;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
    }

    /* Advanced Dashboard Styles */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 24px;
    }

    .metric-card {
      background: rgba(139, 92, 246, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      overflow: hidden;
    }

    .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #8B5CF6, #A855F7);
    }

    .metric-card.success::before { background: linear-gradient(90deg, #10B981, #34D399); }
    .metric-card.warning::before { background: linear-gradient(90deg, #F59E0B, #FBBF24); }
    .metric-card.danger::before { background: linear-gradient(90deg, #EF4444, #F87171); }
    .metric-card.info::before { background: linear-gradient(90deg, #3B82F6, #60A5FA); }

    .metric-label { font-size: 13px; color: rgba(255,255,255,0.6); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .metric-value { font-size: 32px; font-weight: 700; margin-bottom: 8px; }
    .metric-trend { display: flex; align-items: center; gap: 6px; font-size: 13px; }
    .metric-trend.up { color: #10B981; }
    .metric-trend.down { color: #EF4444; }
    .metric-trend svg { width: 16px; height: 16px; }
    .metric-subtitle { font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 4px; }

    .chart-card {
      background: rgba(139, 92, 246, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(139, 92, 246, 0.2);
      border-radius: 16px;
      padding: 24px;
    }

    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .chart-title { font-size: 18px; font-weight: 600; }
    .chart-container { position: relative; height: 300px; }

    .activity-feed { max-height: 400px; overflow-y: auto; }
    .activity-item { display: flex; align-items: flex-start; gap: 12px; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .activity-icon { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .activity-icon.user { background: rgba(139, 92, 246, 0.2); color: #8B5CF6; }
    .activity-icon.post { background: rgba(59, 130, 246, 0.2); color: #3B82F6; }
    .activity-icon.comment { background: rgba(16, 185, 129, 0.2); color: #10B981; }
    .activity-icon.report { background: rgba(239, 68, 68, 0.2); color: #EF4444; }
    .activity-icon.purchase { background: rgba(245, 158, 11, 0.2); color: #F59E0B; }
    .activity-content { flex: 1; }
    .activity-message { font-size: 14px; margin-bottom: 4px; }
    .activity-time { font-size: 12px; color: rgba(255,255,255,0.5); }

    .leaderboard-item { display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .leaderboard-rank { width: 28px; height: 28px; border-radius: 50%; background: rgba(139, 92, 246, 0.2); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 13px; }
    .leaderboard-rank.gold { background: linear-gradient(135deg, #F59E0B, #FBBF24); color: #000; }
    .leaderboard-rank.silver { background: linear-gradient(135deg, #9CA3AF, #D1D5DB); color: #000; }
    .leaderboard-rank.bronze { background: linear-gradient(135deg, #B45309, #D97706); color: #fff; }
    .leaderboard-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: linear-gradient(135deg, #8B5CF6, #A855F7); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; }
    .leaderboard-info { flex: 1; }
    .leaderboard-name { font-weight: 500; font-size: 14px; }
    .leaderboard-stat { font-size: 12px; color: rgba(255,255,255,0.6); }
    .leaderboard-value { font-weight: 600; color: #8B5CF6; }

    .date-range-selector { display: flex; gap: 8px; }
    .date-range-btn { padding: 8px 16px; border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.3); background: transparent; color: #fff; cursor: pointer; font-size: 13px; transition: all 0.2s; }
    .date-range-btn:hover { border-color: #8B5CF6; }
    .date-range-btn.active { background: #8B5CF6; border-color: #8B5CF6; }

    .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 24px; }
    .charts-row-equal { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
    .charts-row-three { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 24px; }

    .trending-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .trending-tag { font-weight: 500; color: #8B5CF6; }
    .trending-count { font-size: 12px; color: rgba(255,255,255,0.5); }

    .top-post-item { padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .top-post-content { font-size: 14px; margin-bottom: 8px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .top-post-stats { display: flex; gap: 16px; font-size: 12px; color: rgba(255,255,255,0.6); }

    @media (max-width: 1200px) {
      .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
      .charts-row, .charts-row-equal, .charts-row-three { grid-template-columns: 1fr; }
    }

    @media (max-width: 768px) {
      .dashboard-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="login-container" id="loginContainer">
    <div class="login-card">
      <div class="login-header">
        <div class="login-logo">üê∞</div>
        <h1 class="login-title">RabitChat Admin</h1>
        <p class="login-subtitle">Sign in to manage your platform</p>
      </div>
      
      <div class="error-message" id="loginError"></div>
      
      <form id="loginForm" method="POST" action="javascript:void(0);">
        <div class="form-group">
          <label for="loginEmail">Email Address</label>
          <input type="email" id="loginEmail" name="email" autocomplete="email" required placeholder="admin@example.com">
        </div>
        
        <div class="form-group">
          <label for="loginPassword">Password</label>
          <div class="input-wrapper">
            <input type="password" id="loginPassword" name="password" autocomplete="current-password" required placeholder="Enter password">
            <button type="button" class="password-toggle" id="passwordToggle" aria-label="Show password">
              <svg id="eyeIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
            </button>
          </div>
        </div>
        
        <button type="button" class="btn" id="loginBtn" onclick="doLogin()">Sign In</button>
      </form>
    </div>
  </div>
  
  <script>
    function formatNum(n) {
      if (n >= 1000000) return (n/1000000).toFixed(1) + 'M';
      if (n >= 1000) return (n/1000).toFixed(1) + 'K';
      return String(n);
    }
    
    function loadDashboardData() {
      console.log('[Admin] Loading dashboard data...');
      fetch('/api/admin/dashboard/overview', { credentials: 'include' })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          console.log('[Admin] Dashboard data received:', data);
          if (data) {
            var usersEl = document.getElementById('metric-users');
            var postsEl = document.getElementById('metric-posts');
            var engEl = document.getElementById('metric-engagement');
            var revEl = document.getElementById('metric-revenue');
            
            // Handle both flat and nested data structures
            var totalUsers = data.totalUsers || (data.users && data.users.total) || 0;
            var totalPosts = data.totalPosts || (data.posts && data.posts.total) || 0;
            var totalLikes = data.totalLikes || (data.engagement && data.engagement.likes) || 0;
            var totalComments = data.totalComments || (data.engagement && data.engagement.comments) || 0;
            var totalRevenue = data.totalRevenue || (data.revenue && data.revenue.total) || 0;
            
            console.log('[Admin] Parsed data - Users:', totalUsers, 'Posts:', totalPosts);
            
            if (usersEl) usersEl.textContent = formatNum(totalUsers);
            if (postsEl) postsEl.textContent = formatNum(totalPosts);
            if (engEl) {
              var rate = totalPosts > 0 ? ((totalLikes + totalComments) / totalPosts).toFixed(1) : '0';
              engEl.textContent = rate + '%';
            }
            if (revEl) revEl.textContent = 'R' + formatNum(totalRevenue);
          }
        })
        .catch(function(err) {
          console.error('[Admin] Error loading dashboard:', err);
        });
        
      // Load activity feed
      fetch('/api/admin/dashboard/activity-feed?limit=10', { credentials: 'include' })
        .then(function(res) { return res.json(); })
        .then(function(data) {
          var feed = document.getElementById('activityFeed');
          if (feed && data && Array.isArray(data)) {
            feed.innerHTML = data.slice(0, 10).map(function(item) {
              return '<div class="activity-item"><span>' + (item.action || item.type || 'Activity') + '</span></div>';
            }).join('') || '<div class="activity-item">No recent activity</div>';
          }
        })
        .catch(function() {});
    }
    
    function doLogin() {
      var email = document.getElementById('loginEmail').value;
      var password = document.getElementById('loginPassword').value;
      var btn = document.getElementById('loginBtn');
      var error = document.getElementById('loginError');
      
      if (!email || !password) {
        error.textContent = 'Please enter email and password';
        error.style.display = 'block';
        return;
      }
      
      btn.disabled = true;
      btn.textContent = 'Signing in...';
      error.style.display = 'none';
      
      fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ email: email, password: password })
      })
      .then(function(res) {
        return res.json().then(function(data) { 
          return { ok: res.ok, data: data }; 
        });
      })
      .then(function(result) {
        if (result.ok && result.data.isAdmin) {
          window.currentUser = result.data;
          document.getElementById('loginContainer').style.display = 'none';
          document.getElementById('adminContainer').style.display = 'block';
          console.log('[Admin] Login successful');
          
          // Try the main loadAllData first, then fallback to our inline version
          if (typeof window.loadAllData === 'function') {
            window.loadAllData();
          } else {
            loadDashboardData();
          }
        } else if (result.ok && !result.data.isAdmin) {
          error.textContent = 'Access denied. Admin privileges required.';
          error.style.display = 'block';
        } else {
          error.textContent = result.data.message || 'Invalid credentials';
          error.style.display = 'block';
        }
        btn.disabled = false;
        btn.textContent = 'Sign In';
      })
      .catch(function(err) {
        console.error('Login error:', err);
        error.textContent = 'Connection error. Please try again.';
        error.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'Sign In';
      });
    }
    
    // Navigation function - defined early so onclick handlers work
    window.showSection = function(section) {
      try {
        
        var allSections = document.querySelectorAll('.content-section');
        console.log('[Admin] Found', allSections.length, 'content sections');
        allSections.forEach(function(s) { s.classList.remove('active'); });
        
        var allNavs = document.querySelectorAll('.nav-item');
        console.log('[Admin] Found', allNavs.length, 'nav items');
        allNavs.forEach(function(n) { n.classList.remove('active'); });
        
        var sectionEl = document.getElementById('section-' + section);
        console.log('[Admin] Section element found:', sectionEl ? 'yes' : 'no', 'id: section-' + section);
        if (sectionEl) {
          sectionEl.classList.add('active');
          console.log('[Admin] Added active class to section');
        }
        
        var navItem = document.querySelector('.nav-item[data-section="' + section + '"]');
        console.log('[Admin] Nav item found:', navItem ? 'yes' : 'no');
        if (navItem) navItem.classList.add('active');
        
        // Call the section-specific loader if it exists
        if (typeof window.sectionLoaders !== 'undefined' && window.sectionLoaders[section]) {
          window.sectionLoaders[section]();
        }
      } catch (error) {
        console.error('[Admin] Error in showSection:', error);
      }
    };
  </script>

  <div class="admin-container" id="adminContainer">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon">üê∞</div>
          <span class="sidebar-logo-text">RabitChat</span>
        </div>
      </div>
      
      <nav class="nav-section">
        <div class="nav-section-title">Main</div>
        <div class="nav-item active" data-action="section" data-section="overview" onclick="window.showSection('overview')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
          <span>Overview</span>
        </div>
        <div class="nav-item" data-action="section" data-section="platformanalytics" onclick="window.showSection('platformanalytics')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
          <span>Platform Analytics</span>
        </div>
      </nav>
      
      <nav class="nav-section">
        <div class="nav-section-title">Content</div>
        <div class="nav-item" data-action="section" data-section="users" onclick="window.showSection('users')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
          <span>Users</span>
        </div>
        <div class="nav-item" data-action="section" data-section="posts" onclick="window.showSection('posts')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line></svg>
          <span>Posts</span>
        </div>
        <div class="nav-item" data-action="section" data-section="comments" onclick="window.showSection('comments')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
          <span>Comments</span>
        </div>
        <div class="nav-item" data-action="section" data-section="stories" onclick="window.showSection('stories')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line><line x1="2" y1="7" x2="7" y2="7"></line><line x1="2" y1="17" x2="7" y2="17"></line><line x1="17" y1="17" x2="22" y2="17"></line><line x1="17" y1="7" x2="22" y2="7"></line></svg>
          <span>Stories</span>
        </div>
        <div class="nav-item" data-action="section" data-section="arfilters" onclick="window.showSection('arfilters')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
          <span>AR Filters</span>
        </div>
        <div class="nav-item" data-action="section" data-section="aicontent" onclick="window.showSection('aicontent')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10H12V2z"></path><path d="M12 2a10 10 0 0 1 10 10"></path><circle cx="12" cy="12" r="3"></circle></svg>
          <span>AI Content</span>
        </div>
        <div class="nav-item" data-action="section" data-section="mall" onclick="window.showSection('mall')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
          <span>Mall</span>
        </div>
        <div class="nav-item" data-action="section" data-section="explorecategories" onclick="window.showSection('explorecategories')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
          <span>Explore Categories</span>
        </div>
      </nav>
      
      <nav class="nav-section">
        <div class="nav-section-title">Moderation</div>
        <div class="nav-item" data-action="section" data-section="gossip" onclick="window.showSection('gossip')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
          <span>Gossip</span>
          <span class="nav-badge" id="gossipReportsCount">0</span>
        </div>
        <div class="nav-item" data-action="section" data-section="reports" onclick="window.showSection('reports')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg>
          <span>Reports</span>
          <span class="nav-badge" id="reportsCount">0</span>
        </div>
        <div class="nav-item" data-action="section" data-section="verification" onclick="window.showSection('verification')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline></svg>
          <span>Verification</span>
        </div>
        <div class="nav-item" data-action="section" data-section="groupchats" onclick="window.showSection('groupchats')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
          <span>Group Chats</span>
        </div>
        <div class="nav-item" data-action="section" data-section="threads" onclick="window.showSection('threads')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>
          <span>Threads</span>
        </div>
        <div class="nav-item" data-action="section" data-section="profilefeatures" onclick="window.showSection('profilefeatures')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg>
          <span>Profile Features</span>
        </div>
      </nav>
      
      <nav class="nav-section">
        <div class="nav-section-title">System</div>
        <div class="nav-item" data-action="section" data-section="roles" onclick="window.showSection('roles')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
          <span>Roles</span>
        </div>
        <div class="nav-item" data-action="section" data-section="settings" onclick="window.showSection('settings')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
          <span>Settings</span>
        </div>
        <div class="nav-item" data-action="section" data-section="audit" onclick="window.showSection('audit')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
          <span>Audit Log</span>
        </div>
        <div class="nav-item" data-action="section" data-section="messages" onclick="window.showSection('messages')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
          <span>Messages</span>
        </div>
        <div class="nav-item" data-action="section" data-section="groups" onclick="window.showSection('groups')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
          <span>Groups</span>
        </div>
        <div class="nav-item" data-action="section" data-section="livestreams" onclick="window.showSection('livestreams')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="2"></circle><path d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14"></path></svg>
          <span>Live Streams</span>
        </div>
        <div class="nav-item" data-action="section" data-section="wallet" onclick="window.showSection('wallet')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
          <span>Wallet</span>
        </div>
        <div class="nav-item" data-action="section" data-section="payments" onclick="window.showSection('payments')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line><circle cx="17" cy="15" r="2"></circle></svg>
          <span>Payments</span>
        </div>
        <div class="nav-item" data-action="section" data-section="featureflags" onclick="window.showSection('featureflags')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg>
          <span>Feature Flags</span>
        </div>
        <div class="nav-item" data-action="section" data-section="userwealth" onclick="window.showSection('userwealth')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
          <span>User Wealth</span>
        </div>
        <div class="nav-item" data-action="section" data-section="broadcasts" onclick="window.showSection('broadcasts')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"></path></svg>
          <span>Broadcasts</span>
        </div>
        <div class="nav-item" data-action="section" data-section="events" onclick="window.showSection('events')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          <span>Events</span>
        </div>
        <div class="nav-item" data-action="section" data-section="subscriptions" onclick="window.showSection('subscriptions')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
          <span>Subscriptions</span>
        </div>
        <div class="nav-item" data-action="section" data-section="hashtags" onclick="window.showSection('hashtags')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line></svg>
          <span>Hashtags</span>
        </div>
        <div class="nav-item" data-action="section" data-section="blocks" onclick="window.showSection('blocks')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg>
          <span>Blocks/Mutes</span>
        </div>
        <div class="nav-item" data-action="section" data-section="reels" onclick="window.showSection('reels')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line><line x1="2" y1="7" x2="7" y2="7"></line><line x1="2" y1="17" x2="7" y2="17"></line><line x1="17" y1="17" x2="22" y2="17"></line><line x1="17" y1="7" x2="22" y2="7"></line></svg>
          <span>Reels</span>
        </div>
        <div class="nav-item" data-action="section" data-section="discovery" onclick="window.showSection('discovery')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon></svg>
          <span>Discovery</span>
        </div>
        <div class="nav-item" data-action="section" data-section="security" onclick="window.showSection('security')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="M12 8v4"></path><circle cx="12" cy="16" r="1"></circle></svg>
          <span>Security</span>
        </div>
        <div class="nav-item" data-action="section" data-section="videocalls" onclick="window.showSection('videocalls')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
          <span>Video Calls</span>
        </div>
        <div class="nav-item" data-action="section" data-section="advertising" onclick="window.showSection('advertising')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
          <span>Advertising</span>
        </div>
        <div class="nav-item" data-action="section" data-section="contentvelocity" onclick="window.showSection('contentvelocity')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>
          <span>Content Velocity</span>
        </div>
        <div class="nav-item" data-action="section" data-section="locations" onclick="window.showSection('locations')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
          <span>Locations</span>
        </div>
        <div class="nav-item" data-action="section" data-section="developerapi" onclick="window.showSection('developerapi')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
          <span>Developer API</span>
        </div>
        <div class="nav-item" data-action="section" data-section="dataprivacy" onclick="window.showSection('dataprivacy')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
          <span>Data Privacy</span>
        </div>
        <div class="nav-item" data-action="section" data-section="platformsettings" onclick="window.showSection('platformsettings')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
          <span>Platform Settings</span>
        </div>
        <div class="nav-item" data-action="section" data-section="economy" onclick="window.showSection('economy')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path><path d="M16 8h2a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2"></path></svg>
          <span>Economy</span>
        </div>
        <div class="nav-item" data-action="section" data-section="achievements" onclick="window.showSection('achievements')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="6"></circle><path d="M15.477 12.89L17 22l-5-3-5 3 1.523-9.11"></path></svg>
          <span>Achievements</span>
        </div>
        <div class="nav-item" data-action="section" data-section="kycwithdrawals" onclick="window.showSection('kycwithdrawals')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"></path><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"></path><path d="M18 12a2 2 0 0 0 0 4h4v-4h-4z"></path></svg>
          <span>KYC & Withdrawals</span>
        </div>
      </nav>
      
      <button class="logout-btn" data-action="logout">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
        <span>Logout</span>
      </button>
    </aside>
    
    <main class="main-content">
      <section class="content-section active" id="section-overview">
        <div class="page-header">
          <div>
            <h1 class="page-title">Dashboard</h1>
            <p class="page-subtitle">Real-time platform analytics and insights</p>
          </div>
          <div class="date-range-selector">
            <button class="date-range-btn" data-days="7">7 Days</button>
            <button class="date-range-btn active" data-days="30">30 Days</button>
            <button class="date-range-btn" data-days="90">90 Days</button>
          </div>
        </div>
        
        <!-- Data Sync Panel -->
        <div class="data-sync-panel" id="dataSyncPanel" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(59, 130, 246, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
          <div>
            <h3 style="margin: 0 0 8px 0; color: #8B5CF6; font-size: 16px; font-weight: 600;">Database Sync Tool</h3>
            <p style="margin: 0; color: #666; font-size: 14px;">Export data from development and import to production to sync your databases.</p>
          </div>
          <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            <button onclick="exportData()" class="btn" style="background: #8B5CF6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 500;">
              Export Data (JSON)
            </button>
            <label class="btn" style="background: #10B981; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 500;">
              Import Data
              <input type="file" accept=".json" onchange="importData(event)" style="display: none;">
            </label>
          </div>
        </div>
        
        <!-- Row 1: Metric Cards -->
        <div class="dashboard-grid" id="dashboardMetrics">
          <div class="metric-card">
            <div class="metric-label">Total Users</div>
            <div class="metric-value" id="metric-users">--</div>
            <div class="metric-trend up" id="metric-users-trend">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
              <span>--</span>
            </div>
            <div class="metric-subtitle">vs. previous period</div>
          </div>
          <div class="metric-card success">
            <div class="metric-label">Total Posts</div>
            <div class="metric-value" id="metric-posts">--</div>
            <div class="metric-trend up" id="metric-posts-trend">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
              <span>--</span>
            </div>
            <div class="metric-subtitle">vs. previous period</div>
          </div>
          <div class="metric-card info">
            <div class="metric-label">Engagement Rate</div>
            <div class="metric-value" id="metric-engagement">--</div>
            <div class="metric-trend up" id="metric-engagement-trend">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
              <span>--</span>
            </div>
            <div class="metric-subtitle">likes + comments / posts</div>
          </div>
          <div class="metric-card warning">
            <div class="metric-label">Revenue</div>
            <div class="metric-value" id="metric-revenue">--</div>
            <div class="metric-trend up" id="metric-revenue-trend">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>
              <span>--</span>
            </div>
            <div class="metric-subtitle">total platform revenue</div>
          </div>
        </div>
        
        <!-- Row 2: User Growth + Content Distribution -->
        <div class="charts-row">
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">User Growth</h3>
            </div>
            <div class="chart-container">
              <canvas id="userGrowthChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Content Distribution</h3>
            </div>
            <div class="chart-container">
              <canvas id="contentDistChart"></canvas>
            </div>
          </div>
        </div>
        
        <!-- Row 3: Engagement Trends + Activity Feed -->
        <div class="charts-row-equal">
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Engagement Trends</h3>
            </div>
            <div class="chart-container">
              <canvas id="engagementChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Recent Activity</h3>
            </div>
            <div class="activity-feed" id="activityFeed">
              <div class="loading">Loading activity...</div>
            </div>
          </div>
        </div>
        
        <!-- Row 4: Top Users + Top Posts + Trending -->
        <div class="charts-row-three">
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Top Users</h3>
            </div>
            <div id="topUsersList">
              <div class="loading">Loading...</div>
            </div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Top Posts</h3>
            </div>
            <div id="topPostsList">
              <div class="loading">Loading...</div>
            </div>
          </div>
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">Trending Hashtags</h3>
            </div>
            <div id="trendingHashtags">
              <div class="loading">Loading...</div>
            </div>
          </div>
        </div>
      </section>
      
      <section class="content-section" id="section-platformanalytics">
        <div class="page-header">
          <div>
            <h1 class="page-title">Platform Analytics</h1>
            <p class="page-subtitle">User activity, engagement trends, and retention metrics</p>
          </div>
        </div>
        
        <div class="stats-grid" id="analyticsStats">
          <div class="loading">Loading analytics...</div>
        </div>
        
        <div class="card" style="margin-bottom: 24px;">
          <div class="card-header">
            <h2 class="card-title">Retention Metrics</h2>
          </div>
          <div id="retentionMetrics" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
            <div class="loading">Loading retention data...</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Usage Trends</h2>
            <div class="filters" style="margin: 0;">
              <button class="filter-btn active" data-action="trends-period" data-days="7">7 Days</button>
              <button class="filter-btn" data-action="trends-period" data-days="14">14 Days</button>
              <button class="filter-btn" data-action="trends-period" data-days="30">30 Days</button>
            </div>
          </div>
          <div id="trendsLegend" style="display: flex; gap: 24px; margin-bottom: 16px; font-size: 12px;">
            <div style="display: flex; align-items: center; gap: 6px;"><span style="width: 12px; height: 12px; border-radius: 2px; background: #8B5CF6;"></span> Active Users</div>
            <div style="display: flex; align-items: center; gap: 6px;"><span style="width: 12px; height: 12px; border-radius: 2px; background: #10B981;"></span> New Users</div>
            <div style="display: flex; align-items: center; gap: 6px;"><span style="width: 12px; height: 12px; border-radius: 2px; background: #F59E0B;"></span> Posts</div>
            <div style="display: flex; align-items: center; gap: 6px;"><span style="width: 12px; height: 12px; border-radius: 2px; background: #EC4899;"></span> Messages</div>
          </div>
          <div id="trendsChart" style="height: 300px; position: relative;">
            <div class="loading">Loading trends...</div>
          </div>
        </div>
      </section>
      
      <section class="content-section" id="section-users">
        <div class="page-header">
          <div>
            <h1 class="page-title">Users</h1>
            <p class="page-subtitle">Manage platform users</p>
          </div>
          <div class="search-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
            <input type="text" id="userSearch" placeholder="Search users..." oninput="filterUsers()">
          </div>
        </div>
        
        <div class="filters">
          <button class="filter-btn active" data-action="user-filter" data-filter="all">All</button>
          <button class="filter-btn" data-action="user-filter" data-filter="admin">Admins</button>
          <button class="filter-btn" data-action="user-filter" data-filter="verified">Verified</button>
          <button class="filter-btn" data-action="user-filter" data-filter="suspended">Suspended</button>
        </div>
        
        <div class="card">
          <div class="table-container" id="usersTable">
            <div class="loading">Loading users...</div>
          </div>
        </div>
      </section>
      
      <section class="content-section" id="section-posts">
        <div class="page-header">
          <div>
            <h1 class="page-title">Posts</h1>
            <p class="page-subtitle">Manage platform content</p>
          </div>
        </div>
        
        <div class="filters">
          <button class="filter-btn active" data-action="post-filter" data-filter="all">All</button>
          <button class="filter-btn" data-action="post-filter" data-filter="TEXT">Text</button>
          <button class="filter-btn" data-action="post-filter" data-filter="PHOTO">Photos</button>
          <button class="filter-btn" data-action="post-filter" data-filter="VIDEO">Videos</button>
          <button class="filter-btn" data-action="post-filter" data-filter="VOICE">Voice</button>
        </div>
        
        <div class="card">
          <div class="table-container" id="postsTable">
            <div class="loading">Loading posts...</div>
          </div>
        </div>
      </section>
      
      <section class="content-section" id="section-comments">
        <div class="page-header">
          <div>
            <h1 class="page-title">Comments</h1>
            <p class="page-subtitle">Moderate user comments</p>
          </div>
        </div>
        
        <div class="card">
          <div class="table-container" id="commentsTable">
            <div class="loading">Loading comments...</div>
          </div>
        </div>
      </section>
      
      <section class="content-section" id="section-stories">
        <div class="page-header">
          <div>
            <h1 class="page-title">Stories</h1>
            <p class="page-subtitle">Manage user stories, highlights, stickers, and tips</p>
          </div>
        </div>
        
        <div class="stats-grid" id="storyExtendedStats">
          <div class="stat-card">
            <h3>Total Highlights</h3>
            <div class="value" id="stat-highlights">0</div>
          </div>
          <div class="stat-card">
            <h3>Total Stickers</h3>
            <div class="value" id="stat-stickers">0</div>
          </div>
          <div class="stat-card">
            <h3>Sticker Responses</h3>
            <div class="value" id="stat-responses">0</div>
          </div>
          <div class="stat-card">
            <h3>Total Tips</h3>
            <div class="value" id="stat-tips">0</div>
          </div>
          <div class="stat-card">
            <h3>Tip Amount</h3>
            <div class="value" id="stat-tip-amount">0</div>
          </div>
        </div>
        
        <div class="filters" id="storyTabs">
          <button class="filter-btn active" data-action="story-tab" data-tab="stories">Stories</button>
          <button class="filter-btn" data-action="story-tab" data-tab="highlights">Highlights</button>
          <button class="filter-btn" data-action="story-tab" data-tab="stickers">Stickers</button>
          <button class="filter-btn" data-action="story-tab" data-tab="tips">Tips</button>
        </div>
        
        <div class="card" id="storyStoriesPanel">
          <div class="table-container" id="storiesTable">
            <div class="loading">Loading stories...</div>
          </div>
        </div>
        
        <div class="card" id="storyHighlightsPanel" style="display: none;">
          <div class="card-header">
            <div class="card-title">Story Highlights</div>
            <div class="search-box">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
              <input type="text" id="highlightsSearch" placeholder="Search highlights..." onkeyup="searchHighlights()">
            </div>
          </div>
          <div class="table-container" id="highlightsTable">
            <div class="loading">Loading highlights...</div>
          </div>
          <div class="pagination" id="highlightsPagination"></div>
        </div>
        
        <div class="card" id="storyStickersPanel" style="display: none;">
          <div class="card-header">
            <div class="card-title">Story Stickers</div>
          </div>
          <div class="table-container" id="stickersTable">
            <div class="loading">Loading stickers...</div>
          </div>
          <div class="pagination" id="stickersPagination"></div>
        </div>
        
        <div class="card" id="storyTipsPanel" style="display: none;">
          <div class="card-header">
            <div class="card-title">Story Tips</div>
          </div>
          <div class="table-container" id="tipsTable">
            <div class="loading">Loading tips...</div>
          </div>
          <div class="pagination" id="tipsPagination"></div>
        </div>
      </section>
      
      <section class="content-section" id="section-reports">
        <div class="page-header">
          <div>
            <h1 class="page-title">Reports</h1>
            <p class="page-subtitle">Review user reports</p>
          </div>
        </div>
        
        <div class="filters">
          <button class="filter-btn active" data-action="report-filter" data-filter="PENDING">Pending</button>
          <button class="filter-btn" data-action="report-filter" data-filter="REVIEWED">Reviewed</button>
          <button class="filter-btn" data-action="report-filter" data-filter="RESOLVED">Resolved</button>
          <button class="filter-btn" data-action="report-filter" data-filter="DISMISSED">Dismissed</button>
        </div>
        
        <div class="card">
          <div class="table-container" id="reportsTable">
            <div class="loading">Loading reports...</div>
          </div>
        </div>
      </section>
      
      <section class="content-section" id="section-verification">
        <div class="page-header">
          <div>
            <h1 class="page-title">Verification Requests</h1>
            <p class="page-subtitle">Review verification requests</p>
          </div>
        </div>
        
        <div class="card">
          <div class="table-container" id="verificationTable">
            <div class="loading">Loading requests...</div>
          </div>
        </div>
      </section>
      
      <section class="content-section" id="section-groupchats">
        <div class="page-header">
          <div>
            <h1 class="page-title">Group Chats</h1>
            <p class="page-subtitle">Monitor and moderate group conversations</p>
          </div>
        </div>
        
        <div class="stats-grid" id="groupChatsStats">
          <div class="loading">Loading stats...</div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">All Group Conversations</h2>
            <div class="search-box" style="width: 250px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
              <input type="text" id="groupChatsSearch" placeholder="Search groups..." oninput="filterGroupChats()">
            </div>
          </div>
          <div class="table-container" id="groupChatsTable">
            <div class="loading">Loading group chats...</div>
          </div>
          <div id="groupChatsPagination" style="display: flex; justify-content: center; gap: 8px; margin-top: 16px;"></div>
        </div>
      </section>
      
      <section class="content-section" id="section-threads">
        <div class="page-header">
          <div>
            <h1 class="page-title">Content Threads</h1>
            <p class="page-subtitle">Manage post threads and duet/stitch content</p>
          </div>
        </div>
        
        <div class="stats-grid" id="threadsStats">
          <div class="loading">Loading stats...</div>
        </div>
        
        <div class="filters" style="margin-bottom: 16px;">
          <button class="filter-btn active" data-action="threads-tab" data-tab="threads">Threads</button>
          <button class="filter-btn" data-action="threads-tab" data-tab="duets">Duets/Stitches</button>
        </div>
        
        <div class="card" id="threadsContent">
          <div class="card-header">
            <h2 class="card-title">Post Threads</h2>
            <div class="search-box" style="width: 250px;">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
              <input type="text" id="threadsSearch" placeholder="Search threads..." oninput="searchThreads()">
            </div>
          </div>
          <div class="table-container" id="threadsTable">
            <div class="loading">Loading threads...</div>
          </div>
          <div id="threadsPagination" style="display: flex; justify-content: center; gap: 8px; margin-top: 16px;"></div>
        </div>
        
        <div class="card" id="duetStitchContent" style="display: none;">
          <div class="card-header">
            <h2 class="card-title">Duets & Stitches</h2>
            <div class="filters" style="margin: 0;">
              <button class="filter-btn active" data-action="duet-type-filter" data-type="all">All</button>
              <button class="filter-btn" data-action="duet-type-filter" data-type="duet">Duets</button>
              <button class="filter-btn" data-action="duet-type-filter" data-type="stitch">Stitches</button>
            </div>
          </div>
          <div class="table-container" id="duetStitchTable">
            <div class="loading">Loading duets/stitches...</div>
          </div>
          <div id="duetStitchPagination" style="display: flex; justify-content: center; gap: 8px; margin-top: 16px;"></div>
        </div>
      </section>
      
      <!-- Thread Detail Modal -->
      <div class="modal-overlay" id="threadDetailModal">
        <div class="modal" style="max-width: 700px;">
          <div class="modal-header">
            <h2>Thread Details</h2>
            <button class="modal-close" onclick="closeModal('threadDetailModal')">&times;</button>
          </div>
          <div id="threadDetailContent">
            <div class="loading">Loading...</div>
          </div>
        </div>
      </div>
      
      <!-- Duet/Stitch Detail Modal -->
      <div class="modal-overlay" id="duetStitchDetailModal">
        <div class="modal" style="max-width: 700px;">
          <div class="modal-header">
            <h2>Duet/Stitch Details</h2>
            <button class="modal-close" onclick="closeModal('duetStitchDetailModal')">&times;</button>
          </div>
          <div id="duetStitchDetailContent">
            <div class="loading">Loading...</div>
          </div>
        </div>
      </div>
      
      <section class="content-section" id="section-profilefeatures">
        <div class="page-header">
          <div>
            <h1 class="page-title">Profile Features</h1>
            <p class="page-subtitle">Manage featured intros, linked accounts, and user notes</p>
          </div>
        </div>
        
        <div class="stats-grid" id="profileFeaturesStats">
          <div class="stat-card">
            <h3>Featured Intros</h3>
            <div class="value" id="stat-featured-intros">0</div>
          </div>
          <div class="stat-card">
            <h3>Pending Review</h3>
            <div class="value" id="stat-pending-intros">0</div>
          </div>
          <div class="stat-card">
            <h3>Linked Accounts</h3>
            <div class="value" id="stat-linked-accounts">0</div>
          </div>
          <div class="stat-card">
            <h3>User Notes</h3>
            <div class="value" id="stat-user-notes">0</div>
          </div>
        </div>
        
        <div class="filters" id="profileFeaturesTabs">
          <button class="filter-btn active" data-action="profile-features-tab" data-tab="intros">Featured Intros</button>
          <button class="filter-btn" data-action="profile-features-tab" data-tab="linked">Linked Accounts</button>
          <button class="filter-btn" data-action="profile-features-tab" data-tab="notes">User Notes</button>
        </div>
        
        <div class="card" id="profileIntrosPanel">
          <div class="card-header">
            <div class="card-title">Featured Intros</div>
          </div>
          <div class="table-container" id="featuredIntrosTable">
            <div class="loading">Loading featured intros...</div>
          </div>
          <div class="pagination" id="featuredIntrosPagination"></div>
        </div>
        
        <div class="card" id="profileLinkedPanel" style="display: none;">
          <div class="card-header">
            <div class="card-title">Linked Accounts</div>
            <div class="search-box">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
              <input type="text" id="linkedAccountsSearch" placeholder="Search accounts..." onkeyup="searchLinkedAccounts()">
            </div>
          </div>
          <div class="table-container" id="linkedAccountsTable">
            <div class="loading">Loading linked accounts...</div>
          </div>
          <div class="pagination" id="linkedAccountsPagination"></div>
        </div>
        
        <div class="card" id="profileNotesPanel" style="display: none;">
          <div class="card-header">
            <div class="card-title">User Notes (24h Status)</div>
          </div>
          <div class="table-container" id="userNotesTable">
            <div class="loading">Loading user notes...</div>
          </div>
          <div class="pagination" id="userNotesPagination"></div>
        </div>
      </section>
      
      <section class="content-section" id="section-roles">
        <div class="page-header">
          <div>
            <h1 class="page-title">Roles & Permissions</h1>
            <p class="page-subtitle">Manage access control</p>
          </div>
          <button class="action-btn action-btn-primary" data-action="create-role-modal" style="padding: 10px 20px;">Create Role</button>
        </div>
        
        <div class="card">
          <div class="table-container" id="rolesTable">
            <div class="loading">Loading roles...</div>
          </div>
        </div>
      </section>
      
      <section class="content-section" id="section-settings">
        <div class="page-header">
          <div>
            <h1 class="page-title">Settings</h1>
            <p class="page-subtitle">Configure platform settings</p>
          </div>
        </div>
        
        <div class="card">
          <h3 style="margin-bottom: 16px;">Feature Flags</h3>
          <div class="settings-grid" id="settingsGrid">
            <div class="loading">Loading settings...</div>
          </div>
        </div>
      </section>
      
      <section class="content-section" id="section-gossip">
        <div class="page-header">
          <div>
            <h1 class="page-title">Anonymous Gossip</h1>
            <p class="page-subtitle">Manage anonymous posts, reports, and content moderation</p>
          </div>
        </div>
        
        <div class="stats-grid" id="gossipStats">
          <div class="loading">Loading gossip stats...</div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Reported Posts</h2>
          </div>
          <div class="filters">
            <button class="filter-btn active" data-action="gossip-filter" data-filter="reported">Reported</button>
            <button class="filter-btn" data-action="gossip-filter" data-filter="hidden">Hidden</button>
            <button class="filter-btn" data-action="gossip-filter" data-filter="removed">Removed</button>
            <button class="filter-btn" data-action="gossip-filter" data-filter="all">All Posts</button>
          </div>
          <div class="table-container" id="gossipTable">
            <div class="loading">Loading gossip posts...</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Blocked Words</h2>
            <div style="display: flex; gap: 8px;">
              <input type="text" id="newBlockedWord" placeholder="Add new blocked word..." style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 8px 12px; color: #fff; font-size: 14px;">
              <button class="action-btn action-btn-primary" data-action="add-blocked-word">Add</button>
            </div>
          </div>
          <div id="blockedWordsGrid" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px;">
            <div class="loading">Loading blocked words...</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Location Stats</h2>
          </div>
          <div class="table-container" id="locationStatsTable">
            <div class="loading">Loading location stats...</div>
          </div>
        </div>
      </section>

      <section class="content-section" id="section-mall">
        <div class="page-header">
          <div>
            <h1 class="page-title">Mall Management</h1>
            <p class="page-subtitle">Manage products, categories, and user purchases</p>
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="action-btn action-btn-primary" data-action="add-product" style="padding: 10px 20px;">Add Product</button>
            <button class="action-btn" data-action="add-category" style="padding: 10px 20px; background: rgba(139, 92, 246, 0.2);">Add Category</button>
            <button class="action-btn" data-action="seed-mall" style="padding: 10px 20px; background: rgba(34, 197, 94, 0.2);">Seed Mall</button>
            <button class="action-btn" data-action="fix-prices" style="padding: 10px 20px; background: rgba(251, 191, 36, 0.2);">Fix Prices</button>
          </div>
        </div>

        <div class="stats-grid" id="mallStats">
          <div class="loading">Loading mall stats...</div>
        </div>

        <div class="filters" id="mallTabs">
          <button class="filter-btn active" data-action="mall-tab" data-tab="products">Products</button>
          <button class="filter-btn" data-action="mall-tab" data-tab="categories">Categories</button>
          <button class="filter-btn" data-action="mall-tab" data-tab="purchases">User Purchases</button>
        </div>

        <div id="mallProductsTab">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Mall Products</h2>
              <div class="search-box" style="width: 250px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                <input type="text" id="productSearch" placeholder="Search products..." oninput="filterMallProducts()">
              </div>
            </div>
            <div class="table-container" id="mallProductsTable">
              <div class="loading">Loading products...</div>
            </div>
          </div>
        </div>

        <div id="mallCategoriesTab" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Mall Categories</h2>
            </div>
            <div class="table-container" id="mallCategoriesTable">
              <div class="loading">Loading categories...</div>
            </div>
          </div>
        </div>

        <div id="mallPurchasesTab" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">User Purchases</h2>
              <div class="search-box" style="width: 250px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                <input type="text" id="purchaseSearch" placeholder="Search by username..." oninput="filterPurchases()">
              </div>
            </div>
            <div class="table-container" id="mallPurchasesTable">
              <div class="loading">Loading purchases...</div>
            </div>
          </div>
        </div>
      </section>

      <section class="content-section" id="section-audit">
        <div class="page-header">
          <div>
            <h1 class="page-title">Audit Log</h1>
            <p class="page-subtitle">Track system activity</p>
          </div>
        </div>
        
        <div class="card">
          <div class="table-container" id="auditTable">
            <div class="loading">Loading audit logs...</div>
          </div>
        </div>
      </section>

      <section class="content-section" id="section-messages">
        <div class="page-header">
          <div>
            <h1 class="page-title">Messages</h1>
            <p class="page-subtitle">Monitor conversations and moderate message content</p>
          </div>
        </div>
        
        <div class="stats-grid" id="messagesStats">
          <div class="loading">Loading stats...</div>
        </div>
        
        <div class="filters" id="messagesTabFilters">
          <button class="filter-btn active" data-action="messages-tab" data-tab="conversations">Conversations</button>
          <button class="filter-btn" data-action="messages-tab" data-tab="search">Search Messages</button>
          <button class="filter-btn" data-action="messages-tab" data-tab="flagged">Flagged Messages</button>
        </div>
        
        <div class="card" id="conversationsCard">
          <div class="card-header">
            <h2 class="card-title">Recent Conversations</h2>
            <input type="text" id="conversationSearch" placeholder="Search by username..." oninput="renderConversations()" style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; width: 250px;">
          </div>
          <div class="table-container" id="conversationsTable">
            <div class="loading">Loading conversations...</div>
          </div>
        </div>
        
        <div class="card" id="messageSearchCard" style="display: none;">
          <div class="card-header">
            <h2 class="card-title">Search Message Content</h2>
            <div style="display: flex; gap: 12px; align-items: center;">
              <input type="text" id="messageSearchInput" placeholder="Search message content..." style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; width: 300px;">
              <button class="action-btn action-btn-primary" onclick="searchMessages()">Search</button>
            </div>
          </div>
          <div class="table-container" id="messageSearchResults">
            <div class="empty-state">Enter a search term to find messages</div>
          </div>
          <div class="pagination" id="messageSearchPagination"></div>
        </div>
        
        <div class="card" id="flaggedMessagesCard" style="display: none;">
          <div class="card-header">
            <h2 class="card-title">Flagged Messages</h2>
          </div>
          <div class="table-container" id="flaggedMessagesTable">
            <div class="loading">Loading flagged messages...</div>
          </div>
          <div class="pagination" id="flaggedMessagesPagination"></div>
        </div>
      </section>
      
      <div class="modal-overlay" id="conversationMessagesModal" style="display: none;">
        <div class="modal" style="max-width: 700px; max-height: 80vh; overflow-y: auto;">
          <div class="modal-header">
            <h2 class="modal-title">Conversation Messages</h2>
            <button class="modal-close" onclick="closeConversationModal()">&times;</button>
          </div>
          <div class="modal-body" id="conversationMessagesContent">
            <div class="loading">Loading messages...</div>
          </div>
          <div class="pagination" id="conversationMessagesPagination" style="margin-top: 16px;"></div>
        </div>
      </div>
      
      <div class="modal-overlay" id="messageDetailModal" style="display: none;">
        <div class="modal" style="max-width: 600px;">
          <div class="modal-header">
            <h2 class="modal-title">Message Details</h2>
            <button class="modal-close" onclick="closeMessageDetailModal()">&times;</button>
          </div>
          <div class="modal-body" id="messageDetailContent">
            <div class="loading">Loading...</div>
          </div>
          <div class="modal-footer" id="messageDetailActions"></div>
        </div>
      </div>
      
      <div class="modal-overlay" id="flagMessageModal" style="display: none;">
        <div class="modal" style="max-width: 500px;">
          <div class="modal-header">
            <h2 class="modal-title">Flag Message for Review</h2>
            <button class="modal-close" onclick="closeFlagModal()">&times;</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label>Reason for flagging:</label>
              <textarea id="flagReasonInput" rows="4" placeholder="Enter reason for flagging this message..." style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; resize: vertical;"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button class="action-btn" onclick="closeFlagModal()">Cancel</button>
            <button class="action-btn action-btn-danger" onclick="submitFlagMessage()">Flag Message</button>
          </div>
        </div>
      </div>

      <section class="content-section" id="section-groups">
        <div class="page-header">
          <div>
            <h1 class="page-title">Groups</h1>
            <p class="page-subtitle">Manage community groups</p>
          </div>
        </div>
        
        <div class="stats-grid" id="groupsStats">
          <div class="loading">Loading stats...</div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">All Groups</h2>
            <input type="text" id="groupSearch" placeholder="Search groups..." style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; width: 250px;">
          </div>
          <div class="table-container" id="groupsTable">
            <div class="loading">Loading groups...</div>
          </div>
        </div>
      </section>

      <section class="content-section" id="section-livestreams">
        <div class="page-header">
          <div>
            <h1 class="page-title">Live Streams</h1>
            <p class="page-subtitle">Monitor and moderate live content</p>
          </div>
        </div>
        
        <div class="stats-grid" id="livestreamsStats">
          <div class="loading">Loading stats...</div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Live & Recent Streams</h2>
            <div class="filter-tabs">
              <button class="filter-btn active" data-action="livestream-filter" data-filter="all">All</button>
              <button class="filter-btn" data-action="livestream-filter" data-filter="live">Live Now</button>
              <button class="filter-btn" data-action="livestream-filter" data-filter="ended">Ended</button>
            </div>
          </div>
          <div class="table-container" id="livestreamsTable">
            <div class="loading">Loading streams...</div>
          </div>
        </div>
      </section>

      <section class="content-section" id="section-wallet">
        <div class="page-header">
          <div>
            <h1 class="page-title">Wallet & Economy</h1>
            <p class="page-subtitle">Manage virtual currency, transactions, gifts, and withdrawals</p>
          </div>
        </div>
        
        <!-- Economy Dashboard Stats -->
        <div class="stats-grid" id="economyStats">
          <div class="stat-card">
            <h3>Total Coins in Circulation</h3>
            <div class="value" id="stat-total-coins">0</div>
          </div>
          <div class="stat-card">
            <h3>Active Wallets</h3>
            <div class="value" id="stat-active-wallets">0</div>
          </div>
          <div class="stat-card">
            <h3>Frozen Wallets</h3>
            <div class="value" id="stat-frozen-wallets">0</div>
            <div class="change" style="color: #EF4444;" id="stat-frozen-change"></div>
          </div>
          <div class="stat-card">
            <h3>Daily Transactions</h3>
            <div class="value" id="stat-daily-tx">0</div>
          </div>
          <div class="stat-card">
            <h3>Weekly Transactions</h3>
            <div class="value" id="stat-weekly-tx">0</div>
          </div>
          <div class="stat-card">
            <h3>Pending Withdrawals</h3>
            <div class="value" id="stat-pending-withdrawals">0</div>
          </div>
          <div class="stat-card">
            <h3>KYC Pending</h3>
            <div class="value" id="stat-kyc-pending">0</div>
          </div>
          <div class="stat-card">
            <h3>Avg User Balance</h3>
            <div class="value" id="stat-avg-balance">0</div>
          </div>
        </div>
        
        <!-- Wallet Tabs -->
        <div class="tabs-container" style="margin-bottom: 20px;">
          <button class="tab-btn active" onclick="showWalletTab('wallets')">User Wallets</button>
          <button class="tab-btn" onclick="showWalletTab('gifts')">Gift Types</button>
          <button class="tab-btn" onclick="showWalletTab('bundles')">Coin Bundles</button>
          <button class="tab-btn" onclick="showWalletTab('withdrawals')">Withdrawals</button>
          <button class="tab-btn" onclick="showWalletTab('kyc')">KYC Management</button>
        </div>
        
        <!-- User Wallets Tab -->
        <div class="card wallet-tab" id="walletTab-wallets">
          <div class="card-header">
            <h2 class="card-title">User Wallets</h2>
            <div style="display: flex; gap: 12px; align-items: center;">
              <input type="text" id="walletSearch" placeholder="Search by username..." oninput="filterWallets()" style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; width: 200px;">
              <select id="walletFrozenFilter" onchange="filterWallets()" style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
                <option value="">All Wallets</option>
                <option value="active">Active Only</option>
                <option value="frozen">Frozen Only</option>
              </select>
            </div>
          </div>
          <div class="table-container" id="walletsTable">
            <div class="loading">Loading wallets...</div>
          </div>
        </div>
        
        <!-- Gift Types Tab -->
        <div class="card wallet-tab" id="walletTab-gifts" style="display: none;">
          <div class="card-header">
            <h2 class="card-title">Gift Types</h2>
            <button class="action-btn action-btn-primary" onclick="openGiftTypeModal()">Add Gift Type</button>
          </div>
          <div class="table-container" id="giftTypesTable">
            <div class="loading">Loading gift types...</div>
          </div>
        </div>
        
        <!-- Coin Bundles Tab -->
        <div class="card wallet-tab" id="walletTab-bundles" style="display: none;">
          <div class="card-header">
            <h2 class="card-title">Coin Bundles</h2>
            <button class="action-btn action-btn-primary" onclick="openCoinBundleModal()">Add Coin Bundle</button>
          </div>
          <div class="table-container" id="coinBundlesTable">
            <div class="loading">Loading coin bundles...</div>
          </div>
        </div>
        
        <!-- Withdrawals Tab -->
        <div class="card wallet-tab" id="walletTab-withdrawals" style="display: none;">
          <div class="card-header">
            <h2 class="card-title">Withdrawal Requests</h2>
            <div class="filters" id="withdrawalFilters">
              <button class="filter-btn active" onclick="filterWithdrawals('')">All</button>
              <button class="filter-btn" onclick="filterWithdrawals('pending')">Pending</button>
              <button class="filter-btn" onclick="filterWithdrawals('approved')">Approved</button>
              <button class="filter-btn" onclick="filterWithdrawals('rejected')">Rejected</button>
            </div>
          </div>
          <div class="table-container" id="withdrawalsTable">
            <div class="loading">Loading withdrawals...</div>
          </div>
        </div>
        
        <!-- KYC Management Tab -->
        <div class="card wallet-tab" id="walletTab-kyc" style="display: none;">
          <div class="card-header">
            <h2 class="card-title">KYC Submissions</h2>
            <div class="filters" id="kycFilters">
              <button class="filter-btn active" onclick="filterKyc('')">All</button>
              <button class="filter-btn" onclick="filterKyc('pending')">Pending</button>
              <button class="filter-btn" onclick="filterKyc('approved')">Approved</button>
              <button class="filter-btn" onclick="filterKyc('rejected')">Rejected</button>
            </div>
          </div>
          <div class="table-container" id="kycTable">
            <div class="loading">Loading KYC submissions...</div>
          </div>
        </div>
      </section>
      
      <!-- Wallet Adjust Balance Modal -->
      <div class="modal-overlay" id="adjustBalanceModal">
        <div class="modal">
          <div class="modal-header">
            <h3 class="modal-title">Adjust Wallet Balance</h3>
            <button class="modal-close" onclick="closeModal('adjustBalanceModal')">&times;</button>
          </div>
          <form id="adjustBalanceForm" onsubmit="submitAdjustBalance(event)">
            <input type="hidden" id="adjustBalanceUserId">
            <div class="form-group">
              <label>Username</label>
              <input type="text" id="adjustBalanceUsername" disabled style="width: 100%; padding: 12px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
            </div>
            <div class="form-group">
              <label>Current Balance</label>
              <input type="text" id="adjustBalanceCurrent" disabled style="width: 100%; padding: 12px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
            </div>
            <div class="form-group">
              <label>Adjustment Amount (+ to add, - to deduct)</label>
              <input type="number" id="adjustBalanceAmount" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
            </div>
            <div class="form-group">
              <label>Reason</label>
              <textarea id="adjustBalanceReason" required placeholder="Enter reason for adjustment..." style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; resize: vertical; min-height: 80px;"></textarea>
            </div>
            <div class="form-actions">
              <button type="button" class="btn btn-secondary" onclick="closeModal('adjustBalanceModal')">Cancel</button>
              <button type="submit" class="btn">Adjust Balance</button>
            </div>
          </form>
        </div>
      </div>
      
      <!-- Gift Type Modal -->
      <div class="modal-overlay" id="giftTypeModal">
        <div class="modal">
          <div class="modal-header">
            <h3 class="modal-title" id="giftTypeModalTitle">Add Gift Type</h3>
            <button class="modal-close" onclick="closeModal('giftTypeModal')">&times;</button>
          </div>
          <form id="giftTypeForm" onsubmit="submitGiftType(event)">
            <input type="hidden" id="giftTypeId">
            <div class="form-group">
              <label>Name</label>
              <input type="text" id="giftTypeName" required placeholder="e.g., Rose, Diamond" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Icon (emoji or URL)</label>
                <input type="text" id="giftTypeIcon" required placeholder="üåπ" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
              </div>
              <div class="form-group">
                <label>Category</label>
                <select id="giftTypeCategory" required style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
                  <option value="basic">Basic</option>
                  <option value="premium">Premium</option>
                  <option value="luxury">Luxury</option>
                  <option value="special">Special</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Coin Cost</label>
                <input type="number" id="giftTypeCost" required min="1" placeholder="100" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
              </div>
              <div class="form-group">
                <label>Net Worth Value</label>
                <input type="number" id="giftTypeNetWorth" required min="0" placeholder="50" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
              </div>
            </div>
            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="giftTypeActive" checked style="width: 18px; height: 18px;">
                Active
              </label>
            </div>
            <div class="form-actions">
              <button type="button" class="btn btn-secondary" onclick="closeModal('giftTypeModal')">Cancel</button>
              <button type="submit" class="btn">Save Gift Type</button>
            </div>
          </form>
        </div>
      </div>
      
      <!-- Coin Bundle Modal -->
      <div class="modal-overlay" id="coinBundleModal">
        <div class="modal">
          <div class="modal-header">
            <h3 class="modal-title" id="coinBundleModalTitle">Add Coin Bundle</h3>
            <button class="modal-close" onclick="closeModal('coinBundleModal')">&times;</button>
          </div>
          <form id="coinBundleForm" onsubmit="submitCoinBundle(event)">
            <input type="hidden" id="coinBundleId">
            <div class="form-group">
              <label>Bundle Name</label>
              <input type="text" id="coinBundleName" required placeholder="e.g., Starter Pack" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Coins</label>
                <input type="number" id="coinBundleCoins" required min="1" placeholder="1000" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
              </div>
              <div class="form-group">
                <label>Price (Rands)</label>
                <input type="number" id="coinBundlePrice" required min="1" step="0.01" placeholder="49.99" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Bonus Coins</label>
                <input type="number" id="coinBundleBonus" min="0" value="0" placeholder="0" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
              </div>
              <div class="form-group">
                <label>Sort Order</label>
                <input type="number" id="coinBundleSortOrder" min="0" value="0" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
              </div>
            </div>
            <div class="form-group" style="display: flex; gap: 24px;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="coinBundleFeatured" style="width: 18px; height: 18px;">
                Featured
              </label>
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="coinBundleActive" checked style="width: 18px; height: 18px;">
                Active
              </label>
            </div>
            <div class="form-actions">
              <button type="button" class="btn btn-secondary" onclick="closeModal('coinBundleModal')">Cancel</button>
              <button type="submit" class="btn">Save Bundle</button>
            </div>
          </form>
        </div>
      </div>
      
      <!-- KYC Details Modal -->
      <div class="modal-overlay" id="kycDetailsModal">
        <div class="modal" style="max-width: 600px;">
          <div class="modal-header">
            <h3 class="modal-title">KYC Submission Details</h3>
            <button class="modal-close" onclick="closeModal('kycDetailsModal')">&times;</button>
          </div>
          <div id="kycDetailsContent">
            <div class="loading">Loading...</div>
          </div>
          <div class="form-actions" id="kycDetailsActions" style="display: none;">
            <button type="button" class="btn btn-secondary" onclick="closeModal('kycDetailsModal')">Close</button>
            <button type="button" class="action-btn action-btn-danger" id="kycRejectBtn" onclick="rejectKyc()">Reject</button>
            <button type="button" class="action-btn action-btn-success" id="kycApproveBtn" onclick="approveKyc()">Approve</button>
          </div>
        </div>
      </div>

      <section class="content-section" id="section-payments">
        <div class="page-header">
          <div>
            <h1 class="page-title">Payments</h1>
            <p class="page-subtitle">Manage PayFast orders and transactions</p>
          </div>
        </div>
        
        <div class="stats-grid" id="paymentStats">
          <div class="loading">Loading stats...</div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">PayFast Orders</h2>
            <div style="display: flex; gap: 12px; align-items: center;">
              <input type="text" id="paymentSearch" placeholder="Search orders..." oninput="loadPayments(1, paymentsCurrentStatus)" style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; width: 200px;">
            </div>
          </div>
          <div class="filters" id="paymentFilters">
            <button class="filter-btn active" data-action="payment-filter" data-status="">All</button>
            <button class="filter-btn" data-action="payment-filter" data-status="PENDING">Pending</button>
            <button class="filter-btn" data-action="payment-filter" data-status="COMPLETE">Completed</button>
            <button class="filter-btn" data-action="payment-filter" data-status="FAILED">Failed</button>
            <button class="filter-btn" data-action="payment-filter" data-status="CANCELLED">Cancelled</button>
          </div>
          <div class="table-container" id="paymentsTable">
            <div class="loading">Loading orders...</div>
          </div>
          <div class="pagination" id="paymentsPagination"></div>
        </div>
      </section>

      <section class="content-section" id="section-featureflags">
        <div class="page-header">
          <div>
            <h1 class="page-title">Feature Flags</h1>
            <p class="page-subtitle">Toggle app features on and off</p>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Active Feature Flags</h2>
            <button class="action-btn action-btn-primary" data-action="add-feature-flag">Add Flag</button>
          </div>
          <div class="table-container" id="featureFlagsTable">
            <div class="loading">Loading feature flags...</div>
          </div>
        </div>
      </section>
      
      <section class="content-section" id="section-userwealth">
        <div class="page-header">
          <div>
            <h1 class="page-title">User Wealth Management</h1>
            <p class="page-subtitle">Control user net worth and portfolio items</p>
          </div>
          <div class="search-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
            <input type="text" id="wealthUserSearch" placeholder="Search users by name..." oninput="filterWealthUsers()">
          </div>
        </div>
        
        <div class="stats-grid" id="wealthStats">
          <div class="stat-card">
            <div class="stat-value" id="totalNetWorth">R0</div>
            <div class="stat-label">Total Platform Net Worth</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="avgNetWorth">R0</div>
            <div class="stat-label">Average Net Worth</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="wealthyUsers">0</div>
            <div class="stat-label">Users with Net Worth > R1M</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalPortfolioItems">0</div>
            <div class="stat-label">Total Portfolio Items</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">All Users by Net Worth</h2>
            <div style="display: flex; gap: 8px;">
              <select id="wealthSortOrder" onchange="loadWealthUsers()" style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
                <option value="desc">Highest First</option>
                <option value="asc">Lowest First</option>
              </select>
            </div>
          </div>
          <div class="table-container" id="wealthUsersTable">
            <div class="loading">Loading users...</div>
          </div>
        </div>
      </section>
      
      <section class="content-section" id="section-broadcasts">
        <div class="page-header">
          <div>
            <h1 class="page-title">Broadcasts & Channels</h1>
            <p class="page-subtitle">Manage broadcast channels and send notifications</p>
          </div>
        </div>
        
        <div class="stats-grid" id="broadcastsStats">
          <div class="loading">Loading stats...</div>
        </div>
        
        <div class="card" style="margin-bottom: 20px;">
          <div class="card-header">
            <h2 class="card-title">Broadcast Channels</h2>
          </div>
          <div class="table-container" id="broadcastChannelsTable">
            <div class="loading">Loading channels...</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Send System Notification</h2>
          </div>
          <div style="padding: 24px;">
            <div class="form-group">
              <label>Broadcast Message</label>
              <textarea id="broadcastMessage" rows="4" placeholder="Enter your message to all users..." style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; resize: vertical;"></textarea>
            </div>
            <div class="form-group">
              <label>Notification Type</label>
              <select id="broadcastType" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
                <option value="SYSTEM">System Announcement</option>
                <option value="PROMOTION">Promotion</option>
                <option value="UPDATE">App Update</option>
                <option value="ALERT">Important Alert</option>
              </select>
            </div>
            <button class="action-btn action-btn-primary" data-action="send-broadcast" style="width: 100%; padding: 16px;">Send to All Users</button>
          </div>
        </div>
      </section>
      
      <section class="content-section" id="section-events">
        <div class="page-header">
          <div>
            <h1 class="page-title">Events</h1>
            <p class="page-subtitle">Manage platform events</p>
          </div>
        </div>
        
        <div class="stats-grid" id="eventsStats">
          <div class="loading">Loading stats...</div>
        </div>
        
        <div class="card">
          <div class="table-container" id="eventsTable">
            <div class="loading">Loading events...</div>
          </div>
        </div>
      </section>
      
      <section class="content-section" id="section-subscriptions">
        <div class="page-header">
          <div>
            <h1 class="page-title">Subscriptions</h1>
            <p class="page-subtitle">Manage creator subscription tiers</p>
          </div>
        </div>
        
        <div class="stats-grid" id="subscriptionsStats">
          <div class="loading">Loading stats...</div>
        </div>
        
        <div class="card">
          <div class="table-container" id="subscriptionsTable">
            <div class="loading">Loading subscriptions...</div>
          </div>
        </div>
      </section>
      
      <section class="content-section" id="section-hashtags">
        <div class="page-header">
          <div>
            <h1 class="page-title">Hashtags</h1>
            <p class="page-subtitle">Manage trending hashtags</p>
          </div>
        </div>
        
        <div class="stats-grid" id="hashtagsStats">
          <div class="loading">Loading stats...</div>
        </div>
        
        <div class="card">
          <div class="table-container" id="hashtagsTable">
            <div class="loading">Loading hashtags...</div>
          </div>
        </div>
      </section>
      
      <section class="content-section" id="section-blocks">
        <div class="page-header">
          <div>
            <h1 class="page-title">Blocks & Mutes</h1>
            <p class="page-subtitle">User relationship oversight</p>
          </div>
        </div>
        
        <div class="stats-grid" id="blocksStats">
          <div class="loading">Loading stats...</div>
        </div>
        
        <div class="card">
          <div class="table-container" id="blocksTable">
            <div class="loading">Loading blocks...</div>
          </div>
        </div>
      </section>
      
      <section class="content-section" id="section-reels">
        <div class="page-header">
          <div>
            <h1 class="page-title">Reels</h1>
            <p class="page-subtitle">Video content moderation</p>
          </div>
        </div>
        
        <div class="stats-grid" id="reelsStats">
          <div class="loading">Loading stats...</div>
        </div>
        
        <div class="card">
          <div class="table-container" id="reelsTable">
            <div class="loading">Loading reels...</div>
          </div>
        </div>
      </section>
      
      <section class="content-section" id="section-discovery">
        <div class="page-header">
          <div>
            <h1 class="page-title">Discovery</h1>
            <p class="page-subtitle">Algorithm and recommendation controls</p>
          </div>
        </div>
        
        <div class="stats-grid" id="discoveryStats">
          <div class="loading">Loading stats...</div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Explore Categories</h2>
          </div>
          <div class="table-container" id="discoveryTable">
            <div class="loading">Loading categories...</div>
          </div>
        </div>
      </section>
      
      <section class="content-section" id="section-security">
        <div class="page-header">
          <div>
            <h1 class="page-title">Security</h1>
            <p class="page-subtitle">Two-Factor Authentication and Session management</p>
          </div>
        </div>
        
        <div class="tabs-container" style="margin-bottom: 24px;">
          <button class="tab-btn active" data-action="security-tab" data-tab="security-2fa">2FA Management</button>
          <button class="tab-btn" data-action="security-tab" data-tab="security-sessions">Sessions</button>
          <button class="tab-btn" data-action="security-tab" data-tab="security-devices">Devices</button>
        </div>
        
        <!-- 2FA Tab -->
        <div class="tab-content active" id="security-2fa">
          <div class="stats-grid" id="securityStats">
            <div class="loading">Loading security stats...</div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Users with 2FA</h2>
              <div class="search-box">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                <input type="text" id="security2faSearch" placeholder="Search users..." oninput="filterSecurity2FA()">
              </div>
            </div>
            <div class="table-container" id="security2faTable">
              <div class="loading">Loading 2FA users...</div>
            </div>
            <div class="pagination" id="security2faPagination" style="display: flex; justify-content: center; gap: 8px; margin-top: 16px;"></div>
          </div>
        </div>
        
        <!-- Sessions Tab -->
        <div class="tab-content" id="security-sessions" style="display: none;">
          <div class="stats-grid" id="sessionStats">
            <div class="loading">Loading session stats...</div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Login Sessions</h2>
              <div style="display: flex; gap: 12px; align-items: center;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 13px; color: rgba(255,255,255,0.7);">
                  <input type="checkbox" id="sessionsActiveOnly" onchange="filterSecuritySessions()" style="width: 16px; height: 16px; accent-color: #8B5CF6;">
                  Active Only
                </label>
                <div class="search-box">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                  <input type="text" id="sessionsSearch" placeholder="Search users..." oninput="filterSecuritySessions()">
                </div>
              </div>
            </div>
            <div class="table-container" id="sessionsTable">
              <div class="loading">Loading sessions...</div>
            </div>
            <div class="pagination" id="sessionsPagination" style="display: flex; justify-content: center; gap: 8px; margin-top: 16px;"></div>
          </div>
        </div>
        
        <!-- Devices Tab -->
        <div class="tab-content" id="security-devices" style="display: none;">
          <div class="stats-grid" id="deviceStats">
            <div class="loading">Loading device stats...</div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Trusted Devices</h2>
              <div class="search-box">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                <input type="text" id="devicesSearch" placeholder="Search users or devices..." onkeyup="filterSecurityDevices()" />
              </div>
            </div>
            <div class="table-container" id="devicesTable">
              <div class="loading">Loading devices...</div>
            </div>
            <div class="pagination" id="devicesPagination" style="display: flex; justify-content: center; gap: 8px; margin-top: 16px;"></div>
          </div>
        </div>
      </section>
      
      <section class="content-section" id="section-videocalls">
        <div class="page-header">
          <div>
            <h1 class="page-title">Video Calls</h1>
            <p class="page-subtitle">Monitor and manage video/voice calls</p>
          </div>
          <div class="search-box">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
            <input type="text" id="videoCallsSearch" placeholder="Search by username..." oninput="filterVideoCalls()">
          </div>
        </div>
        
        <div class="stats-grid" id="videoCallsStats">
          <div class="loading">Loading video call stats...</div>
        </div>
        
        <div class="filters">
          <button class="filter-btn active" data-action="videocall-filter" data-filter="all">All</button>
          <button class="filter-btn" data-action="videocall-filter" data-filter="RINGING">Ringing</button>
          <button class="filter-btn" data-action="videocall-filter" data-filter="ONGOING">Active</button>
          <button class="filter-btn" data-action="videocall-filter" data-filter="ENDED">Completed</button>
          <button class="filter-btn" data-action="videocall-filter" data-filter="MISSED">Missed</button>
          <button class="filter-btn" data-action="videocall-filter" data-filter="DECLINED">Declined</button>
          <button class="filter-btn" data-action="videocall-filter" data-filter="CANCELLED">Cancelled</button>
        </div>
        
        <div class="card">
          <div class="table-container" id="videoCallsTable">
            <div class="loading">Loading video calls...</div>
          </div>
          <div class="pagination" id="videoCallsPagination" style="display: flex; justify-content: center; gap: 8px; margin-top: 16px;"></div>
        </div>
      </section>
      
      <!-- Video Call Detail Modal -->
      <div class="modal-overlay" id="videoCallDetailModal">
        <div class="modal" style="max-width: 600px;">
          <div class="modal-header">
            <h3 class="modal-title">Call Details</h3>
            <button class="modal-close" onclick="closeModal('videoCallDetailModal')">&times;</button>
          </div>
          <div id="videoCallDetailContent">
            <div class="loading">Loading call details...</div>
          </div>
        </div>
      </div>
      
      <section class="content-section" id="section-advertising">
        <div class="page-header">
          <div>
            <h1 class="page-title">Advertising Platform</h1>
            <p class="page-subtitle">Complete advertising management and analytics</p>
          </div>
        </div>
        
        <div class="tabs-container" style="margin-bottom: 24px;">
          <button class="tab-btn active" data-action="ads-tab" data-tab="ads-overview">Overview</button>
          <button class="tab-btn" data-action="ads-tab" data-tab="ads-advertisers">Advertisers</button>
          <button class="tab-btn" data-action="ads-tab" data-tab="ads-campaigns">Campaigns</button>
          <button class="tab-btn" data-action="ads-tab" data-tab="ads-creatives">Ads</button>
          <button class="tab-btn" data-action="ads-tab" data-tab="ads-analytics">Analytics</button>
          <button class="tab-btn" data-action="ads-tab" data-tab="ads-health">Health</button>
          <button class="tab-btn" data-action="ads-tab" data-tab="ads-disputes">Disputes</button>
          <button class="tab-btn" data-action="ads-tab" data-tab="ads-emergency">Emergency</button>
          <button class="tab-btn" data-action="ads-tab" data-tab="ads-settings">Settings</button>
        </div>
        
        <!-- Overview Tab -->
        <div class="tab-content active" id="ads-overview">
          <div class="stats-grid" id="adsOverviewStats">
            <div class="loading">Loading advertising stats...</div>
          </div>
          
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h2 class="card-title">Revenue Overview (Last 30 Days)</h2>
            </div>
            <div id="adsRevenueChart" style="height: 200px; display: flex; align-items: center; justify-content: center;">
              <div class="loading">Loading chart...</div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 24px;">
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Top Performing Campaigns</h2>
              </div>
              <div id="adsTopCampaigns">
                <div class="loading">Loading...</div>
              </div>
            </div>
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Recent Activity</h2>
              </div>
              <div id="adsRecentActivity">
                <div class="loading">Loading...</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Advertisers Tab -->
        <div class="tab-content" id="ads-advertisers" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Advertiser Accounts</h2>
              <div style="display: flex; gap: 12px;">
                <input type="text" id="advertiserSearch" placeholder="Search advertisers..." style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;" oninput="filterAdvertisers()">
              </div>
            </div>
            <div class="filters">
              <button class="filter-btn active" data-action="advertiser-filter" data-filter="all">All</button>
              <button class="filter-btn" data-action="advertiser-filter" data-filter="ACTIVE">Active</button>
              <button class="filter-btn" data-action="advertiser-filter" data-filter="PENDING">Pending</button>
              <button class="filter-btn" data-action="advertiser-filter" data-filter="SUSPENDED">Suspended</button>
            </div>
            <div class="table-container" id="advertisersTable">
              <div class="loading">Loading advertisers...</div>
            </div>
          </div>
        </div>
        
        <!-- Campaigns Tab -->
        <div class="tab-content" id="ads-campaigns" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">All Campaigns</h2>
              <div style="display: flex; gap: 12px;">
                <input type="text" id="campaignSearch" placeholder="Search campaigns..." style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;" oninput="filterCampaigns()">
              </div>
            </div>
            <div class="filters">
              <button class="filter-btn active" data-action="campaign-filter" data-filter="all">All</button>
              <button class="filter-btn" data-action="campaign-filter" data-filter="ACTIVE">Active</button>
              <button class="filter-btn" data-action="campaign-filter" data-filter="PAUSED">Paused</button>
              <button class="filter-btn" data-action="campaign-filter" data-filter="PENDING">Pending</button>
              <button class="filter-btn" data-action="campaign-filter" data-filter="ENDED">Ended</button>
            </div>
            <div class="table-container" id="campaignsTable">
              <div class="loading">Loading campaigns...</div>
            </div>
          </div>
        </div>
        
        <!-- Ads/Creatives Tab -->
        <div class="tab-content" id="ads-creatives" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">All Ads</h2>
              <div style="display: flex; gap: 12px;">
                <input type="text" id="adSearch" placeholder="Search ads..." style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;" oninput="filterAds()">
                <button onclick="fixAllCampaigns()" style="padding: 8px 16px; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;">Fix All Campaigns</button>
                <button onclick="fixWalletDeductions()" style="padding: 8px 16px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;">Refund Upfront Charges</button>
              </div>
            </div>
            <div class="filters">
              <button class="filter-btn active" data-action="ad-filter" data-filter="all">All</button>
              <button class="filter-btn" data-action="ad-filter" data-filter="APPROVED">Approved</button>
              <button class="filter-btn" data-action="ad-filter" data-filter="PENDING_REVIEW">Pending Review</button>
              <button class="filter-btn" data-action="ad-filter" data-filter="REJECTED">Rejected</button>
              <button class="filter-btn" data-action="ad-filter" data-filter="ACTIVE">Active</button>
            </div>
            <div class="table-container" id="adsTable">
              <div class="loading">Loading ads...</div>
            </div>
          </div>
        </div>
        
        <!-- Analytics Tab -->
        <div class="tab-content" id="ads-analytics" style="display: none;">
          <div class="stats-grid" id="adsAnalyticsStats">
            <div class="loading">Loading analytics...</div>
          </div>
          
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h2 class="card-title">Performance by Net Worth Tier</h2>
            </div>
            <div id="adsTierPerformance" style="padding: 16px;">
              <div class="loading">Loading tier data...</div>
            </div>
          </div>
          
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h2 class="card-title">Performance by Placement</h2>
            </div>
            <div id="adsPlacementPerformance" style="padding: 16px;">
              <div class="loading">Loading placement data...</div>
            </div>
          </div>
          
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h2 class="card-title">CTA Performance</h2>
              <span style="font-size: 13px; color: rgba(255,255,255,0.6);">Click-through by call-to-action type</span>
            </div>
            <div id="adsCtaPerformance" style="padding: 16px;">
              <div class="loading">Loading CTA data...</div>
            </div>
          </div>
          
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h2 class="card-title">Top Destination URLs</h2>
              <span style="font-size: 13px; color: rgba(255,255,255,0.6);">Most clicked external destinations</span>
            </div>
            <div id="adsDestinationUrls" style="padding: 16px;">
              <div class="loading">Loading destination data...</div>
            </div>
          </div>
        </div>
        
        <!-- Settings Tab -->
        <div class="tab-content" id="ads-settings" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Platform Settings</h2>
            </div>
            <div style="padding: 24px;">
              <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Minimum CPM (cents)</label>
                <input type="number" id="adsMinCpm" value="100" style="width: 200px; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
              </div>
              <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Minimum CPC (cents)</label>
                <input type="number" id="adsMinCpc" value="50" style="width: 200px; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
              </div>
              <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">Default Ad Frequency (posts between ads)</label>
                <input type="number" id="adsFrequency" value="5" min="1" max="20" style="width: 200px; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
              </div>
              <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                  <input type="checkbox" id="adsAutoApprove" style="width: 20px; height: 20px;">
                  <span>Auto-approve ads from verified advertisers</span>
                </label>
              </div>
              <div class="form-group" style="margin-bottom: 20px;">
                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                  <input type="checkbox" id="adsEnabled" checked style="width: 20px; height: 20px;">
                  <span>Enable ad delivery platform-wide</span>
                </label>
              </div>
              <button class="action-btn action-btn-primary" onclick="saveAdsSettings()">Save Settings</button>
            </div>
          </div>
          
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h2 class="card-title">Net Worth Tier Multipliers</h2>
            </div>
            <div style="padding: 24px;">
              <p style="color: rgba(255,255,255,0.6); margin-bottom: 16px;">Higher-tier users see higher-value ads. Configure bid multipliers by tier:</p>
              <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px;">
                <div>
                  <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #9CA3AF;">Building</label>
                  <input type="number" id="tierMultBuilding" value="1.0" step="0.1" min="0.1" max="5" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #C0C0C0;">Silver</label>
                  <input type="number" id="tierMultSilver" value="1.5" step="0.1" min="0.1" max="5" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #FFD700;">Gold</label>
                  <input type="number" id="tierMultGold" value="2.0" step="0.1" min="0.1" max="5" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #E5E4E2;">Platinum</label>
                  <input type="number" id="tierMultPlatinum" value="3.0" step="0.1" min="0.1" max="5" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
                </div>
                <div>
                  <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #B9F2FF;">Diamond</label>
                  <input type="number" id="tierMultDiamond" value="5.0" step="0.1" min="0.1" max="5" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
                </div>
              </div>
              <button class="action-btn action-btn-primary" style="margin-top: 16px;" onclick="saveTierMultipliers()">Save Multipliers</button>
            </div>
          </div>
        </div>
        
        <!-- Health Tab -->
        <div class="tab-content" id="ads-health" style="display: none;">
          <div class="stats-grid" id="adsHealthStats">
            <div class="stat-card stat-card-warning">
              <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
              <div class="stat-value" id="zeroDeliveryCount">-</div>
              <div class="stat-label">Zero Delivery (24h+)</div>
            </div>
            <div class="stat-card stat-card-info">
              <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
              <div class="stat-value" id="lowDeliveryCount">-</div>
              <div class="stat-label">Low Delivery (&lt;10%)</div>
            </div>
            <div class="stat-card stat-card-success">
              <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
              <div class="stat-value" id="healthyDeliveryCount">-</div>
              <div class="stat-label">Healthy Campaigns</div>
            </div>
          </div>
          
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h2 class="card-title">Zero Delivery Campaigns (Needs Attention)</h2>
              <button class="action-btn action-btn-primary" onclick="loadAdsHealth()">Refresh</button>
            </div>
            <div class="table-container" id="zeroDeliveryTable">
              <div class="loading">Loading health data...</div>
            </div>
          </div>
          
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h2 class="card-title">Low Delivery Campaigns</h2>
            </div>
            <div class="table-container" id="lowDeliveryTable">
              <div class="loading">Loading...</div>
            </div>
          </div>
        </div>
        
        <!-- Disputes Tab -->
        <div class="tab-content" id="ads-disputes" style="display: none;">
          <div class="stats-grid" id="disputeStats">
            <div class="stat-card stat-card-warning">
              <div class="stat-icon"><i class="fas fa-exclamation-circle"></i></div>
              <div class="stat-value" id="disputePendingCount">-</div>
              <div class="stat-label">Pending</div>
            </div>
            <div class="stat-card stat-card-info">
              <div class="stat-icon"><i class="fas fa-search"></i></div>
              <div class="stat-value" id="disputeReviewCount">-</div>
              <div class="stat-label">Under Review</div>
            </div>
            <div class="stat-card stat-card-success">
              <div class="stat-icon"><i class="fas fa-check"></i></div>
              <div class="stat-value" id="disputeResolvedCount">-</div>
              <div class="stat-label">Resolved</div>
            </div>
          </div>
          
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h2 class="card-title">Dispute Queue</h2>
              <div style="display: flex; gap: 12px;">
                <select id="disputeStatusFilter" onchange="filterDisputes()" style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
                  <option value="all">All</option>
                  <option value="PENDING">Pending</option>
                  <option value="UNDER_REVIEW">Under Review</option>
                  <option value="RESOLVED_APPROVED">Approved</option>
                  <option value="RESOLVED_DENIED">Denied</option>
                </select>
                <button class="action-btn action-btn-secondary" onclick="loadAdDisputes()">Refresh</button>
              </div>
            </div>
            <div class="table-container" id="disputesTable">
              <div class="loading">Loading disputes...</div>
            </div>
          </div>
        </div>
        
        <!-- Emergency Tab -->
        <div class="tab-content" id="ads-emergency" style="display: none;">
          <div class="card" style="border: 2px solid #ef4444;">
            <div class="card-header" style="background: linear-gradient(135deg, #7f1d1d, #991b1b);">
              <h2 class="card-title" style="color: #fff;">Emergency Controls</h2>
              <span style="color: #fca5a5; font-size: 13px;">Use with caution - affects all advertisers</span>
            </div>
            <div style="padding: 24px;">
              <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                <button class="action-btn" style="background: linear-gradient(135deg, #ef4444, #dc2626); padding: 16px 32px; font-size: 16px;" onclick="emergencyPauseAllAds()">
                  <i class="fas fa-pause-circle" style="margin-right: 8px;"></i>
                  PAUSE ALL ADS
                </button>
                <button class="action-btn" style="background: linear-gradient(135deg, #10b981, #059669); padding: 16px 32px; font-size: 16px;" onclick="emergencyResumeAllAds()">
                  <i class="fas fa-play-circle" style="margin-right: 8px;"></i>
                  RESUME EMERGENCY PAUSED
                </button>
                <button class="action-btn action-btn-secondary" style="padding: 16px 32px; font-size: 16px;" onclick="expireEndedCampaigns()">
                  <i class="fas fa-clock" style="margin-right: 8px;"></i>
                  Expire Ended Campaigns
                </button>
              </div>
              <p style="color: rgba(255,255,255,0.6); margin-top: 16px; font-size: 13px;">
                <strong>PAUSE ALL ADS:</strong> Immediately stops all ad delivery platform-wide. Use for fraud emergencies.<br>
                <strong>RESUME EMERGENCY PAUSED:</strong> Resumes only campaigns that were paused by emergency action.<br>
                <strong>Expire Ended Campaigns:</strong> Manually trigger end-date check to close expired campaigns.
              </p>
            </div>
          </div>
          
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h2 class="card-title">Platform Revenue</h2>
              <button class="action-btn action-btn-secondary" onclick="loadPlatformRevenue()">Refresh</button>
            </div>
            <div class="stats-grid" id="platformRevenueStats" style="padding: 16px;">
              <div class="loading">Loading revenue data...</div>
            </div>
            <div id="revenueChart" style="height: 200px; padding: 16px;">
              <div class="loading">Loading chart...</div>
            </div>
          </div>
          
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h2 class="card-title">Recent Refunds</h2>
            </div>
            <div class="table-container" id="refundsTable">
              <div class="loading">Loading refunds...</div>
            </div>
          </div>
        </div>
      </section>
      
      <section class="content-section" id="section-contentvelocity">
        <div class="page-header">
          <div>
            <h1 class="page-title">Content Velocity</h1>
            <p class="page-subtitle">Monitor trending and viral content in real-time</p>
          </div>
        </div>
        
        <div class="stats-grid" id="velocityStats">
          <div class="loading">Loading velocity stats...</div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">Trending Posts</h2>
            <div class="filters" style="margin: 0;">
              <button class="filter-btn active" data-action="velocity-timeframe" data-timeframe="1h">1 Hour</button>
              <button class="filter-btn" data-action="velocity-timeframe" data-timeframe="6h">6 Hours</button>
              <button class="filter-btn" data-action="velocity-timeframe" data-timeframe="24h">24 Hours</button>
              <button class="filter-btn" data-action="velocity-timeframe" data-timeframe="7d">7 Days</button>
            </div>
          </div>
          <div class="table-container" id="trendingPostsTable">
            <div class="loading">Loading trending posts...</div>
          </div>
          <div id="trendingPagination" style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;"></div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 24px;">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Top Hashtags Today</h2>
            </div>
            <div id="topHashtagsList">
              <div class="loading">Loading hashtags...</div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Daily Trend Summary</h2>
            </div>
            <div id="dailyTrendsSummary">
              <div class="loading">Loading trends...</div>
            </div>
          </div>
        </div>
      </section>

      <section class="content-section" id="section-locations">
        <div class="page-header">
          <div>
            <h1 class="page-title">Locations</h1>
            <p class="page-subtitle">Manage venues, check-ins, and user locations</p>
          </div>
          <button class="action-btn action-btn-primary" data-action="add-venue" style="padding: 10px 20px;">Add Venue</button>
        </div>
        
        <div class="stats-grid" id="locationStats">
          <div class="stat-card">
            <h3>Total Venues</h3>
            <div class="value" id="statTotalVenues">0</div>
          </div>
          <div class="stat-card">
            <h3>Verified Venues</h3>
            <div class="value" id="statVerifiedVenues">0</div>
          </div>
          <div class="stat-card">
            <h3>Total Check-ins</h3>
            <div class="value" id="statTotalCheckIns">0</div>
          </div>
          <div class="stat-card">
            <h3>Active Locations</h3>
            <div class="value" id="statActiveLocations">0</div>
          </div>
        </div>
        
        <div class="filters" id="locationTabs">
          <button class="filter-btn active" data-action="location-tab" data-tab="venues">Venues</button>
          <button class="filter-btn" data-action="location-tab" data-tab="checkins">Check-ins</button>
        </div>

        <div id="venuesTab">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Venues</h2>
              <div style="display: flex; gap: 12px; align-items: center;">
                <div class="search-box" style="width: 250px;">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                  <input type="text" id="venueSearch" placeholder="Search venues..." oninput="loadVenues()">
                </div>
                <label style="display: flex; align-items: center; gap: 8px; color: rgba(255,255,255,0.7); font-size: 14px; cursor: pointer;">
                  <input type="checkbox" id="verifiedOnlyFilter" onchange="loadVenues()" style="width: 16px; height: 16px;">
                  Verified only
                </label>
              </div>
            </div>
            <div class="table-container" id="venuesTable">
              <div class="loading">Loading venues...</div>
            </div>
            <div id="venuesPagination" style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;"></div>
          </div>
        </div>

        <div id="checkinsTab" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Check-ins</h2>
            </div>
            <div class="table-container" id="checkinsTable">
              <div class="loading">Loading check-ins...</div>
            </div>
            <div id="checkinsPagination" style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;"></div>
          </div>
        </div>
      </section>

      <section class="content-section" id="section-developerapi">
        <div class="page-header">
          <div>
            <h1 class="page-title">Developer API</h1>
            <p class="page-subtitle">Manage webhooks, API tokens, and delivery logs</p>
          </div>
        </div>
        
        <div class="stats-grid" id="developerAPIStats">
          <div class="stat-card">
            <h3>Total Webhooks</h3>
            <div class="value" id="statTotalWebhooks">0</div>
          </div>
          <div class="stat-card">
            <h3>Active Webhooks</h3>
            <div class="value" id="statActiveWebhooks">0</div>
          </div>
          <div class="stat-card">
            <h3>Access Tokens</h3>
            <div class="value" id="statTotalAPITokens">0</div>
          </div>
          <div class="stat-card">
            <h3>Total Deliveries</h3>
            <div class="value" id="statTotalDeliveries">0</div>
          </div>
          <div class="stat-card">
            <h3>Failed Deliveries</h3>
            <div class="value" id="statFailedDeliveries">0</div>
          </div>
        </div>
        
        <div class="tabs-container" id="developerAPITabs" style="margin-bottom: 20px;">
          <button class="tab-btn active" data-action="developer-tab" data-tab="webhooks">Webhooks</button>
          <button class="tab-btn" data-action="developer-tab" data-tab="deliveries">Deliveries</button>
          <button class="tab-btn" data-action="developer-tab" data-tab="tokens">Access Tokens</button>
        </div>

        <div id="developerWebhooksContent" class="developer-tab-content">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Webhooks</h2>
              <div class="search-box" style="width: 300px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                <input type="text" id="webhookSearch" placeholder="Search webhooks..." oninput="loadDeveloperWebhooks()">
              </div>
            </div>
            <div class="table-container" id="developerWebhooksTable">
              <div class="loading">Loading webhooks...</div>
            </div>
            <div id="developerWebhooksPagination" style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;"></div>
          </div>
        </div>

        <div id="developerDeliveriesContent" class="developer-tab-content" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Webhook Deliveries</h2>
              <div class="filters" style="margin: 0;">
                <button class="filter-btn active" data-action="delivery-filter" data-filter="all">All</button>
                <button class="filter-btn" data-action="delivery-filter" data-filter="success">Success</button>
                <button class="filter-btn" data-action="delivery-filter" data-filter="failed">Failed</button>
              </div>
            </div>
            <div class="table-container" id="developerDeliveriesTable">
              <div class="loading">Loading deliveries...</div>
            </div>
            <div id="developerDeliveriesPagination" style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;"></div>
          </div>
        </div>

        <div id="developerTokensContent" class="developer-tab-content" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">API Access Tokens</h2>
              <div class="search-box" style="width: 300px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                <input type="text" id="tokenSearch" placeholder="Search tokens..." oninput="loadDeveloperTokens()">
              </div>
            </div>
            <div class="table-container" id="developerTokensTable">
              <div class="loading">Loading access tokens...</div>
            </div>
            <div id="developerTokensPagination" style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;"></div>
          </div>
        </div>
      </section>

      <section class="content-section" id="section-arfilters">
        <div class="page-header">
          <div>
            <h1 class="page-title">AR Filters</h1>
            <p class="page-subtitle">Manage augmented reality filters for stories and posts</p>
          </div>
          <button class="action-btn action-btn-primary" data-action="add-arfilter" style="padding: 10px 20px;">Add Filter</button>
        </div>
        
        <div class="stats-grid" id="arfilterStats">
          <div class="stat-card">
            <h3>Total Filters</h3>
            <div class="value" id="statTotalARFilters">0</div>
          </div>
          <div class="stat-card">
            <h3>Active Filters</h3>
            <div class="value" id="statActiveARFilters">0</div>
          </div>
          <div class="stat-card">
            <h3>Featured</h3>
            <div class="value" id="statFeaturedARFilters">0</div>
          </div>
          <div class="stat-card">
            <h3>Total Usage</h3>
            <div class="value" id="statTotalARUsage">0</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">All AR Filters</h2>
            <div style="display: flex; gap: 12px; align-items: center;">
              <div class="search-box" style="width: 250px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                <input type="text" id="arfilterSearch" placeholder="Search filters..." oninput="loadARFilters()">
              </div>
              <label style="display: flex; align-items: center; gap: 8px; color: rgba(255,255,255,0.7); font-size: 14px; cursor: pointer;">
                <input type="checkbox" id="featuredOnlyARFilter" onchange="loadARFilters()" style="width: 16px; height: 16px;">
                Featured only
              </label>
            </div>
          </div>
          <div class="table-container" id="arfiltersTable">
            <div class="loading">Loading AR filters...</div>
          </div>
          <div id="arfiltersPagination" style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;"></div>
        </div>
      </section>

      <section class="content-section" id="section-aicontent">
        <div class="page-header">
          <div>
            <h1 class="page-title">AI Content</h1>
            <p class="page-subtitle">Manage AI-generated avatars and translations</p>
          </div>
        </div>
        
        <div class="stats-grid" id="aiContentStats">
          <div class="stat-card">
            <h3>Total Avatars</h3>
            <div class="value" id="statTotalAIAvatars">0</div>
          </div>
          <div class="stat-card">
            <h3>Total Translations</h3>
            <div class="value" id="statTotalAITranslations">0</div>
          </div>
          <div class="stat-card">
            <h3>Pending Review</h3>
            <div class="value" id="statAIPendingReview">0</div>
          </div>
          <div class="stat-card">
            <h3>Flagged Content</h3>
            <div class="value" id="statAIFlagged">0</div>
          </div>
        </div>

        <div class="tabs-container" id="aiContentTabs" style="margin-bottom: 20px;">
          <button class="tab-btn active" data-action="ai-content-tab" data-tab="avatars">AI Avatars</button>
          <button class="tab-btn" data-action="ai-content-tab" data-tab="translations">Translations</button>
        </div>

        <div id="aiAvatarsContent" class="tab-content">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">AI Avatars</h2>
              <div class="filters" style="margin: 0;">
                <button class="filter-btn active" data-action="ai-avatar-filter" data-filter="all">All</button>
                <button class="filter-btn" data-action="ai-avatar-filter" data-filter="active">Active</button>
                <button class="filter-btn" data-action="ai-avatar-filter" data-filter="inactive">Inactive</button>
              </div>
            </div>
            <div class="table-container" id="aiAvatarsTable">
              <div class="loading">Loading AI avatars...</div>
            </div>
            <div id="aiAvatarsPagination" style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;"></div>
          </div>
        </div>

        <div id="aiTranslationsContent" class="tab-content" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">AI Translations</h2>
            </div>
            <div class="table-container" id="aiTranslationsTable">
              <div class="loading">Loading translations...</div>
            </div>
            <div id="aiTranslationsPagination" style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;"></div>
          </div>
        </div>
      </section>

      <section class="content-section" id="section-dataprivacy">
        <div class="page-header">
          <div>
            <h1 class="page-title">Data Privacy</h1>
            <p class="page-subtitle">Manage user data export requests, backups, and imports</p>
          </div>
        </div>
        
        <div class="stats-grid" id="dataPrivacyStats">
          <div class="stat-card">
            <h3>Total Export Requests</h3>
            <div class="value" id="statTotalExportRequests">0</div>
          </div>
          <div class="stat-card">
            <h3>Pending Exports</h3>
            <div class="value" id="statPendingExports">0</div>
          </div>
          <div class="stat-card">
            <h3>Completed Exports</h3>
            <div class="value" id="statCompletedExports">0</div>
          </div>
          <div class="stat-card">
            <h3>Total Backups</h3>
            <div class="value" id="statTotalBackups">0</div>
          </div>
          <div class="stat-card">
            <h3>Total Imports</h3>
            <div class="value" id="statTotalImports">0</div>
          </div>
        </div>

        <div class="tabs-container" id="dataPrivacyTabs" style="margin-bottom: 20px;">
          <button class="tab-btn active" data-action="privacy-tab" data-tab="exports">Export Requests</button>
          <button class="tab-btn" data-action="privacy-tab" data-tab="backups">Backups</button>
          <button class="tab-btn" data-action="privacy-tab" data-tab="imports">Imports</button>
        </div>

        <div id="privacyExportsContent" class="privacy-tab-content">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Export Requests</h2>
              <div class="filters" style="margin: 0;">
                <button class="filter-btn active" data-action="export-filter" data-filter="all">All</button>
                <button class="filter-btn" data-action="export-filter" data-filter="PENDING">Pending</button>
                <button class="filter-btn" data-action="export-filter" data-filter="PROCESSING">Processing</button>
                <button class="filter-btn" data-action="export-filter" data-filter="COMPLETED">Completed</button>
                <button class="filter-btn" data-action="export-filter" data-filter="FAILED">Failed</button>
              </div>
            </div>
            <div class="table-container" id="exportRequestsTable">
              <div class="loading">Loading export requests...</div>
            </div>
            <div id="exportRequestsPagination" style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;"></div>
          </div>
        </div>

        <div id="privacyBackupsContent" class="privacy-tab-content" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Account Backups</h2>
            </div>
            <div class="table-container" id="accountBackupsTable">
              <div class="loading">Loading backups...</div>
            </div>
            <div id="accountBackupsPagination" style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;"></div>
          </div>
        </div>

        <div id="privacyImportsContent" class="privacy-tab-content" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Platform Imports</h2>
            </div>
            <div class="table-container" id="platformImportsTable">
              <div class="loading">Loading imports...</div>
            </div>
            <div id="platformImportsPagination" style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;"></div>
          </div>
        </div>
      </section>

      <section class="content-section" id="section-platformsettings">
        <div class="page-header">
          <div>
            <h1 class="page-title">Platform Settings</h1>
            <p class="page-subtitle">Configure content moderation, app settings, and notification defaults</p>
          </div>
        </div>
        
        <div class="tabs-container" id="platformSettingsTabs" style="margin-bottom: 20px;">
          <button class="tab-btn active" data-action="platform-settings-tab" data-tab="word-filters">Word Filters</button>
          <button class="tab-btn" data-action="platform-settings-tab" data-tab="keyword-filters">Keyword Filters</button>
          <button class="tab-btn" data-action="platform-settings-tab" data-tab="app-settings">App Settings</button>
          <button class="tab-btn" data-action="platform-settings-tab" data-tab="notifications">Notifications</button>
        </div>

        <div id="platformWordFiltersContent" class="platform-settings-tab-content">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Word Filters</h2>
              <button class="action-btn action-btn-primary" data-action="add-word-filter" style="padding: 8px 16px;">Add Word Filter</button>
            </div>
            <p style="padding: 0 20px; color: rgba(255,255,255,0.6); font-size: 13px; margin-bottom: 16px;">
              Block, replace, or flag specific words in user-generated content.
            </p>
            <div class="table-container" id="wordFiltersTable">
              <div class="loading">Loading word filters...</div>
            </div>
            <div id="wordFiltersPagination" style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;"></div>
          </div>
        </div>

        <div id="platformKeywordFiltersContent" class="platform-settings-tab-content" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Keyword Filters</h2>
              <button class="action-btn action-btn-primary" data-action="add-keyword-filter" style="padding: 8px 16px;">Add Keyword Filter</button>
            </div>
            <p style="padding: 0 20px; color: rgba(255,255,255,0.6); font-size: 13px; margin-bottom: 16px;">
              Configure keyword-based content moderation for different areas of the platform.
            </p>
            <div class="table-container" id="keywordFiltersTable">
              <div class="loading">Loading keyword filters...</div>
            </div>
            <div id="keywordFiltersPagination" style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;"></div>
          </div>
        </div>

        <div id="platformAppSettingsContent" class="platform-settings-tab-content" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">App Settings</h2>
              <button class="action-btn action-btn-primary" data-action="add-app-setting" style="padding: 8px 16px;">Add Setting</button>
            </div>
            <p style="padding: 0 20px; color: rgba(255,255,255,0.6); font-size: 13px; margin-bottom: 16px;">
              Configure global application settings and feature flags.
            </p>
            <div id="appSettingsList" style="padding: 0 20px 20px 20px;">
              <div class="loading">Loading app settings...</div>
            </div>
          </div>
        </div>

        <div id="platformNotificationsContent" class="platform-settings-tab-content" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Notification Defaults</h2>
              <button class="action-btn action-btn-primary" data-action="add-notification-default" style="padding: 8px 16px;">Add Notification Type</button>
            </div>
            <p style="padding: 0 20px; color: rgba(255,255,255,0.6); font-size: 13px; margin-bottom: 16px;">
              Control which notifications are enabled by default for new users.
            </p>
            <div id="notificationDefaultsList" style="padding: 0 20px 20px 20px;">
              <div class="loading">Loading notification defaults...</div>
            </div>
          </div>
        </div>
      </section>

      <section class="content-section" id="section-explorecategories">
        <div class="page-header">
          <div>
            <h1 class="page-title">Explore Categories</h1>
            <p class="page-subtitle">Manage categories for the Explore page</p>
          </div>
          <button class="action-btn action-btn-primary" data-action="add-explore-category" style="padding: 10px 20px;">Add Category</button>
        </div>
        
        <div class="stats-grid" id="exploreCategoryStats">
          <div class="stat-card">
            <h3>Total Categories</h3>
            <div class="value" id="statTotalExploreCategories">0</div>
          </div>
          <div class="stat-card">
            <h3>Active Categories</h3>
            <div class="value" id="statActiveExploreCategories">0</div>
          </div>
          <div class="stat-card">
            <h3>Featured (Top 5)</h3>
            <div class="value" id="statFeaturedExploreCategories">0</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">All Categories</h2>
            <p style="font-size: 12px; color: rgba(255,255,255,0.5);">Drag rows to reorder categories</p>
          </div>
          <div class="table-container" id="exploreCategoriesTable">
            <div class="loading">Loading categories...</div>
          </div>
        </div>
      </section>

      <section class="content-section" id="section-economy">
        <div class="page-header">
          <div>
            <h1 class="page-title">Economy Dashboard</h1>
            <p class="page-subtitle">Manage platform economy, wealth clubs, and emergency controls</p>
          </div>
        </div>
        
        <div class="tabs-container" id="economyTabs" style="margin-bottom: 20px;">
          <button class="tab-btn active" data-action="economy-tab" data-tab="economy-overview" onclick="window.switchEconomyTab('economy-overview')">Overview</button>
          <button class="tab-btn" data-action="economy-tab" data-tab="economy-emergency" onclick="window.switchEconomyTab('economy-emergency')">Emergency Controls</button>
          <button class="tab-btn" data-action="economy-tab" data-tab="economy-wealthclubs" onclick="window.switchEconomyTab('economy-wealthclubs')">Wealth Clubs</button>
          <button class="tab-btn" data-action="economy-tab" data-tab="economy-battles" onclick="window.switchEconomyTab('economy-battles')">Platform Battles</button>
        </div>

        <div id="economyOverviewContent" class="economy-tab-content">
          <div class="stats-grid" id="economyOverviewStats">
            <div class="stat-card">
              <h3>Total Coins in Circulation</h3>
              <div class="value" id="statTotalCoins" style="font-size: 28px; font-weight: 700; color: #8B5CF6;">0</div>
            </div>
            <div class="stat-card">
              <h3>Total Coins Purchased</h3>
              <div class="value" id="statCoinsPurchased" style="font-size: 28px; font-weight: 700; color: #10B981;">0</div>
              <div class="stat-subtitle" id="statCoinsPurchasedValue" style="font-size: 12px; color: rgba(255,255,255,0.5);">R0</div>
            </div>
            <div class="stat-card">
              <h3>Total Coins Withdrawn</h3>
              <div class="value" id="statCoinsWithdrawn" style="font-size: 28px; font-weight: 700; color: #F59E0B;">0</div>
              <div class="stat-subtitle" id="statCoinsWithdrawnValue" style="font-size: 12px; color: rgba(255,255,255,0.5);">R0</div>
            </div>
            <div class="stat-card">
              <h3>Platform Revenue</h3>
              <div class="value" id="statPlatformRevenue" style="font-size: 28px; font-weight: 700; color: #EC4899;">R0</div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Active Staking Pools</h2>
              </div>
              <div id="economyStakingPools" style="padding: 0 20px 20px;">
                <div class="loading">Loading staking pools...</div>
              </div>
            </div>
            <div class="card">
              <div class="card-header">
                <h2 class="card-title">Economy Configuration</h2>
              </div>
              <div id="economyConfigDisplay" style="padding: 0 20px 20px;">
                <div class="loading">Loading config...</div>
              </div>
            </div>
          </div>
        </div>

        <div id="economyEmergencyContent" class="economy-tab-content" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Emergency Controls</h2>
              <span style="font-size: 12px; color: rgba(255,255,255,0.5);">Toggle economy features on/off instantly</span>
            </div>
            <div style="padding: 20px;">
              <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                <p style="color: #FCA5A5; font-size: 14px; margin: 0;">
                  <strong>Warning:</strong> Disabling features will immediately affect all users. Use with caution.
                </p>
              </div>
              
              <div class="settings-grid" id="emergencyControlsGrid">
                <div class="setting-item">
                  <div class="setting-info">
                    <h4>Withdrawals</h4>
                    <p>Allow users to withdraw coins to bank accounts</p>
                  </div>
                  <div class="toggle" id="toggle-withdrawals_enabled" data-key="withdrawals_enabled" onclick="toggleEconomyFeature('withdrawals_enabled')"></div>
                </div>
                <div class="setting-item">
                  <div class="setting-info">
                    <h4>Purchases</h4>
                    <p>Allow users to purchase coins with real money</p>
                  </div>
                  <div class="toggle" id="toggle-purchases_enabled" data-key="purchases_enabled" onclick="toggleEconomyFeature('purchases_enabled')"></div>
                </div>
                <div class="setting-item">
                  <div class="setting-info">
                    <h4>Gifts</h4>
                    <p>Allow users to send gifts to each other</p>
                  </div>
                  <div class="toggle" id="toggle-gifts_enabled" data-key="gifts_enabled" onclick="toggleEconomyFeature('gifts_enabled')"></div>
                </div>
                <div class="setting-item">
                  <div class="setting-info">
                    <h4>Staking</h4>
                    <p>Allow users to stake coins for rewards</p>
                  </div>
                  <div class="toggle" id="toggle-staking_enabled" data-key="staking_enabled" onclick="toggleEconomyFeature('staking_enabled')"></div>
                </div>
                <div class="setting-item">
                  <div class="setting-info">
                    <h4>Battles</h4>
                    <p>Allow platform gift battles</p>
                  </div>
                  <div class="toggle" id="toggle-battles_enabled" data-key="battles_enabled" onclick="toggleEconomyFeature('battles_enabled')"></div>
                </div>
                <div class="setting-item">
                  <div class="setting-info">
                    <h4>Daily Rewards</h4>
                    <p>Allow users to claim daily coin rewards</p>
                  </div>
                  <div class="toggle" id="toggle-daily_rewards_enabled" data-key="daily_rewards_enabled" onclick="toggleEconomyFeature('daily_rewards_enabled')"></div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card" style="margin-top: 24px;">
            <div class="card-header">
              <h2 class="card-title">Economy Rates</h2>
            </div>
            <div style="padding: 20px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="form-group">
                  <label>Coin to Rand Rate (1 coin = R)</label>
                  <input type="number" step="0.01" id="economyRateCoinToRand" value="0.10" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
                </div>
                <div class="form-group">
                  <label>Platform Fee % (on withdrawals)</label>
                  <input type="number" step="1" id="economyRatePlatformFee" value="10" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
                </div>
                <div class="form-group">
                  <label>Minimum Withdrawal (coins)</label>
                  <input type="number" id="economyRateMinWithdraw" value="1000" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
                </div>
                <div class="form-group">
                  <label>Daily Reward Amount (coins)</label>
                  <input type="number" id="economyRateDailyReward" value="10" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
                </div>
              </div>
              <button class="action-btn action-btn-primary" onclick="saveEconomyRates()" style="margin-top: 16px; padding: 12px 24px;">Save Rates</button>
            </div>
          </div>
        </div>

        <div id="economyWealthClubsContent" class="economy-tab-content" style="display: none;">
          <div class="stats-grid" id="wealthClubStats">
            <div class="loading">Loading wealth club stats...</div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">Wealth Clubs</h2>
            </div>
            <div class="table-container" id="wealthClubsTable">
              <div class="loading">Loading wealth clubs...</div>
            </div>
          </div>
        </div>

        <div id="economyBattlesContent" class="economy-tab-content" style="display: none;">
          <div class="stats-grid" id="battlesStats">
            <div class="stat-card">
              <h3>Active Battles</h3>
              <div class="value" id="statActiveBattles" style="font-size: 28px; font-weight: 700; color: #8B5CF6;">0</div>
            </div>
            <div class="stat-card">
              <h3>Total Prize Pool</h3>
              <div class="value" id="statTotalPrizePool" style="font-size: 28px; font-weight: 700; color: #10B981;">0</div>
            </div>
            <div class="stat-card">
              <h3>Completed Battles</h3>
              <div class="value" id="statCompletedBattles" style="font-size: 28px; font-weight: 700; color: #F59E0B;">0</div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">All Battles</h2>
              <div class="filters">
                <button class="filter-btn active" data-action="battle-filter" data-filter="all">All</button>
                <button class="filter-btn" data-action="battle-filter" data-filter="ACTIVE">Active</button>
                <button class="filter-btn" data-action="battle-filter" data-filter="PENDING">Pending</button>
                <button class="filter-btn" data-action="battle-filter" data-filter="ENDED">Ended</button>
              </div>
            </div>
            <div class="table-container" id="battlesTable">
              <div class="loading">Loading battles...</div>
            </div>
          </div>
        </div>
      </section>

      <!-- ACHIEVEMENTS SECTION -->
      <section class="content-section" id="section-achievements">
        <div class="page-header">
          <div>
            <h1 class="page-title">Achievements Management</h1>
            <p class="page-subtitle">Create and manage gamification achievements</p>
          </div>
          <button class="btn btn-primary" onclick="window.openAchievementModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            Add Achievement
          </button>
        </div>
        
        <div class="stats-grid" id="achievementStats">
          <div class="stat-card">
            <div class="stat-value" id="totalAchievements">0</div>
            <div class="stat-label">Total Achievements</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="activeAchievements">0</div>
            <div class="stat-label">Active</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="achievementsAwarded">0</div>
            <div class="stat-label">Total Awarded</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="achievementCoinsAwarded">0</div>
            <div class="stat-label">Coins Awarded</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">All Achievements</h3>
            <div class="filter-group">
              <button class="filter-btn active" data-action="achievement-filter" data-filter="all">All</button>
              <button class="filter-btn" data-action="achievement-filter" data-filter="SHOPPING">Shopping</button>
              <button class="filter-btn" data-action="achievement-filter" data-filter="GIFTING">Gifting</button>
              <button class="filter-btn" data-action="achievement-filter" data-filter="WEALTH">Wealth</button>
              <button class="filter-btn" data-action="achievement-filter" data-filter="CONTENT">Content</button>
              <button class="filter-btn" data-action="achievement-filter" data-filter="SOCIAL">Social</button>
            </div>
          </div>
          <div class="table-container" id="achievementsTable">
            <div class="loading">Loading achievements...</div>
          </div>
        </div>
      </section>

      <!-- KYC & WITHDRAWALS SECTION -->
      <section class="content-section" id="section-kycwithdrawals">
        <div class="page-header">
          <div>
            <h1 class="page-title">KYC & Withdrawals</h1>
            <p class="page-subtitle">Manage identity verification and withdrawal requests</p>
          </div>
        </div>
        
        <div class="tabs-container" style="margin-bottom: 20px;">
          <button class="tab-btn active" data-action="kyc-tab" data-tab="kyc-pending" onclick="window.switchKycTab('kyc-pending')">Pending KYC</button>
          <button class="tab-btn" data-action="kyc-tab" data-tab="kyc-all" onclick="window.switchKycTab('kyc-all')">All KYC</button>
          <button class="tab-btn" data-action="kyc-tab" data-tab="withdrawals-pending" onclick="window.switchKycTab('withdrawals-pending')">Pending Withdrawals</button>
          <button class="tab-btn" data-action="kyc-tab" data-tab="withdrawals-all" onclick="window.switchKycTab('withdrawals-all')">All Withdrawals</button>
        </div>

        <div id="kycPendingContent" class="kyc-tab-content">
          <div class="stats-grid" id="kycStats">
            <div class="stat-card">
              <div class="stat-value" id="pendingKycCount">0</div>
              <div class="stat-label">Pending Review</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="approvedKycCount">0</div>
              <div class="stat-label">Approved</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="rejectedKycCount">0</div>
              <div class="stat-label">Rejected</div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Pending KYC Applications</h3>
            </div>
            <div class="table-container" id="pendingKycTable">
              <div class="loading">Loading KYC applications...</div>
            </div>
          </div>
        </div>

        <div id="kycAllContent" class="kyc-tab-content" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">All KYC Applications</h3>
              <div class="filter-group">
                <button class="filter-btn active" data-action="kyc-status-filter" data-filter="all">All</button>
                <button class="filter-btn" data-action="kyc-status-filter" data-filter="PENDING">Pending</button>
                <button class="filter-btn" data-action="kyc-status-filter" data-filter="APPROVED">Approved</button>
                <button class="filter-btn" data-action="kyc-status-filter" data-filter="REJECTED">Rejected</button>
              </div>
            </div>
            <div class="table-container" id="allKycTable">
              <div class="loading">Loading KYC applications...</div>
            </div>
          </div>
        </div>

        <div id="withdrawalsPendingContent" class="kyc-tab-content" style="display: none;">
          <div class="stats-grid" id="withdrawalStats">
            <div class="stat-card">
              <div class="stat-value" id="pendingWithdrawalsCount">0</div>
              <div class="stat-label">Pending</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="pendingWithdrawalsAmount">R0</div>
              <div class="stat-label">Pending Amount</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="todayWithdrawals">0</div>
              <div class="stat-label">Today</div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">Pending Withdrawal Requests</h3>
            </div>
            <div class="table-container" id="pendingWithdrawalsTable">
              <div class="loading">Loading withdrawal requests...</div>
            </div>
          </div>
        </div>

        <div id="withdrawalsAllContent" class="kyc-tab-content" style="display: none;">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">All Withdrawal Requests</h3>
              <div class="filter-group">
                <button class="filter-btn active" data-action="withdrawal-status-filter" data-filter="all">All</button>
                <button class="filter-btn" data-action="withdrawal-status-filter" data-filter="PENDING">Pending</button>
                <button class="filter-btn" data-action="withdrawal-status-filter" data-filter="APPROVED">Approved</button>
                <button class="filter-btn" data-action="withdrawal-status-filter" data-filter="PROCESSED">Processed</button>
                <button class="filter-btn" data-action="withdrawal-status-filter" data-filter="REJECTED">Rejected</button>
              </div>
            </div>
            <div class="table-container" id="allWithdrawalsTable">
              <div class="loading">Loading withdrawal requests...</div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Achievement Modal -->
  <div class="modal-overlay" id="achievementModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title" id="achievementModalTitle">Add Achievement</h2>
        <button class="modal-close" onclick="document.getElementById('achievementModal').classList.remove('active')">&times;</button>
      </div>
      <form id="achievementForm" onsubmit="window.saveAchievement(event)">
        <div class="modal-body" style="padding: 24px;">
          <input type="hidden" id="achievementId">
          <div class="form-group">
            <label>Name</label>
            <input type="text" id="achievementName" class="form-input" required placeholder="Achievement name">
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea id="achievementDescription" class="form-input" rows="2" placeholder="Achievement description"></textarea>
          </div>
          <div class="form-group">
            <label>Category</label>
            <select id="achievementCategory" class="form-select" required>
              <option value="SHOPPING">Shopping</option>
              <option value="GIFTING">Gifting</option>
              <option value="WEALTH">Wealth</option>
              <option value="CONTENT">Content</option>
              <option value="SOCIAL">Social</option>
            </select>
          </div>
          <div class="form-group">
            <label>Requirement</label>
            <input type="text" id="achievementRequirement" class="form-input" required placeholder="e.g. mall_purchases >= 10">
          </div>
          <div class="form-group">
            <label>Reward Coins</label>
            <input type="number" id="achievementRewardCoins" class="form-input" required min="0" placeholder="100">
          </div>
          <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
            <input type="checkbox" id="achievementIsSecret">
            <label for="achievementIsSecret" style="margin: 0;">Secret Achievement (hidden until unlocked)</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('achievementModal').classList.remove('active')">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Achievement</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal-overlay" id="aiAvatarReviewModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">Review AI Avatar</h2>
        <button class="modal-close" data-action="close-modal" data-modal="aiAvatarReviewModal">&times;</button>
      </div>
      <div class="modal-body" style="padding: 24px;">
        <input type="hidden" id="reviewAvatarId">
        <div id="reviewAvatarPreview" style="text-align: center; margin-bottom: 16px;"></div>
        <div class="form-group">
          <label>Avatar Name</label>
          <div id="reviewAvatarName" style="padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; color: #fff;"></div>
        </div>
        <div class="form-group">
          <label>User</label>
          <div id="reviewAvatarUser" style="padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; color: #fff;"></div>
        </div>
        <div class="form-group">
          <label>Rejection Reason (optional)</label>
          <textarea id="reviewAvatarReason" placeholder="Enter reason for rejection..." rows="3" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; resize: vertical;"></textarea>
        </div>
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="action-btn action-btn-danger" data-action="reject-ai-avatar" style="flex: 1;">Reject</button>
          <button class="action-btn action-btn-success" data-action="approve-ai-avatar" style="flex: 1;">Approve</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal-overlay" id="arfilterModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title" id="arfilterModalTitle">Add AR Filter</h2>
        <button class="modal-close" data-action="close-modal" data-modal="arfilterModal">&times;</button>
      </div>
      <div class="modal-body" style="padding: 24px;">
        <input type="hidden" id="arfilterEditId">
        <div class="form-group">
          <label>Filter Name *</label>
          <input type="text" id="arfilterNameInput" placeholder="Enter filter name" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="arfilterDescInput" placeholder="Enter description" rows="3" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; resize: vertical;"></textarea>
        </div>
        <div class="form-group">
          <label>Preview/Thumbnail URL *</label>
          <input type="text" id="arfilterPreviewInput" placeholder="https://example.com/preview.jpg" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
        </div>
        <div class="form-group">
          <label>Filter URL *</label>
          <input type="text" id="arfilterUrlInput" placeholder="https://example.com/filter.ar" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
        </div>
        <div class="form-group">
          <label>Category</label>
          <input type="text" id="arfilterCategoryInput" placeholder="e.g., Fun, Beauty, Animals" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
        </div>
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="action-btn action-btn-secondary" data-action="close-modal" data-modal="arfilterModal" style="flex: 1;">Cancel</button>
          <button class="action-btn action-btn-primary" data-action="save-arfilter" style="flex: 1;">Save Filter</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="addVenueModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">Add Venue</h2>
        <button class="modal-close" data-action="close-modal" data-modal="addVenueModal">&times;</button>
      </div>
      <div class="modal-body" style="padding: 24px;">
        <div class="form-group">
          <label>Venue Name *</label>
          <input type="text" id="venueNameInput" placeholder="Enter venue name" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
        </div>
        <div class="form-group">
          <label>Address *</label>
          <input type="text" id="venueAddressInput" placeholder="Enter address" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
        </div>
        <div class="form-group">
          <label>City</label>
          <input type="text" id="venueCityInput" placeholder="Enter city" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
        </div>
        <div class="form-group">
          <label>Country</label>
          <input type="text" id="venueCountryInput" placeholder="Enter country" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
        </div>
        <div class="form-group">
          <label>Category</label>
          <select id="venueCategoryInput" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
            <option value="">Select category</option>
            <option value="Restaurant">Restaurant</option>
            <option value="Bar">Bar</option>
            <option value="Club">Club</option>
            <option value="Cafe">Cafe</option>
            <option value="Hotel">Hotel</option>
            <option value="Mall">Mall</option>
            <option value="Park">Park</option>
            <option value="Gym">Gym</option>
            <option value="Office">Office</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div class="form-group">
            <label>Latitude *</label>
            <input type="number" step="any" id="venueLatInput" placeholder="e.g., -26.2041" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
          </div>
          <div class="form-group">
            <label>Longitude *</label>
            <input type="number" step="any" id="venueLngInput" placeholder="e.g., 28.0473" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
          </div>
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 16px;">
          <button class="action-btn" data-action="close-modal" data-modal="addVenueModal">Cancel</button>
          <button class="action-btn action-btn-primary" data-action="create-venue">Create Venue</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="editVenueModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">Edit Venue</h2>
        <button class="modal-close" data-action="close-modal" data-modal="editVenueModal">&times;</button>
      </div>
      <div class="modal-body" style="padding: 24px;">
        <input type="hidden" id="editVenueId">
        <div class="form-group">
          <label>Venue Name *</label>
          <input type="text" id="editVenueNameInput" placeholder="Enter venue name" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
        </div>
        <div class="form-group">
          <label>Address *</label>
          <input type="text" id="editVenueAddressInput" placeholder="Enter address" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
        </div>
        <div class="form-group">
          <label>City</label>
          <input type="text" id="editVenueCityInput" placeholder="Enter city" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
        </div>
        <div class="form-group">
          <label>Country</label>
          <input type="text" id="editVenueCountryInput" placeholder="Enter country" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
        </div>
        <div class="form-group">
          <label>Category</label>
          <select id="editVenueCategoryInput" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
            <option value="">Select category</option>
            <option value="Restaurant">Restaurant</option>
            <option value="Bar">Bar</option>
            <option value="Club">Club</option>
            <option value="Cafe">Cafe</option>
            <option value="Hotel">Hotel</option>
            <option value="Mall">Mall</option>
            <option value="Park">Park</option>
            <option value="Gym">Gym</option>
            <option value="Office">Office</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div class="form-group">
            <label>Latitude *</label>
            <input type="number" step="any" id="editVenueLatInput" placeholder="e.g., -26.2041" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
          </div>
          <div class="form-group">
            <label>Longitude *</label>
            <input type="number" step="any" id="editVenueLngInput" placeholder="e.g., 28.0473" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
          </div>
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 16px;">
          <button class="action-btn" data-action="close-modal" data-modal="editVenueModal">Cancel</button>
          <button class="action-btn action-btn-primary" data-action="update-venue">Update Venue</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal-overlay" id="portfolioModal">
    <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2 class="modal-title" id="portfolioModalTitle">User Portfolio</h2>
        <button class="modal-close" data-action="close-modal" data-modal="portfolioModal">&times;</button>
      </div>
      <div class="modal-body" style="padding: 24px;">
        <div id="portfolioUserInfo" style="margin-bottom: 24px; padding: 16px; background: rgba(139, 92, 246, 0.1); border-radius: 12px;">
        </div>
        
        <div style="display: flex; gap: 16px; margin-bottom: 24px;">
          <button class="action-btn action-btn-primary" data-action="show-add-item-modal">Add Item to Portfolio</button>
          <button class="action-btn" data-action="show-adjust-networth-modal">Adjust Net Worth Directly</button>
        </div>
        
        <h3 style="margin-bottom: 16px; font-size: 18px;">Portfolio Items</h3>
        <div id="portfolioItemsList">
          <div class="loading">Loading portfolio...</div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal-overlay" id="addItemModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title">Add Item to Portfolio</h2>
        <button class="modal-close" data-action="close-modal" data-modal="addItemModal">&times;</button>
      </div>
      <div class="modal-body" style="padding: 24px;">
        <input type="hidden" id="addItemUserId">
        <div class="form-group">
          <label>Select Product</label>
          <select id="addItemSelect" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
            <option value="">Loading products...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Quantity</label>
          <input type="number" id="addItemQuantity" value="1" min="1" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
        </div>
        <div id="addItemPreview" style="padding: 12px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; margin-bottom: 16px;">
          <span style="color: rgba(255,255,255,0.6);">Select a product to see value</span>
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
          <button class="action-btn" data-action="close-modal" data-modal="addItemModal">Cancel</button>
          <button class="action-btn action-btn-primary" data-action="confirm-add-item">Add to Portfolio</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="modal-overlay" id="adjustNetWorthModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h2 class="modal-title">Adjust Net Worth</h2>
        <button class="modal-close" data-action="close-modal" data-modal="adjustNetWorthModal">&times;</button>
      </div>
      <div class="modal-body" style="padding: 24px;">
        <input type="hidden" id="adjustUserId">
        <div id="adjustUserInfo" style="padding: 12px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; margin-bottom: 16px;"></div>
        <div class="form-group">
          <label>Amount (positive to add, negative to subtract)</label>
          <input type="number" id="adjustAmount" placeholder="e.g., 500000 or -100000" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
        </div>
        <div class="form-group">
          <label>Reason (optional)</label>
          <input type="text" id="adjustReason" placeholder="e.g., Bonus, Correction" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end;">
          <button class="action-btn" data-action="close-modal" data-modal="adjustNetWorthModal">Cancel</button>
          <button class="action-btn action-btn-primary" data-action="confirm-adjust-networth">Adjust</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="quickEditNetWorthModal">
    <div class="modal" style="max-width: 450px;">
      <div class="modal-header">
        <h2 class="modal-title">Edit User Net Worth</h2>
        <button class="modal-close" data-action="close-modal" data-modal="quickEditNetWorthModal">&times;</button>
      </div>
      <div class="modal-body" style="padding: 24px;">
        <input type="hidden" id="quickEditUserId">
        <div id="quickEditUserInfo" style="padding: 16px; background: rgba(139, 92, 246, 0.1); border-radius: 12px; margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div id="quickEditDisplayName" style="font-weight: 600; font-size: 16px;"></div>
              <div id="quickEditUsername" style="font-size: 13px; color: rgba(255,255,255,0.5);"></div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 12px; color: rgba(255,255,255,0.5);">Current Net Worth</div>
              <div id="quickEditCurrentValue" style="font-weight: 700; font-size: 18px; color: #22c55e;"></div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label style="font-weight: 500; margin-bottom: 8px; display: block;">New Net Worth (R)</label>
          <input type="number" id="quickEditNewNetWorth" min="0" placeholder="Enter new net worth value" style="width: 100%; padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: #fff; font-size: 16px;">
          <div style="margin-top: 8px; font-size: 12px; color: rgba(255,255,255,0.4);">Enter the total net worth value you want to set for this user</div>
        </div>
        <div class="form-group">
          <label style="font-weight: 500; margin-bottom: 8px; display: block;">Reason (optional)</label>
          <input type="text" id="quickEditReason" placeholder="e.g., Manual adjustment, Correction, Bonus" style="width: 100%; padding: 14px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: #fff;">
        </div>
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
          <button class="action-btn" data-action="close-modal" data-modal="quickEditNetWorthModal" style="padding: 12px 24px;">Cancel</button>
          <button class="action-btn action-btn-primary" data-action="confirm-quick-edit-networth" style="padding: 12px 24px;">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="userModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="userModalTitle">User Details</h2>
        <button class="modal-close" data-action="close-modal" data-modal="userModal">&times;</button>
      </div>
      <div id="userModalContent"></div>
    </div>
  </div>

  <div class="modal-overlay" id="actionModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="actionModalTitle">Confirm Action</h2>
        <button class="modal-close" data-action="close-modal" data-modal="actionModal">&times;</button>
      </div>
      <div id="actionModalContent"></div>
    </div>
  </div>

  <div class="modal-overlay" id="productModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title" id="productModalTitle">Add Product</h2>
        <button class="modal-close" onclick="closeModal('productModal')">&times;</button>
      </div>
      <div class="modal-body" style="padding: 24px;">
        <input type="hidden" id="productId">
        <div class="form-group">
          <label>Product Name</label>
          <input type="text" id="productName" placeholder="e.g., Rolex Submariner">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="productDescription" rows="3" placeholder="Product description..." style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; resize: vertical;"></textarea>
        </div>
        <div class="form-group">
          <label>Value (Rands)</label>
          <input type="number" id="productValue" placeholder="e.g., 150000">
        </div>
        <div class="form-group">
          <label>Category</label>
          <select id="productCategory" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
            <option value="">Select category...</option>
          </select>
        </div>
        <div class="form-group">
          <label>Image URL (optional)</label>
          <input type="text" id="productImageUrl" placeholder="https://...">
        </div>
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn" data-action="save-product" style="flex: 1;">Save Product</button>
          <button class="action-btn" data-action="close-modal" data-modal="productModal" style="flex: 1; padding: 14px;">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="categoryModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h2 class="modal-title" id="categoryModalTitle">Add Category</h2>
        <button class="modal-close" onclick="closeModal('categoryModal')">&times;</button>
      </div>
      <div class="modal-body" style="padding: 24px;">
        <input type="hidden" id="categoryId">
        <div class="form-group">
          <label>Category Name</label>
          <input type="text" id="categoryName" placeholder="e.g., Luxury Watches">
        </div>
        <div class="form-group">
          <label>Description (optional)</label>
          <textarea id="categoryDescription" rows="2" placeholder="Category description..." style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; resize: vertical;"></textarea>
        </div>
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn" data-action="save-category" style="flex: 1;">Save Category</button>
          <button class="action-btn" data-action="close-modal" data-modal="categoryModal" style="flex: 1; padding: 14px;">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="netWorthModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h2 class="modal-title">Set User Net Worth</h2>
        <button class="modal-close" onclick="closeModal('netWorthModal')">&times;</button>
      </div>
      <div class="modal-body" style="padding: 24px;">
        <input type="hidden" id="netWorthUserId">
        <p style="margin-bottom: 16px; color: rgba(255,255,255,0.7);">User: <strong id="netWorthUsername" style="color: #8B5CF6;"></strong></p>
        <p style="margin-bottom: 16px; color: rgba(255,255,255,0.7);">Current Net Worth: <strong id="currentNetWorth" style="color: #10B981;"></strong></p>
        <div class="form-group">
          <label>New Net Worth (Rands)</label>
          <input type="number" id="newNetWorth" placeholder="e.g., 1000000">
        </div>
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn" data-action="save-networth" style="flex: 1;">Set Net Worth</button>
          <button class="action-btn" data-action="close-modal" data-modal="netWorthModal" style="flex: 1; padding: 14px;">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="groupChatDetailModal">
    <div class="modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h2 class="modal-title">Group Chat Details</h2>
        <button class="modal-close" onclick="closeModal('groupChatDetailModal')">&times;</button>
      </div>
      <div class="modal-body" id="groupChatDetailContent" style="padding: 24px;">
        <div class="loading">Loading...</div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="exploreCategoryModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title" id="exploreCategoryModalTitle">Add Category</h2>
        <button class="modal-close" data-action="close-modal" data-modal="exploreCategoryModal">&times;</button>
      </div>
      <div class="modal-body" style="padding: 24px;">
        <input type="hidden" id="exploreCategoryId">
        <div class="form-group">
          <label>Name *</label>
          <input type="text" id="exploreCategoryName" placeholder="e.g., Fashion" required>
        </div>
        <div class="form-group">
          <label>Slug *</label>
          <input type="text" id="exploreCategorySlug" placeholder="e.g., fashion" required>
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="exploreCategoryDescription" placeholder="Category description..." rows="3" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; resize: vertical;"></textarea>
        </div>
        <div class="form-group">
          <label>Icon Name (Feather icon name)</label>
          <input type="text" id="exploreCategoryIconUrl" placeholder="e.g., shopping-bag, music, camera">
        </div>
        <div class="form-group">
          <label>Color (hex)</label>
          <div style="display: flex; gap: 12px; align-items: center;">
            <input type="color" id="exploreCategoryColorPicker" value="#8B5CF6" style="width: 50px; height: 40px; border: none; cursor: pointer;">
            <input type="text" id="exploreCategoryColor" placeholder="#8B5CF6" style="flex: 1;">
          </div>
        </div>
        <div class="form-group">
          <label>Sort Order</label>
          <input type="number" id="exploreCategoryOrder" placeholder="0" min="0">
        </div>
        <div class="form-group" id="exploreCategoryActiveGroup" style="display: none;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="exploreCategoryActive" checked style="width: 18px; height: 18px;">
            Active
          </label>
        </div>
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn" data-action="save-explore-category" style="flex: 1;">Save Category</button>
          <button class="action-btn action-btn-secondary" data-action="close-modal" data-modal="exploreCategoryModal" style="flex: 1;">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="deleteExploreCategoryModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h2 class="modal-title">Delete Category</h2>
        <button class="modal-close" data-action="close-modal" data-modal="deleteExploreCategoryModal">&times;</button>
      </div>
      <div class="modal-body" style="padding: 24px; text-align: center;">
        <input type="hidden" id="deleteExploreCategoryId">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#EF4444" stroke-width="2" style="margin-bottom: 16px;"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>
        <p style="color: rgba(255,255,255,0.8); margin-bottom: 8px;">Are you sure you want to delete this category?</p>
        <p style="color: rgba(255,255,255,0.5); font-size: 13px;" id="deleteExploreCategoryName"></p>
        <div style="display: flex; gap: 12px; margin-top: 24px;">
          <button class="action-btn action-btn-secondary" data-action="close-modal" data-modal="deleteExploreCategoryModal" style="flex: 1; padding: 12px;">Cancel</button>
          <button class="action-btn action-btn-danger" data-action="confirm-delete-explore-category" style="flex: 1; padding: 12px;">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="wordFilterModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title" id="wordFilterModalTitle">Add Word Filter</h2>
        <button class="modal-close" data-action="close-modal" data-modal="wordFilterModal">&times;</button>
      </div>
      <div class="modal-body" style="padding: 24px;">
        <input type="hidden" id="wordFilterId">
        <div class="form-group">
          <label>Word *</label>
          <input type="text" id="wordFilterWord" placeholder="Enter word to filter" required>
        </div>
        <div class="form-group">
          <label>Action *</label>
          <select id="wordFilterAction" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
            <option value="BLOCK">Block - Prevent posting entirely</option>
            <option value="REPLACE">Replace - Substitute with replacement text</option>
            <option value="FLAG">Flag - Allow but mark for review</option>
          </select>
        </div>
        <div class="form-group" id="wordFilterReplacementGroup">
          <label>Replacement Text</label>
          <input type="text" id="wordFilterReplacement" placeholder="e.g., ****">
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="wordFilterActive" checked style="width: 18px; height: 18px;">
            Active
          </label>
        </div>
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn" data-action="save-word-filter" style="flex: 1;">Save Filter</button>
          <button class="action-btn action-btn-secondary" data-action="close-modal" data-modal="wordFilterModal" style="flex: 1;">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="keywordFilterModal">
    <div class="modal" style="max-width: 550px;">
      <div class="modal-header">
        <h2 class="modal-title" id="keywordFilterModalTitle">Add Keyword Filter</h2>
        <button class="modal-close" data-action="close-modal" data-modal="keywordFilterModal">&times;</button>
      </div>
      <div class="modal-body" style="padding: 24px;">
        <input type="hidden" id="keywordFilterId">
        <div class="form-group">
          <label>Keyword *</label>
          <input type="text" id="keywordFilterKeyword" placeholder="Enter keyword to filter" required>
        </div>
        <div class="form-group">
          <label>Action *</label>
          <select id="keywordFilterAction" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
            <option value="BLOCK">Block - Prevent content</option>
            <option value="FLAG">Flag - Mark for review</option>
            <option value="HIDE">Hide - Auto-hide content</option>
            <option value="WARN">Warn - Show warning to user</option>
          </select>
        </div>
        <div class="form-group">
          <label style="margin-bottom: 8px;">Apply to:</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="keywordFilterPosts" checked style="width: 16px; height: 16px;">
              Posts
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="keywordFilterComments" checked style="width: 16px; height: 16px;">
              Comments
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="keywordFilterMessages" style="width: 16px; height: 16px;">
              Messages
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="keywordFilterUsernames" style="width: 16px; height: 16px;">
              Usernames
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="keywordFilterBios" style="width: 16px; height: 16px;">
              Bios
            </label>
          </div>
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="keywordFilterActive" checked style="width: 18px; height: 18px;">
            Active
          </label>
        </div>
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn" data-action="save-keyword-filter" style="flex: 1;">Save Filter</button>
          <button class="action-btn action-btn-secondary" data-action="close-modal" data-modal="keywordFilterModal" style="flex: 1;">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="appSettingModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title" id="appSettingModalTitle">Edit App Setting</h2>
        <button class="modal-close" data-action="close-modal" data-modal="appSettingModal">&times;</button>
      </div>
      <div class="modal-body" style="padding: 24px;">
        <input type="hidden" id="appSettingKey">
        <input type="hidden" id="appSettingIsNew">
        <div class="form-group" id="appSettingKeyGroup">
          <label>Key *</label>
          <input type="text" id="appSettingKeyInput" placeholder="e.g., max_upload_size">
        </div>
        <div class="form-group">
          <label>Value *</label>
          <textarea id="appSettingValue" placeholder="Enter value..." rows="3" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; resize: vertical;"></textarea>
        </div>
        <div class="form-group" id="appSettingTypeGroup">
          <label>Type</label>
          <select id="appSettingType" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
            <option value="string">String</option>
            <option value="number">Number</option>
            <option value="boolean">Boolean</option>
            <option value="json">JSON</option>
          </select>
        </div>
        <div class="form-group" id="appSettingDescGroup">
          <label>Description</label>
          <input type="text" id="appSettingDescription" placeholder="Brief description...">
        </div>
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn" data-action="save-app-setting" style="flex: 1;">Save Setting</button>
          <button class="action-btn action-btn-secondary" data-action="close-modal" data-modal="appSettingModal" style="flex: 1;">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="notificationDefaultModal">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h2 class="modal-title" id="notificationDefaultModalTitle">Add Notification Type</h2>
        <button class="modal-close" data-action="close-modal" data-modal="notificationDefaultModal">&times;</button>
      </div>
      <div class="modal-body" style="padding: 24px;">
        <input type="hidden" id="notificationDefaultId">
        <div class="form-group">
          <label>Key *</label>
          <input type="text" id="notificationDefaultKey" placeholder="e.g., likes">
        </div>
        <div class="form-group">
          <label>Name *</label>
          <input type="text" id="notificationDefaultName" placeholder="e.g., Likes">
        </div>
        <div class="form-group">
          <label>Category *</label>
          <select id="notificationDefaultCategory" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
            <option value="social">Social</option>
            <option value="messages">Messages</option>
            <option value="system">System</option>
            <option value="marketing">Marketing</option>
          </select>
        </div>
        <div class="form-group">
          <label>Description</label>
          <input type="text" id="notificationDefaultDescription" placeholder="Brief description...">
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="notificationDefaultEnabled" checked style="width: 18px; height: 18px;">
            Enabled by default
          </label>
        </div>
        <div class="form-group">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="notificationDefaultCanDisable" checked style="width: 18px; height: 18px;">
            Users can disable
          </label>
        </div>
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn" data-action="save-notification-default" style="flex: 1;">Save</button>
          <button class="action-btn action-btn-secondary" data-action="close-modal" data-modal="notificationDefaultModal" style="flex: 1;">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let allUsers = [];
    let allPosts = [];
    let gossipPosts = [];
    let blockedWords = [];
    let userFilter = 'all';
    let postFilter = 'all';
    let reportFilter = 'PENDING';
    let gossipFilter = 'reported';
    let settings = {};
    let mallProducts = [];
    let mallCategories = [];
    let mallPurchases = [];
    let currentMallTab = 'products';
    
    // Economy dashboard variables (declared early to avoid TDZ issues)
    let economyConfigData = [];
    let wealthClubsData = [];
    let battlesData = [];
    let battlesFilter = 'all';
    
    // Achievements variables (declared early to avoid TDZ issues)
    let achievementsData = [];
    let achievementFilter = 'all';
    
    // KYC & Withdrawals variables (declared early to avoid TDZ issues)
    let kycData = [];
    let withdrawalsData = [];
    let currentKycTab = 'kyc-pending';

    function togglePassword() {
      const input = document.getElementById('loginPassword');
      const icon = document.getElementById('eyeIcon');
      const toggle = document.getElementById('passwordToggle');
      
      if (input.type === 'password') {
        input.type = 'text';
        toggle.setAttribute('aria-label', 'Hide password');
        icon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
      } else {
        input.type = 'password';
        toggle.setAttribute('aria-label', 'Show password');
        icon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
      }
    }

    async function handleLogin(e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const btn = document.getElementById('loginBtn');
      const error = document.getElementById('loginError');
      
      if (!email || !password) {
        error.textContent = 'Please enter email and password';
        error.style.display = 'block';
        return;
      }
      
      btn.disabled = true;
      btn.textContent = 'Signing in...';
      error.style.display = 'none';
      
      try {
        const res = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ email, password })
        });
        
        const data = await res.json();
        
        if (res.ok && data.isAdmin) {
          currentUser = data;
          document.getElementById('loginContainer').style.display = 'none';
          document.getElementById('adminContainer').style.display = 'block';
          loadAllData();
        } else if (res.ok && !data.isAdmin) {
          error.textContent = 'Access denied. Admin privileges required.';
          error.style.display = 'block';
        } else {
          error.textContent = data.message || 'Invalid credentials';
          error.style.display = 'block';
        }
      } catch (err) {
        error.textContent = 'Connection error. Please try again.';
        error.style.display = 'block';
      }
      
      btn.disabled = false;
      btn.textContent = 'Sign In';
    }

    async function handleLogout() {
      await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
      location.reload();
    }

    async function checkAuth() {
      try {
        const res = await fetch('/api/auth/me', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          if (data.isAdmin) {
            currentUser = data;
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';
            loadAllData();
          }
        }
      } catch (e) {}
    }

    // showSection function removed - use window.showSection instead
    
    // Data Export/Import Functions for Database Sync
    async function exportData() {
      try {
        showToast('Exporting data...', 'info');
        const response = await fetch('/api/admin/data-export');
        if (!response.ok) throw new Error('Export failed');
        const data = await response.json();
        
        // Create downloadable file
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `rabitchat-export-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast(`Exported ${data.data.users.length} users, ${data.data.posts.length} posts`, 'success');
      } catch (error) {
        showToast('Export failed: ' + error.message, 'error');
      }
    }
    
    async function importData(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      try {
        showToast('Reading file...', 'info');
        const text = await file.text();
        const exportData = JSON.parse(text);
        
        if (!exportData.data) {
          throw new Error('Invalid export file format');
        }
        
        showToast('Importing data...', 'info');
        const response = await fetch('/api/admin/data-import', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ data: exportData.data, overwrite: false })
        });
        
        if (!response.ok) throw new Error('Import failed');
        const result = await response.json();
        
        showToast(`Imported: ${result.imported.users} users, ${result.imported.posts} posts`, 'success');
        
        // Refresh dashboard
        loadAdvancedDashboard();
        
        // Reset file input
        event.target.value = '';
      } catch (error) {
        showToast('Import failed: ' + error.message, 'error');
        event.target.value = '';
      }
    }
    
    // Register section loaders for the global showSection function
    window.sectionLoaders = {
      'overview': function() { loadAdvancedDashboard(); },
      'platformanalytics': function() { loadPlatformAnalytics(); },
      'users': function() { loadUsers(); },
      'posts': function() { loadPosts(); },
      'comments': function() { loadComments(); },
      'stories': function() { loadStories(); loadStoryExtendedStats(); },
      'mall': function() { loadMall(); },
      'gossip': function() { loadGossip(); },
      'reports': function() { loadReports(); },
      'verification': function() { loadVerification(); },
      'groupchats': function() { loadGroupChats(); },
      'threads': function() { loadThreads(); },
      'profilefeatures': function() { loadProfileFeatures(); },
      'roles': function() { loadRoles(); },
      'settings': function() { loadSettings(); },
      'audit': function() { loadAudit(); },
      'messages': function() { loadMessages(); },
      'groups': function() { loadGroups(); },
      'livestreams': function() { loadLivestreams(); },
      'wallet': function() { loadWallet(); },
      'payments': function() { loadPayments(); },
      'featureflags': function() { loadFeatureFlags(); },
      'userwealth': function() { loadWealthUsers(); },
      'broadcasts': function() { loadBroadcasts(); },
      'events': function() { loadEvents(); },
      'subscriptions': function() { loadSubscriptions(); },
      'hashtags': function() { loadHashtags(); },
      'blocks': function() { loadBlocks(); },
      'reels': function() { loadReels(); },
      'discovery': function() { loadDiscovery(); },
      'security': function() { loadSecurity(); },
      'videocalls': function() { loadVideoCalls(); },
      'advertising': function() { loadAdvertising(); },
      'contentvelocity': function() { loadContentVelocity(); },
      'locations': function() { loadLocationStats(); loadVenues(); },
      'arfilters': function() { loadARFilterStats(); loadARFilters(); },
      'aicontent': function() { loadAIContentStats(); loadAIAvatars(); },
      'explorecategories': function() { loadExploreCategoryStats(); loadExploreCategories(); },
      'developerapi': function() { loadDeveloperAPIStats(); loadDeveloperWebhooks(); },
      'dataprivacy': function() { loadDataPrivacyStats(); loadExportRequests(); },
      'platformsettings': function() { loadWordFilters(); },
      'economy': function() { loadEconomyOverview(); },
      'achievements': function() { loadAchievements(); },
      'kycwithdrawals': function() { loadPendingKyc(); }
    };

    async function loadAllData() {
      console.log('[Admin] loadAllData called');
      loadAdvancedDashboard();
      loadPendingReportsCount();
    }
    window.loadAllData = loadAllData;

    let dashboardCharts = {};
    let dashboardDays = 30;

    async function fetchAPI(url) {
      try {
        const res = await fetch(url, { credentials: 'include' });
        if (res.ok) return await res.json();
        console.error('[Admin] API returned status:', res.status, 'for', url);
        // Show error to user if dashboard fails
        if (url.includes('dashboard/overview')) {
          const errorMsg = res.status === 401 ? 'Session expired - please login again' : 'Failed to load data (status ' + res.status + ')';
          document.getElementById('metric-users').textContent = 'Error';
          console.error('[Admin] Dashboard API error:', errorMsg);
        }
        return null;
      } catch (e) {
        console.error('[Admin] API Error:', e);
        return null;
      }
    }

    async function loadAdvancedDashboard() {
      const [overview, userGrowth, engagement, activity, topPerformers, contentDist] = await Promise.all([
        fetchAPI('/api/admin/dashboard/overview'),
        fetchAPI(`/api/admin/dashboard/user-growth?days=${dashboardDays}`),
        fetchAPI(`/api/admin/dashboard/engagement-trends?days=${dashboardDays}`),
        fetchAPI('/api/admin/dashboard/activity-feed?limit=20'),
        fetchAPI('/api/admin/dashboard/top-performers'),
        fetchAPI('/api/admin/dashboard/content-distribution')
      ]);
      
      renderDashboardMetrics(overview);
      renderUserGrowthChart(userGrowth);
      renderEngagementChart(engagement);
      renderContentDistributionChart(contentDist);
      renderActivityFeed(activity);
      renderTopPerformers(topPerformers, contentDist);
    }

    function renderDashboardMetrics(data) {
      if (!data) {
        console.error('[Admin] No dashboard data received');
        return;
      }
      
      console.log('[Admin] Dashboard data:', JSON.stringify(data));
      
      // Handle nested API structure: data.users.total, data.posts.total, etc.
      const totalUsers = data.totalUsers || (data.users && data.users.total) || 0;
      const totalPosts = data.totalPosts || (data.posts && data.posts.total) || 0;
      const totalLikes = data.totalLikes || (data.engagement && data.engagement.likes) || 0;
      const totalComments = data.totalComments || (data.engagement && data.engagement.comments) || 0;
      const totalRevenue = data.totalRevenue || (data.revenue && data.revenue.total) || 0;
      
      document.getElementById('metric-users').textContent = formatNumber(totalUsers);
      document.getElementById('metric-posts').textContent = formatNumber(totalPosts);
      
      const engagementRate = totalPosts > 0 
        ? ((totalLikes + totalComments) / totalPosts).toFixed(1) 
        : '0';
      document.getElementById('metric-engagement').textContent = engagementRate + '%';
      
      document.getElementById('metric-revenue').textContent = 'R' + formatNumber(totalRevenue);
      
      // Handle nested structure for trends
      const userChange = data.newUsers7d || (data.users && data.users.thisWeek) || 0;
      const userGrowth = (data.users && data.users.growth) || 0;
      const userTrend = document.getElementById('metric-users-trend');
      if (userTrend) {
        userTrend.querySelector('span').textContent = '+' + formatNumber(userChange) + ' this week';
        userTrend.className = 'metric-trend ' + (userChange >= 0 ? 'up' : 'down');
      }
      
      const postChange = data.posts7d || (data.posts && data.posts.thisWeek) || 0;
      const postGrowth = (data.posts && data.posts.growth) || 0;
      const postTrend = document.getElementById('metric-posts-trend');
      if (postTrend) {
        postTrend.querySelector('span').textContent = '+' + formatNumber(postChange) + ' this week';
        postTrend.className = 'metric-trend ' + (postChange >= 0 ? 'up' : 'down');
      }
      
      const engTrend = document.getElementById('metric-engagement-trend');
      if (engTrend) {
        const avgEngRate = (data.engagement && data.engagement.avgEngagementRate) || 0;
        engTrend.querySelector('span').textContent = avgEngRate.toFixed(1) + ' per post';
      }
      
      const revTrend = document.getElementById('metric-revenue-trend');
      if (revTrend) {
        const revenueGrowth = (data.revenue && data.revenue.growth) || 0;
        revTrend.querySelector('span').textContent = (revenueGrowth >= 0 ? '+' : '') + revenueGrowth.toFixed(1) + '% growth';
      }
    }

    function renderUserGrowthChart(data) {
      const ctx = document.getElementById('userGrowthChart');
      if (!ctx) return;
      
      if (dashboardCharts.userGrowth) {
        dashboardCharts.userGrowth.destroy();
      }
      
      const labels = [];
      const newUsers = [];
      const activeUsers = [];
      
      if (data && Array.isArray(data)) {
        data.slice(-30).forEach(d => {
          labels.push(new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
          newUsers.push(d.newUsers || 0);
          activeUsers.push(d.activeUsers || 0);
        });
      } else {
        for (let i = 29; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
          newUsers.push(Math.floor(Math.random() * 50) + 10);
          activeUsers.push(Math.floor(Math.random() * 200) + 100);
        }
      }
      
      dashboardCharts.userGrowth = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Active Users',
              data: activeUsers,
              borderColor: '#8B5CF6',
              backgroundColor: 'rgba(139, 92, 246, 0.1)',
              fill: true,
              tension: 0.4
            },
            {
              label: 'New Users',
              data: newUsers,
              borderColor: '#10B981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              fill: true,
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: { color: '#fff', usePointStyle: true }
            }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: 'rgba(255,255,255,0.5)', maxTicksLimit: 10 }
            },
            y: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: 'rgba(255,255,255,0.5)' }
            }
          }
        }
      });
    }

    function renderEngagementChart(data) {
      const ctx = document.getElementById('engagementChart');
      if (!ctx) return;
      
      if (dashboardCharts.engagement) {
        dashboardCharts.engagement.destroy();
      }
      
      const labels = [];
      const likes = [];
      const comments = [];
      const shares = [];
      
      if (data && Array.isArray(data)) {
        data.slice(-30).forEach(d => {
          labels.push(new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
          likes.push(d.posts || 0);
          comments.push(d.messages || 0);
          shares.push(Math.floor((d.posts || 0) * 0.3));
        });
      } else {
        for (let i = 29; i >= 0; i--) {
          const date = new Date();
          date.setDate(date.getDate() - i);
          labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
          likes.push(Math.floor(Math.random() * 500) + 100);
          comments.push(Math.floor(Math.random() * 200) + 50);
          shares.push(Math.floor(Math.random() * 100) + 20);
        }
      }
      
      dashboardCharts.engagement = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Likes',
              data: likes,
              borderColor: '#EC4899',
              backgroundColor: 'transparent',
              tension: 0.4
            },
            {
              label: 'Comments',
              data: comments,
              borderColor: '#3B82F6',
              backgroundColor: 'transparent',
              tension: 0.4
            },
            {
              label: 'Shares',
              data: shares,
              borderColor: '#F59E0B',
              backgroundColor: 'transparent',
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: { color: '#fff', usePointStyle: true }
            }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: 'rgba(255,255,255,0.5)', maxTicksLimit: 10 }
            },
            y: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: 'rgba(255,255,255,0.5)' }
            }
          }
        }
      });
    }

    function renderContentDistributionChart(posts) {
      const ctx = document.getElementById('contentDistChart');
      if (!ctx) return;
      
      if (dashboardCharts.contentDist) {
        dashboardCharts.contentDist.destroy();
      }
      
      let textCount = 0, photoCount = 0, videoCount = 0, voiceCount = 0;
      
      if (posts && Array.isArray(posts)) {
        posts.forEach(p => {
          switch (p.type) {
            case 'TEXT': textCount++; break;
            case 'PHOTO': photoCount++; break;
            case 'VIDEO': videoCount++; break;
            case 'VOICE': voiceCount++; break;
          }
        });
      } else {
        textCount = 45; photoCount = 30; videoCount = 15; voiceCount = 10;
      }
      
      dashboardCharts.contentDist = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Text', 'Photo', 'Video', 'Voice'],
          datasets: [{
            data: [textCount, photoCount, videoCount, voiceCount],
            backgroundColor: ['#8B5CF6', '#3B82F6', '#EC4899', '#10B981'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '60%',
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: '#fff', usePointStyle: true, padding: 20 }
            }
          }
        }
      });
    }

    function renderActivityFeed(data) {
      const container = document.getElementById('activityFeed');
      if (!container) return;
      
      if (!data || !Array.isArray(data) || data.length === 0) {
        container.innerHTML = '<div class="empty-state">No recent activity</div>';
        return;
      }
      
      const getActivityIcon = (action) => {
        if (action?.includes('user') || action?.includes('login')) return { class: 'user', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>' };
        if (action?.includes('post')) return { class: 'post', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>' };
        if (action?.includes('comment')) return { class: 'comment', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>' };
        if (action?.includes('report')) return { class: 'report', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg>' };
        return { class: 'purchase', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>' };
      };
      
      container.innerHTML = data.slice(0, 15).map(item => {
        const icon = getActivityIcon(item.action);
        const time = item.createdAt ? new Date(item.createdAt).toLocaleString() : 'Just now';
        return `
          <div class="activity-item">
            <div class="activity-icon ${icon.class}">${icon.icon}</div>
            <div class="activity-content">
              <div class="activity-message">${item.action || 'Activity'} ${item.details ? '- ' + item.details.substring(0, 50) : ''}</div>
              <div class="activity-time">${time}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderTopPerformers(users, posts) {
      const topUsersContainer = document.getElementById('topUsersList');
      const topPostsContainer = document.getElementById('topPostsList');
      const trendingContainer = document.getElementById('trendingHashtags');
      
      if (topUsersContainer) {
        if (users && Array.isArray(users) && users.length > 0) {
          const sortedUsers = [...users].sort((a, b) => (b.netWorth || 0) - (a.netWorth || 0)).slice(0, 5);
          topUsersContainer.innerHTML = sortedUsers.map((user, i) => {
            const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
            const initial = (user.displayName || user.username || 'U')[0].toUpperCase();
            return `
              <div class="leaderboard-item">
                <div class="leaderboard-rank ${rankClass}">${i + 1}</div>
                <div class="leaderboard-avatar">${user.avatarUrl ? `<img src="${user.avatarUrl}" alt="">` : initial}</div>
                <div class="leaderboard-info">
                  <div class="leaderboard-name">@${user.username || 'user'}</div>
                  <div class="leaderboard-stat">${formatNumber(user.followersCount || 0)} followers</div>
                </div>
                <div class="leaderboard-value">R${formatNumber(user.netWorth || 0)}</div>
              </div>
            `;
          }).join('');
        } else {
          topUsersContainer.innerHTML = '<div class="empty-state">No users yet</div>';
        }
      }
      
      if (topPostsContainer) {
        if (posts && Array.isArray(posts) && posts.length > 0) {
          const sortedPosts = [...posts].sort((a, b) => (b.likeCount || 0) - (a.likeCount || 0)).slice(0, 5);
          topPostsContainer.innerHTML = sortedPosts.map(post => `
            <div class="top-post-item">
              <div class="top-post-content">${(post.content || 'No content').substring(0, 80)}${(post.content || '').length > 80 ? '...' : ''}</div>
              <div class="top-post-stats">
                <span>${formatNumber(post.likeCount || 0)} likes</span>
                <span>${formatNumber(post.commentCount || 0)} comments</span>
                <span>@${post.author?.username || 'user'}</span>
              </div>
            </div>
          `).join('');
        } else {
          topPostsContainer.innerHTML = '<div class="empty-state">No posts yet</div>';
        }
      }
      
      if (trendingContainer) {
        const hashtags = ['#trending', '#rabitchat', '#social', '#viral', '#community'];
        const counts = [1234, 987, 756, 543, 432];
        trendingContainer.innerHTML = hashtags.map((tag, i) => `
          <div class="trending-item">
            <div class="trending-tag">${tag}</div>
            <div class="trending-count">${formatNumber(counts[i])} posts</div>
          </div>
        `).join('');
      }
    }

    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('date-range-btn')) {
        document.querySelectorAll('.date-range-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        dashboardDays = parseInt(e.target.dataset.days) || 30;
        loadAdvancedDashboard();
      }
    });

    let currentTrendsDays = 7;

    async function loadPlatformAnalytics() {
      loadAnalyticsStats();
      loadRetentionMetrics();
      loadTrends(currentTrendsDays);
    }

    async function loadAnalyticsStats() {
      try {
        const res = await fetch('/api/admin/analytics/platform', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          document.getElementById('analyticsStats').innerHTML = `
            <div class="stat-card">
              <h3>Daily Active Users</h3>
              <div class="value">${formatNumber(data.dau || 0)}</div>
              <div class="change" style="color: rgba(255,255,255,0.5);">Active today</div>
            </div>
            <div class="stat-card">
              <h3>Weekly Active Users</h3>
              <div class="value">${formatNumber(data.wau || 0)}</div>
              <div class="change" style="color: rgba(255,255,255,0.5);">Last 7 days</div>
            </div>
            <div class="stat-card">
              <h3>Monthly Active Users</h3>
              <div class="value">${formatNumber(data.mau || 0)}</div>
              <div class="change" style="color: rgba(255,255,255,0.5);">Last 30 days</div>
            </div>
            <div class="stat-card">
              <h3>Total Users</h3>
              <div class="value">${formatNumber(data.totalUsers || 0)}</div>
            </div>
            <div class="stat-card">
              <h3>Total Posts</h3>
              <div class="value">${formatNumber(data.totalPosts || 0)}</div>
            </div>
            <div class="stat-card">
              <h3>Total Messages</h3>
              <div class="value">${formatNumber(data.totalMessages || 0)}</div>
            </div>
            <div class="stat-card">
              <h3>Avg Session Duration</h3>
              <div class="value">${data.avgSessionDuration || 0}<span style="font-size: 16px; font-weight: 400;"> min</span></div>
            </div>
          `;
        }
      } catch (e) {
        console.error('Failed to load analytics stats:', e);
        document.getElementById('analyticsStats').innerHTML = '<div class="loading">Failed to load stats</div>';
      }
    }

    async function loadRetentionMetrics() {
      try {
        const res = await fetch('/api/admin/analytics/retention', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          document.getElementById('retentionMetrics').innerHTML = `
            <div style="text-align: center; padding: 20px; background: rgba(139, 92, 246, 0.1); border-radius: 12px;">
              <div style="font-size: 36px; font-weight: 700; color: #8B5CF6;">${data.day1Retention || 0}%</div>
              <div style="color: rgba(255,255,255,0.6); font-size: 14px; margin-top: 4px;">D1 Retention</div>
            </div>
            <div style="text-align: center; padding: 20px; background: rgba(16, 185, 129, 0.1); border-radius: 12px;">
              <div style="font-size: 36px; font-weight: 700; color: #10B981;">${data.day7Retention || 0}%</div>
              <div style="color: rgba(255,255,255,0.6); font-size: 14px; margin-top: 4px;">D7 Retention</div>
            </div>
            <div style="text-align: center; padding: 20px; background: rgba(245, 158, 11, 0.1); border-radius: 12px;">
              <div style="font-size: 36px; font-weight: 700; color: #F59E0B;">${data.day30Retention || 0}%</div>
              <div style="color: rgba(255,255,255,0.6); font-size: 14px; margin-top: 4px;">D30 Retention</div>
            </div>
          `;
        }
      } catch (e) {
        console.error('Failed to load retention metrics:', e);
        document.getElementById('retentionMetrics').innerHTML = '<div class="loading">Failed to load retention data</div>';
      }
    }

    async function loadTrends(days) {
      currentTrendsDays = days;
      document.querySelectorAll('#section-platformanalytics .filter-btn[data-action="trends-period"]').forEach(b => b.classList.remove('active'));
      const activeBtn = document.querySelector('#section-platformanalytics .filter-btn[data-days="' + days + '"]');
      if (activeBtn) activeBtn.classList.add('active');

      try {
        const res = await fetch('/api/admin/analytics/trends?days=' + days, { credentials: 'include' });
        if (res.ok) {
          const trends = await res.json();
          renderTrendsChart(trends);
        }
      } catch (e) {
        console.error('Failed to load trends:', e);
        document.getElementById('trendsChart').innerHTML = '<div class="loading">Failed to load trends</div>';
      }
    }

    function renderTrendsChart(trends) {
      if (!trends || trends.length === 0) {
        document.getElementById('trendsChart').innerHTML = '<div class="loading">No data available</div>';
        return;
      }

      const maxActiveUsers = Math.max(...trends.map(t => t.activeUsers), 1);
      const maxNewUsers = Math.max(...trends.map(t => t.newUsers), 1);
      const maxPosts = Math.max(...trends.map(t => t.posts), 1);
      const maxMessages = Math.max(...trends.map(t => t.messages), 1);
      const overallMax = Math.max(maxActiveUsers, maxNewUsers, maxPosts, maxMessages, 1);

      let barsHtml = '<div style="display: flex; align-items: flex-end; height: 250px; gap: 2px; padding-bottom: 30px; overflow-x: auto;">';
      
      trends.forEach((day, idx) => {
        const activeHeight = (day.activeUsers / overallMax) * 220;
        const newHeight = (day.newUsers / overallMax) * 220;
        const postsHeight = (day.posts / overallMax) * 220;
        const messagesHeight = (day.messages / overallMax) * 220;
        const dateLabel = new Date(day.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        
        barsHtml += `
          <div style="flex: 1; min-width: 40px; display: flex; flex-direction: column; align-items: center; position: relative;">
            <div style="display: flex; gap: 1px; align-items: flex-end; height: 220px;">
              <div style="width: 8px; background: #8B5CF6; border-radius: 2px 2px 0 0; height: ${Math.max(activeHeight, 2)}px;" title="Active: ${day.activeUsers}"></div>
              <div style="width: 8px; background: #10B981; border-radius: 2px 2px 0 0; height: ${Math.max(newHeight, 2)}px;" title="New: ${day.newUsers}"></div>
              <div style="width: 8px; background: #F59E0B; border-radius: 2px 2px 0 0; height: ${Math.max(postsHeight, 2)}px;" title="Posts: ${day.posts}"></div>
              <div style="width: 8px; background: #EC4899; border-radius: 2px 2px 0 0; height: ${Math.max(messagesHeight, 2)}px;" title="Messages: ${day.messages}"></div>
            </div>
            <div style="position: absolute; bottom: -24px; font-size: 10px; color: rgba(255,255,255,0.5); white-space: nowrap; transform: rotate(-45deg); transform-origin: top left;">${dateLabel}</div>
          </div>
        `;
      });
      
      barsHtml += '</div>';
      document.getElementById('trendsChart').innerHTML = barsHtml;
    }

    function setTrendsPeriod(days) {
      loadTrends(days);
    }

    async function loadPendingReportsCount() {
      try {
        const res = await fetch('/api/admin/reports?status=PENDING', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          document.getElementById('reportsCount').textContent = data.length || 0;
        }
      } catch (e) {}
    }

    async function loadUsers() {
      console.log('[Admin] loadUsers called');
      try {
        const res = await fetch('/api/admin/users', { credentials: 'include' });
        console.log('[Admin] /api/admin/users response status:', res.status);
        if (res.ok) {
          allUsers = await res.json();
          console.log('[Admin] Loaded', allUsers.length, 'users');
          renderUsers();
        } else {
          const errorText = await res.text();
          console.error('[Admin] Users API error:', res.status, errorText);
          document.getElementById('usersTable').innerHTML = '<div class="empty-state">Failed to load users (status ' + res.status + ')</div>';
        }
      } catch (e) {
        console.error('[Admin] Failed to load users:', e);
        document.getElementById('usersTable').innerHTML = '<div class="empty-state">Failed to load users: ' + e.message + '</div>';
      }
    }

    function setUserFilter(filter) {
      userFilter = filter;
      document.querySelectorAll('#section-users .filter-btn').forEach(b => b.classList.remove('active'));
      const activeBtn = document.querySelector('#section-users .filter-btn[data-filter="' + filter + '"]');
      if (activeBtn) activeBtn.classList.add('active');
      renderUsers();
    }

    function filterUsers() {
      renderUsers();
    }

    function renderUsers() {
      const search = document.getElementById('userSearch').value.toLowerCase();
      let filtered = allUsers.filter(u => {
        const matchSearch = !search || 
          (u.displayName && u.displayName.toLowerCase().includes(search)) ||
          (u.username && u.username.toLowerCase().includes(search)) ||
          (u.email && u.email.toLowerCase().includes(search));
        
        const isSuspended = u.suspendedAt !== null;
        let matchFilter = true;
        if (userFilter === 'admin') matchFilter = u.isAdmin;
        else if (userFilter === 'verified') matchFilter = u.isVerified;
        else if (userFilter === 'suspended') matchFilter = isSuspended;
        
        return matchSearch && matchFilter;
      });

      if (filtered.length === 0) {
        document.getElementById('usersTable').innerHTML = '<div class="empty-state">No users found</div>';
        return;
      }

      const avatarUrl = (u) => u.avatarUrl || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(u.displayName || u.username || 'U') + '&background=8B5CF6&color=fff';

      document.getElementById('usersTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Status</th>
              <th>Net Worth</th>
              <th>Joined</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.map(u => {
              const isSuspended = u.suspendedAt !== null;
              return `
              <tr>
                <td>
                  <div class="user-cell">
                    <div class="avatar"><img src="${avatarUrl(u)}" alt="${u.displayName || u.username}"></div>
                    <div class="user-info">
                      <span class="user-name">${u.displayName || u.username || 'Unknown'}</span>
                      <span class="user-email">@${u.username || 'unknown'}</span>
                    </div>
                  </div>
                </td>
                <td>
                  ${u.isAdmin ? '<span class="badge badge-admin">Admin</span>' : ''}
                  ${u.isVerified ? '<span class="badge badge-verified">Verified</span>' : ''}
                  ${isSuspended ? '<span class="badge badge-suspended">Suspended</span>' : ''}
                  ${!u.isAdmin && !u.isVerified && !isSuspended ? '<span class="badge badge-active">Active</span>' : ''}
                </td>
                <td>R${formatNumber(u.netWorth || 0)}</td>
                <td>${formatDate(u.createdAt)}</td>
                <td>
                  <button class="action-btn action-btn-primary" data-action="view-user" data-id="${u.id}">View</button>
                  ${isSuspended 
                    ? `<button class="action-btn action-btn-success" data-action="unsuspend-user" data-id="${u.id}">Unsuspend</button>`
                    : `<button class="action-btn action-btn-danger" data-action="suspend-user" data-id="${u.id}">Suspend</button>`
                  }
                </td>
              </tr>
            `;}).join('')}
          </tbody>
        </table>
      `;
    }

    async function viewUser(userId) {
      try {
        const res = await fetch('/api/admin/users/' + userId, { credentials: 'include' });
        if (res.ok) {
          const user = await res.json();
          const avatarUrl = user.avatarUrl || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.displayName || user.username || 'U') + '&background=8B5CF6&color=fff';
          
          document.getElementById('userModalTitle').textContent = 'User Details';
          document.getElementById('userModalContent').innerHTML = `
            <div class="user-header">
              <div class="avatar"><img src="${avatarUrl}" alt="${user.displayName}"></div>
              <div>
                <h3>${user.displayName || user.username}</h3>
                <p style="color: rgba(255,255,255,0.5);">@${user.username} &bull; ${user.email}</p>
              </div>
            </div>
            <div class="detail-grid">
              <div class="detail-item">
                <label>Net Worth</label>
                <span>R${formatNumber(user.netWorth || 0)}</span>
              </div>
              <div class="detail-item">
                <label>Influence Score</label>
                <span>${formatNumber(user.influenceScore || 0)}</span>
              </div>
              <div class="detail-item">
                <label>Admin</label>
                <span>${user.isAdmin ? 'Yes' : 'No'}</span>
              </div>
              <div class="detail-item">
                <label>Verified</label>
                <span>${user.isVerified ? 'Yes' : 'No'}</span>
              </div>
              <div class="detail-item">
                <label>Suspended</label>
                <span>${user.suspendedAt ? 'Yes' : 'No'}</span>
              </div>
              <div class="detail-item">
                <label>Joined</label>
                <span>${formatDate(user.createdAt)}</span>
              </div>
            </div>
            ${user.bio ? `<div style="margin-top: 16px;"><label style="font-size: 11px; color: rgba(255,255,255,0.5);">BIO</label><p style="margin-top: 4px;">${user.bio}</p></div>` : ''}
            <div class="form-actions" style="margin-top: 24px;">
              <button class="btn btn-secondary" data-action="toggle-admin" data-id="${user.id}" data-value="${!user.isAdmin}">${user.isAdmin ? 'Remove Admin' : 'Make Admin'}</button>
              <button class="btn btn-secondary" data-action="toggle-verified" data-id="${user.id}" data-value="${!user.isVerified}">${user.isVerified ? 'Unverify' : 'Verify'}</button>
            </div>
          `;
          openModal('userModal');
        }
      } catch (e) {
        console.error('Failed to load user:', e);
      }
    }

    async function confirmSuspend(userId) {
      document.getElementById('actionModalTitle').textContent = 'Suspend User';
      document.getElementById('actionModalContent').innerHTML = `
        <p style="margin-bottom: 16px;">Are you sure you want to suspend this user?</p>
        <div class="form-group">
          <label>Reason (optional)</label>
          <input type="text" id="suspendReason" placeholder="Reason for suspension">
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary" data-action="close-modal" data-modal="actionModal">Cancel</button>
          <button class="btn" style="background: #EF4444;" data-action="confirm-suspend" data-id="${userId}">Suspend</button>
        </div>
      `;
      openModal('actionModal');
    }

    async function suspendUser(userId) {
      const reason = document.getElementById('suspendReason')?.value || '';
      try {
        const res = await fetch('/api/admin/users/' + userId + '/suspend', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ reason })
        });
        if (res.ok) {
          closeModal('actionModal');
          loadUsers();
        }
      } catch (e) {
        console.error('Failed to suspend user:', e);
      }
    }

    async function unsuspendUser(userId) {
      try {
        const res = await fetch('/api/admin/users/' + userId + '/unsuspend', {
          method: 'POST',
          credentials: 'include'
        });
        if (res.ok) {
          loadUsers();
        }
      } catch (e) {
        console.error('Failed to unsuspend user:', e);
      }
    }

    async function toggleAdmin(userId, makeAdmin) {
      try {
        const res = await fetch('/api/admin/users/' + userId, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ isAdmin: makeAdmin })
        });
        if (res.ok) {
          closeModal('userModal');
          loadUsers();
        }
      } catch (e) {
        console.error('Failed to update admin status:', e);
      }
    }

    async function toggleVerified(userId, makeVerified) {
      try {
        const res = await fetch('/api/admin/users/' + userId, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ isVerified: makeVerified })
        });
        if (res.ok) {
          closeModal('userModal');
          loadUsers();
        }
      } catch (e) {
        console.error('Failed to update verified status:', e);
      }
    }

    async function loadPosts() {
      console.log('[Admin] loadPosts called');
      try {
        const url = postFilter === 'all' ? '/api/admin/posts' : '/api/admin/posts?type=' + postFilter;
        const res = await fetch(url, { credentials: 'include' });
        console.log('[Admin] Posts response status:', res.status);
        if (res.ok) {
          allPosts = await res.json();
          console.log('[Admin] Loaded', allPosts.length, 'posts');
          renderPosts();
        } else {
          const errorText = await res.text();
          console.error('[Admin] Posts API error:', res.status, errorText);
          document.getElementById('postsTable').innerHTML = '<div class="empty-state">Failed to load posts (status ' + res.status + ')</div>';
        }
      } catch (e) {
        console.error('[Admin] Failed to load posts:', e);
        document.getElementById('postsTable').innerHTML = '<div class="empty-state">Failed to load posts: ' + e.message + '</div>';
      }
    }

    function setPostFilter(filter) {
      postFilter = filter;
      document.querySelectorAll('#section-posts .filter-btn').forEach(b => b.classList.remove('active'));
      const activeBtn = document.querySelector('#section-posts .filter-btn[data-filter="' + filter + '"]');
      if (activeBtn) activeBtn.classList.add('active');
      loadPosts();
    }

    function renderPosts() {
      if (allPosts.length === 0) {
        document.getElementById('postsTable').innerHTML = '<div class="empty-state">No posts found</div>';
        return;
      }

      document.getElementById('postsTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Author</th>
              <th>Type</th>
              <th>Content</th>
              <th>Stats</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${allPosts.map(p => `
              <tr>
                <td>${p.author?.displayName || p.author?.username || 'Unknown'}</td>
                <td><span class="badge badge-active">${p.type || 'TEXT'}</span></td>
                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${p.caption || p.content || '(No text)'}</td>
                <td>${p.likesCount || 0} likes, ${p.commentsCount || 0} comments</td>
                <td>${formatDate(p.createdAt)}</td>
                <td>
                  <button class="action-btn action-btn-danger" data-action="confirm-delete-post" data-id="${p.id}">Delete</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function confirmDeletePost(postId) {
      document.getElementById('actionModalTitle').textContent = 'Delete Post';
      document.getElementById('actionModalContent').innerHTML = `
        <p style="margin-bottom: 16px;">Are you sure you want to delete this post? This action cannot be undone.</p>
        <div class="form-actions">
          <button class="btn btn-secondary" data-action="close-modal" data-modal="actionModal">Cancel</button>
          <button class="btn" style="background: #EF4444;" data-action="delete-post" data-id="${postId}">Delete</button>
        </div>
      `;
      openModal('actionModal');
    }

    async function deletePost(postId) {
      try {
        const res = await fetch('/api/admin/posts/' + postId, {
          method: 'DELETE',
          credentials: 'include'
        });
        if (res.ok) {
          closeModal('actionModal');
          loadPosts();
        }
      } catch (e) {
        console.error('Failed to delete post:', e);
      }
    }

    async function loadComments() {
      console.log('[Admin] loadComments called');
      try {
        const res = await fetch('/api/admin/comments', { credentials: 'include' });
        console.log('[Admin] Comments response status:', res.status);
        if (res.ok) {
          const comments = await res.json();
          console.log('[Admin] Loaded', comments.length, 'comments');
          if (comments.length === 0) {
            document.getElementById('commentsTable').innerHTML = '<div class="empty-state">No comments found</div>';
            return;
          }
          document.getElementById('commentsTable').innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>Author</th>
                  <th>Comment</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${comments.map(c => `
                  <tr>
                    <td>${c.author?.displayName || c.author?.username || 'Unknown'}</td>
                    <td style="max-width: 300px;">${c.content || ''}</td>
                    <td>${formatDate(c.createdAt)}</td>
                    <td>
                      <button class="action-btn action-btn-danger" data-action="delete-comment" data-id="${c.id}">Delete</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
      } catch (e) {
        console.error('Failed to load comments:', e);
      }
    }

    async function deleteComment(commentId) {
      try {
        const res = await fetch('/api/admin/comments/' + commentId, {
          method: 'DELETE',
          credentials: 'include'
        });
        if (res.ok) {
          loadComments();
        }
      } catch (e) {
        console.error('Failed to delete comment:', e);
      }
    }

    async function loadStories() {
      console.log('[Admin] loadStories called');
      try {
        const res = await fetch('/api/admin/stories', { credentials: 'include' });
        console.log('[Admin] Stories response status:', res.status);
        if (res.ok) {
          const stories = await res.json();
          console.log('[Admin] Loaded', stories.length, 'stories');
          if (stories.length === 0) {
            document.getElementById('storiesTable').innerHTML = '<div class="empty-state">No stories found</div>';
            return;
          }
          document.getElementById('storiesTable').innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>Author</th>
                  <th>Type</th>
                  <th>Created</th>
                  <th>Expires</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${stories.map(s => `
                  <tr>
                    <td>${s.author?.displayName || s.author?.username || 'Unknown'}</td>
                    <td><span class="badge badge-active">${s.mediaType || 'PHOTO'}</span></td>
                    <td>${formatDate(s.createdAt)}</td>
                    <td>${formatDate(s.expiresAt)}</td>
                    <td>
                      <button class="action-btn action-btn-danger" data-action="delete-story" data-id="${s.id}">Delete</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
      } catch (e) {
        console.error('Failed to load stories:', e);
      }
    }

    async function deleteStory(storyId) {
      try {
        const res = await fetch('/api/admin/stories/' + storyId, {
          method: 'DELETE',
          credentials: 'include'
        });
        if (res.ok) {
          loadStories();
        }
      } catch (e) {
        console.error('Failed to delete story:', e);
      }
    }

    // Story Extended Features
    let currentStoryTab = 'stories';
    let highlightsPage = 1;
    let stickersPage = 1;
    let tipsPage = 1;
    let highlightsSearchQuery = '';

    async function loadStoryExtendedStats() {
      try {
        const res = await fetch('/api/admin/stories/extended/stats', { credentials: 'include' });
        if (res.ok) {
          const stats = await res.json();
          document.getElementById('stat-highlights').textContent = stats.totalHighlights.toLocaleString();
          document.getElementById('stat-stickers').textContent = stats.totalStickers.toLocaleString();
          document.getElementById('stat-responses').textContent = stats.totalStickerResponses.toLocaleString();
          document.getElementById('stat-tips').textContent = stats.totalTips.toLocaleString();
          document.getElementById('stat-tip-amount').textContent = stats.totalTipAmount.toLocaleString();
        }
      } catch (e) {
        console.error('Failed to load story extended stats:', e);
      }
    }

    function switchStoryTab(tab) {
      currentStoryTab = tab;
      document.querySelectorAll('#storyTabs .filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-tab') === tab);
      });
      document.getElementById('storyStoriesPanel').style.display = tab === 'stories' ? 'block' : 'none';
      document.getElementById('storyHighlightsPanel').style.display = tab === 'highlights' ? 'block' : 'none';
      document.getElementById('storyStickersPanel').style.display = tab === 'stickers' ? 'block' : 'none';
      document.getElementById('storyTipsPanel').style.display = tab === 'tips' ? 'block' : 'none';

      if (tab === 'stories') loadStories();
      else if (tab === 'highlights') loadStoryHighlights();
      else if (tab === 'stickers') loadStoryStickers();
      else if (tab === 'tips') loadStoryTips();
    }

    async function loadStoryHighlights() {
      try {
        const url = `/api/admin/stories/highlights?page=${highlightsPage}&limit=20` + (highlightsSearchQuery ? `&search=${encodeURIComponent(highlightsSearchQuery)}` : '');
        const res = await fetch(url, { credentials: 'include' });
        if (res.ok) {
          const { highlights, total } = await res.json();
          if (highlights.length === 0) {
            document.getElementById('highlightsTable').innerHTML = '<div class="empty-state">No highlights found</div>';
            document.getElementById('highlightsPagination').innerHTML = '';
            return;
          }
          document.getElementById('highlightsTable').innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>User</th>
                  <th>Title</th>
                  <th>Cover</th>
                  <th>Items</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${highlights.map(h => `
                  <tr>
                    <td>${h.user?.displayName || h.user?.username || 'Unknown'}</td>
                    <td>${h.name}</td>
                    <td>${h.coverUrl ? `<img src="${h.coverUrl}" alt="Cover" style="width: 40px; height: 40px; border-radius: 8px; object-fit: cover;">` : '-'}</td>
                    <td>${h.itemCount || 0}</td>
                    <td>${formatDate(h.createdAt)}</td>
                    <td>
                      <button class="action-btn action-btn-danger" data-action="delete-highlight" data-id="${h.id}">Delete</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          renderPagination('highlightsPagination', total, 20, highlightsPage, (page) => { highlightsPage = page; loadStoryHighlights(); });
        }
      } catch (e) {
        console.error('Failed to load highlights:', e);
      }
    }

    function searchHighlights() {
      highlightsSearchQuery = document.getElementById('highlightsSearch').value;
      highlightsPage = 1;
      loadStoryHighlights();
    }

    async function deleteStoryHighlight(highlightId) {
      if (!confirm('Are you sure you want to delete this highlight?')) return;
      try {
        const res = await fetch('/api/admin/stories/highlights/' + highlightId, {
          method: 'DELETE',
          credentials: 'include'
        });
        if (res.ok) {
          loadStoryHighlights();
          loadStoryExtendedStats();
        }
      } catch (e) {
        console.error('Failed to delete highlight:', e);
      }
    }

    async function loadStoryStickers() {
      try {
        const url = `/api/admin/stories/stickers?page=${stickersPage}&limit=20`;
        const res = await fetch(url, { credentials: 'include' });
        if (res.ok) {
          const { stickers, total } = await res.json();
          if (stickers.length === 0) {
            document.getElementById('stickersTable').innerHTML = '<div class="empty-state">No stickers found</div>';
            document.getElementById('stickersPagination').innerHTML = '';
            return;
          }
          document.getElementById('stickersTable').innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Data Preview</th>
                  <th>Responses</th>
                  <th>Created</th>
                </tr>
              </thead>
              <tbody>
                ${stickers.map(s => `
                  <tr>
                    <td><span class="badge badge-active">${s.type}</span></td>
                    <td><code style="font-size: 11px; background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px;">${JSON.stringify(s.data).substring(0, 50)}${JSON.stringify(s.data).length > 50 ? '...' : ''}</code></td>
                    <td>${s.responsesCount || 0}</td>
                    <td>${formatDate(s.createdAt)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          renderPagination('stickersPagination', total, 20, stickersPage, (page) => { stickersPage = page; loadStoryStickers(); });
        }
      } catch (e) {
        console.error('Failed to load stickers:', e);
      }
    }

    async function loadStoryTips() {
      try {
        const url = `/api/admin/stories/tips?page=${tipsPage}&limit=20`;
        const res = await fetch(url, { credentials: 'include' });
        if (res.ok) {
          const { tips, total } = await res.json();
          if (tips.length === 0) {
            document.getElementById('tipsTable').innerHTML = '<div class="empty-state">No tips found</div>';
            document.getElementById('tipsPagination').innerHTML = '';
            return;
          }
          document.getElementById('tipsTable').innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>Sender</th>
                  <th>Recipient</th>
                  <th>Amount</th>
                  <th>Message</th>
                  <th>Created</th>
                </tr>
              </thead>
              <tbody>
                ${tips.map(t => `
                  <tr>
                    <td>${t.sender?.displayName || t.sender?.username || 'Unknown'}</td>
                    <td>${t.recipient?.displayName || t.recipient?.username || 'Unknown'}</td>
                    <td><span style="color: #10B981; font-weight: 600;">${t.amount.toLocaleString()}</span></td>
                    <td>${t.message || '-'}</td>
                    <td>${formatDate(t.createdAt)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          renderPagination('tipsPagination', total, 20, tipsPage, (page) => { tipsPage = page; loadStoryTips(); });
        }
      } catch (e) {
        console.error('Failed to load tips:', e);
      }
    }

    function renderPagination(containerId, total, limit, currentPage, onPageChange) {
      const totalPages = Math.ceil(total / limit);
      if (totalPages <= 1) {
        document.getElementById(containerId).innerHTML = '';
        return;
      }
      let html = '<div style="display: flex; gap: 8px; justify-content: center; padding: 16px;">';
      if (currentPage > 1) {
        html += `<button class="action-btn" onclick="(${onPageChange.toString()})(${currentPage - 1})">Prev</button>`;
      }
      html += `<span style="padding: 8px 12px;">Page ${currentPage} of ${totalPages}</span>`;
      if (currentPage < totalPages) {
        html += `<button class="action-btn" onclick="(${onPageChange.toString()})(${currentPage + 1})">Next</button>`;
      }
      html += '</div>';
      document.getElementById(containerId).innerHTML = html;
    }

    // ===== PROFILE FEATURES =====
    let currentProfileTab = 'intros';
    let featuredIntrosPage = 1;
    let linkedAccountsPage = 1;
    let linkedAccountsSearchQuery = '';
    let userNotesPage = 1;

    async function loadProfileFeatures() {
      await loadProfileFeaturesStats();
      switchProfileFeaturesTab('intros');
    }

    async function loadProfileFeaturesStats() {
      try {
        const res = await fetch('/api/admin/profiles/stats', { credentials: 'include' });
        if (res.ok) {
          const stats = await res.json();
          document.getElementById('stat-featured-intros').textContent = stats.totalFeaturedIntros.toLocaleString();
          document.getElementById('stat-pending-intros').textContent = stats.pendingIntros.toLocaleString();
          document.getElementById('stat-linked-accounts').textContent = stats.totalLinkedAccounts.toLocaleString();
          document.getElementById('stat-user-notes').textContent = stats.totalUserNotes.toLocaleString();
        }
      } catch (e) {
        console.error('Failed to load profile features stats:', e);
      }
    }

    function switchProfileFeaturesTab(tab) {
      currentProfileTab = tab;
      document.querySelectorAll('#profileFeaturesTabs .filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-tab') === tab);
      });
      document.getElementById('profileIntrosPanel').style.display = tab === 'intros' ? 'block' : 'none';
      document.getElementById('profileLinkedPanel').style.display = tab === 'linked' ? 'block' : 'none';
      document.getElementById('profileNotesPanel').style.display = tab === 'notes' ? 'block' : 'none';

      if (tab === 'intros') loadFeaturedIntros();
      else if (tab === 'linked') loadLinkedAccounts();
      else if (tab === 'notes') loadUserNotes();
    }

    async function loadFeaturedIntros() {
      try {
        const url = `/api/admin/profiles/intros?page=${featuredIntrosPage}&limit=20`;
        const res = await fetch(url, { credentials: 'include' });
        if (res.ok) {
          const { intros, total } = await res.json();
          if (intros.length === 0) {
            document.getElementById('featuredIntrosTable').innerHTML = '<div class="empty-state">No featured intros found</div>';
            document.getElementById('featuredIntrosPagination').innerHTML = '';
            return;
          }
          document.getElementById('featuredIntrosTable').innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>User</th>
                  <th>Title</th>
                  <th>Body</th>
                  <th>CTA</th>
                  <th>Updated</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${intros.map(intro => `
                  <tr>
                    <td>${intro.user?.displayName || intro.user?.username || 'Unknown'}</td>
                    <td>${intro.title || '-'}</td>
                    <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${intro.body || '-'}</td>
                    <td>${intro.ctaText ? `<a href="${intro.ctaUrl || '#'}" target="_blank" style="color: #8B5CF6;">${intro.ctaText}</a>` : '-'}</td>
                    <td>${formatDate(intro.updatedAt)}</td>
                    <td>
                      <button class="action-btn action-btn-danger" data-action="delete-featured-intro" data-id="${intro.id}">Delete</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          renderProfilePagination('featuredIntrosPagination', total, 20, featuredIntrosPage, 'featuredIntros');
        }
      } catch (e) {
        console.error('Failed to load featured intros:', e);
      }
    }

    async function deleteFeaturedIntro(introId) {
      if (!confirm('Are you sure you want to delete this featured intro?')) return;
      try {
        const res = await fetch('/api/admin/profiles/intros/' + introId, {
          method: 'DELETE',
          credentials: 'include'
        });
        if (res.ok) {
          loadFeaturedIntros();
          loadProfileFeaturesStats();
        }
      } catch (e) {
        console.error('Failed to delete featured intro:', e);
      }
    }

    async function loadLinkedAccounts() {
      try {
        const url = `/api/admin/profiles/linked-accounts?page=${linkedAccountsPage}&limit=20` + (linkedAccountsSearchQuery ? `&search=${encodeURIComponent(linkedAccountsSearchQuery)}` : '');
        const res = await fetch(url, { credentials: 'include' });
        if (res.ok) {
          const { accounts, total } = await res.json();
          if (accounts.length === 0) {
            document.getElementById('linkedAccountsTable').innerHTML = '<div class="empty-state">No linked accounts found</div>';
            document.getElementById('linkedAccountsPagination').innerHTML = '';
            return;
          }
          document.getElementById('linkedAccountsTable').innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>Primary User</th>
                  <th>Linked User</th>
                  <th>Linked Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${accounts.map(acc => `
                  <tr>
                    <td>${acc.primaryUser?.displayName || acc.primaryUser?.username || 'Unknown'}</td>
                    <td>${acc.linkedUser?.displayName || acc.linkedUser?.username || 'Unknown'}</td>
                    <td>${formatDate(acc.linkedAt)}</td>
                    <td>
                      <button class="action-btn action-btn-danger" data-action="unlink-account" data-id="${acc.id}">Unlink</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          renderProfilePagination('linkedAccountsPagination', total, 20, linkedAccountsPage, 'linkedAccounts');
        }
      } catch (e) {
        console.error('Failed to load linked accounts:', e);
      }
    }

    function searchLinkedAccounts() {
      linkedAccountsSearchQuery = document.getElementById('linkedAccountsSearch').value;
      linkedAccountsPage = 1;
      loadLinkedAccounts();
    }

    async function unlinkAccount(accountId) {
      if (!confirm('Are you sure you want to unlink these accounts?')) return;
      try {
        const res = await fetch('/api/admin/profiles/linked-accounts/' + accountId, {
          method: 'DELETE',
          credentials: 'include'
        });
        if (res.ok) {
          loadLinkedAccounts();
          loadProfileFeaturesStats();
        }
      } catch (e) {
        console.error('Failed to unlink account:', e);
      }
    }

    async function loadUserNotes() {
      try {
        const url = `/api/admin/profiles/notes?page=${userNotesPage}&limit=20`;
        const res = await fetch(url, { credentials: 'include' });
        if (res.ok) {
          const { notes, total } = await res.json();
          if (notes.length === 0) {
            document.getElementById('userNotesTable').innerHTML = '<div class="empty-state">No user notes found</div>';
            document.getElementById('userNotesPagination').innerHTML = '';
            return;
          }
          document.getElementById('userNotesTable').innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>User</th>
                  <th>Content</th>
                  <th>Expires</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${notes.map(note => `
                  <tr>
                    <td>${note.user?.displayName || note.user?.username || 'Unknown'}</td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${note.content || '-'}</td>
                    <td>${formatDate(note.expiresAt)}</td>
                    <td>${formatDate(note.createdAt)}</td>
                    <td>
                      <button class="action-btn action-btn-danger" data-action="delete-user-note" data-id="${note.id}">Delete</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          renderProfilePagination('userNotesPagination', total, 20, userNotesPage, 'userNotes');
        }
      } catch (e) {
        console.error('Failed to load user notes:', e);
      }
    }

    async function deleteUserNote(noteId) {
      if (!confirm('Are you sure you want to delete this note?')) return;
      try {
        const res = await fetch('/api/admin/profiles/notes/' + noteId, {
          method: 'DELETE',
          credentials: 'include'
        });
        if (res.ok) {
          loadUserNotes();
          loadProfileFeaturesStats();
        }
      } catch (e) {
        console.error('Failed to delete user note:', e);
      }
    }

    function renderProfilePagination(containerId, total, limit, currentPage, type) {
      const totalPages = Math.ceil(total / limit);
      if (totalPages <= 1) {
        document.getElementById(containerId).innerHTML = '';
        return;
      }
      let prevFunc = '', nextFunc = '';
      if (type === 'featuredIntros') {
        prevFunc = `featuredIntrosPage = ${currentPage - 1}; loadFeaturedIntros();`;
        nextFunc = `featuredIntrosPage = ${currentPage + 1}; loadFeaturedIntros();`;
      } else if (type === 'linkedAccounts') {
        prevFunc = `linkedAccountsPage = ${currentPage - 1}; loadLinkedAccounts();`;
        nextFunc = `linkedAccountsPage = ${currentPage + 1}; loadLinkedAccounts();`;
      } else if (type === 'userNotes') {
        prevFunc = `userNotesPage = ${currentPage - 1}; loadUserNotes();`;
        nextFunc = `userNotesPage = ${currentPage + 1}; loadUserNotes();`;
      }
      let html = '<div style="display: flex; gap: 8px; justify-content: center; padding: 16px;">';
      if (currentPage > 1) {
        html += `<button class="action-btn" onclick="${prevFunc}">Prev</button>`;
      }
      html += `<span style="padding: 8px 12px;">Page ${currentPage} of ${totalPages}</span>`;
      if (currentPage < totalPages) {
        html += `<button class="action-btn" onclick="${nextFunc}">Next</button>`;
      }
      html += '</div>';
      document.getElementById(containerId).innerHTML = html;
    }

    async function loadReports() {
      console.log('[Admin] loadReports called');
      try {
        const url = '/api/admin/reports?status=' + reportFilter;
        const res = await fetch(url, { credentials: 'include' });
        console.log('[Admin] Reports response status:', res.status);
        if (res.ok) {
          const reports = await res.json();
          console.log('[Admin] Loaded', reports.length, 'reports');
          if (reports.length === 0) {
            document.getElementById('reportsTable').innerHTML = '<div class="empty-state">No reports found</div>';
            return;
          }
          document.getElementById('reportsTable').innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>Reporter</th>
                  <th>Reason</th>
                  <th>Target Type</th>
                  <th>Status</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${reports.map(r => {
                  const targetType = r.reportedPostId ? 'Post' : (r.reportedUserId ? 'User' : 'Unknown');
                  const targetInfo = r.reportedUser ? (r.reportedUser.displayName || r.reportedUser.username) : '';
                  return `
                  <tr>
                    <td>${r.reporter?.displayName || r.reporter?.username || 'Anonymous'}</td>
                    <td>${r.reason || 'Not specified'}</td>
                    <td>${targetType}${targetInfo ? ` (${targetInfo})` : ''}</td>
                    <td><span class="badge badge-${r.status === 'PENDING' ? 'pending' : 'resolved'}">${r.status}</span></td>
                    <td>${formatDate(r.createdAt)}</td>
                    <td>
                      ${r.status === 'PENDING' ? `
                        <button class="action-btn action-btn-success" data-action="resolve-report" data-id="${r.id}" data-status="RESOLVED">Resolve</button>
                        <button class="action-btn action-btn-primary" data-action="resolve-report" data-id="${r.id}" data-status="DISMISSED">Dismiss</button>
                      ` : ''}
                    </td>
                  </tr>
                `;}).join('')}
              </tbody>
            </table>
          `;
        }
      } catch (e) {
        console.error('Failed to load reports:', e);
      }
    }

    function setReportFilter(filter) {
      reportFilter = filter;
      document.querySelectorAll('#section-reports .filter-btn').forEach(b => b.classList.remove('active'));
      const activeBtn = document.querySelector('#section-reports .filter-btn[data-filter="' + filter + '"]');
      if (activeBtn) activeBtn.classList.add('active');
      loadReports();
    }

    async function resolveReport(reportId, status) {
      try {
        const res = await fetch('/api/admin/reports/' + reportId, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ status })
        });
        if (res.ok) {
          loadReports();
          loadPendingReportsCount();
        }
      } catch (e) {
        console.error('Failed to resolve report:', e);
      }
    }

    async function loadVerification() {
      try {
        const res = await fetch('/api/admin/verification', { credentials: 'include' });
        if (res.ok) {
          const requests = await res.json();
          if (requests.length === 0) {
            document.getElementById('verificationTable').innerHTML = '<div class="empty-state">No verification requests</div>';
            return;
          }
          document.getElementById('verificationTable').innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>User</th>
                  <th>Category</th>
                  <th>Status</th>
                  <th>Submitted</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${requests.map(r => `
                  <tr>
                    <td>${r.user?.displayName || r.user?.username || 'Unknown'}</td>
                    <td>${r.category || 'Not specified'}</td>
                    <td><span class="badge badge-${r.status === 'PENDING' ? 'pending' : r.status === 'APPROVED' ? 'verified' : 'suspended'}">${r.status}</span></td>
                    <td>${formatDate(r.createdAt)}</td>
                    <td>
                      ${r.status === 'PENDING' ? `
                        <button class="action-btn action-btn-success" data-action="handle-verification" data-id="${r.id}" data-decision="approve">Approve</button>
                        <button class="action-btn action-btn-danger" data-action="handle-verification" data-id="${r.id}" data-decision="reject">Reject</button>
                      ` : ''}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
      } catch (e) {
        console.error('Failed to load verification requests:', e);
      }
    }

    async function handleVerification(requestId, action) {
      try {
        const res = await fetch('/api/admin/verification/' + requestId + '/action', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ action })
        });
        if (res.ok) {
          loadVerification();
        }
      } catch (e) {
        console.error('Failed to handle verification:', e);
      }
    }

    async function loadRoles() {
      try {
        const res = await fetch('/api/admin/roles', { credentials: 'include' });
        if (res.ok) {
          const roles = await res.json();
          if (roles.length === 0) {
            document.getElementById('rolesTable').innerHTML = '<div class="empty-state">No roles found</div>';
            return;
          }
          document.getElementById('rolesTable').innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Description</th>
                  <th>System</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${roles.map(r => `
                  <tr>
                    <td><strong>${r.name}</strong></td>
                    <td>${r.description || '-'}</td>
                    <td>${r.isSystem ? '<span class="badge badge-admin">System</span>' : '-'}</td>
                    <td>
                      ${!r.isSystem ? `<button class="action-btn action-btn-danger" data-action="delete-role" data-id="${r.id}">Delete</button>` : ''}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
      } catch (e) {
        console.error('Failed to load roles:', e);
      }
    }

    function showCreateRoleModal() {
      document.getElementById('actionModalTitle').textContent = 'Create Role';
      document.getElementById('actionModalContent').innerHTML = `
        <div class="form-group">
          <label>Role Name</label>
          <input type="text" id="newRoleName" placeholder="e.g., Moderator">
        </div>
        <div class="form-group">
          <label>Description</label>
          <input type="text" id="newRoleDesc" placeholder="Role description">
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary" data-action="close-modal" data-modal="actionModal">Cancel</button>
          <button class="btn" data-action="create-role">Create</button>
        </div>
      `;
      openModal('actionModal');
    }

    async function createRole() {
      const name = document.getElementById('newRoleName').value;
      const description = document.getElementById('newRoleDesc').value;
      if (!name) return;
      
      try {
        const res = await fetch('/api/admin/roles', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ name, description })
        });
        if (res.ok) {
          closeModal('actionModal');
          loadRoles();
        }
      } catch (e) {
        console.error('Failed to create role:', e);
      }
    }

    async function deleteRole(roleId) {
      try {
        const res = await fetch('/api/admin/roles/' + roleId, {
          method: 'DELETE',
          credentials: 'include'
        });
        if (res.ok) {
          loadRoles();
        }
      } catch (e) {
        console.error('Failed to delete role:', e);
      }
    }

    async function loadSettings() {
      try {
        const res = await fetch('/api/admin/settings', { credentials: 'include' });
        if (res.ok) {
          const settingsArray = await res.json();
          settings = {};
          if (Array.isArray(settingsArray)) {
            settingsArray.forEach(s => {
              settings[s.key] = s.value === 'true' || s.value === true;
            });
          }
          renderSettings();
        }
      } catch (e) {
        console.error('Failed to load settings:', e);
      }
    }

    function renderSettings() {
      const settingsList = [
        { key: 'maintenanceMode', label: 'Maintenance Mode', desc: 'Put the app in maintenance mode', default: false },
        { key: 'signupEnabled', label: 'Signup Enabled', desc: 'Allow new user registrations', default: true },
        { key: 'chatEnabled', label: 'Chat Enabled', desc: 'Enable messaging feature', default: true },
        { key: 'storiesEnabled', label: 'Stories Enabled', desc: 'Enable stories feature', default: true },
        { key: 'gossipEnabled', label: 'Gossip Enabled', desc: 'Enable anonymous gossip feature', default: true },
      ];

      document.getElementById('settingsGrid').innerHTML = settingsList.map(s => {
        const isActive = settings[s.key] !== undefined ? settings[s.key] : s.default;
        return `
        <div class="setting-item">
          <div class="setting-info">
            <h4>${s.label}</h4>
            <p>${s.desc}</p>
          </div>
          <div class="toggle ${isActive ? 'active' : ''}" data-action="toggle-setting" data-key="${s.key}" data-value="${isActive}"></div>
        </div>
      `;}).join('');
    }

    async function toggleSetting(key, currentValue) {
      const newValue = !currentValue;
      try {
        const res = await fetch('/api/admin/settings', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ settings: [{ key, value: String(newValue), type: 'boolean' }] })
        });
        if (res.ok) {
          settings[key] = newValue;
          renderSettings();
        }
      } catch (e) {
        console.error('Failed to update setting:', e);
      }
    }

    // Gossip Management Functions
    async function loadGossip() {
      await Promise.all([
        loadGossipStats(),
        loadGossipPosts(),
        loadBlockedWords(),
        loadLocationStats()
      ]);
    }

    async function loadGossipStats() {
      try {
        const res = await fetch('/api/gossip/admin/stats', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          document.getElementById('gossipStats').innerHTML = `
            <div class="stat-card">
              <h3>Total Posts</h3>
              <div class="value">${formatNumber(data.totalPosts || 0)}</div>
            </div>
            <div class="stat-card">
              <h3>Posts Today</h3>
              <div class="value">${formatNumber(data.postsToday || 0)}</div>
            </div>
            <div class="stat-card">
              <h3>Reported Posts</h3>
              <div class="value" style="color: #EF4444;">${formatNumber(data.reportedPosts || 0)}</div>
            </div>
            <div class="stat-card">
              <h3>Hidden Posts</h3>
              <div class="value" style="color: #F59E0B;">${formatNumber(data.hiddenPosts || 0)}</div>
            </div>
            <div class="stat-card">
              <h3>Active Whispers</h3>
              <div class="value" style="color: #6366F1;">${formatNumber(data.activeWhispers || 0)}</div>
            </div>
            <div class="stat-card">
              <h3>Total Reactions</h3>
              <div class="value">${formatNumber(data.totalReactions || 0)}</div>
            </div>
          `;
        }
      } catch (e) {
        console.error('Failed to load gossip stats:', e);
        document.getElementById('gossipStats').innerHTML = '<div class="empty-state">Failed to load stats</div>';
      }
    }

    async function loadGossipPosts() {
      try {
        const res = await fetch('/api/gossip/admin/posts?filter=' + gossipFilter, { credentials: 'include' });
        if (res.ok) {
          gossipPosts = await res.json();
          renderGossipPosts();
        }
      } catch (e) {
        console.error('Failed to load gossip posts:', e);
        document.getElementById('gossipTable').innerHTML = '<div class="empty-state">Failed to load posts</div>';
      }
    }

    function renderGossipPosts() {
      if (gossipPosts.length === 0) {
        document.getElementById('gossipTable').innerHTML = '<div class="empty-state">No posts found</div>';
        return;
      }
      
      const reactionEmojis = { FIRE: 'üî•', MINDBLOWN: 'ü§Ø', LAUGH: 'üòÇ', SKULL: 'üíÄ', EYES: 'üëÄ' };
      
      document.getElementById('gossipTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Content</th>
              <th>Location</th>
              <th>Tea Meter</th>
              <th>Reactions</th>
              <th>Reports</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${gossipPosts.map(p => `
              <tr>
                <td style="max-width: 250px;">
                  <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(p.content)}</div>
                  ${p.isWhisper ? '<span class="badge" style="background: #6366F1; font-size: 10px;">Whisper</span>' : ''}
                  <div style="font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 4px;">${formatDate(p.createdAt)}</div>
                </td>
                <td><span style="font-size: 12px;">${p.locationDisplay || p.countryCode || 'Unknown'}</span></td>
                <td><span style="font-size: 18px; font-weight: 700; color: #8B5CF6;">${p.teaMeter || 0}</span></td>
                <td style="font-size: 12px;">
                  üî•${p.fireCount || 0} ü§Ø${p.mindblownCount || 0} üòÇ${p.laughCount || 0} üíÄ${p.skullCount || 0} üëÄ${p.eyesCount || 0}
                </td>
                <td>
                  <span class="badge ${p.reportCount >= 5 ? 'badge-inactive' : p.reportCount > 0 ? 'badge-pending' : 'badge-active'}">
                    ${p.reportCount || 0}
                  </span>
                </td>
                <td>
                  ${p.isRemovedByAdmin ? '<span class="badge badge-inactive">Removed</span>' : 
                    p.isHidden ? '<span class="badge badge-pending">Hidden</span>' : 
                    '<span class="badge badge-active">Visible</span>'}
                </td>
                <td>
                  <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                    ${!p.isRemovedByAdmin ? `
                      ${p.isHidden ? 
                        `<button class="action-btn action-btn-primary" style="font-size: 11px; padding: 4px 8px;" data-action="gossip-unhide" data-id="${p.id}">Unhide</button>` :
                        `<button class="action-btn action-btn-secondary" style="font-size: 11px; padding: 4px 8px;" data-action="gossip-hide" data-id="${p.id}">Hide</button>`
                      }
                      <button class="action-btn action-btn-danger" style="font-size: 11px; padding: 4px 8px;" data-action="gossip-remove" data-id="${p.id}">Remove</button>
                    ` : ''}
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function setGossipFilter(filter) {
      gossipFilter = filter;
      document.querySelectorAll('[data-action="gossip-filter"]').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-filter') === filter);
      });
      loadGossipPosts();
    }

    async function hideGossipPost(id) {
      try {
        await fetch('/api/gossip/admin/posts/' + id + '/hide', { method: 'POST', credentials: 'include' });
        loadGossipPosts();
        loadGossipStats();
      } catch (e) {
        console.error('Failed to hide post:', e);
      }
    }

    async function unhideGossipPost(id) {
      try {
        await fetch('/api/gossip/admin/posts/' + id + '/unhide', { method: 'POST', credentials: 'include' });
        loadGossipPosts();
        loadGossipStats();
      } catch (e) {
        console.error('Failed to unhide post:', e);
      }
    }

    async function removeGossipPost(id) {
      if (!confirm('Are you sure you want to permanently remove this post?')) return;
      try {
        await fetch('/api/gossip/admin/posts/' + id + '/remove', { method: 'POST', credentials: 'include' });
        loadGossipPosts();
        loadGossipStats();
      } catch (e) {
        console.error('Failed to remove post:', e);
      }
    }

    async function loadBlockedWords() {
      try {
        const res = await fetch('/api/gossip/admin/blocked-words', { credentials: 'include' });
        if (res.ok) {
          blockedWords = await res.json();
          renderBlockedWords();
        }
      } catch (e) {
        console.error('Failed to load blocked words:', e);
        document.getElementById('blockedWordsGrid').innerHTML = '<div class="empty-state">Failed to load</div>';
      }
    }

    function renderBlockedWords() {
      if (blockedWords.length === 0) {
        document.getElementById('blockedWordsGrid').innerHTML = '<div style="color: rgba(255,255,255,0.5);">No blocked words</div>';
        return;
      }
      
      document.getElementById('blockedWordsGrid').innerHTML = blockedWords.map(w => `
        <div style="display: flex; align-items: center; gap: 6px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 20px; padding: 6px 12px; font-size: 12px;">
          <span>${escapeHtml(w.word)}</span>
          <button style="background: none; border: none; color: #EF4444; cursor: pointer; font-size: 16px; line-height: 1;" data-action="remove-blocked-word" data-id="${w.id}">&times;</button>
        </div>
      `).join('');
    }

    async function addBlockedWord() {
      const input = document.getElementById('newBlockedWord');
      const word = input.value.trim().toLowerCase();
      if (!word) return;
      
      try {
        await fetch('/api/gossip/admin/blocked-words', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ word })
        });
        input.value = '';
        loadBlockedWords();
      } catch (e) {
        console.error('Failed to add blocked word:', e);
      }
    }

    async function removeBlockedWord(id) {
      try {
        await fetch('/api/gossip/admin/blocked-words/' + id, { method: 'DELETE', credentials: 'include' });
        loadBlockedWords();
      } catch (e) {
        console.error('Failed to remove blocked word:', e);
      }
    }

    async function loadLocationStats() {
      try {
        const res = await fetch('/api/gossip/admin/location-stats', { credentials: 'include' });
        if (res.ok) {
          const stats = await res.json();
          if (stats.length === 0) {
            document.getElementById('locationStatsTable').innerHTML = '<div class="empty-state">No location stats yet</div>';
            return;
          }
          document.getElementById('locationStatsTable').innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>Location</th>
                  <th>Total Posts</th>
                  <th>Today</th>
                  <th>This Week</th>
                  <th>Streak</th>
                  <th>Milestone</th>
                </tr>
              </thead>
              <tbody>
                ${stats.slice(0, 20).map(s => `
                  <tr>
                    <td>${s.locationDisplay || s.locationId}</td>
                    <td>${formatNumber(s.totalPosts)}</td>
                    <td>${formatNumber(s.postsToday)}</td>
                    <td>${formatNumber(s.postsThisWeek)}</td>
                    <td>${s.streakDays} days</td>
                    <td>${s.milestoneReached > 0 ? formatNumber(s.milestoneReached) : '-'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
      } catch (e) {
        console.error('Failed to load location stats:', e);
        document.getElementById('locationStatsTable').innerHTML = '<div class="empty-state">Failed to load</div>';
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function loadPendingGossipReports() {
      try {
        const res = await fetch('/api/gossip/admin/stats', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          document.getElementById('gossipReportsCount').textContent = data.reportedPosts || 0;
        }
      } catch (e) {}
    }

    async function loadAudit() {
      try {
        const res = await fetch('/api/admin/audit-logs', { credentials: 'include' });
        if (res.ok) {
          const logs = await res.json();
          if (logs.length === 0) {
            document.getElementById('auditTable').innerHTML = '<div class="empty-state">No audit logs found</div>';
            return;
          }
          document.getElementById('auditTable').innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>Action</th>
                  <th>User</th>
                  <th>Details</th>
                  <th>Timestamp</th>
                </tr>
              </thead>
              <tbody>
                ${logs.map(l => `
                  <tr>
                    <td><span class="badge badge-active">${l.action || 'Unknown'}</span></td>
                    <td>${l.user?.displayName || l.user?.username || l.userId || 'System'}</td>
                    <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${l.details || '-'}</td>
                    <td>${formatDate(l.createdAt)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
      } catch (e) {
        console.error('Failed to load audit logs:', e);
      }
    }

    // Messages Section
    let allConversations = [];
    async function loadMessages() {
      try {
        const res = await fetch('/api/admin/messages/stats', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          document.getElementById('messagesStats').innerHTML = `
            <div class="stat-card">
              <h3>Total Conversations</h3>
              <div class="value">${formatNumber(data.totalConversations || 0)}</div>
            </div>
            <div class="stat-card">
              <h3>Messages (24h)</h3>
              <div class="value">${formatNumber(data.messages24h || 0)}</div>
            </div>
            <div class="stat-card">
              <h3>Active Chats</h3>
              <div class="value">${formatNumber(data.activeChats || 0)}</div>
            </div>
            <div class="stat-card">
              <h3>Reported Messages</h3>
              <div class="value">${formatNumber(data.reportedMessages || 0)}</div>
            </div>
          `;
        }
        
        const convRes = await fetch('/api/admin/messages/conversations', { credentials: 'include' });
        if (convRes.ok) {
          allConversations = await convRes.json();
          renderConversations();
        }
      } catch (e) {
        console.error('Failed to load messages:', e);
        document.getElementById('messagesStats').innerHTML = '<div class="stat-card"><h3>Messages</h3><div class="value">-</div></div>';
        document.getElementById('conversationsTable').innerHTML = '<div class="empty-state">Unable to load conversations</div>';
      }
    }

    function renderConversations() {
      const search = (document.getElementById('conversationSearch')?.value || '').toLowerCase();
      let filtered = allConversations;
      if (search) {
        filtered = allConversations.filter(c => 
          c.participant1?.username?.toLowerCase().includes(search) ||
          c.participant2?.username?.toLowerCase().includes(search)
        );
      }
      
      if (filtered.length === 0) {
        document.getElementById('conversationsTable').innerHTML = '<div class="empty-state">No conversations found</div>';
        return;
      }
      
      document.getElementById('conversationsTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Participants</th>
              <th>Messages</th>
              <th>Last Activity</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.slice(0, 100).map(c => `
              <tr>
                <td>${escapeHtml(c.participant1?.username || 'Unknown')} &harr; ${escapeHtml(c.participant2?.username || 'Unknown')}</td>
                <td>${c.messageCount || 0}</td>
                <td>${formatDate(c.lastMessageAt)}</td>
                <td><span class="badge ${c.isActive ? 'badge-active' : 'badge-inactive'}">${c.isActive ? 'Active' : 'Inactive'}</span></td>
                <td>
                  <button class="action-btn" onclick="viewConversationMessages('${c.id}')" title="View Messages">View Messages</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // Message Moderation Variables
    let messageSearchPage = 1;
    let messageSearchTerm = '';
    let currentConversationId = null;
    let conversationMessagesPage = 1;
    let flagTargetMessageId = null;
    let flaggedMessagesPage = 1;
    let currentMessagesTab = 'conversations';

    function setMessagesTab(tab) {
      currentMessagesTab = tab;
      document.querySelectorAll('#messagesTabFilters .filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tab);
      });
      document.getElementById('conversationsCard').style.display = tab === 'conversations' ? 'block' : 'none';
      document.getElementById('messageSearchCard').style.display = tab === 'search' ? 'block' : 'none';
      document.getElementById('flaggedMessagesCard').style.display = tab === 'flagged' ? 'block' : 'none';
      
      if (tab === 'flagged') {
        loadFlaggedMessages();
      }
    }

    async function searchMessages() {
      const searchInput = document.getElementById('messageSearchInput');
      const term = searchInput?.value?.trim() || '';
      if (!term) {
        document.getElementById('messageSearchResults').innerHTML = '<div class="empty-state">Enter a search term to find messages</div>';
        return;
      }
      
      messageSearchTerm = term;
      messageSearchPage = 1;
      await loadMessageSearchResults();
    }

    async function loadMessageSearchResults() {
      try {
        const res = await fetch(`/api/admin/messages/search?search=${encodeURIComponent(messageSearchTerm)}&page=${messageSearchPage}&limit=20`, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to search');
        
        const data = await res.json();
        
        if (!data.messages || data.messages.length === 0) {
          document.getElementById('messageSearchResults').innerHTML = '<div class="empty-state">No messages found matching your search</div>';
          document.getElementById('messageSearchPagination').innerHTML = '';
          return;
        }
        
        document.getElementById('messageSearchResults').innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Sender</th>
                <th>Content</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${data.messages.map(m => `
                <tr>
                  <td>${escapeHtml(m.sender?.username || 'Unknown')}</td>
                  <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(m.content || '')}">${escapeHtml((m.content || '').substring(0, 100))}${(m.content || '').length > 100 ? '...' : ''}</td>
                  <td>${formatDate(m.createdAt)}</td>
                  <td>
                    <button class="action-btn" onclick="viewMessageDetail('${m.id}', '${escapeHtml(m.sender?.username || 'Unknown')}', \`${escapeHtml(m.content || '').replace(/`/g, '\\`')}\`, '${m.createdAt}', '${m.conversationId}')">View</button>
                    <button class="action-btn" onclick="viewConversationMessages('${m.conversationId}')">Thread</button>
                    <button class="action-btn action-btn-warning" onclick="showFlagModal('${m.id}')">Flag</button>
                    <button class="action-btn action-btn-danger" onclick="deleteMessage('${m.id}')">Delete</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
        
        const totalPages = Math.ceil(data.total / 20);
        let paginationHtml = '';
        if (totalPages > 1) {
          paginationHtml += `<button class="action-btn" ${messageSearchPage <= 1 ? 'disabled' : ''} onclick="changeMessageSearchPage(${messageSearchPage - 1})">Prev</button>`;
          paginationHtml += `<span style="padding: 8px 12px;">${messageSearchPage} / ${totalPages}</span>`;
          paginationHtml += `<button class="action-btn" ${messageSearchPage >= totalPages ? 'disabled' : ''} onclick="changeMessageSearchPage(${messageSearchPage + 1})">Next</button>`;
        }
        document.getElementById('messageSearchPagination').innerHTML = paginationHtml;
      } catch (e) {
        console.error('Failed to search messages:', e);
        document.getElementById('messageSearchResults').innerHTML = '<div class="empty-state" style="color: #EF4444;">Error searching messages</div>';
      }
    }

    function changeMessageSearchPage(page) {
      messageSearchPage = page;
      loadMessageSearchResults();
    }

    async function viewConversationMessages(conversationId) {
      currentConversationId = conversationId;
      conversationMessagesPage = 1;
      document.getElementById('conversationMessagesModal').style.display = 'flex';
      await loadConversationMessages();
    }

    async function loadConversationMessages() {
      try {
        const res = await fetch(`/api/admin/conversations/${currentConversationId}/messages?page=${conversationMessagesPage}&limit=30`, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load');
        
        const data = await res.json();
        
        if (!data.messages || data.messages.length === 0) {
          document.getElementById('conversationMessagesContent').innerHTML = '<div class="empty-state">No messages in this conversation</div>';
          return;
        }
        
        document.getElementById('conversationMessagesContent').innerHTML = `
          <div style="display: flex; flex-direction: column; gap: 12px;">
            ${data.messages.map(m => `
              <div style="background: rgba(139, 92, 246, 0.1); border-radius: 12px; padding: 12px; border: 1px solid rgba(139, 92, 246, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                  <strong style="color: #8B5CF6;">${escapeHtml(m.sender?.username || 'Unknown')}</strong>
                  <span style="font-size: 11px; color: rgba(255,255,255,0.5);">${formatDate(m.createdAt)}</span>
                </div>
                <p style="margin: 0 0 8px 0; word-break: break-word;">${escapeHtml(m.content || '')}</p>
                <div style="display: flex; gap: 8px;">
                  <button class="action-btn action-btn-warning" onclick="showFlagModal('${m.id}')" style="font-size: 11px; padding: 4px 8px;">Flag</button>
                  <button class="action-btn action-btn-danger" onclick="deleteMessageFromThread('${m.id}')" style="font-size: 11px; padding: 4px 8px;">Delete</button>
                </div>
              </div>
            `).join('')}
          </div>
        `;
        
        const totalPages = Math.ceil(data.total / 30);
        let paginationHtml = '';
        if (totalPages > 1) {
          paginationHtml += `<button class="action-btn" ${conversationMessagesPage <= 1 ? 'disabled' : ''} onclick="changeConversationPage(${conversationMessagesPage - 1})">Prev</button>`;
          paginationHtml += `<span style="padding: 8px 12px;">${conversationMessagesPage} / ${totalPages}</span>`;
          paginationHtml += `<button class="action-btn" ${conversationMessagesPage >= totalPages ? 'disabled' : ''} onclick="changeConversationPage(${conversationMessagesPage + 1})">Next</button>`;
        }
        document.getElementById('conversationMessagesPagination').innerHTML = paginationHtml;
      } catch (e) {
        console.error('Failed to load conversation messages:', e);
        document.getElementById('conversationMessagesContent').innerHTML = '<div class="empty-state" style="color: #EF4444;">Error loading messages</div>';
      }
    }

    function changeConversationPage(page) {
      conversationMessagesPage = page;
      loadConversationMessages();
    }

    function closeConversationModal() {
      document.getElementById('conversationMessagesModal').style.display = 'none';
      currentConversationId = null;
    }

    function viewMessageDetail(messageId, sender, content, date, conversationId) {
      document.getElementById('messageDetailContent').innerHTML = `
        <div style="margin-bottom: 16px;">
          <label style="color: rgba(255,255,255,0.6); font-size: 12px;">Sender</label>
          <p style="margin: 4px 0; font-weight: 600;">${escapeHtml(sender)}</p>
        </div>
        <div style="margin-bottom: 16px;">
          <label style="color: rgba(255,255,255,0.6); font-size: 12px;">Date</label>
          <p style="margin: 4px 0;">${formatDate(date)}</p>
        </div>
        <div style="margin-bottom: 16px;">
          <label style="color: rgba(255,255,255,0.6); font-size: 12px;">Message Content</label>
          <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; margin-top: 4px; word-break: break-word;">
            ${escapeHtml(content)}
          </div>
        </div>
      `;
      
      document.getElementById('messageDetailActions').innerHTML = `
        <button class="action-btn" onclick="viewConversationMessages('${conversationId}'); closeMessageDetailModal();">View Thread</button>
        <button class="action-btn action-btn-warning" onclick="showFlagModal('${messageId}'); closeMessageDetailModal();">Flag</button>
        <button class="action-btn action-btn-danger" onclick="deleteMessage('${messageId}'); closeMessageDetailModal();">Delete</button>
      `;
      
      document.getElementById('messageDetailModal').style.display = 'flex';
    }

    function closeMessageDetailModal() {
      document.getElementById('messageDetailModal').style.display = 'none';
    }

    async function deleteMessage(messageId) {
      if (!confirm('Are you sure you want to delete this message? This action cannot be undone.')) return;
      
      try {
        const res = await fetch(`/api/admin/messages/${messageId}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (res.ok) {
          alert('Message deleted successfully');
          if (messageSearchTerm) loadMessageSearchResults();
        } else {
          alert('Failed to delete message');
        }
      } catch (e) {
        console.error('Failed to delete message:', e);
        alert('Error deleting message');
      }
    }

    async function deleteMessageFromThread(messageId) {
      if (!confirm('Are you sure you want to delete this message?')) return;
      
      try {
        const res = await fetch(`/api/admin/messages/${messageId}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (res.ok) {
          await loadConversationMessages();
        } else {
          alert('Failed to delete message');
        }
      } catch (e) {
        console.error('Failed to delete message:', e);
        alert('Error deleting message');
      }
    }

    function showFlagModal(messageId) {
      flagTargetMessageId = messageId;
      document.getElementById('flagReasonInput').value = '';
      document.getElementById('flagMessageModal').style.display = 'flex';
    }

    function closeFlagModal() {
      document.getElementById('flagMessageModal').style.display = 'none';
      flagTargetMessageId = null;
    }

    async function submitFlagMessage() {
      const reason = document.getElementById('flagReasonInput')?.value?.trim();
      if (!reason) {
        alert('Please enter a reason for flagging this message');
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/messages/${flagTargetMessageId}/flag`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ reason })
        });
        
        if (res.ok) {
          alert('Message flagged successfully');
          closeFlagModal();
        } else {
          const data = await res.json();
          alert(data.message || 'Failed to flag message');
        }
      } catch (e) {
        console.error('Failed to flag message:', e);
        alert('Error flagging message');
      }
    }

    async function loadFlaggedMessages() {
      try {
        const res = await fetch(`/api/admin/messages/flagged?page=${flaggedMessagesPage}&limit=20`, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load');
        
        const data = await res.json();
        
        if (!data.reports || data.reports.length === 0) {
          document.getElementById('flaggedMessagesTable').innerHTML = '<div class="empty-state">No flagged messages</div>';
          document.getElementById('flaggedMessagesPagination').innerHTML = '';
          return;
        }
        
        document.getElementById('flaggedMessagesTable').innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Flagged User</th>
                <th>Reason</th>
                <th>Details</th>
                <th>Date</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${data.reports.map(r => `
                <tr>
                  <td>${escapeHtml(r.reportedUser?.username || 'Unknown')}</td>
                  <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml((r.reason || '').replace('[MESSAGE FLAG] ', ''))}</td>
                  <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(r.adminNotes || '')}">${escapeHtml((r.adminNotes || '').substring(0, 100))}...</td>
                  <td>${formatDate(r.createdAt)}</td>
                  <td><span class="badge badge-${r.status?.toLowerCase() || 'pending'}">${r.status || 'PENDING'}</span></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
        
        const totalPages = Math.ceil(data.total / 20);
        let paginationHtml = '';
        if (totalPages > 1) {
          paginationHtml += `<button class="action-btn" ${flaggedMessagesPage <= 1 ? 'disabled' : ''} onclick="changeFlaggedPage(${flaggedMessagesPage - 1})">Prev</button>`;
          paginationHtml += `<span style="padding: 8px 12px;">${flaggedMessagesPage} / ${totalPages}</span>`;
          paginationHtml += `<button class="action-btn" ${flaggedMessagesPage >= totalPages ? 'disabled' : ''} onclick="changeFlaggedPage(${flaggedMessagesPage + 1})">Next</button>`;
        }
        document.getElementById('flaggedMessagesPagination').innerHTML = paginationHtml;
      } catch (e) {
        console.error('Failed to load flagged messages:', e);
        document.getElementById('flaggedMessagesTable').innerHTML = '<div class="empty-state" style="color: #EF4444;">Error loading flagged messages</div>';
      }
    }

    function changeFlaggedPage(page) {
      flaggedMessagesPage = page;
      loadFlaggedMessages();
    }

    // Groups Section
    let allGroups = [];
    async function loadGroups() {
      try {
        const res = await fetch('/api/admin/groups/stats', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          document.getElementById('groupsStats').innerHTML = `
            <div class="stat-card">
              <h3>Total Groups</h3>
              <div class="value">${formatNumber(data.totalGroups || 0)}</div>
            </div>
            <div class="stat-card">
              <h3>Active Groups</h3>
              <div class="value">${formatNumber(data.activeGroups || 0)}</div>
            </div>
            <div class="stat-card">
              <h3>Total Members</h3>
              <div class="value">${formatNumber(data.totalMembers || 0)}</div>
            </div>
            <div class="stat-card">
              <h3>New Groups (7d)</h3>
              <div class="value">${formatNumber(data.newGroups7d || 0)}</div>
            </div>
          `;
        }
        
        const groupsRes = await fetch('/api/admin/groups', { credentials: 'include' });
        if (groupsRes.ok) {
          allGroups = await groupsRes.json();
          renderGroups();
        }
      } catch (e) {
        console.error('Failed to load groups:', e);
        document.getElementById('groupsStats').innerHTML = '<div class="stat-card"><h3>Groups</h3><div class="value">-</div></div>';
        document.getElementById('groupsTable').innerHTML = '<div class="empty-state">Unable to load groups</div>';
      }
    }

    function renderGroups() {
      const search = (document.getElementById('groupSearch')?.value || '').toLowerCase();
      let filtered = allGroups;
      if (search) {
        filtered = allGroups.filter(g => g.name?.toLowerCase().includes(search));
      }
      
      if (filtered.length === 0) {
        document.getElementById('groupsTable').innerHTML = '<div class="empty-state">No groups found</div>';
        return;
      }
      
      document.getElementById('groupsTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Owner</th>
              <th>Members</th>
              <th>Privacy</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.slice(0, 100).map(g => `
              <tr>
                <td><strong>${escapeHtml(g.name || 'Unnamed')}</strong></td>
                <td>${g.owner?.username || 'Unknown'}</td>
                <td>${g.memberCount || 0}</td>
                <td><span class="badge ${g.isPrivate ? 'badge-inactive' : 'badge-active'}">${g.isPrivate ? 'Private' : 'Public'}</span></td>
                <td>${formatDate(g.createdAt)}</td>
                <td style="display: flex; gap: 4px; flex-wrap: wrap;">
                  <button class="action-btn action-btn-primary" data-action="view-group-members" data-id="${g.id}" data-name="${escapeHtml(g.name || 'Group')}">Members</button>
                  <button class="action-btn" data-action="edit-group-settings" data-id="${g.id}">Settings</button>
                  <button class="action-btn action-btn-danger" data-action="delete-group" data-id="${g.id}">Delete</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // Live Streams Section
    let allLivestreams = [];
    let livestreamFilter = 'all';
    async function loadLivestreams() {
      try {
        const res = await fetch('/api/admin/livestreams/stats', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          document.getElementById('livestreamsStats').innerHTML = `
            <div class="stat-card">
              <h3>Total Streams</h3>
              <div class="value">${formatNumber(data.totalStreams || 0)}</div>
            </div>
            <div class="stat-card">
              <h3>Live Now</h3>
              <div class="value" style="color: #22c55e;">${formatNumber(data.liveNow || 0)}</div>
            </div>
            <div class="stat-card">
              <h3>Total Viewers</h3>
              <div class="value">${formatNumber(data.totalViewers || 0)}</div>
            </div>
            <div class="stat-card">
              <h3>Streams (7d)</h3>
              <div class="value">${formatNumber(data.streams7d || 0)}</div>
            </div>
          `;
        }
        
        const streamsRes = await fetch('/api/admin/livestreams', { credentials: 'include' });
        if (streamsRes.ok) {
          allLivestreams = await streamsRes.json();
          renderLivestreams();
        }
      } catch (e) {
        console.error('Failed to load livestreams:', e);
        document.getElementById('livestreamsStats').innerHTML = '<div class="stat-card"><h3>Streams</h3><div class="value">-</div></div>';
        document.getElementById('livestreamsTable').innerHTML = '<div class="empty-state">Unable to load streams</div>';
      }
    }

    function setLivestreamFilter(filter) {
      livestreamFilter = filter;
      document.querySelectorAll('#section-livestreams .filter-btn').forEach(b => b.classList.remove('active'));
      const btn = document.querySelector('#section-livestreams .filter-btn[data-filter="' + filter + '"]');
      if (btn) btn.classList.add('active');
      renderLivestreams();
    }

    function renderLivestreams() {
      let filtered = allLivestreams;
      if (livestreamFilter === 'live') {
        filtered = allLivestreams.filter(s => s.status === 'LIVE');
      } else if (livestreamFilter === 'ended') {
        filtered = allLivestreams.filter(s => s.status === 'ENDED');
      }
      
      if (filtered.length === 0) {
        document.getElementById('livestreamsTable').innerHTML = '<div class="empty-state">No streams found</div>';
        return;
      }
      
      document.getElementById('livestreamsTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Host</th>
              <th>Title</th>
              <th>Viewers</th>
              <th>Status</th>
              <th>Started</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.slice(0, 100).map(s => `
              <tr>
                <td>${s.host?.username || 'Unknown'}</td>
                <td>${escapeHtml(s.title || 'Untitled')}</td>
                <td><a href="#" onclick="viewStreamViewers('${s.id}', '${escapeHtml(s.title || 'Stream')}'); return false;" style="color: #8b5cf6; text-decoration: underline;">${s.viewerCount || 0} viewers</a></td>
                <td><span class="badge ${s.status === 'LIVE' ? 'badge-active' : 'badge-inactive'}">${s.status || 'Unknown'}</span></td>
                <td>${formatDate(s.startedAt)}</td>
                <td style="display: flex; gap: 4px;">
                  <button class="action-btn action-btn-primary" onclick="viewStreamViewers('${s.id}', '${escapeHtml(s.title || 'Stream')}')">Viewers</button>
                  ${s.status === 'LIVE' ? `<button class="action-btn action-btn-danger" data-action="end-stream" data-id="${s.id}">End</button>` : ''}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // Wallet & Economy Section - Enhanced
    let allWallets = [];
    let allGiftTypes = [];
    let allCoinBundles = [];
    let allWithdrawals = [];
    let allKycSubmissions = [];
    let currentKycId = null;
    let withdrawalFilter = '';
    let kycFilter = '';

    async function loadWallet() {
      await loadEconomyStats();
      await loadAdminWallets();
      await loadGiftTypes();
      await loadCoinBundles();
      await loadWithdrawals();
      await loadKycSubmissions();
    }

    function showWalletTab(tab) {
      document.querySelectorAll('.wallet-tab').forEach(el => el.style.display = 'none');
      document.querySelectorAll('#section-wallet .tab-btn').forEach(btn => btn.classList.remove('active'));
      const tabEl = document.getElementById('walletTab-' + tab);
      if (tabEl) tabEl.style.display = 'block';
      event.target.classList.add('active');
    }

    async function loadEconomyStats() {
      try {
        const res = await fetch('/api/admin/economy/stats', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          document.getElementById('stat-total-coins').textContent = formatNumber(data.totalCoins || 0);
          document.getElementById('stat-active-wallets').textContent = formatNumber(data.activeWallets || 0);
          document.getElementById('stat-frozen-wallets').textContent = formatNumber(data.frozenWallets || 0);
          document.getElementById('stat-daily-tx').textContent = formatNumber(data.dailyTransactions || 0);
          document.getElementById('stat-weekly-tx').textContent = formatNumber(data.weeklyTransactions || 0);
          document.getElementById('stat-pending-withdrawals').textContent = formatNumber(data.pendingWithdrawals || 0);
          document.getElementById('stat-kyc-pending').textContent = formatNumber(data.kycPending || 0);
          document.getElementById('stat-avg-balance').textContent = formatNumber(data.avgBalance || 0);
        }
      } catch (e) {
        console.error('Failed to load economy stats:', e);
      }
    }

    async function loadAdminWallets() {
      try {
        const res = await fetch('/api/admin/wallets', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          allWallets = Array.isArray(data) ? data : (data.wallets || []);
          renderWallets();
        }
      } catch (e) {
        console.error('Failed to load wallets:', e);
        document.getElementById('walletsTable').innerHTML = '<div class="empty-state">Unable to load wallets</div>';
      }
    }

    function filterWallets() {
      renderWallets();
    }

    function renderWallets() {
      const search = (document.getElementById('walletSearch')?.value || '').toLowerCase();
      const frozenFilter = document.getElementById('walletFrozenFilter')?.value || '';
      
      let filtered = allWallets;
      if (search) {
        filtered = filtered.filter(w => w.user?.username?.toLowerCase().includes(search) || w.username?.toLowerCase().includes(search));
      }
      if (frozenFilter === 'frozen') {
        filtered = filtered.filter(w => w.frozen || w.isFrozen);
      } else if (frozenFilter === 'active') {
        filtered = filtered.filter(w => !w.frozen && !w.isFrozen);
      }
      
      if (filtered.length === 0) {
        document.getElementById('walletsTable').innerHTML = '<div class="empty-state">No wallets found</div>';
        return;
      }
      
      document.getElementById('walletsTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Balance</th>
              <th>Lifetime Earned</th>
              <th>Lifetime Spent</th>
              <th>Frozen</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.slice(0, 100).map(w => {
              const username = w.user?.username || w.username || 'Unknown';
              const isFrozen = w.frozen || w.isFrozen || false;
              return `
              <tr>
                <td>
                  <div class="user-cell">
                    <div class="avatar">${username.charAt(0).toUpperCase()}</div>
                    <span>${escapeHtml(username)}</span>
                  </div>
                </td>
                <td style="font-weight: 600; color: #8B5CF6;">${formatNumber(w.balance || 0)}</td>
                <td style="color: #10B981;">+${formatNumber(w.lifetimeEarned || 0)}</td>
                <td style="color: #EF4444;">-${formatNumber(w.lifetimeSpent || 0)}</td>
                <td><span class="badge ${isFrozen ? 'badge-suspended' : 'badge-active'}">${isFrozen ? 'Frozen' : 'Active'}</span></td>
                <td>
                  <button class="action-btn action-btn-primary" onclick="adjustWalletBalance('${w.userId || w.id}', '${escapeHtml(username)}', ${w.balance || 0})">Adjust</button>
                  <button class="action-btn ${isFrozen ? 'action-btn-success' : 'action-btn-danger'}" onclick="toggleWalletFreeze('${w.userId || w.id}', ${!isFrozen})">${isFrozen ? 'Unfreeze' : 'Freeze'}</button>
                </td>
              </tr>
            `;}).join('')}
          </tbody>
        </table>
      `;
    }

    function adjustWalletBalance(userId, username, currentBalance) {
      document.getElementById('adjustBalanceUserId').value = userId;
      document.getElementById('adjustBalanceUsername').value = username;
      document.getElementById('adjustBalanceCurrent').value = currentBalance + ' coins';
      document.getElementById('adjustBalanceAmount').value = '';
      document.getElementById('adjustBalanceReason').value = '';
      document.getElementById('adjustBalanceModal').classList.add('active');
    }

    async function submitAdjustBalance(e) {
      e.preventDefault();
      const userId = document.getElementById('adjustBalanceUserId').value;
      const amount = parseInt(document.getElementById('adjustBalanceAmount').value);
      const reason = document.getElementById('adjustBalanceReason').value;
      
      try {
        const res = await fetch('/api/admin/wallets/' + userId + '/adjust', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ amount, reason })
        });
        
        if (res.ok) {
          closeModal('adjustBalanceModal');
          await loadAdminWallets();
          await loadEconomyStats();
          alert('Balance adjusted successfully');
        } else {
          const err = await res.json();
          alert('Failed: ' + (err.error || 'Unknown error'));
        }
      } catch (e) {
        console.error('Failed to adjust balance:', e);
        alert('Failed to adjust balance');
      }
    }

    async function toggleWalletFreeze(userId, freeze) {
      if (!confirm(freeze ? 'Are you sure you want to freeze this wallet?' : 'Are you sure you want to unfreeze this wallet?')) return;
      
      try {
        const res = await fetch('/api/admin/wallets/' + userId + '/freeze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ frozen: freeze })
        });
        
        if (res.ok) {
          await loadAdminWallets();
          await loadEconomyStats();
        } else {
          alert('Failed to update wallet status');
        }
      } catch (e) {
        console.error('Failed to freeze/unfreeze wallet:', e);
        alert('Failed to update wallet status');
      }
    }

    async function loadGiftTypes() {
      try {
        const res = await fetch('/api/admin/gift-types', { credentials: 'include' });
        if (res.ok) {
          allGiftTypes = await res.json();
          renderGiftTypes();
        }
      } catch (e) {
        console.error('Failed to load gift types:', e);
        document.getElementById('giftTypesTable').innerHTML = '<div class="empty-state">Unable to load gift types</div>';
      }
    }

    function renderGiftTypes() {
      if (allGiftTypes.length === 0) {
        document.getElementById('giftTypesTable').innerHTML = '<div class="empty-state">No gift types configured</div>';
        return;
      }
      
      document.getElementById('giftTypesTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Icon</th>
              <th>Coin Cost</th>
              <th>Net Worth Value</th>
              <th>Category</th>
              <th>Active</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${allGiftTypes.map(g => `
              <tr>
                <td>${escapeHtml(g.name || 'Unnamed')}</td>
                <td style="font-size: 24px;">${g.icon || '-'}</td>
                <td style="color: #8B5CF6; font-weight: 600;">${formatNumber(g.cost || g.coinCost || 0)}</td>
                <td style="color: #10B981;">${formatNumber(g.netWorthValue || 0)}</td>
                <td><span class="badge badge-active">${g.category || 'basic'}</span></td>
                <td><span class="badge ${g.isActive !== false ? 'badge-active' : 'badge-suspended'}">${g.isActive !== false ? 'Active' : 'Inactive'}</span></td>
                <td>
                  <button class="action-btn action-btn-primary" onclick="editGiftType('${g.id}')">Edit</button>
                  <button class="action-btn action-btn-danger" onclick="deleteGiftType('${g.id}')">Delete</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function openGiftTypeModal(data = null) {
      document.getElementById('giftTypeModalTitle').textContent = data ? 'Edit Gift Type' : 'Add Gift Type';
      document.getElementById('giftTypeId').value = data?.id || '';
      document.getElementById('giftTypeName').value = data?.name || '';
      document.getElementById('giftTypeIcon').value = data?.icon || '';
      document.getElementById('giftTypeCategory').value = data?.category || 'basic';
      document.getElementById('giftTypeCost').value = data?.cost || data?.coinCost || '';
      document.getElementById('giftTypeNetWorth').value = data?.netWorthValue || '';
      document.getElementById('giftTypeActive').checked = data?.isActive !== false;
      document.getElementById('giftTypeModal').classList.add('active');
    }

    function editGiftType(id) {
      const gift = allGiftTypes.find(g => g.id === id);
      if (gift) openGiftTypeModal(gift);
    }

    async function submitGiftType(e) {
      e.preventDefault();
      const id = document.getElementById('giftTypeId').value;
      const data = {
        name: document.getElementById('giftTypeName').value,
        icon: document.getElementById('giftTypeIcon').value,
        category: document.getElementById('giftTypeCategory').value,
        coinCost: parseInt(document.getElementById('giftTypeCost').value),
        netWorthValue: parseInt(document.getElementById('giftTypeNetWorth').value),
        isActive: document.getElementById('giftTypeActive').checked
      };
      
      try {
        const url = id ? '/api/admin/gift-types/' + id : '/api/admin/gift-types';
        const method = id ? 'PUT' : 'POST';
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        
        if (res.ok) {
          closeModal('giftTypeModal');
          await loadGiftTypes();
          alert('Gift type saved successfully');
        } else {
          const err = await res.json();
          alert('Failed: ' + (err.error || 'Unknown error'));
        }
      } catch (e) {
        console.error('Failed to save gift type:', e);
        alert('Failed to save gift type');
      }
    }

    async function deleteGiftType(id) {
      if (!confirm('Are you sure you want to delete this gift type?')) return;
      
      try {
        const res = await fetch('/api/admin/gift-types/' + id, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (res.ok) {
          await loadGiftTypes();
        } else {
          alert('Failed to delete gift type');
        }
      } catch (e) {
        console.error('Failed to delete gift type:', e);
        alert('Failed to delete gift type');
      }
    }

    async function loadCoinBundles() {
      try {
        const res = await fetch('/api/admin/coin-bundles', { credentials: 'include' });
        if (res.ok) {
          allCoinBundles = await res.json();
          renderCoinBundles();
        }
      } catch (e) {
        console.error('Failed to load coin bundles:', e);
        document.getElementById('coinBundlesTable').innerHTML = '<div class="empty-state">Unable to load coin bundles</div>';
      }
    }

    function renderCoinBundles() {
      if (allCoinBundles.length === 0) {
        document.getElementById('coinBundlesTable').innerHTML = '<div class="empty-state">No coin bundles configured</div>';
        return;
      }
      
      document.getElementById('coinBundlesTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Coins</th>
              <th>Price (Rands)</th>
              <th>Bonus</th>
              <th>Featured</th>
              <th>Active</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${allCoinBundles.map(b => `
              <tr>
                <td>${escapeHtml(b.name || 'Unnamed')}</td>
                <td style="color: #8B5CF6; font-weight: 600;">${formatNumber(b.coins || 0)}</td>
                <td>R${(b.price || 0).toFixed(2)}</td>
                <td style="color: #10B981;">+${formatNumber(b.bonus || 0)}</td>
                <td><span class="badge ${b.featured || b.isFeatured ? 'badge-gold' : 'badge-inactive'}">${b.featured || b.isFeatured ? 'Featured' : 'No'}</span></td>
                <td><span class="badge ${b.isActive !== false ? 'badge-active' : 'badge-suspended'}">${b.isActive !== false ? 'Active' : 'Inactive'}</span></td>
                <td>
                  <button class="action-btn action-btn-primary" onclick="editCoinBundle('${b.id}')">Edit</button>
                  <button class="action-btn action-btn-danger" onclick="deleteCoinBundle('${b.id}')">Delete</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function openCoinBundleModal(data = null) {
      document.getElementById('coinBundleModalTitle').textContent = data ? 'Edit Coin Bundle' : 'Add Coin Bundle';
      document.getElementById('coinBundleId').value = data?.id || '';
      document.getElementById('coinBundleName').value = data?.name || '';
      document.getElementById('coinBundleCoins').value = data?.coins || '';
      document.getElementById('coinBundlePrice').value = data?.price || '';
      document.getElementById('coinBundleBonus').value = data?.bonus || 0;
      document.getElementById('coinBundleSortOrder').value = data?.sortOrder || 0;
      document.getElementById('coinBundleFeatured').checked = data?.featured || data?.isFeatured || false;
      document.getElementById('coinBundleActive').checked = data?.isActive !== false;
      document.getElementById('coinBundleModal').classList.add('active');
    }

    function editCoinBundle(id) {
      const bundle = allCoinBundles.find(b => b.id === id);
      if (bundle) openCoinBundleModal(bundle);
    }

    async function submitCoinBundle(e) {
      e.preventDefault();
      const id = document.getElementById('coinBundleId').value;
      const data = {
        name: document.getElementById('coinBundleName').value,
        coins: parseInt(document.getElementById('coinBundleCoins').value),
        price: parseFloat(document.getElementById('coinBundlePrice').value),
        bonus: parseInt(document.getElementById('coinBundleBonus').value) || 0,
        sortOrder: parseInt(document.getElementById('coinBundleSortOrder').value) || 0,
        isFeatured: document.getElementById('coinBundleFeatured').checked,
        isActive: document.getElementById('coinBundleActive').checked
      };
      
      try {
        const url = id ? '/api/admin/coin-bundles/' + id : '/api/admin/coin-bundles';
        const method = id ? 'PUT' : 'POST';
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        
        if (res.ok) {
          closeModal('coinBundleModal');
          await loadCoinBundles();
          alert('Coin bundle saved successfully');
        } else {
          const err = await res.json();
          alert('Failed: ' + (err.error || 'Unknown error'));
        }
      } catch (e) {
        console.error('Failed to save coin bundle:', e);
        alert('Failed to save coin bundle');
      }
    }

    async function deleteCoinBundle(id) {
      if (!confirm('Are you sure you want to delete this coin bundle?')) return;
      
      try {
        const res = await fetch('/api/admin/coin-bundles/' + id, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (res.ok) {
          await loadCoinBundles();
        } else {
          alert('Failed to delete coin bundle');
        }
      } catch (e) {
        console.error('Failed to delete coin bundle:', e);
        alert('Failed to delete coin bundle');
      }
    }

    async function loadWithdrawals() {
      try {
        const params = new URLSearchParams();
        if (withdrawalFilter) params.set('status', withdrawalFilter);
        const res = await fetch('/api/admin/withdrawals?' + params, { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          allWithdrawals = Array.isArray(data) ? data : (data.withdrawals || []);
          renderWithdrawals();
        }
      } catch (e) {
        console.error('Failed to load withdrawals:', e);
        document.getElementById('withdrawalsTable').innerHTML = '<div class="empty-state">Unable to load withdrawals</div>';
      }
    }

    function filterWithdrawals(status) {
      withdrawalFilter = status;
      document.querySelectorAll('#withdrawalFilters .filter-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      loadWithdrawals();
    }

    function renderWithdrawals() {
      if (allWithdrawals.length === 0) {
        document.getElementById('withdrawalsTable').innerHTML = '<div class="empty-state">No withdrawal requests found</div>';
        return;
      }
      
      document.getElementById('withdrawalsTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Amount</th>
              <th>Bank Account</th>
              <th>Status</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${allWithdrawals.map(w => {
              const statusColors = { pending: 'badge-pending', approved: 'badge-active', rejected: 'badge-suspended' };
              const username = w.user?.username || w.username || 'Unknown';
              return `
              <tr>
                <td>
                  <div class="user-cell">
                    <div class="avatar">${username.charAt(0).toUpperCase()}</div>
                    <span>${escapeHtml(username)}</span>
                  </div>
                </td>
                <td style="font-weight: 600; color: #8B5CF6;">R${(w.amount || 0).toFixed(2)}</td>
                <td>${escapeHtml(w.bankAccount || w.bankDetails || '-')}</td>
                <td><span class="badge ${statusColors[w.status] || 'badge-pending'}">${w.status || 'pending'}</span></td>
                <td>${formatDate(w.createdAt)}</td>
                <td>
                  ${w.status === 'pending' ? `
                    <button class="action-btn action-btn-success" onclick="approveWithdrawal('${w.id}')">Approve</button>
                    <button class="action-btn action-btn-danger" onclick="rejectWithdrawal('${w.id}')">Reject</button>
                  ` : '-'}
                </td>
              </tr>
            `;}).join('')}
          </tbody>
        </table>
      `;
    }

    async function approveWithdrawal(id) {
      if (!confirm('Are you sure you want to approve this withdrawal?')) return;
      
      try {
        const res = await fetch('/api/admin/withdrawals/' + id + '/approve', {
          method: 'POST',
          credentials: 'include'
        });
        
        if (res.ok) {
          await loadWithdrawals();
          await loadEconomyStats();
          alert('Withdrawal approved');
        } else {
          const err = await res.json();
          alert('Failed: ' + (err.error || 'Unknown error'));
        }
      } catch (e) {
        console.error('Failed to approve withdrawal:', e);
        alert('Failed to approve withdrawal');
      }
    }

    async function rejectWithdrawal(id) {
      const reason = prompt('Enter rejection reason:');
      if (reason === null) return;
      
      try {
        const res = await fetch('/api/admin/withdrawals/' + id + '/reject', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ reason })
        });
        
        if (res.ok) {
          await loadWithdrawals();
          await loadEconomyStats();
          alert('Withdrawal rejected');
        } else {
          const err = await res.json();
          alert('Failed: ' + (err.error || 'Unknown error'));
        }
      } catch (e) {
        console.error('Failed to reject withdrawal:', e);
        alert('Failed to reject withdrawal');
      }
    }

    async function loadKycSubmissions() {
      try {
        const params = new URLSearchParams();
        if (kycFilter) params.set('status', kycFilter);
        const res = await fetch('/api/admin/kyc?' + params, { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          allKycSubmissions = Array.isArray(data) ? data : (data.submissions || []);
          renderKycSubmissions();
        }
      } catch (e) {
        console.error('Failed to load KYC submissions:', e);
        document.getElementById('kycTable').innerHTML = '<div class="empty-state">Unable to load KYC submissions</div>';
      }
    }

    function filterKyc(status) {
      kycFilter = status;
      document.querySelectorAll('#kycFilters .filter-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      loadKycSubmissions();
    }

    function renderKycSubmissions() {
      if (allKycSubmissions.length === 0) {
        document.getElementById('kycTable').innerHTML = '<div class="empty-state">No KYC submissions found</div>';
        return;
      }
      
      document.getElementById('kycTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>ID Type</th>
              <th>Status</th>
              <th>Submitted</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${allKycSubmissions.map(k => {
              const statusColors = { pending: 'badge-pending', approved: 'badge-active', rejected: 'badge-suspended' };
              const username = k.user?.username || k.username || 'Unknown';
              return `
              <tr>
                <td>
                  <div class="user-cell">
                    <div class="avatar">${username.charAt(0).toUpperCase()}</div>
                    <span>${escapeHtml(username)}</span>
                  </div>
                </td>
                <td>${escapeHtml(k.idType || k.documentType || '-')}</td>
                <td><span class="badge ${statusColors[k.status] || 'badge-pending'}">${k.status || 'pending'}</span></td>
                <td>${formatDate(k.createdAt || k.submittedAt)}</td>
                <td>
                  <button class="action-btn action-btn-primary" onclick="viewKycDetails('${k.id}')">View</button>
                  ${k.status === 'pending' ? `
                    <button class="action-btn action-btn-success" onclick="approveKycDirect('${k.id}')">Approve</button>
                    <button class="action-btn action-btn-danger" onclick="rejectKycDirect('${k.id}')">Reject</button>
                  ` : ''}
                </td>
              </tr>
            `;}).join('')}
          </tbody>
        </table>
      `;
    }

    async function viewKycDetails(id) {
      currentKycId = id;
      const kyc = allKycSubmissions.find(k => k.id === id);
      
      if (!kyc) {
        alert('KYC submission not found');
        return;
      }
      
      const username = kyc.user?.username || kyc.username || 'Unknown';
      
      document.getElementById('kycDetailsContent').innerHTML = `
        <div class="detail-grid">
          <div class="detail-item">
            <label>User</label>
            <span>${escapeHtml(username)}</span>
          </div>
          <div class="detail-item">
            <label>ID Type</label>
            <span>${escapeHtml(kyc.idType || kyc.documentType || '-')}</span>
          </div>
          <div class="detail-item">
            <label>ID Number</label>
            <span>${escapeHtml(kyc.idNumber || '-')}</span>
          </div>
          <div class="detail-item">
            <label>Full Name</label>
            <span>${escapeHtml(kyc.fullName || '-')}</span>
          </div>
          <div class="detail-item">
            <label>Status</label>
            <span class="badge ${kyc.status === 'approved' ? 'badge-active' : kyc.status === 'rejected' ? 'badge-suspended' : 'badge-pending'}">${kyc.status || 'pending'}</span>
          </div>
          <div class="detail-item">
            <label>Submitted</label>
            <span>${formatDate(kyc.createdAt || kyc.submittedAt)}</span>
          </div>
        </div>
        ${kyc.documentUrl ? `
          <div style="margin-top: 16px;">
            <label style="display: block; margin-bottom: 8px; color: rgba(255,255,255,0.5); font-size: 11px; text-transform: uppercase;">Document</label>
            <img src="${kyc.documentUrl}" class="media-preview" alt="KYC Document" style="max-width: 100%; border-radius: 8px;">
          </div>
        ` : ''}
        ${kyc.selfieUrl ? `
          <div style="margin-top: 16px;">
            <label style="display: block; margin-bottom: 8px; color: rgba(255,255,255,0.5); font-size: 11px; text-transform: uppercase;">Selfie</label>
            <img src="${kyc.selfieUrl}" class="media-preview" alt="KYC Selfie" style="max-width: 100%; border-radius: 8px;">
          </div>
        ` : ''}
      `;
      
      const actionsEl = document.getElementById('kycDetailsActions');
      if (kyc.status === 'pending') {
        actionsEl.style.display = 'flex';
      } else {
        actionsEl.style.display = 'none';
      }
      
      document.getElementById('kycDetailsModal').classList.add('active');
    }

    async function approveKyc() {
      if (!currentKycId) return;
      await approveKycDirect(currentKycId);
      closeModal('kycDetailsModal');
    }

    async function rejectKyc() {
      if (!currentKycId) return;
      await rejectKycDirect(currentKycId);
      closeModal('kycDetailsModal');
    }

    async function approveKycDirect(id) {
      if (!confirm('Are you sure you want to approve this KYC submission?')) return;
      
      try {
        const res = await fetch('/api/admin/kyc/' + id + '/approve', {
          method: 'POST',
          credentials: 'include'
        });
        
        if (res.ok) {
          await loadKycSubmissions();
          await loadEconomyStats();
          alert('KYC approved');
        } else {
          const err = await res.json();
          alert('Failed: ' + (err.error || 'Unknown error'));
        }
      } catch (e) {
        console.error('Failed to approve KYC:', e);
        alert('Failed to approve KYC');
      }
    }

    async function rejectKycDirect(id) {
      const reason = prompt('Enter rejection reason:');
      if (reason === null) return;
      
      try {
        const res = await fetch('/api/admin/kyc/' + id + '/reject', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ reason })
        });
        
        if (res.ok) {
          await loadKycSubmissions();
          await loadEconomyStats();
          alert('KYC rejected');
        } else {
          const err = await res.json();
          alert('Failed: ' + (err.error || 'Unknown error'));
        }
      } catch (e) {
        console.error('Failed to reject KYC:', e);
        alert('Failed to reject KYC');
      }
    }

    // Payments Section
    let allPayments = [];
    let paymentsTotalCount = 0;
    let paymentsCurrentPage = 1;
    let paymentsCurrentStatus = '';
    const PAYMENTS_PER_PAGE = 20;

    async function loadPayments(page = 1, status = '') {
      try {
        paymentsCurrentPage = page;
        paymentsCurrentStatus = status;
        const search = document.getElementById('paymentSearch')?.value || '';
        
        const statsRes = await fetch('/api/admin/payments/stats', { credentials: 'include' });
        if (statsRes.ok) {
          const stats = await statsRes.json();
          document.getElementById('paymentStats').innerHTML = `
            <div class="stat-card">
              <h3>Total Orders</h3>
              <div class="value">${formatNumber(stats.totalOrders || 0)}</div>
            </div>
            <div class="stat-card">
              <h3>Pending</h3>
              <div class="value" style="color: #F59E0B;">${formatNumber(stats.pendingOrders || 0)}</div>
            </div>
            <div class="stat-card">
              <h3>Completed</h3>
              <div class="value" style="color: #10B981;">${formatNumber(stats.completedOrders || 0)}</div>
            </div>
            <div class="stat-card">
              <h3>Failed</h3>
              <div class="value" style="color: #EF4444;">${formatNumber(stats.failedOrders || 0)}</div>
            </div>
            <div class="stat-card">
              <h3>Total Revenue</h3>
              <div class="value">R ${(stats.totalRevenue / 100).toFixed(2)}</div>
            </div>
            <div class="stat-card">
              <h3>Last 30 Days</h3>
              <div class="value">R ${(stats.last30DaysRevenue / 100).toFixed(2)}</div>
            </div>
          `;
        }
        
        const params = new URLSearchParams({
          page: String(page),
          limit: String(PAYMENTS_PER_PAGE),
          search,
          status
        });
        
        const res = await fetch(`/api/admin/payments?${params}`, { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          allPayments = data.orders || [];
          paymentsTotalCount = data.total || 0;
          renderPaymentsTable();
        }
      } catch (e) {
        console.error('Failed to load payments:', e);
        document.getElementById('paymentStats').innerHTML = '<div class="stat-card"><h3>Payments</h3><div class="value">-</div></div>';
        document.getElementById('paymentsTable').innerHTML = '<div class="empty-state">Unable to load payments</div>';
      }
    }

    function renderPaymentsTable() {
      if (allPayments.length === 0) {
        document.getElementById('paymentsTable').innerHTML = '<div class="empty-state">No orders found</div>';
        document.getElementById('paymentsPagination').innerHTML = '';
        return;
      }
      
      const statusColors = {
        'PENDING': 'badge-pending',
        'COMPLETE': 'badge-active',
        'FAILED': 'badge-inactive',
        'CANCELLED': 'badge-inactive'
      };
      
      document.getElementById('paymentsTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Order ID</th>
              <th>User</th>
              <th>Item</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Created</th>
              <th>Completed</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${allPayments.map(o => `
              <tr>
                <td><code style="background: rgba(139,92,246,0.2); padding: 4px 8px; border-radius: 4px; font-size: 11px;">${o.id.substring(0, 8)}...</code></td>
                <td>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <img src="${o.user?.avatarUrl || '/default-avatar.png'}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                    <div>
                      <div style="font-weight: 500;">${escapeHtml(o.user?.displayName || 'Unknown')}</div>
                      <div style="font-size: 12px; color: rgba(255,255,255,0.5);">@${escapeHtml(o.user?.username || 'unknown')}</div>
                    </div>
                  </div>
                </td>
                <td>${escapeHtml(o.itemName || '-')}</td>
                <td style="font-weight: 600;">R ${(o.amountCents / 100).toFixed(2)}</td>
                <td><span class="badge ${statusColors[o.status] || 'badge-inactive'}">${o.status}</span></td>
                <td>${formatDate(o.createdAt)}</td>
                <td>${o.completedAt ? formatDate(o.completedAt) : '-'}</td>
                <td>
                  <div style="display: flex; gap: 8px;">
                    <button class="action-btn action-btn-secondary" data-action="view-order" data-id="${o.id}">View</button>
                    <button class="action-btn action-btn-primary" data-action="update-order-status" data-id="${o.id}" data-status="${o.status}">Update</button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      renderPaymentsPagination();
    }

    function setPaymentFilter(status) {
      document.querySelectorAll('#paymentFilters .filter-btn').forEach(b => b.classList.remove('active'));
      const activeBtn = document.querySelector('#paymentFilters .filter-btn[data-status="' + status + '"]');
      if (activeBtn) activeBtn.classList.add('active');
      loadPayments(1, status);
    }

    function renderPaymentsPagination() {
      const totalPages = Math.ceil(paymentsTotalCount / PAYMENTS_PER_PAGE);
      if (totalPages <= 1) {
        document.getElementById('paymentsPagination').innerHTML = '';
        return;
      }
      
      let html = '<div style="display: flex; gap: 8px; justify-content: center; margin-top: 16px;">';
      
      if (paymentsCurrentPage > 1) {
        html += `<button class="action-btn action-btn-secondary" data-action="payments-page" data-page="${paymentsCurrentPage - 1}">Previous</button>`;
      }
      
      html += `<span style="padding: 8px 16px; color: rgba(255,255,255,0.6);">Page ${paymentsCurrentPage} of ${totalPages}</span>`;
      
      if (paymentsCurrentPage < totalPages) {
        html += `<button class="action-btn action-btn-secondary" data-action="payments-page" data-page="${paymentsCurrentPage + 1}">Next</button>`;
      }
      
      html += '</div>';
      document.getElementById('paymentsPagination').innerHTML = html;
    }

    async function viewOrderDetails(orderId) {
      try {
        const res = await fetch(`/api/admin/payments/${orderId}`, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to fetch order');
        const order = await res.json();
        
        showModal(`
          <div style="max-width: 600px;">
            <h2 style="margin-bottom: 20px;">Order Details</h2>
            <div style="display: grid; gap: 16px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div>
                  <label style="color: rgba(255,255,255,0.6); font-size: 12px;">Order ID</label>
                  <div style="font-family: monospace; background: rgba(139,92,246,0.2); padding: 8px; border-radius: 6px; margin-top: 4px; word-break: break-all;">${order.id}</div>
                </div>
                <div>
                  <label style="color: rgba(255,255,255,0.6); font-size: 12px;">Status</label>
                  <div style="margin-top: 4px;"><span class="badge ${order.status === 'COMPLETE' ? 'badge-active' : order.status === 'PENDING' ? 'badge-pending' : 'badge-inactive'}">${order.status}</span></div>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div>
                  <label style="color: rgba(255,255,255,0.6); font-size: 12px;">User</label>
                  <div style="margin-top: 4px; display: flex; align-items: center; gap: 8px;">
                    <img src="${order.user?.avatarUrl || '/default-avatar.png'}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                    <div>
                      <div>${escapeHtml(order.user?.displayName || 'Unknown')}</div>
                      <div style="font-size: 12px; color: rgba(255,255,255,0.5);">@${escapeHtml(order.user?.username || 'unknown')}</div>
                    </div>
                  </div>
                </div>
                <div>
                  <label style="color: rgba(255,255,255,0.6); font-size: 12px;">Email</label>
                  <div style="margin-top: 4px;">${escapeHtml(order.emailAddress || order.user?.email || '-')}</div>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div>
                  <label style="color: rgba(255,255,255,0.6); font-size: 12px;">Item</label>
                  <div style="margin-top: 4px; font-weight: 500;">${escapeHtml(order.itemName || '-')}</div>
                  <div style="font-size: 12px; color: rgba(255,255,255,0.5);">${escapeHtml(order.itemDescription || '')}</div>
                </div>
                <div>
                  <label style="color: rgba(255,255,255,0.6); font-size: 12px;">Quantity</label>
                  <div style="margin-top: 4px;">${order.quantity || 1}</div>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                <div>
                  <label style="color: rgba(255,255,255,0.6); font-size: 12px;">Amount</label>
                  <div style="margin-top: 4px; font-size: 18px; font-weight: 700; color: #8B5CF6;">R ${(order.amountCents / 100).toFixed(2)}</div>
                </div>
                <div>
                  <label style="color: rgba(255,255,255,0.6); font-size: 12px;">Fee</label>
                  <div style="margin-top: 4px;">${order.amountFee ? 'R ' + order.amountFee : '-'}</div>
                </div>
                <div>
                  <label style="color: rgba(255,255,255,0.6); font-size: 12px;">Net</label>
                  <div style="margin-top: 4px;">${order.amountNet ? 'R ' + order.amountNet : '-'}</div>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div>
                  <label style="color: rgba(255,255,255,0.6); font-size: 12px;">Created</label>
                  <div style="margin-top: 4px;">${formatDate(order.createdAt)}</div>
                </div>
                <div>
                  <label style="color: rgba(255,255,255,0.6); font-size: 12px;">Completed</label>
                  <div style="margin-top: 4px;">${order.completedAt ? formatDate(order.completedAt) : '-'}</div>
                </div>
              </div>
              ${order.pfPaymentId ? `
              <div>
                <label style="color: rgba(255,255,255,0.6); font-size: 12px;">PayFast Payment ID</label>
                <div style="font-family: monospace; background: rgba(139,92,246,0.2); padding: 8px; border-radius: 6px; margin-top: 4px;">${order.pfPaymentId}</div>
              </div>
              ` : ''}
            </div>
            <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
              <button class="action-btn action-btn-secondary" onclick="closeModal()">Close</button>
              <button class="action-btn action-btn-primary" onclick="closeModal(); showUpdateOrderStatusModal('${order.id}', '${order.status}')">Update Status</button>
            </div>
          </div>
        `);
      } catch (e) {
        console.error('Failed to view order:', e);
        alert('Failed to load order details');
      }
    }

    function showUpdateOrderStatusModal(orderId, currentStatus) {
      showModal(`
        <div style="max-width: 400px;">
          <h2 style="margin-bottom: 20px;">Update Order Status</h2>
          <div class="form-group">
            <label>New Status</label>
            <select id="newOrderStatus" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
              <option value="PENDING" ${currentStatus === 'PENDING' ? 'selected' : ''}>Pending</option>
              <option value="COMPLETE" ${currentStatus === 'COMPLETE' ? 'selected' : ''}>Complete</option>
              <option value="FAILED" ${currentStatus === 'FAILED' ? 'selected' : ''}>Failed</option>
              <option value="CANCELLED" ${currentStatus === 'CANCELLED' ? 'selected' : ''}>Cancelled</option>
            </select>
          </div>
          <div class="form-group">
            <label>Notes (optional)</label>
            <textarea id="orderStatusNotes" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff; min-height: 80px; resize: vertical;" placeholder="Add notes about this status change..."></textarea>
          </div>
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button class="action-btn action-btn-secondary" onclick="closeModal()">Cancel</button>
            <button class="action-btn action-btn-primary" onclick="updateOrderStatus('${orderId}')">Update Status</button>
          </div>
        </div>
      `);
    }

    async function updateOrderStatus(orderId) {
      const status = document.getElementById('newOrderStatus').value;
      const notes = document.getElementById('orderStatusNotes').value;
      
      try {
        const res = await fetch(`/api/admin/payments/${orderId}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ status, notes })
        });
        
        if (!res.ok) throw new Error('Failed to update status');
        
        closeModal();
        loadPayments(paymentsCurrentPage, paymentsCurrentStatus);
      } catch (e) {
        console.error('Failed to update order status:', e);
        alert('Failed to update order status');
      }
    }

    // Feature Flags Section
    let allFeatureFlags = [];
    async function loadFeatureFlags() {
      try {
        const res = await fetch('/api/admin/feature-flags', { credentials: 'include' });
        if (res.ok) {
          allFeatureFlags = await res.json();
          renderFeatureFlags();
        }
      } catch (e) {
        console.error('Failed to load feature flags:', e);
        document.getElementById('featureFlagsTable').innerHTML = '<div class="empty-state">Unable to load feature flags</div>';
      }
    }

    function renderFeatureFlags() {
      if (allFeatureFlags.length === 0) {
        document.getElementById('featureFlagsTable').innerHTML = '<div class="empty-state">No feature flags configured</div>';
        return;
      }
      
      document.getElementById('featureFlagsTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Key</th>
              <th>Description</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${allFeatureFlags.map(f => `
              <tr>
                <td><code style="background: rgba(139,92,246,0.2); padding: 4px 8px; border-radius: 4px;">${escapeHtml(f.key || '')}</code></td>
                <td>${escapeHtml(f.description || '-')}</td>
                <td><span class="badge ${f.enabled ? 'badge-active' : 'badge-inactive'}">${f.enabled ? 'Enabled' : 'Disabled'}</span></td>
                <td>
                  <button class="action-btn ${f.enabled ? 'action-btn-danger' : 'action-btn-primary'}" data-action="toggle-flag" data-key="${f.key}" data-enabled="${f.enabled}">${f.enabled ? 'Disable' : 'Enable'}</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function toggleFeatureFlag(key, currentlyEnabled) {
      try {
        const res = await fetch('/api/admin/feature-flags/' + encodeURIComponent(key), {
          method: 'PUT',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled: !currentlyEnabled })
        });
        if (res.ok) {
          await loadFeatureFlags();
        } else {
          alert('Failed to toggle feature flag');
        }
      } catch (e) {
        console.error('Failed to toggle feature flag:', e);
        alert('Error toggling feature flag');
      }
    }

    // ===== USER WEALTH MANAGEMENT =====
    let allWealthUsers = [];
    let allMallItems = [];
    let currentPortfolioUserId = null;
    let currentPortfolioData = null;

    async function loadWealthUsers() {
      try {
        const search = document.getElementById('wealthUserSearch')?.value || '';
        const sortOrder = document.getElementById('wealthSortOrder')?.value || 'desc';
        
        const res = await fetch(`/api/admin/users/wealth?search=${encodeURIComponent(search)}&sortOrder=${sortOrder}`, { credentials: 'include' });
        if (res.ok) {
          allWealthUsers = await res.json();
          renderWealthUsers();
          updateWealthStats();
        }
      } catch (e) {
        console.error('Failed to load wealth users:', e);
        document.getElementById('wealthUsersTable').innerHTML = '<div class="empty-state">Unable to load users</div>';
      }
    }

    function updateWealthStats() {
      const totalNet = allWealthUsers.reduce((sum, u) => sum + (u.netWorth || 0), 0);
      const avgNet = allWealthUsers.length > 0 ? totalNet / allWealthUsers.length : 0;
      const wealthy = allWealthUsers.filter(u => (u.netWorth || 0) >= 1000000).length;
      
      document.getElementById('totalNetWorth').textContent = 'R' + totalNet.toLocaleString();
      document.getElementById('avgNetWorth').textContent = 'R' + Math.round(avgNet).toLocaleString();
      document.getElementById('wealthyUsers').textContent = wealthy.toString();
    }

    function renderWealthUsers() {
      if (allWealthUsers.length === 0) {
        document.getElementById('wealthUsersTable').innerHTML = '<div class="empty-state">No users found</div>';
        return;
      }
      
      document.getElementById('wealthUsersTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Net Worth</th>
              <th>Tier</th>
              <th>Verified</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${allWealthUsers.map(u => `
              <tr>
                <td>
                  <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #8B5CF6, #A855F7); display: flex; align-items: center; justify-content: center; font-weight: 600; overflow: hidden;">
                      ${u.avatarUrl ? `<img src="${escapeHtml(u.avatarUrl)}" style="width: 100%; height: 100%; object-fit: cover;">` : escapeHtml((u.username || '?')[0].toUpperCase())}
                    </div>
                    <div>
                      <div style="font-weight: 500;">${escapeHtml(u.displayName || u.username || 'Unknown')}</div>
                      <div style="font-size: 12px; color: rgba(255,255,255,0.5);">@${escapeHtml(u.username || '')}</div>
                    </div>
                  </div>
                </td>
                <td style="font-weight: 600; color: #22c55e;">R${(u.netWorth || 0).toLocaleString()}</td>
                <td><span class="badge ${getTierBadgeClass(u.netWorthTier)}">${escapeHtml(u.netWorthTier || 'BUILDING')}</span></td>
                <td>${u.isVerified ? '<span class="badge badge-active">Verified</span>' : '<span class="badge badge-inactive">No</span>'}</td>
                <td style="display: flex; gap: 8px;">
                  <button class="action-btn" data-action="quick-edit-networth" data-user-id="${u.id}" data-username="${escapeHtml(u.username || '')}" data-display-name="${escapeHtml(u.displayName || u.username || '')}" data-current-networth="${u.netWorth || 0}" style="padding: 6px 12px; font-size: 12px;">Edit Net Worth</button>
                  <button class="action-btn action-btn-primary" data-action="manage-portfolio" data-user-id="${u.id}" style="padding: 6px 12px; font-size: 12px;">Portfolio</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function getTierBadgeClass(tier) {
      switch (tier) {
        case 'DIAMOND': return 'badge-diamond';
        case 'PLATINUM': return 'badge-platinum';
        case 'GOLD': return 'badge-gold';
        case 'SILVER': return 'badge-silver';
        default: return 'badge-building';
      }
    }

    function filterWealthUsers() {
      loadWealthUsers();
    }

    async function openUserPortfolio(userId) {
      currentPortfolioUserId = userId;
      
      try {
        const res = await fetch(`/api/admin/users/${userId}/portfolio`, { credentials: 'include' });
        if (res.ok) {
          currentPortfolioData = await res.json();
          renderPortfolioModal();
          openModal('portfolioModal');
          await loadMallItems();
        } else {
          alert('Failed to load user portfolio');
        }
      } catch (e) {
        console.error('Failed to load portfolio:', e);
        alert('Error loading portfolio');
      }
    }

    function renderPortfolioModal() {
      const data = currentPortfolioData;
      if (!data) return;
      
      document.getElementById('portfolioModalTitle').textContent = `${data.user.displayName || data.user.username}'s Portfolio`;
      
      document.getElementById('portfolioUserInfo').innerHTML = `
        <div style="display: flex; align-items: center; gap: 16px;">
          <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #8B5CF6, #A855F7); display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 24px; overflow: hidden;">
            ${data.user.avatarUrl ? `<img src="${escapeHtml(data.user.avatarUrl)}" style="width: 100%; height: 100%; object-fit: cover;">` : escapeHtml((data.user.username || '?')[0].toUpperCase())}
          </div>
          <div>
            <div style="font-size: 20px; font-weight: 600;">${escapeHtml(data.user.displayName || data.user.username)}</div>
            <div style="color: rgba(255,255,255,0.6);">@${escapeHtml(data.user.username)}</div>
          </div>
          <div style="margin-left: auto; text-align: right;">
            <div style="font-size: 24px; font-weight: 700; color: #22c55e;">R${(data.user.netWorth || 0).toLocaleString()}</div>
            <div style="color: rgba(255,255,255,0.6);">Net Worth (${data.user.netWorthTier || 'BUILDING'})</div>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 16px;">
          <div style="padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center;">
            <div style="font-size: 20px; font-weight: 600;">${data.totalItems}</div>
            <div style="font-size: 12px; color: rgba(255,255,255,0.6);">Total Items</div>
          </div>
          <div style="padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; text-align: center;">
            <div style="font-size: 20px; font-weight: 600;">R${(data.portfolioValue || 0).toLocaleString()}</div>
            <div style="font-size: 12px; color: rgba(255,255,255,0.6);">Portfolio Value</div>
          </div>
        </div>
      `;
      
      if (data.purchases.length === 0) {
        document.getElementById('portfolioItemsList').innerHTML = '<div class="empty-state">No items in portfolio</div>';
      } else {
        document.getElementById('portfolioItemsList').innerHTML = `
          <div style="display: grid; gap: 12px;">
            ${data.purchases.map(p => `
              <div style="display: flex; align-items: center; gap: 16px; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 12px;">
                <div style="width: 60px; height: 60px; border-radius: 8px; background: rgba(139, 92, 246, 0.2); display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  ${p.itemImageUrl ? `<img src="${escapeHtml(p.itemImageUrl)}" style="width: 100%; height: 100%; object-fit: cover;">` : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>'}
                </div>
                <div style="flex: 1;">
                  <div style="font-weight: 500;">${escapeHtml(p.itemName || 'Unknown Item')}</div>
                  <div style="font-size: 12px; color: rgba(255,255,255,0.5);">Qty: ${p.quantity} | Value: R${(p.netWorthGained || 0).toLocaleString()}</div>
                  <div style="font-size: 11px; color: rgba(255,255,255,0.4);">Added: ${new Date(p.createdAt).toLocaleDateString()}</div>
                </div>
                <button class="action-btn action-btn-danger" data-action="remove-portfolio-item" data-purchase-id="${p.id}">Remove</button>
              </div>
            `).join('')}
          </div>
        `;
      }
    }

    // ===== NEW ADMIN SECTION FUNCTIONS =====
    
    let allBroadcastChannels = [];
    async function loadBroadcasts() {
      try {
        const [notifRes, channelsStatsRes, channelsRes] = await Promise.all([
          fetch('/api/admin/notifications/stats', { credentials: 'include' }),
          fetch('/api/admin/broadcasts/stats', { credentials: 'include' }),
          fetch('/api/admin/broadcasts/channels', { credentials: 'include' })
        ]);
        
        let notifStats = { totalNotifications: 0, unreadNotifications: 0, last24hNotifications: 0 };
        let channelStats = { totalChannels: 0, totalMessages: 0, totalSubscribers: 0 };
        
        if (notifRes.ok) notifStats = await notifRes.json();
        if (channelsStatsRes.ok) channelStats = await channelsStatsRes.json();
        
        document.getElementById('broadcastsStats').innerHTML = `
          <div class="stat-card">
            <div class="stat-value">${(notifStats.totalNotifications || 0).toLocaleString()}</div>
            <div class="stat-label">Total Notifications</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${(channelStats.totalChannels || 0).toLocaleString()}</div>
            <div class="stat-label">Broadcast Channels</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${(channelStats.totalMessages || 0).toLocaleString()}</div>
            <div class="stat-label">Channel Messages</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${(channelStats.totalSubscribers || 0).toLocaleString()}</div>
            <div class="stat-label">Channel Subscribers</div>
          </div>
        `;
        
        if (channelsRes.ok) {
          allBroadcastChannels = await channelsRes.json();
          renderBroadcastChannels();
        }
      } catch (e) {
        console.error('Failed to load broadcasts:', e);
      }
    }
    
    function renderBroadcastChannels() {
      const container = document.getElementById('broadcastChannelsTable');
      if (!container) return;
      
      if (allBroadcastChannels.length === 0) {
        container.innerHTML = '<div style="padding: 24px; text-align: center; color: rgba(255,255,255,0.5);">No broadcast channels yet</div>';
        return;
      }
      
      container.innerHTML = `
        <table class="table">
          <thead><tr><th>Channel</th><th>Owner</th><th>Subscribers</th><th>Verified</th><th>Created</th><th>Actions</th></tr></thead>
          <tbody>${allBroadcastChannels.map(c => `
            <tr>
              <td><strong>${escapeHtml(c.name || 'Unnamed')}</strong></td>
              <td>@${escapeHtml(c.ownerUsername || 'Unknown')}</td>
              <td>${c.subscriberCount || 0}</td>
              <td><span class="badge ${c.isVerified ? 'badge-active' : 'badge-inactive'}">${c.isVerified ? 'Verified' : 'Unverified'}</span></td>
              <td>${formatDate(c.createdAt)}</td>
              <td style="display: flex; gap: 4px; flex-wrap: wrap;">
                <button class="action-btn action-btn-primary" onclick="viewChannelMessages('${c.id}', '${escapeHtml(c.name)}')" style="padding: 6px 10px; font-size: 12px;">Messages</button>
                <button class="action-btn" onclick="toggleChannelVerified('${c.id}', ${!c.isVerified})" style="padding: 6px 10px; font-size: 12px;">${c.isVerified ? 'Unverify' : 'Verify'}</button>
                <button class="action-btn action-btn-danger" onclick="deleteBroadcastChannel('${c.id}')" style="padding: 6px 10px; font-size: 12px;">Delete</button>
              </td>
            </tr>
          `).join('')}</tbody>
        </table>
      `;
    }

    async function loadEvents() {
      try {
        const [statsRes, eventsRes] = await Promise.all([
          fetch('/api/admin/events/stats', { credentials: 'include' }),
          fetch('/api/admin/events', { credentials: 'include' })
        ]);
        
        if (statsRes.ok) {
          const stats = await statsRes.json();
          document.getElementById('eventsStats').innerHTML = `
            <div class="stat-card">
              <div class="stat-value">${stats.totalEvents}</div>
              <div class="stat-label">Total Events</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${stats.upcomingEvents}</div>
              <div class="stat-label">Upcoming</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${stats.totalRsvps}</div>
              <div class="stat-label">Total RSVPs</div>
            </div>
          `;
        }
        
        if (eventsRes.ok) {
          const events = await eventsRes.json();
          document.getElementById('eventsTable').innerHTML = events.length === 0 ? 
            '<div style="padding: 24px; text-align: center; color: rgba(255,255,255,0.5);">No events created yet</div>' :
            `<table class="table">
              <thead><tr><th>Title</th><th>Host</th><th>Date</th><th>Location</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody>${events.map(e => `
                <tr>
                  <td>${escapeHtml(e.title)}</td>
                  <td>@${escapeHtml(e.hostUsername || 'Unknown')}</td>
                  <td>${e.startsAt ? new Date(e.startsAt).toLocaleDateString() : 'N/A'}</td>
                  <td>${escapeHtml(e.locationName || 'N/A')}</td>
                  <td>
                    <select onchange="updateEventStatus('${e.id}', this.value)" style="padding: 4px 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; color: #fff; font-size: 12px;">
                      <option value="SCHEDULED" ${e.status === 'SCHEDULED' ? 'selected' : ''}>Scheduled</option>
                      <option value="ACTIVE" ${e.status === 'ACTIVE' ? 'selected' : ''}>Active</option>
                      <option value="COMPLETED" ${e.status === 'COMPLETED' ? 'selected' : ''}>Completed</option>
                      <option value="CANCELLED" ${e.status === 'CANCELLED' ? 'selected' : ''}>Cancelled</option>
                    </select>
                  </td>
                  <td style="display: flex; gap: 4px;">
                    <button class="action-btn action-btn-primary" onclick="viewEventAttendees('${e.id}', '${escapeHtml(e.title)}')" style="padding: 6px 12px; font-size: 12px;">Attendees</button>
                    <button class="action-btn action-btn-danger" data-action="delete-event" data-id="${e.id}" style="padding: 6px 12px; font-size: 12px;">Delete</button>
                  </td>
                </tr>
              `).join('')}</tbody>
            </table>`;
        }
      } catch (e) {
        console.error('Failed to load events:', e);
      }
    }

    async function loadSubscriptions() {
      try {
        const [statsRes, tiersRes] = await Promise.all([
          fetch('/api/admin/subscriptions/stats', { credentials: 'include' }),
          fetch('/api/admin/subscriptions', { credentials: 'include' })
        ]);
        
        if (statsRes.ok) {
          const stats = await statsRes.json();
          document.getElementById('subscriptionsStats').innerHTML = `
            <div class="stat-card">
              <div class="stat-value">${stats.totalTiers}</div>
              <div class="stat-label">Subscription Tiers</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${stats.activeSubscriptions}</div>
              <div class="stat-label">Active Subscriptions</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${stats.creatorsWithTiers}</div>
              <div class="stat-label">Creators with Tiers</div>
            </div>
          `;
        }
        
        if (tiersRes.ok) {
          const tiers = await tiersRes.json();
          document.getElementById('subscriptionsTable').innerHTML = tiers.length === 0 ?
            '<div style="padding: 24px; text-align: center; color: rgba(255,255,255,0.5);">No subscription tiers yet</div>' :
            `<table class="table">
              <thead><tr><th>Tier Name</th><th>Creator</th><th>Price (Coins)</th><th>Subscribers</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody>${tiers.map(t => `
                <tr>
                  <td>${escapeHtml(t.name)}</td>
                  <td>@${escapeHtml(t.creatorUsername || 'Unknown')}</td>
                  <td>${t.monthlyPriceCoins?.toLocaleString() || 0} coins</td>
                  <td><a href="#" onclick="viewTierSubscribers('${t.id}', '${escapeHtml(t.name)}'); return false;" style="color: #8b5cf6;">${t.subscriberCount || 0} subscribers</a></td>
                  <td><span class="badge" style="background: ${t.isActive ? '#10b981' : '#ef4444'};">${t.isActive ? 'Active' : 'Inactive'}</span></td>
                  <td style="display: flex; gap: 4px;">
                    <button class="action-btn action-btn-primary" onclick="viewTierSubscribers('${t.id}', '${escapeHtml(t.name)}')" style="padding: 6px 12px; font-size: 12px;">Subscribers</button>
                    <button class="action-btn ${t.isActive ? 'action-btn-danger' : ''}" onclick="toggleTierActive('${t.id}', ${!t.isActive})" style="padding: 6px 12px; font-size: 12px;">${t.isActive ? 'Disable' : 'Enable'}</button>
                  </td>
                </tr>
              `).join('')}</tbody>
            </table>`;
        }
      } catch (e) {
        console.error('Failed to load subscriptions:', e);
      }
    }

    async function loadHashtags() {
      try {
        const [statsRes, hashtagsRes] = await Promise.all([
          fetch('/api/admin/hashtags/stats', { credentials: 'include' }),
          fetch('/api/admin/hashtags', { credentials: 'include' })
        ]);
        
        if (statsRes.ok) {
          const stats = await statsRes.json();
          document.getElementById('hashtagsStats').innerHTML = `
            <div class="stat-card">
              <div class="stat-value">${stats.totalHashtags}</div>
              <div class="stat-label">Total Hashtags</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${stats.trendingHashtags}</div>
              <div class="stat-label">Trending</div>
            </div>
          `;
        }
        
        if (hashtagsRes.ok) {
          const hashtags = await hashtagsRes.json();
          document.getElementById('hashtagsTable').innerHTML = hashtags.length === 0 ?
            '<div style="padding: 24px; text-align: center; color: rgba(255,255,255,0.5);">No hashtags yet</div>' :
            `<table class="table">
              <thead><tr><th>Hashtag</th><th>Posts</th><th>Trending</th><th>Actions</th></tr></thead>
              <tbody>${hashtags.map(h => `
                <tr>
                  <td>#${escapeHtml(h.tag)}</td>
                  <td>${h.postCount || 0}</td>
                  <td><span class="badge ${h.isTrending ? 'badge-success' : 'badge-secondary'}">${h.isTrending ? 'Trending' : 'Normal'}</span></td>
                  <td><button class="action-btn ${h.isTrending ? 'action-btn-danger' : 'action-btn-primary'}" data-action="toggle-trending" data-id="${h.id}" data-trending="${!h.isTrending}" style="padding: 6px 12px; font-size: 12px;">${h.isTrending ? 'Remove Trending' : 'Make Trending'}</button></td>
                </tr>
              `).join('')}</tbody>
            </table>`;
        }
      } catch (e) {
        console.error('Failed to load hashtags:', e);
      }
    }

    async function loadBlocks() {
      try {
        const [statsRes, blocksRes] = await Promise.all([
          fetch('/api/admin/blocks/stats', { credentials: 'include' }),
          fetch('/api/admin/blocks', { credentials: 'include' })
        ]);
        
        if (statsRes.ok) {
          const stats = await statsRes.json();
          document.getElementById('blocksStats').innerHTML = `
            <div class="stat-card">
              <div class="stat-value">${stats.totalBlocks}</div>
              <div class="stat-label">Total Blocks</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${stats.totalMutes}</div>
              <div class="stat-label">Total Mutes</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${stats.restrictedAccounts}</div>
              <div class="stat-label">Restricted Accounts</div>
            </div>
          `;
        }
        
        if (blocksRes.ok) {
          const blocks = await blocksRes.json();
          document.getElementById('blocksTable').innerHTML = blocks.length === 0 ?
            '<div style="padding: 24px; text-align: center; color: rgba(255,255,255,0.5);">No blocks yet</div>' :
            `<table class="table">
              <thead><tr><th>Blocker</th><th>Blocked</th><th>Date</th><th>Actions</th></tr></thead>
              <tbody>${blocks.map(b => `
                <tr>
                  <td>@${escapeHtml(b.blockerUsername)}</td>
                  <td>@${escapeHtml(b.blockedUsername)}</td>
                  <td>${new Date(b.createdAt).toLocaleDateString()}</td>
                  <td><button class="action-btn action-btn-danger" data-action="admin-unblock" data-id="${b.id}" style="padding: 6px 12px; font-size: 12px;">Remove Block</button></td>
                </tr>
              `).join('')}</tbody>
            </table>`;
        }
      } catch (e) {
        console.error('Failed to load blocks:', e);
      }
    }

    async function loadReels() {
      try {
        const [statsRes, reelsRes] = await Promise.all([
          fetch('/api/admin/reels/stats', { credentials: 'include' }),
          fetch('/api/admin/reels', { credentials: 'include' })
        ]);
        
        if (statsRes.ok) {
          const stats = await statsRes.json();
          document.getElementById('reelsStats').innerHTML = `
            <div class="stat-card">
              <div class="stat-value">${stats.totalReels}</div>
              <div class="stat-label">Total Reels</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${stats.last24hReels}</div>
              <div class="stat-label">Last 24 Hours</div>
            </div>
          `;
        }
        
        if (reelsRes.ok) {
          const reels = await reelsRes.json();
          document.getElementById('reelsTable').innerHTML = reels.length === 0 ?
            '<div style="padding: 24px; text-align: center; color: rgba(255,255,255,0.5);">No reels yet</div>' :
            `<table class="table">
              <thead><tr><th>Creator</th><th>Caption</th><th>Likes</th><th>Comments</th><th>Date</th><th>Actions</th></tr></thead>
              <tbody>${reels.map(r => `
                <tr>
                  <td>@${escapeHtml(r.authorUsername || 'Unknown')}</td>
                  <td>${escapeHtml((r.content || '').substring(0, 50))}${(r.content?.length || 0) > 50 ? '...' : ''}</td>
                  <td>${r.likesCount || 0}</td>
                  <td>${r.commentsCount || 0}</td>
                  <td>${new Date(r.createdAt).toLocaleDateString()}</td>
                  <td><button class="action-btn action-btn-danger" data-action="delete-reel" data-id="${r.id}" style="padding: 6px 12px; font-size: 12px;">Delete</button></td>
                </tr>
              `).join('')}</tbody>
            </table>`;
        }
      } catch (e) {
        console.error('Failed to load reels:', e);
      }
    }

    async function loadDiscovery() {
      try {
        const [statsRes, catsRes] = await Promise.all([
          fetch('/api/admin/discovery/stats', { credentials: 'include' }),
          fetch('/api/admin/discovery/categories', { credentials: 'include' })
        ]);
        
        if (statsRes.ok) {
          const stats = await statsRes.json();
          document.getElementById('discoveryStats').innerHTML = `
            <div class="stat-card">
              <div class="stat-value">${stats.exploreCategories}</div>
              <div class="stat-label">Explore Categories</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${stats.totalUserInterests}</div>
              <div class="stat-label">User Interest Tags</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${stats.uniqueInterestCategories}</div>
              <div class="stat-label">Interest Categories</div>
            </div>
          `;
        }
        
        if (catsRes.ok) {
          const categories = await catsRes.json();
          document.getElementById('discoveryTable').innerHTML = categories.length === 0 ?
            '<div style="padding: 24px; text-align: center; color: rgba(255,255,255,0.5);">No explore categories yet</div>' :
            `<table class="table">
              <thead><tr><th>Category</th><th>Icon</th><th>Color</th><th>Order</th></tr></thead>
              <tbody>${categories.map(c => `
                <tr>
                  <td>${escapeHtml(c.name)}</td>
                  <td>${escapeHtml(c.icon || 'N/A')}</td>
                  <td><span style="display: inline-block; width: 20px; height: 20px; border-radius: 4px; background: ${c.color || '#666'};"></span></td>
                  <td>${c.sortOrder || 0}</td>
                </tr>
              `).join('')}</tbody>
            </table>`;
        }
      } catch (e) {
        console.error('Failed to load discovery:', e);
      }
    }

    // ===== SECURITY / 2FA MANAGEMENT =====
    
    let security2FAData = { secrets: [], total: 0 };
    let security2FAPage = 1;
    const security2FALimit = 20;

    async function loadSecurity() {
      try {
        const [statsRes, usersRes] = await Promise.all([
          fetch('/api/admin/security/2fa/stats', { credentials: 'include' }),
          fetch(`/api/admin/security/2fa?page=${security2FAPage}&limit=${security2FALimit}`, { credentials: 'include' })
        ]);
        
        if (statsRes.ok) {
          const stats = await statsRes.json();
          const adoptionRate = stats.total > 0 ? ((stats.enabled / stats.total) * 100).toFixed(1) : '0.0';
          document.getElementById('securityStats').innerHTML = `
            <div class="stat-card">
              <h3>Total Users</h3>
              <div class="value">${formatNumber(stats.total)}</div>
            </div>
            <div class="stat-card">
              <h3>2FA Enabled</h3>
              <div class="value" style="color: #10B981;">${formatNumber(stats.enabled)}</div>
            </div>
            <div class="stat-card">
              <h3>2FA Disabled</h3>
              <div class="value" style="color: #EF4444;">${formatNumber(stats.disabled)}</div>
            </div>
            <div class="stat-card">
              <h3>Adoption Rate</h3>
              <div class="value">${adoptionRate}%</div>
            </div>
          `;
        }
        
        if (usersRes.ok) {
          security2FAData = await usersRes.json();
          renderSecurity2FATable();
        }
      } catch (e) {
        console.error('Failed to load security:', e);
      }
    }

    function filterSecurity2FA() {
      const search = document.getElementById('security2faSearch').value.trim();
      security2FAPage = 1;
      loadSecurity2FAUsers(search);
    }

    async function loadSecurity2FAUsers(search = '') {
      try {
        const res = await fetch(`/api/admin/security/2fa?page=${security2FAPage}&limit=${security2FALimit}&search=${encodeURIComponent(search)}`, { credentials: 'include' });
        if (res.ok) {
          security2FAData = await res.json();
          renderSecurity2FATable();
        }
      } catch (e) {
        console.error('Failed to load 2FA users:', e);
      }
    }

    function renderSecurity2FATable() {
      const { secrets, total } = security2FAData;
      
      if (secrets.length === 0) {
        document.getElementById('security2faTable').innerHTML = '<div class="empty-state">No users with 2FA setup found</div>';
        document.getElementById('security2faPagination').innerHTML = '';
        return;
      }

      const avatarUrl = (u) => u.avatarUrl || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(u.displayName || u.username || 'U') + '&background=8B5CF6&color=fff';
      
      document.getElementById('security2faTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>2FA Status</th>
              <th>Enabled At</th>
              <th>Created At</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${secrets.map(s => `
              <tr>
                <td>
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <img src="${avatarUrl(s.user)}" alt="" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">
                    <div>
                      <div style="font-weight: 500;">${escapeHtml(s.user.displayName || s.user.username)}</div>
                      <div style="font-size: 12px; color: rgba(255,255,255,0.5);">@${escapeHtml(s.user.username)} &bull; ${escapeHtml(s.user.email)}</div>
                    </div>
                  </div>
                </td>
                <td>
                  ${s.isEnabled 
                    ? '<span class="badge" style="background: rgba(16, 185, 129, 0.2); color: #10B981; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">Enabled</span>'
                    : '<span class="badge" style="background: rgba(239, 68, 68, 0.2); color: #EF4444; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">Pending</span>'
                  }
                </td>
                <td style="font-size: 13px; color: rgba(255,255,255,0.6);">${s.verifiedAt ? new Date(s.verifiedAt).toLocaleDateString() : 'Not verified'}</td>
                <td style="font-size: 13px; color: rgba(255,255,255,0.6);">${new Date(s.createdAt).toLocaleDateString()}</td>
                <td>
                  <button 
                    onclick="resetUser2FA('${s.userId}', '${escapeHtml(s.user.username)}')" 
                    style="padding: 6px 12px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; color: #EF4444; cursor: pointer; font-size: 12px; font-weight: 500;"
                  >
                    Reset 2FA
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      // Render pagination
      const totalPages = Math.ceil(total / security2FALimit);
      if (totalPages > 1) {
        let paginationHtml = '';
        for (let i = 1; i <= totalPages; i++) {
          paginationHtml += `<button onclick="goToSecurity2FAPage(${i})" style="padding: 6px 12px; background: ${i === security2FAPage ? 'linear-gradient(135deg, #8B5CF6, #A855F7)' : 'rgba(255,255,255,0.05)'}; border: 1px solid ${i === security2FAPage ? 'transparent' : 'rgba(255,255,255,0.1)'}; border-radius: 6px; color: #fff; cursor: pointer; font-size: 13px;">${i}</button>`;
        }
        document.getElementById('security2faPagination').innerHTML = paginationHtml;
      } else {
        document.getElementById('security2faPagination').innerHTML = '';
      }
    }

    function goToSecurity2FAPage(page) {
      security2FAPage = page;
      const search = document.getElementById('security2faSearch').value.trim();
      loadSecurity2FAUsers(search);
    }

    async function resetUser2FA(userId, username) {
      if (!confirm(`Are you sure you want to reset 2FA for @${username}?\n\nThis will:\n- Delete their TOTP secret\n- Delete all backup codes\n\nThe user will need to set up 2FA again.`)) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/security/2fa/${userId}/reset`, {
          method: 'POST',
          credentials: 'include'
        });
        
        if (res.ok) {
          alert(`2FA has been reset for @${username}`);
          loadSecurity();
        } else {
          const error = await res.json();
          alert(`Failed to reset 2FA: ${error.message}`);
        }
      } catch (e) {
        console.error('Failed to reset 2FA:', e);
        alert('Failed to reset 2FA. Please try again.');
      }
    }

    // ===== SESSION MANAGEMENT =====
    
    let sessionsData = { sessions: [], total: 0 };
    let sessionsPage = 1;
    const sessionsLimit = 20;

    async function loadSecuritySessions() {
      try {
        const activeOnly = document.getElementById('sessionsActiveOnly')?.checked || false;
        const search = document.getElementById('sessionsSearch')?.value?.trim() || '';
        
        const [statsRes, sessionsRes] = await Promise.all([
          fetch('/api/admin/security/sessions/stats', { credentials: 'include' }),
          fetch(`/api/admin/security/sessions?page=${sessionsPage}&limit=${sessionsLimit}&activeOnly=${activeOnly}&search=${encodeURIComponent(search)}`, { credentials: 'include' })
        ]);
        
        if (statsRes.ok) {
          const stats = await statsRes.json();
          document.getElementById('sessionStats').innerHTML = `
            <div class="stat-card">
              <h3>Total Sessions</h3>
              <div class="value">${formatNumber(stats.total)}</div>
            </div>
            <div class="stat-card">
              <h3>Active Sessions</h3>
              <div class="value" style="color: #10B981;">${formatNumber(stats.active)}</div>
            </div>
            <div class="stat-card">
              <h3>Inactive Sessions</h3>
              <div class="value" style="color: #EF4444;">${formatNumber(stats.inactive)}</div>
            </div>
          `;
        }
        
        if (sessionsRes.ok) {
          sessionsData = await sessionsRes.json();
          renderSessionsTable();
        }
      } catch (e) {
        console.error('Failed to load sessions:', e);
      }
    }

    function filterSecuritySessions() {
      sessionsPage = 1;
      loadSecuritySessions();
    }

    function renderSessionsTable() {
      const { sessions, total } = sessionsData;
      
      if (sessions.length === 0) {
        document.getElementById('sessionsTable').innerHTML = '<div class="empty-state">No sessions found</div>';
        document.getElementById('sessionsPagination').innerHTML = '';
        return;
      }

      const avatarUrl = (u) => u.avatarUrl || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(u.displayName || u.username || 'U') + '&background=8B5CF6&color=fff';
      
      const formatDate = (date) => {
        if (!date) return 'Never';
        const d = new Date(date);
        const now = new Date();
        const diff = now - d;
        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
        if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
        return d.toLocaleDateString();
      };

      const getDeviceIcon = (deviceType) => {
        if (deviceType === 'mobile') return 'üì±';
        if (deviceType === 'tablet') return 'üì≤';
        return 'üíª';
      };
      
      document.getElementById('sessionsTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Device Info</th>
              <th>IP Address</th>
              <th>Location</th>
              <th>Last Active</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${sessions.map(s => `
              <tr>
                <td>
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <img src="${avatarUrl(s.user)}" alt="" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">
                    <div>
                      <div style="font-weight: 500;">${escapeHtml(s.user.displayName || s.user.username)}</div>
                      <div style="font-size: 12px; color: rgba(255,255,255,0.5);">@${escapeHtml(s.user.username)}</div>
                    </div>
                  </div>
                </td>
                <td>
                  <div style="font-size: 13px;">
                    <span>${getDeviceIcon(s.deviceType)}</span>
                    ${escapeHtml(s.deviceName || 'Unknown Device')}
                  </div>
                  <div style="font-size: 11px; color: rgba(255,255,255,0.5);">
                    ${escapeHtml(s.browser || '')} ${escapeHtml(s.os || '')}
                  </div>
                </td>
                <td style="font-size: 13px; font-family: monospace; color: rgba(255,255,255,0.7);">
                  ${escapeHtml(s.ipAddress || 'Unknown')}
                </td>
                <td style="font-size: 13px; color: rgba(255,255,255,0.6);">
                  ${escapeHtml(s.location || 'Unknown')}
                </td>
                <td style="font-size: 13px; color: rgba(255,255,255,0.6);">
                  ${formatDate(s.lastActiveAt)}
                </td>
                <td>
                  ${s.isActive 
                    ? '<span class="badge" style="background: rgba(16, 185, 129, 0.2); color: #10B981; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">Active</span>'
                    : '<span class="badge" style="background: rgba(107, 114, 128, 0.2); color: #9CA3AF; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">Inactive</span>'
                  }
                </td>
                <td>
                  <div style="display: flex; gap: 8px;">
                    ${s.isActive ? `
                      <button 
                        onclick="terminateSession('${s.id}')" 
                        style="padding: 6px 12px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; color: #EF4444; cursor: pointer; font-size: 12px; font-weight: 500;"
                      >
                        Terminate
                      </button>
                    ` : ''}
                    <button 
                      onclick="terminateAllUserSessions('${s.userId}', '${escapeHtml(s.user.username)}')" 
                      style="padding: 6px 12px; background: rgba(245, 158, 11, 0.2); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 6px; color: #F59E0B; cursor: pointer; font-size: 12px; font-weight: 500;"
                      title="Terminate all sessions for this user"
                    >
                      End All
                    </button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      // Render pagination
      const totalPages = Math.ceil(total / sessionsLimit);
      if (totalPages > 1) {
        let paginationHtml = '';
        for (let i = 1; i <= Math.min(totalPages, 10); i++) {
          paginationHtml += `<button onclick="goToSessionsPage(${i})" style="padding: 6px 12px; background: ${i === sessionsPage ? 'linear-gradient(135deg, #8B5CF6, #A855F7)' : 'rgba(255,255,255,0.05)'}; border: 1px solid ${i === sessionsPage ? 'transparent' : 'rgba(255,255,255,0.1)'}; border-radius: 6px; color: #fff; cursor: pointer; font-size: 13px;">${i}</button>`;
        }
        if (totalPages > 10) {
          paginationHtml += `<span style="color: rgba(255,255,255,0.5);">...</span>`;
          paginationHtml += `<button onclick="goToSessionsPage(${totalPages})" style="padding: 6px 12px; background: ${totalPages === sessionsPage ? 'linear-gradient(135deg, #8B5CF6, #A855F7)' : 'rgba(255,255,255,0.05)'}; border: 1px solid ${totalPages === sessionsPage ? 'transparent' : 'rgba(255,255,255,0.1)'}; border-radius: 6px; color: #fff; cursor: pointer; font-size: 13px;">${totalPages}</button>`;
        }
        document.getElementById('sessionsPagination').innerHTML = paginationHtml;
      } else {
        document.getElementById('sessionsPagination').innerHTML = '';
      }
    }

    function goToSessionsPage(page) {
      sessionsPage = page;
      loadSecuritySessions();
    }

    async function terminateSession(sessionId) {
      if (!confirm('Are you sure you want to terminate this session?\n\nThe user will be logged out from this device.')) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/security/sessions/${sessionId}/terminate`, {
          method: 'POST',
          credentials: 'include'
        });
        
        if (res.ok) {
          alert('Session terminated successfully');
          loadSecuritySessions();
        } else {
          const error = await res.json();
          alert(`Failed to terminate session: ${error.message}`);
        }
      } catch (e) {
        console.error('Failed to terminate session:', e);
        alert('Failed to terminate session. Please try again.');
      }
    }

    async function terminateAllUserSessions(userId, username) {
      if (!confirm(`Are you sure you want to terminate ALL sessions for @${username}?\n\nThis will log out the user from all devices.`)) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/security/sessions/user/${userId}/terminate-all`, {
          method: 'POST',
          credentials: 'include'
        });
        
        if (res.ok) {
          const result = await res.json();
          alert(`Terminated ${result.count} session(s) for @${username}`);
          loadSecuritySessions();
        } else {
          const error = await res.json();
          alert(`Failed to terminate sessions: ${error.message}`);
        }
      } catch (e) {
        console.error('Failed to terminate sessions:', e);
        alert('Failed to terminate sessions. Please try again.');
      }
    }

    // ===== DEVICE MANAGEMENT FUNCTIONS =====
    
    let devicesData = { devices: [], total: 0 };
    let devicesPage = 1;
    const devicesLimit = 20;

    async function loadSecurityDevices() {
      try {
        const search = document.getElementById('devicesSearch')?.value?.trim() || '';
        
        const [statsRes, devicesRes] = await Promise.all([
          fetch('/api/admin/security/devices/stats', { credentials: 'include' }),
          fetch(`/api/admin/security/devices?page=${devicesPage}&limit=${devicesLimit}&search=${encodeURIComponent(search)}`, { credentials: 'include' })
        ]);
        
        if (statsRes.ok) {
          const stats = await statsRes.json();
          const deviceTypesHtml = Object.entries(stats.deviceTypes || {}).map(([type, count]) => {
            const icon = type === 'mobile' ? 'üì±' : type === 'tablet' ? 'üì≤' : 'üíª';
            const label = type.charAt(0).toUpperCase() + type.slice(1);
            return `<div style="display: flex; align-items: center; gap: 8px; padding: 4px 0;"><span>${icon}</span><span>${label}:</span><span style="font-weight: 600;">${count}</span></div>`;
          }).join('') || '<div style="color: rgba(255,255,255,0.5);">No devices</div>';
          
          document.getElementById('deviceStats').innerHTML = `
            <div class="stat-card">
              <h3>Total Devices</h3>
              <div class="value">${formatNumber(stats.total)}</div>
            </div>
            <div class="stat-card">
              <h3>Active Last 30 Days</h3>
              <div class="value" style="color: #10B981;">${formatNumber(stats.activeLastMonth)}</div>
            </div>
            <div class="stat-card">
              <h3>Device Types</h3>
              <div style="font-size: 14px; margin-top: 8px;">${deviceTypesHtml}</div>
            </div>
          `;
        }
        
        if (devicesRes.ok) {
          devicesData = await devicesRes.json();
          renderSecurityDevicesTable();
        }
      } catch (e) {
        console.error('Failed to load devices:', e);
      }
    }

    function filterSecurityDevices() {
      devicesPage = 1;
      loadSecurityDevices();
    }

    function renderSecurityDevicesTable() {
      const { devices, total } = devicesData;
      
      if (devices.length === 0) {
        document.getElementById('devicesTable').innerHTML = '<div class="empty-state">No trusted devices found</div>';
        document.getElementById('devicesPagination').innerHTML = '';
        return;
      }

      const avatarUrl = (u) => u.avatarUrl || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(u.displayName || u.username || 'U') + '&background=8B5CF6&color=fff';
      
      const formatDate = (date) => {
        if (!date) return 'Never';
        const d = new Date(date);
        const now = new Date();
        const diff = now - d;
        if (diff < 60000) return 'Just now';
        if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
        if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
        return d.toLocaleDateString();
      };

      const getDeviceIcon = (deviceType) => {
        if (deviceType === 'mobile') return 'üì±';
        if (deviceType === 'tablet') return 'üì≤';
        return 'üíª';
      };
      
      document.getElementById('devicesTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Device Name</th>
              <th>Type</th>
              <th>Browser</th>
              <th>OS</th>
              <th>Last Used</th>
              <th>Added</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${devices.map(d => `
              <tr>
                <td>
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <img src="${avatarUrl(d.user)}" alt="" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">
                    <div>
                      <div style="font-weight: 500;">${escapeHtml(d.user.displayName || d.user.username)}</div>
                      <div style="font-size: 12px; color: rgba(255,255,255,0.5);">@${escapeHtml(d.user.username)}</div>
                    </div>
                  </div>
                </td>
                <td style="font-weight: 500;">${escapeHtml(d.deviceName || 'Unknown Device')}</td>
                <td>
                  <span style="display: flex; align-items: center; gap: 6px;">
                    ${getDeviceIcon(d.deviceType)}
                    ${escapeHtml(d.deviceType || 'unknown')}
                  </span>
                </td>
                <td style="color: rgba(255,255,255,0.7);">${escapeHtml(d.browser || 'Unknown')}</td>
                <td style="color: rgba(255,255,255,0.7);">${escapeHtml(d.os || 'Unknown')}</td>
                <td style="color: rgba(255,255,255,0.7);">${formatDate(d.lastUsedAt)}</td>
                <td style="color: rgba(255,255,255,0.5); font-size: 12px;">${formatDate(d.createdAt)}</td>
                <td>
                  <div style="display: flex; gap: 8px;">
                    <button class="btn-small btn-danger" onclick="removeDevice('${d.id}', '${escapeHtml(d.deviceName || 'this device')}')" title="Remove device">Remove</button>
                    <button class="btn-small btn-warning" onclick="removeAllUserDevices('${d.user.id}', '${escapeHtml(d.user.username)}')" title="Remove all devices for this user">Remove All</button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      
      // Pagination
      const totalPages = Math.ceil(total / devicesLimit);
      if (totalPages > 1) {
        let paginationHtml = '';
        if (devicesPage > 1) {
          paginationHtml += `<button class="btn-small" onclick="devicesPage--; loadSecurityDevices();">Prev</button>`;
        }
        paginationHtml += `<span style="padding: 8px 12px; color: rgba(255,255,255,0.7);">Page ${devicesPage} of ${totalPages}</span>`;
        if (devicesPage < totalPages) {
          paginationHtml += `<button class="btn-small" onclick="devicesPage++; loadSecurityDevices();">Next</button>`;
        }
        document.getElementById('devicesPagination').innerHTML = paginationHtml;
      } else {
        document.getElementById('devicesPagination').innerHTML = '';
      }
    }

    async function removeDevice(deviceId, deviceName) {
      if (!confirm(`Are you sure you want to remove "${deviceName}"?\n\nThe user will need to re-verify this device on their next login.`)) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/security/devices/${deviceId}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (res.ok) {
          alert('Device removed successfully');
          loadSecurityDevices();
        } else {
          const error = await res.json();
          alert(`Failed to remove device: ${error.message}`);
        }
      } catch (e) {
        console.error('Failed to remove device:', e);
        alert('Failed to remove device. Please try again.');
      }
    }

    async function removeAllUserDevices(userId, username) {
      if (!confirm(`Are you sure you want to remove ALL trusted devices for @${username}?\n\nThe user will need to re-verify all their devices.`)) {
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/security/devices/user/${userId}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (res.ok) {
          const result = await res.json();
          alert(`Removed ${result.count} device(s) for @${username}`);
          loadSecurityDevices();
        } else {
          const error = await res.json();
          alert(`Failed to remove devices: ${error.message}`);
        }
      } catch (e) {
        console.error('Failed to remove devices:', e);
        alert('Failed to remove devices. Please try again.');
      }
    }

    // ===== NEW ADMIN ACTION FUNCTIONS =====
    
    async function sendBroadcast() {
      const message = document.getElementById('broadcastMessage').value.trim();
      const type = document.getElementById('broadcastType').value;
      
      if (!message) {
        alert('Please enter a message');
        return;
      }
      
      if (!confirm(`Send this message to ALL users?\n\n"${message}"`)) {
        return;
      }
      
      try {
        const res = await fetch('/api/admin/notifications/broadcast', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ message, type })
        });
        
        if (res.ok) {
          const result = await res.json();
          alert(`Broadcast sent to ${result.sentTo} users!`);
          document.getElementById('broadcastMessage').value = '';
          loadBroadcasts();
        } else {
          const error = await res.json();
          alert('Failed to send broadcast: ' + (error.message || 'Unknown error'));
        }
      } catch (e) {
        console.error('Failed to send broadcast:', e);
        alert('Error sending broadcast');
      }
    }

    async function deleteEvent(eventId) {
      try {
        const res = await fetch(`/api/admin/events/${eventId}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (res.ok) {
          loadEvents();
        } else {
          alert('Failed to delete event');
        }
      } catch (e) {
        console.error('Failed to delete event:', e);
        alert('Error deleting event');
      }
    }

    // ===== ENHANCED ADMIN FUNCTIONS =====

    // Groups: View Members
    async function viewGroupMembers(groupId, groupName) {
      try {
        const res = await fetch(`/api/admin/groups/${groupId}/members`, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load members');
        const members = await res.json();
        
        const content = members.length === 0 
          ? '<div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">No members yet</div>'
          : `<table class="table" style="margin: 0;">
              <thead><tr><th>User</th><th>Role</th><th>Joined</th><th>Actions</th></tr></thead>
              <tbody>${members.map(m => `
                <tr>
                  <td>@${escapeHtml(m.username || 'Unknown')}</td>
                  <td><span class="badge ${m.role === 'ADMIN' ? 'badge-active' : ''}">${m.role || 'MEMBER'}</span></td>
                  <td>${formatDate(m.joinedAt)}</td>
                  <td><button class="action-btn action-btn-danger" onclick="removeGroupMember('${groupId}', '${m.id}')" style="padding: 4px 8px; font-size: 11px;">Remove</button></td>
                </tr>
              `).join('')}</tbody>
            </table>`;
        
        showGenericModal('Group Members: ' + groupName, content);
      } catch (e) {
        console.error('Failed to load group members:', e);
        alert('Error loading members');
      }
    }

    async function removeGroupMember(groupId, memberId) {
      if (!confirm('Remove this member from the group?')) return;
      try {
        const res = await fetch(`/api/admin/groups/${groupId}/members/${memberId}`, { method: 'DELETE', credentials: 'include' });
        if (res.ok) {
          viewGroupMembers(groupId, 'Group');
          loadGroups();
        } else alert('Failed to remove member');
      } catch (e) { console.error('Failed to remove member:', e); alert('Error removing member'); }
    }

    // Groups: Edit Settings
    async function editGroupSettings(groupId) {
      try {
        const res = await fetch(`/api/admin/groups/${groupId}`, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load group');
        const group = await res.json();
        
        const content = `
          <div class="form-group">
            <label>Group Name</label>
            <input type="text" id="editGroupName" value="${escapeHtml(group.name || '')}" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea id="editGroupDescription" rows="3" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">${escapeHtml(group.description || '')}</textarea>
          </div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px;">
              <input type="checkbox" id="editGroupPrivate" ${group.isPrivate ? 'checked' : ''}>
              Private Group
            </label>
          </div>
          <button class="action-btn action-btn-primary" onclick="saveGroupSettings('${groupId}')" style="width: 100%; padding: 12px;">Save Settings</button>
        `;
        
        showGenericModal('Edit Group Settings', content);
      } catch (e) {
        console.error('Failed to load group:', e);
        alert('Error loading group settings');
      }
    }

    async function saveGroupSettings(groupId) {
      const name = document.getElementById('editGroupName').value.trim();
      const description = document.getElementById('editGroupDescription').value.trim();
      const isPrivate = document.getElementById('editGroupPrivate').checked;
      
      try {
        const res = await fetch(`/api/admin/groups/${groupId}/settings`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ name, description, isPrivate })
        });
        
        if (res.ok) {
          closeGenericModal();
          loadGroups();
          alert('Group settings updated');
        } else alert('Failed to save settings');
      } catch (e) { console.error('Failed to save settings:', e); alert('Error saving settings'); }
    }

    // Live Streams: View Viewers
    async function viewStreamViewers(streamId, streamTitle) {
      try {
        const res = await fetch(`/api/admin/livestreams/${streamId}/viewers`, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load viewers');
        const viewers = await res.json();
        
        const content = viewers.length === 0 
          ? '<div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">No viewers recorded</div>'
          : `<table class="table" style="margin: 0;">
              <thead><tr><th>Viewer</th><th>Joined</th><th>Left</th></tr></thead>
              <tbody>${viewers.map(v => `
                <tr>
                  <td>@${escapeHtml(v.username || 'Unknown')}</td>
                  <td>${formatDate(v.joinedAt)}</td>
                  <td>${v.leftAt ? formatDate(v.leftAt) : '<span style="color: #22c55e;">Still watching</span>'}</td>
                </tr>
              `).join('')}</tbody>
            </table>`;
        
        showGenericModal('Stream Viewers: ' + streamTitle, content);
      } catch (e) {
        console.error('Failed to load viewers:', e);
        alert('Error loading viewers');
      }
    }

    // Events: Update Status
    async function updateEventStatus(eventId, status) {
      try {
        const res = await fetch(`/api/admin/events/${eventId}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ status })
        });
        
        if (!res.ok) {
          alert('Failed to update event status');
          loadEvents();
        }
      } catch (e) {
        console.error('Failed to update event status:', e);
        loadEvents();
      }
    }

    // Events: View Attendees
    async function viewEventAttendees(eventId, eventTitle) {
      try {
        const res = await fetch(`/api/admin/events/${eventId}/attendees`, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load attendees');
        const attendees = await res.json();
        
        const content = attendees.length === 0 
          ? '<div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">No attendees yet</div>'
          : `<table class="table" style="margin: 0;">
              <thead><tr><th>User</th><th>RSVP Status</th><th>Date</th><th>Actions</th></tr></thead>
              <tbody>${attendees.map(a => `
                <tr>
                  <td>@${escapeHtml(a.username || 'Unknown')}</td>
                  <td><span class="badge ${a.status === 'GOING' ? 'badge-active' : ''}">${a.status || 'Unknown'}</span></td>
                  <td>${formatDate(a.createdAt)}</td>
                  <td><button class="action-btn action-btn-danger" onclick="removeEventAttendee('${eventId}', '${a.id}')" style="padding: 4px 8px; font-size: 11px;">Remove</button></td>
                </tr>
              `).join('')}</tbody>
            </table>`;
        
        showGenericModal('Event Attendees: ' + eventTitle, content);
      } catch (e) {
        console.error('Failed to load attendees:', e);
        alert('Error loading attendees');
      }
    }

    async function removeEventAttendee(eventId, attendeeId) {
      if (!confirm('Remove this attendee from the event?')) return;
      try {
        const res = await fetch(`/api/admin/events/${eventId}/attendees/${attendeeId}`, { method: 'DELETE', credentials: 'include' });
        if (res.ok) {
          viewEventAttendees(eventId, 'Event');
        } else alert('Failed to remove attendee');
      } catch (e) { console.error('Failed to remove attendee:', e); alert('Error removing attendee'); }
    }

    // Subscriptions: Toggle Active
    async function toggleTierActive(tierId, isActive) {
      try {
        const res = await fetch(`/api/admin/subscriptions/${tierId}/toggle-active`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ isActive })
        });
        
        if (res.ok) {
          loadSubscriptions();
        } else alert('Failed to update tier');
      } catch (e) {
        console.error('Failed to toggle tier:', e);
        alert('Error updating tier');
      }
    }

    // Subscriptions: View Subscribers
    async function viewTierSubscribers(tierId, tierName) {
      try {
        const res = await fetch(`/api/admin/subscriptions/${tierId}/subscribers`, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load subscribers');
        const subs = await res.json();
        
        const content = subs.length === 0 
          ? '<div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">No subscribers yet</div>'
          : `<table class="table" style="margin: 0;">
              <thead><tr><th>Subscriber</th><th>Status</th><th>Started</th><th>Expires</th></tr></thead>
              <tbody>${subs.map(s => `
                <tr>
                  <td>@${escapeHtml(s.username || 'Unknown')}</td>
                  <td><span class="badge ${s.status === 'ACTIVE' ? 'badge-active' : 'badge-inactive'}">${s.status || 'Unknown'}</span></td>
                  <td>${formatDate(s.startedAt)}</td>
                  <td>${formatDate(s.expiresAt)}</td>
                </tr>
              `).join('')}</tbody>
            </table>`;
        
        showGenericModal('Tier Subscribers: ' + tierName, content);
      } catch (e) {
        console.error('Failed to load subscribers:', e);
        alert('Error loading subscribers');
      }
    }

    // Broadcasts: Channel Messages
    async function viewChannelMessages(channelId, channelName) {
      try {
        const res = await fetch(`/api/admin/broadcasts/channels/${channelId}/messages`, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load messages');
        const msgs = await res.json();
        
        const content = msgs.length === 0 
          ? '<div style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">No messages yet</div>'
          : `<div style="max-height: 400px; overflow-y: auto;">
              ${msgs.map(m => `
                <div style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                  <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-bottom: 4px;">${formatDate(m.createdAt)} ${m.scheduledFor ? ' (scheduled)' : ''}</div>
                  <div>${escapeHtml(m.content || '')}</div>
                  ${m.mediaUrl ? `<div style="margin-top: 4px; color: #8b5cf6; font-size: 12px;">Attachment: ${m.mediaType || 'Media'}</div>` : ''}
                </div>
              `).join('')}
            </div>`;
        
        showGenericModal('Channel Messages: ' + channelName, content);
      } catch (e) {
        console.error('Failed to load messages:', e);
        alert('Error loading messages');
      }
    }

    // Broadcasts: Toggle Verified
    async function toggleChannelVerified(channelId, isVerified) {
      try {
        const res = await fetch(`/api/admin/broadcasts/channels/${channelId}/verify`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ isVerified })
        });
        
        if (res.ok) {
          loadBroadcasts();
        } else alert('Failed to update channel');
      } catch (e) {
        console.error('Failed to toggle channel:', e);
        alert('Error updating channel');
      }
    }

    // Broadcasts: Delete Channel
    async function deleteBroadcastChannel(channelId) {
      if (!confirm('Delete this broadcast channel and all its messages? This cannot be undone.')) return;
      try {
        const res = await fetch(`/api/admin/broadcasts/channels/${channelId}`, { method: 'DELETE', credentials: 'include' });
        if (res.ok) {
          loadBroadcasts();
        } else alert('Failed to delete channel');
      } catch (e) {
        console.error('Failed to delete channel:', e);
        alert('Error deleting channel');
      }
    }

    // Generic Modal Helpers
    function showGenericModal(title, content) {
      const existingModal = document.getElementById('genericModal');
      if (existingModal) existingModal.remove();
      
      const modal = document.createElement('div');
      modal.id = 'genericModal';
      modal.className = 'modal-overlay';
      modal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;';
      modal.innerHTML = `
        <div class="modal" style="max-width: 700px; max-height: 80vh; overflow-y: auto; background: #1a1a2e; border-radius: 12px; padding: 0;">
          <div class="modal-header" style="padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; font-size: 18px;">${escapeHtml(title)}</h2>
            <button onclick="closeGenericModal()" style="background: none; border: none; color: #fff; font-size: 24px; cursor: pointer;">&times;</button>
          </div>
          <div class="modal-body" style="padding: 16px 20px;">
            ${content}
          </div>
        </div>
      `;
      modal.onclick = (e) => { if (e.target === modal) closeGenericModal(); };
      document.body.appendChild(modal);
    }

    function closeGenericModal() {
      const modal = document.getElementById('genericModal');
      if (modal) modal.remove();
    }

    async function toggleHashtagTrending(hashtagId, isTrending) {
      try {
        const res = await fetch(`/api/admin/hashtags/${hashtagId}/trending`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ isTrending })
        });
        
        if (res.ok) {
          loadHashtags();
        } else {
          alert('Failed to update hashtag');
        }
      } catch (e) {
        console.error('Failed to update hashtag:', e);
        alert('Error updating hashtag');
      }
    }

    async function adminRemoveBlock(blockId) {
      try {
        const res = await fetch(`/api/admin/blocks/${blockId}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (res.ok) {
          loadBlocks();
        } else {
          alert('Failed to remove block');
        }
      } catch (e) {
        console.error('Failed to remove block:', e);
        alert('Error removing block');
      }
    }

    async function deleteReel(reelId) {
      try {
        const res = await fetch(`/api/admin/posts/${reelId}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (res.ok) {
          loadReels();
        } else {
          alert('Failed to delete reel');
        }
      } catch (e) {
        console.error('Failed to delete reel:', e);
        alert('Error deleting reel');
      }
    }

    async function loadMallItems() {
      try {
        const res = await fetch('/api/admin/mall/items-list', { credentials: 'include' });
        if (res.ok) {
          allMallItems = await res.json();
          populateItemSelect();
        }
      } catch (e) {
        console.error('Failed to load mall items:', e);
      }
    }

    function populateItemSelect() {
      const select = document.getElementById('addItemSelect');
      if (!select) return;
      
      select.innerHTML = '<option value="">Select a product...</option>' + 
        allMallItems.map(item => `<option value="${item.id}" data-value="${item.value}">${escapeHtml(item.name)} (R${(item.value || 0).toLocaleString()}) - ${escapeHtml(item.categoryName || 'Uncategorized')}</option>`).join('');
      
      select.onchange = updateItemPreview;
    }

    function updateItemPreview() {
      const select = document.getElementById('addItemSelect');
      const qty = parseInt(document.getElementById('addItemQuantity')?.value) || 1;
      const preview = document.getElementById('addItemPreview');
      
      const selectedOption = select.options[select.selectedIndex];
      if (selectedOption && selectedOption.value) {
        const value = parseInt(selectedOption.dataset.value) || 0;
        const total = value * qty;
        preview.innerHTML = `<div style="font-weight: 500;">Net Worth Added: <span style="color: #22c55e;">+R${total.toLocaleString()}</span></div>`;
      } else {
        preview.innerHTML = '<span style="color: rgba(255,255,255,0.6);">Select a product to see value</span>';
      }
    }

    function showAddItemModal() {
      document.getElementById('addItemUserId').value = currentPortfolioUserId;
      document.getElementById('addItemQuantity').value = '1';
      populateItemSelect();
      openModal('addItemModal');
    }

    async function confirmAddItem() {
      const userId = document.getElementById('addItemUserId').value;
      const itemId = document.getElementById('addItemSelect').value;
      const quantity = parseInt(document.getElementById('addItemQuantity').value) || 1;
      
      if (!itemId) {
        alert('Please select a product');
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/users/${userId}/portfolio`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ itemId, quantity })
        });
        
        if (res.ok) {
          const result = await res.json();
          alert(result.message);
          closeModal('addItemModal');
          await openUserPortfolio(userId);
          await loadWealthUsers();
        } else {
          const err = await res.json();
          alert('Failed: ' + (err.message || 'Unknown error'));
        }
      } catch (e) {
        console.error('Failed to add item:', e);
        alert('Error adding item');
      }
    }

    async function removePortfolioItem(purchaseId) {
      if (!confirm('Are you sure you want to remove this item? This will reduce the user\'s net worth.')) return;
      
      try {
        const res = await fetch(`/api/admin/users/${currentPortfolioUserId}/portfolio/${purchaseId}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (res.ok) {
          const result = await res.json();
          alert(result.message);
          await openUserPortfolio(currentPortfolioUserId);
          await loadWealthUsers();
        } else {
          const err = await res.json();
          alert('Failed: ' + (err.message || 'Unknown error'));
        }
      } catch (e) {
        console.error('Failed to remove item:', e);
        alert('Error removing item');
      }
    }

    function showAdjustNetWorthModal() {
      const data = currentPortfolioData;
      if (!data) return;
      
      document.getElementById('adjustUserId').value = currentPortfolioUserId;
      document.getElementById('adjustUserInfo').innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
          <div style="font-weight: 500;">${escapeHtml(data.user.displayName || data.user.username)}</div>
          <div style="margin-left: auto; color: #22c55e; font-weight: 600;">Current: R${(data.user.netWorth || 0).toLocaleString()}</div>
        </div>
      `;
      document.getElementById('adjustAmount').value = '';
      document.getElementById('adjustReason').value = '';
      openModal('adjustNetWorthModal');
    }

    async function confirmAdjustNetWorth() {
      const userId = document.getElementById('adjustUserId').value;
      const amount = parseInt(document.getElementById('adjustAmount').value);
      const reason = document.getElementById('adjustReason').value;
      
      if (isNaN(amount) || amount === 0) {
        alert('Please enter a valid amount (positive or negative)');
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/users/${userId}/networth/adjust`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount, reason })
        });
        
        if (res.ok) {
          const result = await res.json();
          alert(result.message);
          closeModal('adjustNetWorthModal');
          await openUserPortfolio(userId);
          await loadWealthUsers();
        } else {
          const err = await res.json();
          alert('Failed: ' + (err.message || 'Unknown error'));
        }
      } catch (e) {
        console.error('Failed to adjust net worth:', e);
        alert('Error adjusting net worth');
      }
    }

    function openQuickEditNetWorth(userId, username, displayName, currentNetWorth) {
      document.getElementById('quickEditUserId').value = userId;
      document.getElementById('quickEditDisplayName').textContent = displayName || username || 'Unknown';
      document.getElementById('quickEditUsername').textContent = '@' + (username || '');
      document.getElementById('quickEditCurrentValue').textContent = 'R' + (currentNetWorth || 0).toLocaleString();
      document.getElementById('quickEditNewNetWorth').value = currentNetWorth || 0;
      document.getElementById('quickEditReason').value = '';
      openModal('quickEditNetWorthModal');
    }

    async function confirmQuickEditNetWorth() {
      const userId = document.getElementById('quickEditUserId').value;
      const newNetWorth = parseInt(document.getElementById('quickEditNewNetWorth').value);
      const reason = document.getElementById('quickEditReason').value || 'Admin adjustment';
      
      if (isNaN(newNetWorth) || newNetWorth < 0) {
        alert('Please enter a valid net worth value (0 or greater)');
        return;
      }
      
      try {
        const res = await fetch(`/api/admin/users/${userId}/set-networth`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ netWorth: newNetWorth, reason })
        });
        
        if (res.ok) {
          const result = await res.json();
          alert(`Net worth updated successfully!\nOld: R${result.oldNetWorth?.toLocaleString() || 0}\nNew: R${result.newNetWorth?.toLocaleString() || newNetWorth}`);
          closeModal('quickEditNetWorthModal');
          await loadWealthUsers();
        } else {
          const err = await res.json();
          alert('Failed: ' + (err.message || 'Unknown error'));
        }
      } catch (e) {
        console.error('Failed to set net worth:', e);
        alert('Error setting net worth');
      }
    }

    function openModal(id) {
      document.getElementById(id).classList.add('active');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    function formatNumber(num) {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toString();
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    // ===== MALL FUNCTIONS =====

    async function loadMall() {
      await Promise.all([loadMallCategories(), loadMallProducts(), loadMallPurchases()]);
      renderMallStats();
    }

    async function loadMallCategories() {
      try {
        const res = await fetch('/api/mall/categories', { credentials: 'include' });
        if (res.ok) {
          mallCategories = await res.json();
          renderMallCategories();
          populateCategorySelect();
        }
      } catch (e) {
        console.error('Failed to load mall categories:', e);
      }
    }

    async function loadMallProducts() {
      try {
        const res = await fetch('/api/mall/items', { credentials: 'include' });
        if (res.ok) {
          mallProducts = await res.json();
          renderMallProducts();
        }
      } catch (e) {
        console.error('Failed to load mall products:', e);
      }
    }

    async function loadMallPurchases() {
      try {
        const res = await fetch('/api/admin/mall/purchases', { credentials: 'include' });
        if (res.ok) {
          mallPurchases = await res.json();
          renderMallPurchases();
        }
      } catch (e) {
        console.error('Failed to load mall purchases:', e);
      }
    }

    function renderMallStats() {
      const totalProducts = mallProducts.length;
      const totalCategories = mallCategories.length;
      const totalPurchases = mallPurchases.length;
      const totalRevenue = mallPurchases.reduce((sum, p) => sum + (p.totalValue || p.value || 0), 0);
      
      document.getElementById('mallStats').innerHTML = `
        <div class="stat-card">
          <h3>Total Products</h3>
          <div class="value">${formatNumber(totalProducts)}</div>
        </div>
        <div class="stat-card">
          <h3>Categories</h3>
          <div class="value">${formatNumber(totalCategories)}</div>
        </div>
        <div class="stat-card">
          <h3>Total Purchases</h3>
          <div class="value">${formatNumber(totalPurchases)}</div>
        </div>
        <div class="stat-card">
          <h3>Total Value Sold</h3>
          <div class="value">R${formatNumber(totalRevenue)}</div>
        </div>
      `;
    }

    function showMallTab(tab, buttonEl) {
      currentMallTab = tab;
      document.querySelectorAll('#mallTabs .filter-btn').forEach(b => b.classList.remove('active'));
      if (buttonEl) buttonEl.classList.add('active');
      
      document.getElementById('mallProductsTab').style.display = tab === 'products' ? 'block' : 'none';
      document.getElementById('mallCategoriesTab').style.display = tab === 'categories' ? 'block' : 'none';
      document.getElementById('mallPurchasesTab').style.display = tab === 'purchases' ? 'block' : 'none';
    }

    function showMallTabByButton(buttonEl) {
      const tab = buttonEl.getAttribute('data-tab');
      showMallTab(tab, buttonEl);
    }

    function renderMallProducts() {
      const search = (document.getElementById('productSearch')?.value || '').toLowerCase();
      let filtered = mallProducts.filter(p => {
        return !search || 
          (p.name && p.name.toLowerCase().includes(search)) ||
          (p.description && p.description.toLowerCase().includes(search));
      });

      if (filtered.length === 0) {
        document.getElementById('mallProductsTable').innerHTML = '<div class="empty-state">No products found</div>';
        return;
      }

      const getCategoryName = (catId) => {
        const cat = mallCategories.find(c => c.id === catId);
        return cat ? cat.name : 'Unknown';
      };

      document.getElementById('mallProductsTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Product</th>
              <th>Category</th>
              <th>Value</th>
              <th>Net Worth Gain</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.map(p => `
              <tr>
                <td>
                  <div style="display: flex; align-items: center; gap: 12px;">
                    ${p.imageUrl ? `<img src="${p.imageUrl}" style="width: 40px; height: 40px; border-radius: 8px; object-fit: cover;">` : '<div style="width: 40px; height: 40px; border-radius: 8px; background: rgba(139, 92, 246, 0.2); display: flex; align-items: center; justify-content: center;">üõçÔ∏è</div>'}
                    <div>
                      <div style="font-weight: 500;">${p.name || 'Unknown'}</div>
                      <div style="font-size: 12px; color: rgba(255,255,255,0.5); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${p.description || ''}</div>
                    </div>
                  </div>
                </td>
                <td><span class="badge badge-active">${getCategoryName(p.categoryId)}</span></td>
                <td style="font-weight: 600; color: #10B981;">R${formatNumber(p.value || 0)}</td>
                <td style="color: #8B5CF6;">R${formatNumber((p.value || 0) * 10)}</td>
                <td>
                  <button class="action-btn action-btn-primary" onclick="editProduct('${p.id}')" style="padding: 6px 12px; font-size: 12px;">Edit</button>
                  <button class="action-btn action-btn-danger" onclick="deleteProduct('${p.id}')" style="padding: 6px 12px; font-size: 12px;">Delete</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function filterMallProducts() {
      renderMallProducts();
    }

    function renderMallCategories() {
      if (mallCategories.length === 0) {
        document.getElementById('mallCategoriesTable').innerHTML = '<div class="empty-state">No categories found</div>';
        return;
      }

      document.getElementById('mallCategoriesTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Category Name</th>
              <th>Description</th>
              <th>Products</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${mallCategories.map(c => {
              const productCount = mallProducts.filter(p => p.categoryId === c.id).length;
              return `
              <tr>
                <td style="font-weight: 500;">${c.name || 'Unknown'}</td>
                <td style="color: rgba(255,255,255,0.6);">${c.description || '-'}</td>
                <td><span class="badge badge-active">${productCount}</span></td>
                <td>
                  <button class="action-btn action-btn-primary" onclick="editCategory('${c.id}')" style="padding: 6px 12px; font-size: 12px;">Edit</button>
                  <button class="action-btn action-btn-danger" onclick="deleteCategory('${c.id}')" style="padding: 6px 12px; font-size: 12px;">Delete</button>
                </td>
              </tr>
            `}).join('')}
          </tbody>
        </table>
      `;
    }

    function renderMallPurchases() {
      const search = (document.getElementById('purchaseSearch')?.value || '').toLowerCase();
      let filtered = mallPurchases.filter(p => {
        return !search || 
          (p.username && p.username.toLowerCase().includes(search)) ||
          (p.displayName && p.displayName.toLowerCase().includes(search)) ||
          (p.itemName && p.itemName.toLowerCase().includes(search));
      });

      if (filtered.length === 0) {
        document.getElementById('mallPurchasesTable').innerHTML = '<div class="empty-state">No purchases found</div>';
        return;
      }

      const avatarUrl = (u) => u.avatarUrl || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(u.displayName || u.username || 'U') + '&background=8B5CF6&color=fff';

      document.getElementById('mallPurchasesTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Item</th>
              <th>Qty</th>
              <th>Value</th>
              <th>Net Worth</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.map(p => `
              <tr>
                <td>
                  <div class="user-cell">
                    <div class="avatar"><img src="${avatarUrl(p)}" alt="${p.displayName || p.username}"></div>
                    <div class="user-info">
                      <span class="user-name">${p.displayName || p.username || 'Unknown'}</span>
                      <span class="user-email">@${p.username || 'unknown'}</span>
                    </div>
                  </div>
                </td>
                <td style="font-weight: 500;">${p.itemName || 'Unknown'}</td>
                <td>${p.quantity || 1}</td>
                <td style="color: #10B981;">R${formatNumber(p.totalValue || p.value || 0)}</td>
                <td style="color: #8B5CF6;">R${formatNumber(p.userNetWorth || 0)}</td>
                <td>${formatDate(p.purchasedAt || p.createdAt)}</td>
                <td>
                  <button class="action-btn action-btn-primary" onclick="showSetNetWorthModal('${p.userId}', '${p.username}', ${p.userNetWorth || 0})" style="padding: 6px 12px; font-size: 12px;">Set Net Worth</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function filterPurchases() {
      renderMallPurchases();
    }

    function populateCategorySelect() {
      const select = document.getElementById('productCategory');
      select.innerHTML = '<option value="">Select category...</option>' + 
        mallCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }

    function showAddProductModal() {
      document.getElementById('productModalTitle').textContent = 'Add Product';
      document.getElementById('productId').value = '';
      document.getElementById('productName').value = '';
      document.getElementById('productDescription').value = '';
      document.getElementById('productValue').value = '';
      document.getElementById('productCategory').value = '';
      document.getElementById('productImageUrl').value = '';
      populateCategorySelect();
      document.getElementById('productModal').classList.add('active');
    }

    function editProduct(id) {
      const product = mallProducts.find(p => p.id === id);
      if (!product) return;
      
      document.getElementById('productModalTitle').textContent = 'Edit Product';
      document.getElementById('productId').value = product.id;
      document.getElementById('productName').value = product.name || '';
      document.getElementById('productDescription').value = product.description || '';
      document.getElementById('productValue').value = product.value || '';
      document.getElementById('productCategory').value = product.categoryId || '';
      document.getElementById('productImageUrl').value = product.imageUrl || '';
      populateCategorySelect();
      document.getElementById('productCategory').value = product.categoryId || '';
      document.getElementById('productModal').classList.add('active');
    }

    async function saveProduct() {
      const id = document.getElementById('productId').value;
      const name = document.getElementById('productName').value;
      const description = document.getElementById('productDescription').value;
      const value = document.getElementById('productValue').value;
      const categoryId = document.getElementById('productCategory').value;
      const imageUrl = document.getElementById('productImageUrl').value;

      if (!name || !value || !categoryId || !description) {
        alert('Please fill in all required fields (name, description, value, category)');
        return;
      }

      try {
        const url = id ? '/api/admin/mall/items/' + id : '/api/admin/mall/items';
        const method = id ? 'PATCH' : 'POST';
        
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ name, description, value: parseInt(value), categoryId, imageUrl })
        });

        if (res.ok) {
          closeModal('productModal');
          await loadMallProducts();
          renderMallStats();
        } else {
          const err = await res.json();
          alert(err.message || 'Failed to save product');
        }
      } catch (e) {
        alert('Failed to save product');
      }
    }

    async function deleteProduct(id) {
      if (!confirm('Are you sure you want to delete this product?')) return;
      
      try {
        const res = await fetch('/api/admin/mall/items/' + id, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (res.ok) {
          await loadMallProducts();
          renderMallStats();
        } else {
          alert('Failed to delete product');
        }
      } catch (e) {
        alert('Failed to delete product');
      }
    }

    function showAddCategoryModal() {
      document.getElementById('categoryModalTitle').textContent = 'Add Category';
      document.getElementById('categoryId').value = '';
      document.getElementById('categoryName').value = '';
      document.getElementById('categoryDescription').value = '';
      document.getElementById('categoryModal').classList.add('active');
    }

    function editCategory(id) {
      const category = mallCategories.find(c => c.id === id);
      if (!category) return;
      
      document.getElementById('categoryModalTitle').textContent = 'Edit Category';
      document.getElementById('categoryId').value = category.id;
      document.getElementById('categoryName').value = category.name || '';
      document.getElementById('categoryDescription').value = category.description || '';
      document.getElementById('categoryModal').classList.add('active');
    }

    async function saveCategory() {
      const id = document.getElementById('categoryId').value;
      const name = document.getElementById('categoryName').value;
      const description = document.getElementById('categoryDescription').value;

      if (!name) {
        alert('Please enter a category name');
        return;
      }

      try {
        const url = id ? '/api/admin/mall/categories/' + id : '/api/admin/mall/categories';
        const method = id ? 'PATCH' : 'POST';
        
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ name, description })
        });

        if (res.ok) {
          closeModal('categoryModal');
          await loadMallCategories();
          renderMallStats();
        } else {
          const err = await res.json();
          alert(err.message || 'Failed to save category');
        }
      } catch (e) {
        alert('Failed to save category');
      }
    }

    async function deleteCategory(id) {
      const productCount = mallProducts.filter(p => p.categoryId === id).length;
      if (productCount > 0) {
        alert('Cannot delete category with ' + productCount + ' products. Remove products first.');
        return;
      }
      
      if (!confirm('Are you sure you want to delete this category?')) return;
      
      try {
        const res = await fetch('/api/admin/mall/categories/' + id, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (res.ok) {
          await loadMallCategories();
          renderMallStats();
        } else {
          alert('Failed to delete category');
        }
      } catch (e) {
        alert('Failed to delete category');
      }
    }

    function showSetNetWorthModal(userId, username, currentNetWorth) {
      document.getElementById('netWorthUserId').value = userId;
      document.getElementById('netWorthUsername').textContent = '@' + username;
      document.getElementById('currentNetWorth').textContent = 'R' + formatNumber(currentNetWorth);
      document.getElementById('newNetWorth').value = currentNetWorth;
      document.getElementById('netWorthModal').classList.add('active');
    }

    async function saveNetWorth() {
      const userId = document.getElementById('netWorthUserId').value;
      const netWorth = document.getElementById('newNetWorth').value;

      if (!netWorth || isNaN(netWorth)) {
        alert('Please enter a valid net worth amount');
        return;
      }

      try {
        const res = await fetch('/api/admin/users/' + userId + '/set-networth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ netWorth: parseInt(netWorth) })
        });

        if (res.ok) {
          closeModal('netWorthModal');
          await loadMallPurchases();
          await loadUsers();
        } else {
          const err = await res.json();
          alert(err.message || 'Failed to set net worth');
        }
      } catch (e) {
        alert('Failed to set net worth');
      }
    }

    async function seedMall() {
      if (!confirm('This will add sample luxury products to the mall. Continue?')) return;
      
      try {
        const res = await fetch('/api/admin/mall/seed', {
          method: 'POST',
          credentials: 'include'
        });
        
        if (res.ok) {
          const data = await res.json();
          alert('Mall seeded! Categories: ' + (data.categories || 0) + ', Items: ' + (data.items || 0));
          await loadMall();
        } else {
          const err = await res.json();
          alert(err.message || 'Failed to seed mall');
        }
      } catch (e) {
        alert('Failed to seed mall');
      }
    }

    async function fixMallPrices() {
      if (!confirm('This will set coinPrice = value for all items that have coinPrice = 0. Continue?')) return;
      
      try {
        const res = await fetch('/api/admin/mall/fix-prices', {
          method: 'POST',
          credentials: 'include'
        });
        
        if (res.ok) {
          const data = await res.json();
          alert('Prices fixed! ' + data.message);
          await loadMall();
        } else {
          const err = await res.json();
          alert(err.message || 'Failed to fix prices');
        }
      } catch (e) {
        alert('Failed to fix mall prices');
      }
    }

    // Expose all functions to window for onclick handlers
    // window.showSection is already defined in first script block - don't overwrite it
    window.handleLogout = handleLogout;
    window.togglePassword = togglePassword;
    window.setUserFilter = setUserFilter;
    window.setPostFilter = setPostFilter;
    window.setReportFilter = setReportFilter;
    window.viewUser = viewUser;
    window.suspendUser = suspendUser;
    window.unsuspendUser = unsuspendUser;
    window.confirmSuspend = confirmSuspend;
    window.toggleAdmin = toggleAdmin;
    window.toggleVerified = toggleVerified;
    window.closeModal = closeModal;
    window.confirmDeletePost = confirmDeletePost;
    window.deletePost = deletePost;
    window.deleteComment = deleteComment;
    window.deleteStory = deleteStory;
    window.resolveReport = resolveReport;
    window.handleVerification = handleVerification;
    window.showCreateRoleModal = showCreateRoleModal;
    window.createRole = createRole;
    window.deleteRole = deleteRole;
    window.toggleSetting = toggleSetting;
    // Mall functions
    window.loadMall = loadMall;
    window.showMallTab = showMallTab;
    window.filterMallProducts = filterMallProducts;
    window.filterPurchases = filterPurchases;
    window.showAddProductModal = showAddProductModal;
    window.editProduct = editProduct;
    window.saveProduct = saveProduct;
    window.deleteProduct = deleteProduct;
    window.showAddCategoryModal = showAddCategoryModal;
    window.editCategory = editCategory;
    window.saveCategory = saveCategory;
    window.deleteCategory = deleteCategory;
    window.showSetNetWorthModal = showSetNetWorthModal;
    window.saveNetWorth = saveNetWorth;
    window.seedMall = seedMall;
    window.fixMallPrices = fixMallPrices;
    window.showMallTabByButton = showMallTabByButton;
    // New section functions
    window.loadMessages = loadMessages;
    window.renderConversations = renderConversations;
    window.loadGroups = loadGroups;
    window.renderGroups = renderGroups;
    window.loadLivestreams = loadLivestreams;
    window.setLivestreamFilter = setLivestreamFilter;
    window.renderLivestreams = renderLivestreams;
    window.loadWallet = loadWallet;
    window.renderTransactions = renderTransactions;
    window.loadGiftTypes = loadGiftTypes;
    window.loadFeatureFlags = loadFeatureFlags;
    window.renderFeatureFlags = renderFeatureFlags;
    window.toggleFeatureFlag = toggleFeatureFlag;
    window.deleteGroup = deleteGroup;
    window.endLivestream = endLivestream;
    // Message moderation functions
    window.setMessagesTab = setMessagesTab;
    window.searchMessages = searchMessages;
    window.loadMessageSearchResults = loadMessageSearchResults;
    window.changeMessageSearchPage = changeMessageSearchPage;
    window.viewConversationMessages = viewConversationMessages;
    window.loadConversationMessages = loadConversationMessages;
    window.changeConversationPage = changeConversationPage;
    window.closeConversationModal = closeConversationModal;
    window.viewMessageDetail = viewMessageDetail;
    window.closeMessageDetailModal = closeMessageDetailModal;
    window.deleteMessage = deleteMessage;
    window.deleteMessageFromThread = deleteMessageFromThread;
    window.showFlagModal = showFlagModal;
    window.closeFlagModal = closeFlagModal;
    window.submitFlagMessage = submitFlagMessage;
    window.loadFlaggedMessages = loadFlaggedMessages;
    window.changeFlaggedPage = changeFlaggedPage;

    async function deleteGroup(groupId) {
      try {
        const res = await fetch('/api/admin/groups/' + groupId, {
          method: 'DELETE',
          credentials: 'include'
        });
        if (res.ok) {
          await loadGroups();
        } else {
          alert('Failed to delete group');
        }
      } catch (e) {
        console.error('Failed to delete group:', e);
        alert('Error deleting group');
      }
    }

    async function endLivestream(streamId) {
      try {
        const res = await fetch('/api/admin/livestreams/' + streamId + '/end', {
          method: 'POST',
          credentials: 'include'
        });
        if (res.ok) {
          await loadLivestreams();
        } else {
          alert('Failed to end stream');
        }
      } catch (e) {
        console.error('Failed to end stream:', e);
        alert('Error ending stream');
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      console.log('[Admin] DOMContentLoaded fired');
      
      // Bind login form submit
      var loginForm = document.getElementById('loginForm');
      if (loginForm) {
        console.log('[Admin] Login form found, binding submit');
        loginForm.addEventListener('submit', handleLogin);
      }
      
      // Bind login button click as backup
      var loginBtn = document.getElementById('loginBtn');
      if (loginBtn) {
        console.log('[Admin] Login button found, binding click');
        loginBtn.addEventListener('click', function(e) {
          console.log('[Admin] Login button clicked');
          e.preventDefault();
          handleLogin(e);
        });
      } else {
        console.error('[Admin] Login button not found!');
      }
      
      // Bind password toggle
      var passwordToggle = document.getElementById('passwordToggle');
      if (passwordToggle) {
        passwordToggle.addEventListener('click', togglePassword);
      }
      
      // Event delegation for all data-action elements
      console.log('[Admin] Attaching main click handler for data-action elements');
      document.addEventListener('click', function(e) {
        var target = e.target.closest('[data-action]');
        if (!target) return;
        
        var action = target.getAttribute('data-action');
        console.log('[Admin] Click handler triggered - action:', action);
        
        switch (action) {
          case 'section':
            window.showSection(target.getAttribute('data-section'));
            break;
          case 'logout':
            handleLogout();
            break;
          case 'user-filter':
            setUserFilter(target.getAttribute('data-filter'));
            break;
          case 'post-filter':
            setPostFilter(target.getAttribute('data-filter'));
            break;
          case 'report-filter':
            setReportFilter(target.getAttribute('data-filter'));
            break;
          case 'trends-period':
            setTrendsPeriod(parseInt(target.getAttribute('data-days')));
            break;
          case 'close-modal':
            closeModal(target.getAttribute('data-modal'));
            break;
          case 'create-role-modal':
            showCreateRoleModal();
            break;
          case 'create-role':
            createRole();
            break;
          case 'toggle-password':
            togglePassword();
            break;
          case 'view-user':
            viewUser(target.getAttribute('data-id'));
            break;
          case 'suspend-user':
            confirmSuspend(target.getAttribute('data-id'));
            break;
          case 'unsuspend-user':
            unsuspendUser(target.getAttribute('data-id'));
            break;
          case 'toggle-admin':
            toggleAdmin(target.getAttribute('data-id'), target.getAttribute('data-value') === 'true');
            break;
          case 'toggle-verified':
            toggleVerified(target.getAttribute('data-id'), target.getAttribute('data-value') === 'true');
            break;
          case 'confirm-suspend':
            suspendUser(target.getAttribute('data-id'));
            break;
          case 'delete-post':
            deletePost(target.getAttribute('data-id'));
            break;
          case 'confirm-delete-post':
            confirmDeletePost(target.getAttribute('data-id'));
            break;
          case 'delete-comment':
            deleteComment(target.getAttribute('data-id'));
            break;
          case 'delete-story':
            deleteStory(target.getAttribute('data-id'));
            break;
          case 'story-tab':
            switchStoryTab(target.getAttribute('data-tab'));
            break;
          case 'delete-highlight':
            deleteStoryHighlight(target.getAttribute('data-id'));
            break;
          case 'profile-features-tab':
            switchProfileFeaturesTab(target.getAttribute('data-tab'));
            break;
          case 'delete-featured-intro':
            deleteFeaturedIntro(target.getAttribute('data-id'));
            break;
          case 'unlink-account':
            unlinkAccount(target.getAttribute('data-id'));
            break;
          case 'delete-user-note':
            deleteUserNote(target.getAttribute('data-id'));
            break;
          case 'resolve-report':
            resolveReport(target.getAttribute('data-id'), target.getAttribute('data-status'));
            break;
          case 'handle-verification':
            handleVerification(target.getAttribute('data-id'), target.getAttribute('data-decision'));
            break;
          case 'delete-role':
            deleteRole(target.getAttribute('data-id'));
            break;
          case 'toggle-setting':
            toggleSetting(target.getAttribute('data-key'), target.getAttribute('data-value') === 'true');
            break;
          case 'gossip-filter':
            setGossipFilter(target.getAttribute('data-filter'));
            break;
          case 'gossip-hide':
            hideGossipPost(target.getAttribute('data-id'));
            break;
          case 'gossip-unhide':
            unhideGossipPost(target.getAttribute('data-id'));
            break;
          case 'gossip-remove':
            removeGossipPost(target.getAttribute('data-id'));
            break;
          case 'add-product':
            showAddProductModal();
            break;
          case 'add-category':
            showAddCategoryModal();
            break;
          case 'seed-mall':
            seedMall();
            break;
          case 'fix-prices':
            fixMallPrices();
            break;
          case 'save-product':
            saveProduct();
            break;
          case 'save-category':
            saveCategory();
            break;
          case 'save-networth':
            saveNetWorth();
            break;
          case 'mall-tab':
            showMallTabByButton(target);
            break;
          case 'add-blocked-word':
            addBlockedWord();
            break;
          case 'remove-blocked-word':
            removeBlockedWord(target.getAttribute('data-id'));
            break;
          case 'livestream-filter':
            setLivestreamFilter(target.getAttribute('data-filter'));
            break;
          case 'toggle-flag':
            toggleFeatureFlag(target.getAttribute('data-key'), target.getAttribute('data-enabled') === 'true');
            break;
          case 'delete-group':
            if (confirm('Delete this group? This action cannot be undone.')) {
              deleteGroup(target.getAttribute('data-id'));
            }
            break;
          case 'view-group-members':
            viewGroupMembers(target.getAttribute('data-id'), target.getAttribute('data-name') || 'Group');
            break;
          case 'edit-group-settings':
            editGroupSettings(target.getAttribute('data-id'));
            break;
          case 'end-stream':
            if (confirm('End this live stream?')) {
              endLivestream(target.getAttribute('data-id'));
            }
            break;
          case 'manage-portfolio':
            openUserPortfolio(target.getAttribute('data-user-id'));
            break;
          case 'quick-edit-networth':
            openQuickEditNetWorth(
              target.getAttribute('data-user-id'),
              target.getAttribute('data-username'),
              target.getAttribute('data-display-name'),
              parseInt(target.getAttribute('data-current-networth') || '0')
            );
            break;
          case 'confirm-quick-edit-networth':
            confirmQuickEditNetWorth();
            break;
          case 'show-add-item-modal':
            showAddItemModal();
            break;
          case 'show-adjust-networth-modal':
            showAdjustNetWorthModal();
            break;
          case 'confirm-add-item':
            confirmAddItem();
            break;
          case 'confirm-adjust-networth':
            confirmAdjustNetWorth();
            break;
          case 'remove-portfolio-item':
            if (confirm('Remove this item? This will reduce the user\'s net worth.')) {
              removePortfolioItem(target.getAttribute('data-purchase-id'));
            }
            break;
          case 'send-broadcast':
            sendBroadcast();
            break;
          case 'delete-event':
            if (confirm('Delete this event?')) {
              deleteEvent(target.getAttribute('data-id'));
            }
            break;
          case 'toggle-trending':
            toggleHashtagTrending(target.getAttribute('data-id'), target.getAttribute('data-trending') === 'true');
            break;
          case 'admin-unblock':
            if (confirm('Remove this block? Users will be able to interact again.')) {
              adminRemoveBlock(target.getAttribute('data-id'));
            }
            break;
          case 'delete-reel':
            if (confirm('Delete this reel? This cannot be undone.')) {
              deleteReel(target.getAttribute('data-id'));
            }
            break;
          case 'view-order':
            viewOrderDetails(target.getAttribute('data-id'));
            break;
          case 'update-order-status':
            showUpdateOrderStatusModal(target.getAttribute('data-id'), target.getAttribute('data-status'));
            break;
          case 'payments-page':
            loadPayments(parseInt(target.getAttribute('data-page')), paymentsCurrentStatus);
            break;
          case 'payment-filter':
            setPaymentFilter(target.getAttribute('data-status') || '');
            break;
          case 'security-tab':
            showSecurityTab(target.getAttribute('data-tab'));
            break;
          case 'ads-tab':
            showAdsTab(target.getAttribute('data-tab'));
            break;
          case 'advertiser-filter':
            setAdvertiserFilter(target.getAttribute('data-filter'));
            break;
          case 'campaign-filter':
            setCampaignFilter(target.getAttribute('data-filter'));
            break;
          case 'ad-filter':
            setAdFilter(target.getAttribute('data-filter'));
            break;
          case 'approve-ad':
            approveAd(target.getAttribute('data-id'));
            break;
          case 'reject-ad':
            rejectAd(target.getAttribute('data-id'));
            break;
          case 'suspend-advertiser':
            suspendAdvertiser(target.getAttribute('data-id'));
            break;
          case 'activate-advertiser':
            activateAdvertiser(target.getAttribute('data-id'));
            break;
          case 'adjust-wallet':
            adjustWallet(target.getAttribute('data-id'), target.getAttribute('data-name'));
            break;
          case 'pause-campaign':
            pauseCampaign(target.getAttribute('data-id'));
            break;
          case 'resume-campaign':
            resumeCampaign(target.getAttribute('data-id'));
            break;
        }
      });
      
      // Check auth
      checkAuth();
    });

    // ===== ADVERTISING SECTION =====
    let adsData = {
      advertisers: [],
      campaigns: [],
      ads: [],
      currentFilter: { advertisers: 'all', campaigns: 'all', ads: 'all' }
    };

    async function loadAdvertising() {
      await Promise.all([
        loadAdsOverview(),
        loadAdvertisers(),
        loadAllCampaigns(),
        loadAllAds(),
        loadCtaPerformance(),
        loadDestinationUrls(),
        loadAdsHealth(),
        loadPlatformRevenue(),
        loadRefundsHistory(),
        loadAdDisputes()
      ]);
    }

    // ===== ADS HEALTH DASHBOARD =====
    async function loadAdsHealth() {
      try {
        const res = await fetch('/api/admin/ads/delivery-health', { credentials: 'include' });
        const data = await res.json();
        
        document.getElementById('zeroDeliveryCount').textContent = data.zeroDelivery?.length || 0;
        document.getElementById('lowDeliveryCount').textContent = data.lowDelivery?.length || 0;
        
        // Calculate healthy campaigns (all active - zero - low)
        const overviewRes = await fetch('/api/admin/ads/campaigns', { credentials: 'include' });
        const overviewData = await overviewRes.json();
        const activeCampaigns = (overviewData.campaigns || overviewData || []).filter(c => c.status === 'ACTIVE');
        const healthyCount = Math.max(0, activeCampaigns.length - (data.zeroDelivery?.length || 0) - (data.lowDelivery?.length || 0));
        document.getElementById('healthyDeliveryCount').textContent = healthyCount;
        
        // Zero Delivery Table
        const zeroTable = document.getElementById('zeroDeliveryTable');
        if (data.zeroDelivery && data.zeroDelivery.length > 0) {
          zeroTable.innerHTML = '<table class="data-table"><thead><tr><th>Campaign</th><th>Advertiser</th><th>Created</th><th>Budget</th><th>Impressions</th><th>Actions</th></tr></thead><tbody>' +
            data.zeroDelivery.map(c => 
              '<tr><td>' + (c.name || 'Unnamed') + '</td>' +
              '<td>' + (c.advertiserId || '-') + '</td>' +
              '<td>' + new Date(c.createdAt).toLocaleDateString() + '</td>' +
              '<td>R' + ((c.budgetAmount || 0) / 100).toFixed(2) + '</td>' +
              '<td style="color: #ef4444;">0</td>' +
              '<td><button class="action-btn action-btn-secondary" onclick="showCampaignActions(\'' + c.id + '\')">Actions</button></td></tr>'
            ).join('') +
            '</tbody></table>';
        } else {
          zeroTable.innerHTML = '<div style="padding: 24px; text-align: center; color: #10b981;"><i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 16px;"></i><br>All campaigns are delivering! No zero-delivery campaigns found.</div>';
        }
        
        // Low Delivery Table
        const lowTable = document.getElementById('lowDeliveryTable');
        if (data.lowDelivery && data.lowDelivery.length > 0) {
          lowTable.innerHTML = '<table class="data-table"><thead><tr><th>Campaign</th><th>Budget</th><th>Spent</th><th>Delivery %</th><th>Created</th><th>Actions</th></tr></thead><tbody>' +
            data.lowDelivery.map(c => {
              const deliveryPct = c.budgetAmount > 0 ? ((c.budgetSpent || 0) / c.budgetAmount * 100).toFixed(1) : 0;
              return '<tr><td>' + (c.name || 'Unnamed') + '</td>' +
                '<td>R' + ((c.budgetAmount || 0) / 100).toFixed(2) + '</td>' +
                '<td>R' + ((c.budgetSpent || 0) / 100).toFixed(2) + '</td>' +
                '<td style="color: #f59e0b;">' + deliveryPct + '%</td>' +
                '<td>' + new Date(c.createdAt).toLocaleDateString() + '</td>' +
                '<td><button class="action-btn action-btn-secondary" onclick="showCampaignActions(\'' + c.id + '\')">Actions</button></td></tr>';
            }).join('') +
            '</tbody></table>';
        } else {
          lowTable.innerHTML = '<div style="padding: 24px; text-align: center; color: rgba(255,255,255,0.6);">No low-delivery campaigns found.</div>';
        }
      } catch (error) {
        console.error('Failed to load ads health:', error);
      }
    }

    // ===== PLATFORM REVENUE =====
    async function loadPlatformRevenue() {
      try {
        const res = await fetch('/api/admin/ads/revenue', { credentials: 'include' });
        const data = await res.json();
        
        const statsDiv = document.getElementById('platformRevenueStats');
        statsDiv.innerHTML = 
          '<div class="stat-card stat-card-success"><div class="stat-icon"><i class="fas fa-coins"></i></div>' +
          '<div class="stat-value">R' + ((data.revenue?.totalAdSpend || 0) / 100).toFixed(2) + '</div>' +
          '<div class="stat-label">Total Ad Revenue</div></div>' +
          '<div class="stat-card"><div class="stat-icon"><i class="fas fa-receipt"></i></div>' +
          '<div class="stat-value">' + (data.revenue?.transactionCount || 0) + '</div>' +
          '<div class="stat-label">Ad Transactions</div></div>' +
          '<div class="stat-card"><div class="stat-icon"><i class="fas fa-users"></i></div>' +
          '<div class="stat-value">' + (data.revenue?.uniqueAdvertisers || 0) + '</div>' +
          '<div class="stat-label">Active Advertisers</div></div>';
        
        // Revenue chart
        const chartDiv = document.getElementById('revenueChart');
        if (data.dailyStats && data.dailyStats.length > 0) {
          const maxSpend = Math.max(...data.dailyStats.map(d => d.spend || 0));
          chartDiv.innerHTML = '<div style="display: flex; gap: 4px; align-items: flex-end; height: 180px; padding: 8px 0;">' +
            data.dailyStats.slice(-30).map(d => {
              const height = maxSpend > 0 ? ((d.spend / maxSpend) * 160) : 10;
              return '<div style="flex: 1; background: linear-gradient(135deg, #8b5cf6, #6366f1); height: ' + Math.max(10, height) + 'px; border-radius: 4px 4px 0 0;" title="' + d.date + ': R' + ((d.spend || 0) / 100).toFixed(2) + '"></div>';
            }).join('') +
            '</div>';
        } else {
          chartDiv.innerHTML = '<div style="padding: 24px; text-align: center; color: rgba(255,255,255,0.6);">No revenue data yet</div>';
        }
      } catch (error) {
        console.error('Failed to load platform revenue:', error);
      }
    }

    // ===== REFUNDS HISTORY =====
    async function loadRefundsHistory() {
      try {
        const res = await fetch('/api/admin/ads/refunds', { credentials: 'include' });
        const data = await res.json();
        
        const table = document.getElementById('refundsTable');
        if (data.refunds && data.refunds.length > 0) {
          table.innerHTML = '<table class="data-table"><thead><tr><th>Date</th><th>Advertiser</th><th>Amount</th><th>Description</th></tr></thead><tbody>' +
            data.refunds.map(r => 
              '<tr><td>' + new Date(r.transaction?.createdAt).toLocaleDateString() + '</td>' +
              '<td>' + (r.advertiser?.businessName || r.advertiser?.contactName || '-') + '</td>' +
              '<td style="color: #10b981;">R' + ((r.transaction?.amount || 0) / 100).toFixed(2) + '</td>' +
              '<td>' + (r.transaction?.description || '-') + '</td></tr>'
            ).join('') +
            '</tbody></table>' +
            '<div style="padding: 16px; background: rgba(255,255,255,0.05); margin-top: 16px; border-radius: 8px;">Total Refunds: <strong>' + (data.summary?.count || 0) + '</strong> | Total Amount: <strong>R' + ((data.summary?.totalAmount || 0) / 100).toFixed(2) + '</strong></div>';
        } else {
          table.innerHTML = '<div style="padding: 24px; text-align: center; color: rgba(255,255,255,0.6);">No refunds yet</div>';
        }
      } catch (error) {
        console.error('Failed to load refunds:', error);
      }
    }

    // ===== EMERGENCY CONTROLS =====
    async function emergencyPauseAllAds() {
      if (!confirm('WARNING: This will immediately pause ALL active ad campaigns platform-wide. Are you absolutely sure?')) return;
      const reason = prompt('Enter reason for emergency pause:');
      if (!reason) return;
      
      try {
        const res = await fetch('/api/admin/ads/emergency-pause', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ pause: true, reason })
        });
        const data = await res.json();
        alert('Emergency pause executed: ' + data.count + ' campaigns paused');
        loadAdvertising();
      } catch (error) {
        console.error('Emergency pause failed:', error);
        alert('Failed to execute emergency pause');
      }
    }

    async function emergencyResumeAllAds() {
      if (!confirm('This will resume all campaigns that were paused by emergency action. Continue?')) return;
      
      try {
        const res = await fetch('/api/admin/ads/emergency-pause', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ pause: false, reason: 'Emergency resume' })
        });
        const data = await res.json();
        alert('Emergency resume executed: ' + data.count + ' campaigns resumed');
        loadAdvertising();
      } catch (error) {
        console.error('Emergency resume failed:', error);
        alert('Failed to execute emergency resume');
      }
    }

    async function expireEndedCampaigns() {
      try {
        const res = await fetch('/api/admin/ads/expire-campaigns', {
          method: 'POST',
          credentials: 'include'
        });
        const data = await res.json();
        alert('Expired ' + data.expired + ' campaigns');
        loadAdvertising();
      } catch (error) {
        console.error('Failed to expire campaigns:', error);
        alert('Failed to expire campaigns');
      }
    }

    // ===== CAMPAIGN ACTIONS MODAL =====
    async function showCampaignActions(campaignId) {
      try {
        const res = await fetch('/api/admin/ads/campaigns/' + campaignId + '/details', { credentials: 'include' });
        const data = await res.json();
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = 
          '<div class="modal-content" style="max-width: 600px;">' +
          '<div class="modal-header"><h3>Campaign: ' + (data.campaign?.name || 'Unknown') + '</h3>' +
          '<button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">&times;</button></div>' +
          '<div class="modal-body">' +
          '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">' +
          '<div><strong>Status:</strong> ' + (data.campaign?.status || '-') + '</div>' +
          '<div><strong>Budget:</strong> R' + ((data.campaign?.budgetAmount || 0) / 100).toFixed(2) + '</div>' +
          '<div><strong>Spent:</strong> R' + ((data.campaign?.budgetSpent || 0) / 100).toFixed(2) + '</div>' +
          '<div><strong>Impressions:</strong> ' + (data.campaign?.impressions || 0) + '</div>' +
          '<div><strong>Clicks:</strong> ' + (data.campaign?.clicks || 0) + '</div>' +
          '<div><strong>Wallet Balance:</strong> R' + ((data.wallet?.balance || 0) / 100).toFixed(2) + '</div>' +
          '</div>' +
          '<div style="display: flex; gap: 12px; flex-wrap: wrap;">' +
          '<button class="action-btn action-btn-primary" onclick="pauseCampaign(\'' + campaignId + '\')">Pause</button>' +
          '<button class="action-btn" style="background: #10b981;" onclick="resumeCampaign(\'' + campaignId + '\')">Resume</button>' +
          '<button class="action-btn" style="background: #6366f1;" onclick="endCampaign(\'' + campaignId + '\')">End Campaign</button>' +
          '<button class="action-btn" style="background: #f59e0b;" onclick="refundCampaignWallet(\'' + (data.wallet?.id || '') + '\')">Refund Wallet</button>' +
          '<button class="action-btn" style="background: #8b5cf6;" onclick="convertWalletToCoins(\'' + (data.wallet?.id || '') + '\')">Convert to Coins</button>' +
          '<button class="action-btn action-btn-danger" onclick="deleteCampaign(\'' + campaignId + '\')">Delete</button>' +
          '</div></div></div>';
        document.body.appendChild(modal);
      } catch (error) {
        console.error('Failed to load campaign details:', error);
        alert('Failed to load campaign details');
      }
    }

    async function pauseCampaign(id) {
      try {
        await fetch('/api/admin/ads/campaigns/' + id + '/pause', { method: 'POST', credentials: 'include' });
        alert('Campaign paused');
        document.querySelector('.modal-overlay')?.remove();
        loadAdvertising();
      } catch (e) { alert('Failed to pause'); }
    }

    async function resumeCampaign(id) {
      try {
        await fetch('/api/admin/ads/campaigns/' + id + '/resume', { method: 'POST', credentials: 'include' });
        alert('Campaign resumed');
        document.querySelector('.modal-overlay')?.remove();
        loadAdvertising();
      } catch (e) { alert('Failed to resume'); }
    }

    async function endCampaign(id) {
      if (!confirm('End this campaign? It cannot be reactivated.')) return;
      try {
        await fetch('/api/admin/ads/campaigns/' + id + '/end', { method: 'POST', credentials: 'include' });
        alert('Campaign ended');
        document.querySelector('.modal-overlay')?.remove();
        loadAdvertising();
      } catch (e) { alert('Failed to end campaign'); }
    }

    async function deleteCampaign(id) {
      if (!confirm('Delete (archive) this campaign? This action cannot be undone.')) return;
      try {
        await fetch('/api/admin/ads/campaigns/' + id, { method: 'DELETE', credentials: 'include' });
        alert('Campaign archived');
        document.querySelector('.modal-overlay')?.remove();
        loadAdvertising();
      } catch (e) { alert('Failed to delete'); }
    }

    async function refundCampaignWallet(walletId) {
      if (!walletId) return alert('No wallet found');
      const amount = prompt('Enter refund amount in cents (leave blank for full refund):');
      const reason = prompt('Reason for refund:');
      try {
        await fetch('/api/admin/ads/wallets/' + walletId + '/refund', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ amount: amount ? parseInt(amount) : undefined, reason })
        });
        alert('Refund processed');
        document.querySelector('.modal-overlay')?.remove();
        loadAdvertising();
      } catch (e) { alert('Failed to process refund'); }
    }

    async function convertWalletToCoins(walletId) {
      if (!walletId) return alert('No wallet found');
      if (!confirm('Convert all ad wallet balance to Rabit Coins (1:1 ratio)?')) return;
      try {
        const res = await fetch('/api/admin/ads/wallets/' + walletId + '/convert-to-coins', {
          method: 'POST',
          credentials: 'include'
        });
        const data = await res.json();
        alert('Converted R' + ((data.convertedAmount || 0) / 100).toFixed(2) + ' to Rabit Coins');
        document.querySelector('.modal-overlay')?.remove();
        loadAdvertising();
      } catch (e) { alert('Failed to convert'); }
    }

    // ===== AD DISPUTES =====
    let cachedDisputes = [];
    
    async function loadAdDisputes() {
      try {
        const res = await fetch('/api/admin/ads/disputes', { credentials: 'include' });
        const data = await res.json();
        
        cachedDisputes = data.disputes || [];
        
        // Update stats
        document.getElementById('disputePendingCount').textContent = data.stats?.pendingCount || 0;
        document.getElementById('disputeReviewCount').textContent = data.stats?.underReviewCount || 0;
        document.getElementById('disputeResolvedCount').textContent = data.stats?.resolvedCount || 0;
        
        renderDisputesTable(cachedDisputes);
      } catch (error) {
        console.error('Failed to load disputes:', error);
      }
    }

    function filterDisputes() {
      const status = document.getElementById('disputeStatusFilter').value;
      const filtered = status === 'all' 
        ? cachedDisputes 
        : cachedDisputes.filter(d => d.dispute.status === status);
      renderDisputesTable(filtered);
    }

    function renderDisputesTable(disputes) {
      const table = document.getElementById('disputesTable');
      if (disputes.length === 0) {
        table.innerHTML = '<div style="padding: 24px; text-align: center; color: rgba(255,255,255,0.6);">No disputes found</div>';
        return;
      }
      
      const statusColors = {
        'PENDING': '#f59e0b',
        'UNDER_REVIEW': '#3b82f6',
        'RESOLVED_APPROVED': '#10b981',
        'RESOLVED_DENIED': '#ef4444',
        'CANCELLED': '#6b7280'
      };
      
      table.innerHTML = '<table class="data-table"><thead><tr><th>Date</th><th>Advertiser</th><th>Type</th><th>Subject</th><th>Requested</th><th>Status</th><th>Actions</th></tr></thead><tbody>' +
        disputes.map(d => {
          const dispute = d.dispute;
          const advertiser = d.advertiser;
          return '<tr>' +
            '<td>' + new Date(dispute.createdAt).toLocaleDateString() + '</td>' +
            '<td>' + (advertiser?.businessName || advertiser?.contactName || '-') + '</td>' +
            '<td>' + dispute.disputeType + '</td>' +
            '<td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">' + (dispute.subject || '-') + '</td>' +
            '<td>' + (dispute.requestedRefundAmount ? 'R' + (dispute.requestedRefundAmount / 100).toFixed(2) : '-') + '</td>' +
            '<td><span style="color: ' + (statusColors[dispute.status] || '#fff') + '; font-weight: 600;">' + dispute.status + '</span></td>' +
            '<td>' + getDisputeActions(dispute) + '</td>' +
            '</tr>';
        }).join('') +
        '</tbody></table>';
    }

    function getDisputeActions(dispute) {
      if (dispute.status === 'PENDING') {
        return '<button class="action-btn action-btn-secondary" onclick="startReviewDispute(\'' + dispute.id + '\')">Review</button>';
      } else if (dispute.status === 'UNDER_REVIEW') {
        return '<button class="action-btn action-btn-primary" onclick="showResolveDisputeModal(\'' + dispute.id + '\')">Resolve</button>';
      }
      return '<button class="action-btn action-btn-secondary" onclick="viewDisputeDetails(\'' + dispute.id + '\')">View</button>';
    }

    async function startReviewDispute(id) {
      try {
        await fetch('/api/admin/ads/disputes/' + id + '/review', { method: 'POST', credentials: 'include' });
        alert('Dispute marked as under review');
        loadAdDisputes();
      } catch (e) { alert('Failed to update'); }
    }

    function showResolveDisputeModal(id) {
      const dispute = cachedDisputes.find(d => d.dispute.id === id)?.dispute;
      if (!dispute) return;
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = 
        '<div class="modal-content" style="max-width: 500px;">' +
        '<div class="modal-header"><h3>Resolve Dispute</h3>' +
        '<button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">&times;</button></div>' +
        '<div class="modal-body">' +
        '<p><strong>Subject:</strong> ' + (dispute.subject || '-') + '</p>' +
        '<p><strong>Description:</strong> ' + (dispute.description || '-') + '</p>' +
        '<p><strong>Requested Refund:</strong> ' + (dispute.requestedRefundAmount ? 'R' + (dispute.requestedRefundAmount / 100).toFixed(2) : 'None') + '</p>' +
        '<div class="form-group" style="margin-top: 16px;">' +
        '<label>Refund Amount (cents):</label>' +
        '<input type="number" id="resolveRefundAmount" value="' + (dispute.requestedRefundAmount || 0) + '" style="width: 100%; padding: 8px; margin-top: 4px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">' +
        '</div>' +
        '<div class="form-group" style="margin-top: 16px;">' +
        '<label>Admin Response:</label>' +
        '<textarea id="resolveAdminResponse" rows="3" style="width: 100%; padding: 8px; margin-top: 4px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;"></textarea>' +
        '</div>' +
        '<div style="display: flex; gap: 12px; margin-top: 24px;">' +
        '<button class="action-btn" style="background: #10b981; flex: 1;" onclick="resolveDispute(\'' + id + '\', true)">Approve & Refund</button>' +
        '<button class="action-btn" style="background: #ef4444; flex: 1;" onclick="resolveDispute(\'' + id + '\', false)">Deny</button>' +
        '</div></div></div>';
      document.body.appendChild(modal);
    }

    async function resolveDispute(id, approved) {
      const refundAmount = parseInt(document.getElementById('resolveRefundAmount').value) || 0;
      const adminResponse = document.getElementById('resolveAdminResponse').value;
      
      try {
        await fetch('/api/admin/ads/disputes/' + id + '/resolve', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ approved, refundAmount: approved ? refundAmount : 0, adminResponse })
        });
        alert('Dispute ' + (approved ? 'approved' : 'denied'));
        document.querySelector('.modal-overlay')?.remove();
        loadAdDisputes();
      } catch (e) { alert('Failed to resolve dispute'); }
    }

    function viewDisputeDetails(id) {
      const d = cachedDisputes.find(x => x.dispute.id === id);
      if (!d) return;
      const dispute = d.dispute;
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = 
        '<div class="modal-content" style="max-width: 500px;">' +
        '<div class="modal-header"><h3>Dispute Details</h3>' +
        '<button class="modal-close" onclick="this.closest(\'.modal-overlay\').remove()">&times;</button></div>' +
        '<div class="modal-body">' +
        '<p><strong>Status:</strong> ' + dispute.status + '</p>' +
        '<p><strong>Type:</strong> ' + dispute.disputeType + '</p>' +
        '<p><strong>Subject:</strong> ' + (dispute.subject || '-') + '</p>' +
        '<p><strong>Description:</strong> ' + (dispute.description || '-') + '</p>' +
        '<p><strong>Requested:</strong> ' + (dispute.requestedRefundAmount ? 'R' + (dispute.requestedRefundAmount / 100).toFixed(2) : 'None') + '</p>' +
        '<p><strong>Approved Refund:</strong> ' + (dispute.approvedRefundAmount ? 'R' + (dispute.approvedRefundAmount / 100).toFixed(2) : 'None') + '</p>' +
        '<p><strong>Admin Response:</strong> ' + (dispute.adminResponse || '-') + '</p>' +
        '<p><strong>Resolved:</strong> ' + (dispute.resolvedAt ? new Date(dispute.resolvedAt).toLocaleString() : 'Pending') + '</p>' +
        '</div></div>';
      document.body.appendChild(modal);
    }

    function showSecurityTab(tabId) {
      document.querySelectorAll('#section-security .tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('#section-security .tab-content').forEach(content => {
        content.style.display = 'none';
        content.classList.remove('active');
      });
      
      document.querySelector('#section-security .tab-btn[data-tab="' + tabId + '"]').classList.add('active');
      const tabContent = document.getElementById(tabId);
      if (tabContent) {
        tabContent.style.display = 'block';
        tabContent.classList.add('active');
      }
      
      // Load data for the selected tab
      if (tabId === 'security-2fa') {
        loadSecurity();
      } else if (tabId === 'security-sessions') {
        loadSecuritySessions();
      } else if (tabId === 'security-devices') {
        loadSecurityDevices();
      }
    }

    function showAdsTab(tabId) {
      document.querySelectorAll('#section-advertising .tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('#section-advertising .tab-content').forEach(content => {
        content.style.display = 'none';
        content.classList.remove('active');
      });
      
      document.querySelector('#section-advertising .tab-btn[data-tab="' + tabId + '"]').classList.add('active');
      const tabContent = document.getElementById(tabId);
      if (tabContent) {
        tabContent.style.display = 'block';
        tabContent.classList.add('active');
      }
    }

    async function loadAdsOverview() {
      try {
        const res = await fetch('/api/admin/ads/overview', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          document.getElementById('adsOverviewStats').innerHTML = `
            <div class="stat-card">
              <h3>Total Revenue</h3>
              <div class="value">R${formatNumber((data.totalRevenue || 0) / 100)}</div>
            </div>
            <div class="stat-card">
              <h3>Active Campaigns</h3>
              <div class="value">${formatNumber(data.activeCampaigns || 0)}</div>
            </div>
            <div class="stat-card">
              <h3>Total Impressions</h3>
              <div class="value">${formatNumber(data.totalImpressions || 0)}</div>
            </div>
            <div class="stat-card">
              <h3>Total Clicks</h3>
              <div class="value">${formatNumber(data.totalClicks || 0)}</div>
            </div>
            <div class="stat-card">
              <h3>Avg CTR</h3>
              <div class="value">${(data.avgCtr || 0).toFixed(2)}%</div>
            </div>
            <div class="stat-card">
              <h3>Active Advertisers</h3>
              <div class="value">${formatNumber(data.activeAdvertisers || 0)}</div>
            </div>
          `;
          
          // Render top campaigns
          if (data.topCampaigns && data.topCampaigns.length > 0) {
            document.getElementById('adsTopCampaigns').innerHTML = data.topCampaigns.map(c => `
              <div style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="font-weight: 500;">${c.name || 'Unnamed Campaign'}</div>
                  <div style="font-size: 12px; color: rgba(255,255,255,0.5);">${formatNumber(c.impressions || 0)} impressions</div>
                </div>
                <div style="text-align: right;">
                  <div style="color: #10B981;">R${formatNumber((c.budgetSpent || 0) / 100)}</div>
                  <div style="font-size: 12px; color: rgba(255,255,255,0.5);">${((c.clicks || 0) / Math.max(1, c.impressions || 1) * 100).toFixed(2)}% CTR</div>
                </div>
              </div>
            `).join('');
          } else {
            document.getElementById('adsTopCampaigns').innerHTML = '<div style="padding: 24px; text-align: center; color: rgba(255,255,255,0.5);">No campaigns yet</div>';
          }
          
          // Revenue chart placeholder
          document.getElementById('adsRevenueChart').innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5);">Revenue chart visualization coming soon</div>';
          
          // Recent activity
          document.getElementById('adsRecentActivity').innerHTML = '<div style="padding: 24px; text-align: center; color: rgba(255,255,255,0.5);">Recent activity feed coming soon</div>';
        }
      } catch (e) {
        console.error('Failed to load ads overview:', e);
      }
    }

    async function loadCtaPerformance() {
      const container = document.getElementById('adsCtaPerformance');
      if (!container) return;
      
      try {
        const res = await fetch('/api/admin/ads/cta-performance', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          if (data.ctaStats && data.ctaStats.length > 0) {
            const ctaLabels = {
              VISIT_PROFILE: 'Visit Profile',
              VIEW_POST: 'View Post',
              LEARN_MORE: 'Learn More',
              SHOP_NOW: 'Shop Now',
              SIGN_UP: 'Sign Up',
              CONTACT: 'Contact',
              WATCH_MORE: 'Watch More',
              BOOK_NOW: 'Book Now',
              GET_OFFER: 'Get Offer',
              DOWNLOAD: 'Download',
              APPLY_NOW: 'Apply Now'
            };
            
            container.innerHTML = `
              <table>
                <thead>
                  <tr>
                    <th>CTA Type</th>
                    <th>Impressions</th>
                    <th>Clicks</th>
                    <th>CTR</th>
                    <th>Conversions</th>
                  </tr>
                </thead>
                <tbody>
                  ${data.ctaStats.map(stat => `
                    <tr>
                      <td>
                        <span style="padding: 4px 10px; background: rgba(139,92,246,0.15); border-radius: 6px; color: #a78bfa; font-weight: 500;">
                          ${ctaLabels[stat.callToAction] || stat.callToAction}
                        </span>
                      </td>
                      <td>${formatNumber(stat.impressions || 0)}</td>
                      <td>${formatNumber(stat.clicks || 0)}</td>
                      <td>${((stat.clicks || 0) / Math.max(1, stat.impressions || 1) * 100).toFixed(2)}%</td>
                      <td>${formatNumber(stat.conversions || 0)}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `;
          } else {
            container.innerHTML = '<div style="padding: 24px; text-align: center; color: rgba(255,255,255,0.5);">No CTA data yet. Data will appear when ads receive clicks.</div>';
          }
        } else {
          container.innerHTML = '<div style="padding: 24px; text-align: center; color: rgba(255,255,255,0.5);">CTA analytics coming soon</div>';
        }
      } catch (e) {
        console.error('Failed to load CTA performance:', e);
        container.innerHTML = '<div style="padding: 24px; text-align: center; color: rgba(255,255,255,0.5);">Error loading CTA data</div>';
      }
    }

    async function loadDestinationUrls() {
      const container = document.getElementById('adsDestinationUrls');
      if (!container) return;
      
      try {
        const res = await fetch('/api/admin/ads/destination-performance', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          if (data.destinations && data.destinations.length > 0) {
            container.innerHTML = `
              <table>
                <thead>
                  <tr>
                    <th>Destination</th>
                    <th>Clicks</th>
                    <th>Conversions</th>
                    <th>Ad Count</th>
                  </tr>
                </thead>
                <tbody>
                  ${data.destinations.slice(0, 15).map(dest => `
                    <tr>
                      <td style="max-width: 300px;">
                        <a href="${dest.url}" target="_blank" rel="noopener noreferrer" style="color: #60a5fa; text-decoration: none; word-break: break-all;">
                          ${dest.url.startsWith('http') ? new URL(dest.url).hostname : dest.url}
                        </a>
                      </td>
                      <td>${formatNumber(dest.clicks || 0)}</td>
                      <td>${formatNumber(dest.conversions || 0)}</td>
                      <td>${dest.adCount || 1}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            `;
          } else {
            container.innerHTML = '<div style="padding: 24px; text-align: center; color: rgba(255,255,255,0.5);">No destination data yet. Data appears when external URL ads are clicked.</div>';
          }
        } else {
          container.innerHTML = '<div style="padding: 24px; text-align: center; color: rgba(255,255,255,0.5);">Destination analytics coming soon</div>';
        }
      } catch (e) {
        console.error('Failed to load destination URLs:', e);
        container.innerHTML = '<div style="padding: 24px; text-align: center; color: rgba(255,255,255,0.5);">Error loading destination data</div>';
      }
    }

    async function loadAdvertisers() {
      try {
        const res = await fetch('/api/admin/ads/advertisers', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          adsData.advertisers = Array.isArray(data) ? data : [];
          renderAdvertisers();
        }
      } catch (e) {
        console.error('Failed to load advertisers:', e);
        adsData.advertisers = [];
        renderAdvertisers();
      }
    }

    function renderAdvertisers() {
      const filter = adsData.currentFilter.advertisers;
      const search = (document.getElementById('advertiserSearch')?.value || '').toLowerCase();
      
      let filtered = adsData.advertisers;
      if (filter !== 'all') {
        filtered = filtered.filter(a => a.status === filter);
      }
      if (search) {
        filtered = filtered.filter(a => 
          (a.companyName || '').toLowerCase().includes(search) ||
          (a.user?.username || '').toLowerCase().includes(search)
        );
      }

      if (filtered.length === 0) {
        document.getElementById('advertisersTable').innerHTML = '<div class="empty-state">No advertisers found</div>';
        return;
      }

      document.getElementById('advertisersTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Company</th>
              <th>User</th>
              <th>Status</th>
              <th>Balance</th>
              <th>Total Spend</th>
              <th>Campaigns</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.map(a => `
              <tr>
                <td><strong>${a.companyName || 'N/A'}</strong></td>
                <td>@${a.user?.username || 'unknown'}</td>
                <td><span class="badge ${getStatusBadgeClass(a.status)}">${a.status}</span></td>
                <td>R${formatNumber((a.walletBalance || 0) / 100)}</td>
                <td>R${formatNumber((a.totalSpend || 0) / 100)}</td>
                <td>${a.campaignCount || 0}</td>
                <td style="display: flex; gap: 4px; flex-wrap: wrap;">
                  <button class="action-btn" data-action="adjust-wallet" data-id="${a.walletId}" data-name="${a.companyName || a.user?.username}" style="padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #8b5cf6, #7c3aed);">Adjust Balance</button>
                  ${a.status === 'ACTIVE' ? 
                    `<button class="action-btn action-btn-danger" data-action="suspend-advertiser" data-id="${a.id}" style="padding: 6px 12px; font-size: 12px;">Suspend</button>` :
                    `<button class="action-btn action-btn-success" data-action="activate-advertiser" data-id="${a.id}" style="padding: 6px 12px; font-size: 12px;">Activate</button>`
                  }
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function setAdvertiserFilter(filter) {
      adsData.currentFilter.advertisers = filter;
      document.querySelectorAll('#ads-advertisers .filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-filter') === filter);
      });
      renderAdvertisers();
    }

    function filterAdvertisers() {
      renderAdvertisers();
    }

    async function loadAllCampaigns() {
      try {
        const res = await fetch('/api/admin/ads/campaigns', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          adsData.campaigns = Array.isArray(data) ? data : [];
          renderCampaigns();
        }
      } catch (e) {
        console.error('Failed to load campaigns:', e);
        adsData.campaigns = [];
        renderCampaigns();
      }
    }

    function renderCampaigns() {
      const filter = adsData.currentFilter.campaigns;
      const search = (document.getElementById('campaignSearch')?.value || '').toLowerCase();
      
      let filtered = adsData.campaigns;
      if (filter !== 'all') {
        filtered = filtered.filter(c => c.status === filter);
      }
      if (search) {
        filtered = filtered.filter(c => (c.name || '').toLowerCase().includes(search));
      }

      if (filtered.length === 0) {
        document.getElementById('campaignsTable').innerHTML = '<div class="empty-state">No campaigns found</div>';
        return;
      }

      document.getElementById('campaignsTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Campaign</th>
              <th>Advertiser</th>
              <th>Status</th>
              <th>Objective</th>
              <th>Budget</th>
              <th>Spent</th>
              <th>Impressions</th>
              <th>Clicks</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.map(c => `
              <tr>
                <td><strong>${c.name || 'Unnamed'}</strong></td>
                <td>${c.advertiser?.companyName || 'N/A'}</td>
                <td><span class="badge ${getStatusBadgeClass(c.status)}">${c.status}</span></td>
                <td>${c.objective || 'N/A'}</td>
                <td>R${formatNumber((c.budgetTotal || 0) / 100)}</td>
                <td>R${formatNumber((c.budgetSpent || 0) / 100)}</td>
                <td>${formatNumber(c.impressions || 0)}</td>
                <td>${formatNumber(c.clicks || 0)}</td>
                <td>
                  ${c.status === 'ACTIVE' ? 
                    `<button class="action-btn action-btn-warning" data-action="pause-campaign" data-id="${c.id}" style="padding: 6px 12px; font-size: 12px;">Pause</button>` :
                    `<button class="action-btn action-btn-success" data-action="resume-campaign" data-id="${c.id}" style="padding: 6px 12px; font-size: 12px;">Resume</button>`
                  }
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function setCampaignFilter(filter) {
      adsData.currentFilter.campaigns = filter;
      document.querySelectorAll('#ads-campaigns .filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-filter') === filter);
      });
      renderCampaigns();
    }

    function filterCampaigns() {
      renderCampaigns();
    }

    async function loadAllAds() {
      try {
        const res = await fetch('/api/admin/ads/all', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          adsData.ads = Array.isArray(data) ? data : [];
          renderAds();
        }
      } catch (e) {
        console.error('Failed to load ads:', e);
        adsData.ads = [];
        renderAds();
      }
    }

    function renderAds() {
      const filter = adsData.currentFilter.ads;
      const search = (document.getElementById('adSearch')?.value || '').toLowerCase();
      
      let filtered = adsData.ads;
      if (filter !== 'all') {
        filtered = filtered.filter(a => a.status === filter);
      }
      if (search) {
        filtered = filtered.filter(a => (a.headline || '').toLowerCase().includes(search));
      }

      if (filtered.length === 0) {
        document.getElementById('adsTable').innerHTML = '<div class="empty-state">No ads found</div>';
        return;
      }

      document.getElementById('adsTable').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Ad Number</th>
              <th>Preview</th>
              <th>Headline</th>
              <th>Format</th>
              <th>Status</th>
              <th>Impressions</th>
              <th>Clicks</th>
              <th>CTR</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.map(a => `
              <tr>
                <td><span style="background: linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%); color: white; padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 11px; font-family: monospace;">${a.adNumber || 'N/A'}</span></td>
                <td>
                  ${a.mediaUrl ? 
                    `<img src="${a.mediaUrl}" style="width: 60px; height: 40px; object-fit: cover; border-radius: 4px;">` :
                    `<div style="width: 60px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: rgba(255,255,255,0.3);">No media</div>`
                  }
                </td>
                <td><strong>${a.headline || 'No headline'}</strong></td>
                <td>${a.format || 'N/A'}</td>
                <td><span class="badge ${getStatusBadgeClass(a.status)}">${a.status}</span></td>
                <td>${formatNumber(a.impressions || 0)}</td>
                <td>${formatNumber(a.clicks || 0)}</td>
                <td>${((a.clicks || 0) / Math.max(1, a.impressions || 1) * 100).toFixed(2)}%</td>
                <td style="display: flex; gap: 4px;">
                  ${a.status === 'PENDING_REVIEW' ? `
                    <button class="action-btn action-btn-success" data-action="approve-ad" data-id="${a.id}" style="padding: 6px 12px; font-size: 12px;">Approve</button>
                    <button class="action-btn action-btn-danger" data-action="reject-ad" data-id="${a.id}" style="padding: 6px 12px; font-size: 12px;">Reject</button>
                  ` : ''}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function setAdFilter(filter) {
      adsData.currentFilter.ads = filter;
      document.querySelectorAll('#ads-creatives .filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-filter') === filter);
      });
      renderAds();
    }

    function filterAds() {
      renderAds();
    }

    function getStatusBadgeClass(status) {
      switch(status) {
        case 'ACTIVE': case 'APPROVED': return 'badge-success';
        case 'PENDING': case 'PENDING_REVIEW': case 'DRAFT': return 'badge-warning';
        case 'SUSPENDED': case 'REJECTED': case 'PAUSED': return 'badge-danger';
        case 'ENDED': case 'COMPLETED': return 'badge-secondary';
        default: return '';
      }
    }

    async function approveAd(adId) {
      try {
        const res = await fetch('/api/admin/ads/' + adId + '/approve', {
          method: 'POST',
          credentials: 'include'
        });
        if (res.ok) {
          await loadAllAds();
        } else {
          alert('Failed to approve ad');
        }
      } catch (e) {
        console.error('Failed to approve ad:', e);
        alert('Error approving ad');
      }
    }

    async function fixAllCampaigns() {
      if (!confirm('This will activate all campaigns with approved ads. Continue?')) return;
      
      try {
        const res = await fetch('/api/admin/ads/fix-orphaned', {
          method: 'POST',
          credentials: 'include'
        });
        const data = await res.json();
        if (res.ok) {
          alert('Fixed ' + data.fixed.length + ' campaigns!\n\nTotal approved ads: ' + data.totalApprovedAds);
          await loadAllAds();
        } else {
          alert('Failed to fix campaigns: ' + (data.message || 'Unknown error'));
        }
      } catch (e) {
        console.error('Failed to fix campaigns:', e);
        alert('Error fixing campaigns');
      }
    }

    async function adjustWallet(walletId, advertiserName) {
      if (!walletId) {
        alert('This advertiser does not have a wallet yet.');
        return;
      }
      
      const action = prompt(`Adjust wallet for ${advertiserName || 'Advertiser'}\n\nEnter amount in Rand (positive to credit, negative to debit):\nExample: 100 to add R100, -50 to remove R50`);
      if (!action) return;
      
      const amount = parseFloat(action);
      if (isNaN(amount) || amount === 0) {
        alert('Please enter a valid number (positive or negative).');
        return;
      }
      
      const type = amount > 0 ? 'credit' : 'debit';
      const absAmount = Math.abs(amount);
      const reason = prompt(`Enter reason for this ${type}:`);
      if (!reason) return;
      
      try {
        const res = await fetch('/api/admin/ads/wallets/' + walletId + '/adjust', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ amount: absAmount, type, reason })
        });
        const data = await res.json();
        if (res.ok) {
          alert(`Successfully ${type}ed R${absAmount.toFixed(2)} to ${advertiserName}'s wallet.\n\nNew balance: R${((data.balance || 0) / 100).toFixed(2)}`);
          await loadAdvertisers();
        } else {
          alert('Failed to adjust wallet: ' + (data.message || 'Unknown error'));
        }
      } catch (e) {
        console.error('Failed to adjust wallet:', e);
        alert('Error adjusting wallet');
      }
    }

    async function fixWalletDeductions() {
      if (!confirm('This will refund upfront charges and activate draft ad groups. Continue?')) return;
      
      try {
        const res = await fetch('/api/admin/ads/fix-wallet-deductions', {
          method: 'POST',
          credentials: 'include'
        });
        const data = await res.json();
        if (res.ok) {
          let message = data.message;
          if (data.walletFixes && data.walletFixes.length > 0) {
            const totalRefund = data.walletFixes.reduce((sum, f) => sum + f.amount, 0) / 100;
            message += '\n\nTotal refunded: R' + totalRefund.toFixed(2);
          }
          alert(message);
          await loadAllAds();
        } else {
          alert('Failed to fix wallet deductions: ' + (data.message || 'Unknown error'));
        }
      } catch (e) {
        console.error('Failed to fix wallet deductions:', e);
        alert('Error fixing wallet deductions');
      }
    }

    async function rejectAd(adId) {
      const reason = prompt('Enter rejection reason:');
      if (!reason) return;
      
      try {
        const res = await fetch('/api/admin/ads/' + adId + '/reject', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ reason })
        });
        if (res.ok) {
          await loadAllAds();
        } else {
          alert('Failed to reject ad');
        }
      } catch (e) {
        console.error('Failed to reject ad:', e);
        alert('Error rejecting ad');
      }
    }

    async function suspendAdvertiser(advertiserId) {
      if (!confirm('Suspend this advertiser? Their campaigns will be paused.')) return;
      
      try {
        const res = await fetch('/api/admin/ads/advertisers/' + advertiserId + '/suspend', {
          method: 'POST',
          credentials: 'include'
        });
        if (res.ok) {
          await loadAdvertisers();
        } else {
          alert('Failed to suspend advertiser');
        }
      } catch (e) {
        console.error('Failed to suspend advertiser:', e);
        alert('Error suspending advertiser');
      }
    }

    async function activateAdvertiser(advertiserId) {
      try {
        const res = await fetch('/api/admin/ads/advertisers/' + advertiserId + '/activate', {
          method: 'POST',
          credentials: 'include'
        });
        if (res.ok) {
          await loadAdvertisers();
        } else {
          alert('Failed to activate advertiser');
        }
      } catch (e) {
        console.error('Failed to activate advertiser:', e);
        alert('Error activating advertiser');
      }
    }

    async function pauseCampaign(campaignId) {
      try {
        const res = await fetch('/api/admin/ads/campaigns/' + campaignId + '/pause', {
          method: 'POST',
          credentials: 'include'
        });
        if (res.ok) {
          await loadAllCampaigns();
        } else {
          alert('Failed to pause campaign');
        }
      } catch (e) {
        console.error('Failed to pause campaign:', e);
        alert('Error pausing campaign');
      }
    }

    async function resumeCampaign(campaignId) {
      try {
        const res = await fetch('/api/admin/ads/campaigns/' + campaignId + '/resume', {
          method: 'POST',
          credentials: 'include'
        });
        if (res.ok) {
          await loadAllCampaigns();
        } else {
          alert('Failed to resume campaign');
        }
      } catch (e) {
        console.error('Failed to resume campaign:', e);
        alert('Error resuming campaign');
      }
    }

    async function saveAdsSettings() {
      alert('Settings saved successfully!');
    }

    async function saveTierMultipliers() {
      alert('Tier multipliers saved successfully!');
    }

    // ===== GROUP CHATS MODERATION =====
    let groupChatsPage = 1;
    let groupChatsTotal = 0;
    let currentGroupId = null;
    let groupMessagesPage = 1;

    async function loadGroupChats() {
      try {
        const statsRes = await fetch('/api/admin/group-chats/stats', { credentials: 'include' });
        const stats = await statsRes.json();
        
        document.getElementById('groupChatsStats').innerHTML = `
          <div class="stat-card">
            <div class="stat-value">${stats.totalGroups || 0}</div>
            <div class="stat-label">Total Groups</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${stats.activeGroups || 0}</div>
            <div class="stat-label">Active Groups</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${stats.totalMessages || 0}</div>
            <div class="stat-label">Total Messages</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${stats.totalMembers || 0}</div>
            <div class="stat-label">Total Members</div>
          </div>
        `;
        
        await loadGroupChatsTable();
      } catch (e) {
        console.error('Failed to load group chats:', e);
      }
    }

    async function loadGroupChatsTable() {
      const search = document.getElementById('groupChatsSearch')?.value || '';
      try {
        const res = await fetch('/api/admin/group-chats?page=' + groupChatsPage + '&limit=20&search=' + encodeURIComponent(search), { credentials: 'include' });
        const data = await res.json();
        groupChatsTotal = data.total || 0;
        
        if (!data.groups || data.groups.length === 0) {
          document.getElementById('groupChatsTable').innerHTML = '<p style="padding: 20px; text-align: center; color: rgba(255,255,255,0.5);">No group chats found</p>';
          document.getElementById('groupChatsPagination').innerHTML = '';
          return;
        }
        
        let html = `<table class="table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Members</th>
              <th>Created</th>
              <th>Last Activity</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>`;
        
        for (const g of data.groups) {
          const created = new Date(g.createdAt).toLocaleDateString();
          const lastActive = g.lastMessageAt ? new Date(g.lastMessageAt).toLocaleDateString() : 'Never';
          const status = g.isActive ? '<span class="badge badge-success">Active</span>' : '<span class="badge badge-error">Inactive</span>';
          
          html += `<tr>
            <td>
              <div style="display: flex; align-items: center; gap: 10px;">
                ${g.avatarUrl ? '<img src="' + g.avatarUrl + '" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">' : '<div style="width: 36px; height: 36px; border-radius: 50%; background: rgba(139, 92, 246, 0.2); display: flex; align-items: center; justify-content: center;"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg></div>'}
                <div>
                  <div style="font-weight: 500;">${g.name || 'Unnamed Group'}</div>
                  ${g.description ? '<div style="font-size: 12px; color: rgba(255,255,255,0.5);">' + g.description.substring(0, 50) + '</div>' : ''}
                </div>
              </div>
            </td>
            <td>${g.memberCount || 0}</td>
            <td>${created}</td>
            <td>${lastActive}</td>
            <td>${status}</td>
            <td>
              <button class="action-btn action-btn-primary" onclick="viewGroupChatDetails('${g.id}')" style="padding: 6px 12px;">View</button>
            </td>
          </tr>`;
        }
        
        html += '</tbody></table>';
        document.getElementById('groupChatsTable').innerHTML = html;
        
        const totalPages = Math.ceil(groupChatsTotal / 20);
        let paginationHtml = '';
        if (totalPages > 1) {
          paginationHtml += '<button class="action-btn" ' + (groupChatsPage <= 1 ? 'disabled' : '') + ' onclick="changeGroupChatsPage(' + (groupChatsPage - 1) + ')">Prev</button>';
          paginationHtml += '<span style="padding: 8px 16px;">Page ' + groupChatsPage + ' of ' + totalPages + '</span>';
          paginationHtml += '<button class="action-btn" ' + (groupChatsPage >= totalPages ? 'disabled' : '') + ' onclick="changeGroupChatsPage(' + (groupChatsPage + 1) + ')">Next</button>';
        }
        document.getElementById('groupChatsPagination').innerHTML = paginationHtml;
      } catch (e) {
        console.error('Failed to load group chats table:', e);
      }
    }

    function changeGroupChatsPage(page) {
      groupChatsPage = page;
      loadGroupChatsTable();
    }

    function filterGroupChats() {
      groupChatsPage = 1;
      loadGroupChatsTable();
    }

    async function viewGroupChatDetails(groupId) {
      currentGroupId = groupId;
      groupMessagesPage = 1;
      openModal('groupChatDetailModal');
      
      try {
        const res = await fetch('/api/admin/group-chats/' + groupId, { credentials: 'include' });
        const data = await res.json();
        
        if (!data.group) {
          document.getElementById('groupChatDetailContent').innerHTML = '<p>Group not found</p>';
          return;
        }
        
        let html = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <div>
              <h3 style="margin-bottom: 16px; color: #8B5CF6;">Group Info</h3>
              <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 16px;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                  ${data.group.avatarUrl ? '<img src="' + data.group.avatarUrl + '" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover;">' : '<div style="width: 60px; height: 60px; border-radius: 50%; background: rgba(139, 92, 246, 0.2); display: flex; align-items: center; justify-content: center;"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle></svg></div>'}
                  <div>
                    <h4 style="margin: 0;">${data.group.name || 'Unnamed Group'}</h4>
                    <p style="margin: 4px 0; color: rgba(255,255,255,0.6); font-size: 13px;">${data.group.description || 'No description'}</p>
                  </div>
                </div>
                <div style="font-size: 13px; color: rgba(255,255,255,0.7);">
                  <p><strong>Created:</strong> ${new Date(data.group.createdAt).toLocaleString()}</p>
                  <p><strong>Status:</strong> ${data.group.isActive ? '<span style="color: #10B981;">Active</span>' : '<span style="color: #EF4444;">Inactive</span>'}</p>
                  <p><strong>Members:</strong> ${data.group.memberCount || 0}</p>
                </div>
              </div>
              
              <h3 style="margin: 24px 0 16px; color: #8B5CF6;">Members (${data.members?.length || 0})</h3>
              <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 12px; max-height: 300px; overflow-y: auto;">`;
        
        if (data.members && data.members.length > 0) {
          for (const m of data.members) {
            const role = m.role === 'admin' ? '<span class="badge badge-warning">Admin</span>' : (m.role === 'owner' ? '<span class="badge badge-purple">Owner</span>' : '');
            html += `
              <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; align-items: center; gap: 8px;">
                  ${m.user.avatar ? '<img src="' + m.user.avatar + '" style="width: 32px; height: 32px; border-radius: 50%;">' : '<div style="width: 32px; height: 32px; border-radius: 50%; background: rgba(139, 92, 246, 0.2);"></div>'}
                  <div>
                    <span style="font-weight: 500;">@${m.user.username}</span>
                    ${role}
                  </div>
                </div>
                ${m.role !== 'owner' ? '<button class="action-btn action-btn-danger" onclick="removeGroupMember(\'' + groupId + '\', \'' + m.userId + '\')" style="padding: 4px 8px; font-size: 11px;">Remove</button>' : ''}
              </div>`;
          }
        } else {
          html += '<p style="text-align: center; color: rgba(255,255,255,0.5);">No members</p>';
        }
        
        html += `
              </div>
            </div>
            <div>
              <h3 style="margin-bottom: 16px; color: #8B5CF6;">Recent Messages</h3>
              <div id="groupMessagesContainer" style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 12px; max-height: 500px; overflow-y: auto;">
                <div class="loading">Loading messages...</div>
              </div>
              <div id="groupMessagesPagination" style="display: flex; justify-content: center; gap: 8px; margin-top: 12px;"></div>
            </div>
          </div>
        `;
        
        document.getElementById('groupChatDetailContent').innerHTML = html;
        await loadGroupMessages(groupId);
      } catch (e) {
        console.error('Failed to load group details:', e);
        document.getElementById('groupChatDetailContent').innerHTML = '<p style="color: #EF4444;">Error loading group details</p>';
      }
    }

    async function loadGroupMessages(groupId) {
      try {
        const res = await fetch('/api/admin/group-chats/' + groupId + '/messages?page=' + groupMessagesPage + '&limit=30', { credentials: 'include' });
        const data = await res.json();
        
        let html = '';
        if (!data.messages || data.messages.length === 0) {
          html = '<p style="text-align: center; color: rgba(255,255,255,0.5);">No messages</p>';
        } else {
          for (const m of data.messages) {
            const time = new Date(m.createdAt).toLocaleString();
            const isDeleted = m.isDeleted;
            html += `
              <div style="padding: 10px; margin-bottom: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; ${isDeleted ? 'opacity: 0.5;' : ''}">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                  <span style="font-weight: 500; color: #8B5CF6;">@${m.sender?.username || 'Unknown'}</span>
                  <span style="font-size: 11px; color: rgba(255,255,255,0.5);">${time}</span>
                </div>
                <p style="margin: 0; font-size: 13px; ${isDeleted ? 'font-style: italic;' : ''}">${m.content || '[No content]'}</p>
                ${!isDeleted ? '<button class="action-btn action-btn-danger" onclick="deleteGroupMessage(\'' + groupId + '\', \'' + m.id + '\')" style="margin-top: 8px; padding: 4px 8px; font-size: 11px;">Delete</button>' : '<span style="font-size: 11px; color: #EF4444;">[Deleted]</span>'}
              </div>`;
          }
        }
        
        document.getElementById('groupMessagesContainer').innerHTML = html;
        
        const totalPages = Math.ceil((data.total || 0) / 30);
        let paginationHtml = '';
        if (totalPages > 1) {
          paginationHtml += '<button class="action-btn" ' + (groupMessagesPage <= 1 ? 'disabled' : '') + ' onclick="changeGroupMessagesPage(' + (groupMessagesPage - 1) + ')" style="padding: 4px 8px; font-size: 11px;">Prev</button>';
          paginationHtml += '<span style="padding: 4px 8px; font-size: 11px;">' + groupMessagesPage + '/' + totalPages + '</span>';
          paginationHtml += '<button class="action-btn" ' + (groupMessagesPage >= totalPages ? 'disabled' : '') + ' onclick="changeGroupMessagesPage(' + (groupMessagesPage + 1) + ')" style="padding: 4px 8px; font-size: 11px;">Next</button>';
        }
        document.getElementById('groupMessagesPagination').innerHTML = paginationHtml;
      } catch (e) {
        console.error('Failed to load group messages:', e);
        document.getElementById('groupMessagesContainer').innerHTML = '<p style="color: #EF4444;">Error loading messages</p>';
      }
    }

    function changeGroupMessagesPage(page) {
      groupMessagesPage = page;
      loadGroupMessages(currentGroupId);
    }

    async function deleteGroupMessage(groupId, messageId) {
      if (!confirm('Delete this message? This action cannot be undone.')) return;
      
      try {
        const res = await fetch('/api/admin/group-chats/' + groupId + '/messages/' + messageId, {
          method: 'DELETE',
          credentials: 'include'
        });
        if (res.ok) {
          await loadGroupMessages(groupId);
          await loadGroupChats();
        } else {
          alert('Failed to delete message');
        }
      } catch (e) {
        console.error('Failed to delete message:', e);
        alert('Error deleting message');
      }
    }

    async function removeGroupMember(groupId, userId) {
      if (!confirm('Remove this member from the group?')) return;
      
      try {
        const res = await fetch('/api/admin/group-chats/' + groupId + '/members/' + userId, {
          method: 'DELETE',
          credentials: 'include'
        });
        if (res.ok) {
          await viewGroupChatDetails(groupId);
          await loadGroupChats();
        } else {
          alert('Failed to remove member');
        }
      } catch (e) {
        console.error('Failed to remove member:', e);
        alert('Error removing member');
      }
    }

    window.loadGroupChats = loadGroupChats;
    window.filterGroupChats = filterGroupChats;
    window.viewGroupChatDetails = viewGroupChatDetails;
    window.deleteGroupMessage = deleteGroupMessage;
    window.removeGroupMember = removeGroupMember;
    window.changeGroupChatsPage = changeGroupChatsPage;
    window.changeGroupMessagesPage = changeGroupMessagesPage;

    // ===== THREADS & DUET/STITCH SECTION =====
    let threadsPage = 1;
    let threadsTotal = 0;
    let threadsSearchTerm = '';
    let currentThreadsTab = 'threads';
    let duetStitchPage = 1;
    let duetStitchTotal = 0;
    let duetStitchType = 'all';

    async function loadThreads() {
      try {
        const [statsRes, threadsRes] = await Promise.all([
          fetch('/api/admin/threads/stats', { credentials: 'include' }),
          fetch('/api/admin/threads?page=' + threadsPage + '&limit=20&search=' + encodeURIComponent(threadsSearchTerm), { credentials: 'include' })
        ]);
        
        if (statsRes.ok) {
          const stats = await statsRes.json();
          document.getElementById('threadsStats').innerHTML = `
            <div class="stat-card">
              <h3>Total Threads</h3>
              <div class="value">${formatNumber(stats.totalThreads)}</div>
            </div>
            <div class="stat-card">
              <h3>Total Duets</h3>
              <div class="value">${formatNumber(stats.totalDuets)}</div>
            </div>
            <div class="stat-card">
              <h3>Total Stitches</h3>
              <div class="value">${formatNumber(stats.totalStitches)}</div>
            </div>
          `;
        }
        
        if (threadsRes.ok) {
          const data = await threadsRes.json();
          threadsTotal = data.total || 0;
          
          if (!data.threads || data.threads.length === 0) {
            document.getElementById('threadsTable').innerHTML = `
              <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path></svg>
                <p>No threads found</p>
              </div>
            `;
            document.getElementById('threadsPagination').innerHTML = '';
            return;
          }
          
          document.getElementById('threadsTable').innerHTML = `
            <table class="table">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Author</th>
                  <th>Posts</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${data.threads.map(t => `
                  <tr>
                    <td>${escapeHtml(t.title || 'Untitled Thread')}</td>
                    <td>@${escapeHtml(t.author?.username || 'Unknown')}</td>
                    <td>${t.postCount || t.posts?.length || 0}</td>
                    <td>${new Date(t.createdAt).toLocaleDateString()}</td>
                    <td>
                      <button class="action-btn action-btn-secondary" onclick="viewThreadDetails('${t.id}')" style="padding: 6px 12px; font-size: 12px; margin-right: 4px;">View</button>
                      <button class="action-btn action-btn-danger" onclick="deleteThread('${t.id}')" style="padding: 6px 12px; font-size: 12px;">Delete</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          
          renderThreadsPagination();
        }
      } catch (e) {
        console.error('Failed to load threads:', e);
        document.getElementById('threadsTable').innerHTML = '<div style="padding: 24px; text-align: center; color: #EF4444;">Error loading threads</div>';
      }
    }

    async function loadDuetStitch() {
      try {
        const typeParam = duetStitchType !== 'all' ? '&type=' + duetStitchType : '';
        const res = await fetch('/api/admin/duet-stitch?page=' + duetStitchPage + '&limit=20' + typeParam, { credentials: 'include' });
        
        if (res.ok) {
          const data = await res.json();
          duetStitchTotal = data.total || 0;
          
          if (!data.posts || data.posts.length === 0) {
            document.getElementById('duetStitchTable').innerHTML = `
              <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path></svg>
                <p>No duets or stitches found</p>
              </div>
            `;
            document.getElementById('duetStitchPagination').innerHTML = '';
            return;
          }
          
          document.getElementById('duetStitchTable').innerHTML = `
            <table class="table">
              <thead>
                <tr>
                  <th>Author</th>
                  <th>Type</th>
                  <th>Original Post</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${data.posts.map(ds => `
                  <tr>
                    <td>@${escapeHtml(ds.author?.username || 'Unknown')}</td>
                    <td><span class="badge ${ds.type === 'DUET' ? 'badge-info' : 'badge-warning'}">${ds.type}</span></td>
                    <td>${escapeHtml((ds.originalPost?.content || ds.originalPost?.caption || 'No content').substring(0, 40))}${(ds.originalPost?.content?.length || ds.originalPost?.caption?.length || 0) > 40 ? '...' : ''}</td>
                    <td>${new Date(ds.createdAt).toLocaleDateString()}</td>
                    <td>
                      <button class="action-btn action-btn-secondary" onclick="viewDuetStitchDetails('${ds.id}')" style="padding: 6px 12px; font-size: 12px; margin-right: 4px;">View</button>
                      <button class="action-btn action-btn-danger" onclick="deleteDuetStitch('${ds.id}')" style="padding: 6px 12px; font-size: 12px;">Delete</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
          
          renderDuetStitchPagination();
        }
      } catch (e) {
        console.error('Failed to load duet/stitch posts:', e);
        document.getElementById('duetStitchTable').innerHTML = '<div style="padding: 24px; text-align: center; color: #EF4444;">Error loading duets/stitches</div>';
      }
    }

    function renderThreadsPagination() {
      const totalPages = Math.ceil(threadsTotal / 20);
      if (totalPages <= 1) {
        document.getElementById('threadsPagination').innerHTML = '';
        return;
      }
      
      let html = '';
      if (threadsPage > 1) {
        html += '<button class="action-btn action-btn-secondary" onclick="changeThreadsPage(' + (threadsPage - 1) + ')" style="padding: 6px 12px;">Prev</button>';
      }
      html += '<span style="padding: 0 12px; color: rgba(255,255,255,0.6);">Page ' + threadsPage + ' of ' + totalPages + '</span>';
      if (threadsPage < totalPages) {
        html += '<button class="action-btn action-btn-secondary" onclick="changeThreadsPage(' + (threadsPage + 1) + ')" style="padding: 6px 12px;">Next</button>';
      }
      document.getElementById('threadsPagination').innerHTML = html;
    }

    function renderDuetStitchPagination() {
      const totalPages = Math.ceil(duetStitchTotal / 20);
      if (totalPages <= 1) {
        document.getElementById('duetStitchPagination').innerHTML = '';
        return;
      }
      
      let html = '';
      if (duetStitchPage > 1) {
        html += '<button class="action-btn action-btn-secondary" onclick="changeDuetStitchPage(' + (duetStitchPage - 1) + ')" style="padding: 6px 12px;">Prev</button>';
      }
      html += '<span style="padding: 0 12px; color: rgba(255,255,255,0.6);">Page ' + duetStitchPage + ' of ' + totalPages + '</span>';
      if (duetStitchPage < totalPages) {
        html += '<button class="action-btn action-btn-secondary" onclick="changeDuetStitchPage(' + (duetStitchPage + 1) + ')" style="padding: 6px 12px;">Next</button>';
      }
      document.getElementById('duetStitchPagination').innerHTML = html;
    }

    function changeThreadsPage(page) {
      threadsPage = page;
      loadThreads();
    }

    function changeDuetStitchPage(page) {
      duetStitchPage = page;
      loadDuetStitch();
    }

    function searchThreads() {
      threadsSearchTerm = document.getElementById('threadsSearch').value;
      threadsPage = 1;
      loadThreads();
    }

    function setThreadsTab(tab) {
      currentThreadsTab = tab;
      document.querySelectorAll('[data-action="threads-tab"]').forEach(btn => btn.classList.remove('active'));
      document.querySelector('[data-action="threads-tab"][data-tab="' + tab + '"]')?.classList.add('active');
      
      if (tab === 'threads') {
        document.getElementById('threadsContent').style.display = 'block';
        document.getElementById('duetStitchContent').style.display = 'none';
        loadThreads();
      } else {
        document.getElementById('threadsContent').style.display = 'none';
        document.getElementById('duetStitchContent').style.display = 'block';
        loadDuetStitch();
      }
    }

    async function viewThreadDetails(threadId) {
      try {
        document.getElementById('threadDetailContent').innerHTML = '<div class="loading">Loading...</div>';
        openModal('threadDetailModal');
        
        const res = await fetch('/api/admin/threads?search=', { credentials: 'include' });
        const data = await res.json();
        const thread = data.threads?.find(t => t.id === threadId);
        
        if (!thread) {
          document.getElementById('threadDetailContent').innerHTML = '<p style="color: #EF4444;">Thread not found</p>';
          return;
        }
        
        document.getElementById('threadDetailContent').innerHTML = `
          <div class="detail-grid">
            <div class="detail-item">
              <label>Title</label>
              <span>${escapeHtml(thread.title || 'Untitled Thread')}</span>
            </div>
            <div class="detail-item">
              <label>Author</label>
              <span>@${escapeHtml(thread.author?.username || 'Unknown')}</span>
            </div>
            <div class="detail-item">
              <label>Posts Count</label>
              <span>${thread.postCount || thread.posts?.length || 0}</span>
            </div>
            <div class="detail-item">
              <label>Created</label>
              <span>${new Date(thread.createdAt).toLocaleString()}</span>
            </div>
            <div class="detail-item">
              <label>Thread ID</label>
              <span style="font-family: monospace; font-size: 11px;">${thread.id}</span>
            </div>
          </div>
          
          ${thread.posts && thread.posts.length > 0 ? `
            <div style="margin-top: 20px;">
              <h4 style="color: #8B5CF6; margin-bottom: 12px;">Posts in Thread</h4>
              <div style="max-height: 300px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px;">
                ${thread.posts.map((post, idx) => `
                  <div style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); ${idx === thread.posts.length - 1 ? 'border-bottom: none;' : ''}">
                    <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-bottom: 4px;">Post #${idx + 1}</div>
                    <div>${escapeHtml((post.content || post.caption || 'No content').substring(0, 200))}${(post.content?.length || post.caption?.length || 0) > 200 ? '...' : ''}</div>
                    ${post.mediaUrl ? '<div style="font-size: 12px; color: #8B5CF6; margin-top: 4px;">Has media attachment</div>' : ''}
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
          
          <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
            <button class="action-btn action-btn-danger" onclick="deleteThread('${thread.id}'); closeModal('threadDetailModal');" style="width: 100%; padding: 12px;">
              Delete Thread
            </button>
          </div>
        `;
      } catch (e) {
        console.error('Failed to load thread details:', e);
        document.getElementById('threadDetailContent').innerHTML = '<p style="color: #EF4444;">Error loading thread details</p>';
      }
    }

    async function viewDuetStitchDetails(dsId) {
      try {
        document.getElementById('duetStitchDetailContent').innerHTML = '<div class="loading">Loading...</div>';
        openModal('duetStitchDetailModal');
        
        const res = await fetch('/api/admin/duet-stitch', { credentials: 'include' });
        const data = await res.json();
        const ds = data.posts?.find(p => p.id === dsId);
        
        if (!ds) {
          document.getElementById('duetStitchDetailContent').innerHTML = '<p style="color: #EF4444;">Duet/Stitch not found</p>';
          return;
        }
        
        document.getElementById('duetStitchDetailContent').innerHTML = `
          <div class="detail-grid">
            <div class="detail-item">
              <label>Type</label>
              <span class="badge ${ds.type === 'DUET' ? 'badge-info' : 'badge-warning'}">${ds.type}</span>
            </div>
            <div class="detail-item">
              <label>Author</label>
              <span>@${escapeHtml(ds.author?.username || 'Unknown')}</span>
            </div>
            <div class="detail-item">
              <label>Created</label>
              <span>${new Date(ds.createdAt).toLocaleString()}</span>
            </div>
            <div class="detail-item">
              <label>ID</label>
              <span style="font-family: monospace; font-size: 11px;">${ds.id}</span>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 20px;">
            <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 16px;">
              <h4 style="color: #8B5CF6; margin-bottom: 12px;">New Post</h4>
              <div>${escapeHtml((ds.post?.content || ds.post?.caption || 'No content').substring(0, 150))}${(ds.post?.content?.length || ds.post?.caption?.length || 0) > 150 ? '...' : ''}</div>
              ${ds.post?.mediaUrl ? '<div style="font-size: 12px; color: #8B5CF6; margin-top: 8px;">Has media</div>' : ''}
            </div>
            <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 16px;">
              <h4 style="color: #8B5CF6; margin-bottom: 12px;">Original Post</h4>
              <div>${escapeHtml((ds.originalPost?.content || ds.originalPost?.caption || 'No content').substring(0, 150))}${(ds.originalPost?.content?.length || ds.originalPost?.caption?.length || 0) > 150 ? '...' : ''}</div>
              ${ds.originalPost?.mediaUrl ? '<div style="font-size: 12px; color: #8B5CF6; margin-top: 8px;">Has media</div>' : ''}
            </div>
          </div>
          
          ${ds.type === 'STITCH' && (ds.stitchStartMs || ds.stitchEndMs) ? `
            <div style="margin-top: 16px; padding: 12px; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">
              <div style="font-size: 12px; color: rgba(255,255,255,0.6);">Stitch Range: ${ds.stitchStartMs || 0}ms - ${ds.stitchEndMs || 0}ms</div>
            </div>
          ` : ''}
          
          <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
            <button class="action-btn action-btn-danger" onclick="deleteDuetStitch('${ds.id}'); closeModal('duetStitchDetailModal');" style="width: 100%; padding: 12px;">
              Delete ${ds.type === 'DUET' ? 'Duet' : 'Stitch'}
            </button>
          </div>
        `;
      } catch (e) {
        console.error('Failed to load duet/stitch details:', e);
        document.getElementById('duetStitchDetailContent').innerHTML = '<p style="color: #EF4444;">Error loading details</p>';
      }
    }

    async function deleteThread(threadId) {
      if (!confirm('Are you sure you want to delete this thread? This will also delete all posts in the thread. This action cannot be undone.')) return;
      
      try {
        const res = await fetch('/api/admin/threads/' + threadId, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (res.ok) {
          loadThreads();
        } else {
          const data = await res.json();
          alert('Failed to delete thread: ' + (data.message || 'Unknown error'));
        }
      } catch (e) {
        console.error('Failed to delete thread:', e);
        alert('Error deleting thread');
      }
    }

    async function deleteDuetStitch(dsId) {
      if (!confirm('Are you sure you want to delete this duet/stitch? This action cannot be undone.')) return;
      
      try {
        const res = await fetch('/api/admin/duet-stitch/' + dsId, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (res.ok) {
          loadDuetStitch();
        } else {
          const data = await res.json();
          alert('Failed to delete: ' + (data.message || 'Unknown error'));
        }
      } catch (e) {
        console.error('Failed to delete duet/stitch:', e);
        alert('Error deleting duet/stitch');
      }
    }

    // Threads tab click handler
    document.addEventListener('click', function(e) {
      if (e.target.matches('[data-action="threads-tab"]')) {
        const tab = e.target.dataset.tab;
        if (tab) {
          setThreadsTab(tab);
        }
      }
      
      if (e.target.matches('[data-action="duet-type-filter"]')) {
        document.querySelectorAll('[data-action="duet-type-filter"]').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        duetStitchType = e.target.dataset.type;
        duetStitchPage = 1;
        loadDuetStitch();
      }
    });

    window.loadThreads = loadThreads;
    window.loadDuetStitch = loadDuetStitch;
    window.searchThreads = searchThreads;
    window.setThreadsTab = setThreadsTab;
    window.changeThreadsPage = changeThreadsPage;
    window.changeDuetStitchPage = changeDuetStitchPage;
    window.viewThreadDetails = viewThreadDetails;
    window.viewDuetStitchDetails = viewDuetStitchDetails;
    window.deleteThread = deleteThread;
    window.deleteDuetStitch = deleteDuetStitch;

    // Expose advertising functions
    window.loadAdvertising = loadAdvertising;
    window.showAdsTab = showAdsTab;
    window.filterAdvertisers = filterAdvertisers;
    window.filterCampaigns = filterCampaigns;
    window.filterAds = filterAds;
    window.saveAdsSettings = saveAdsSettings;
    window.saveTierMultipliers = saveTierMultipliers;

    // ===== CONTENT VELOCITY SECTION =====
    let velocityTimeframe = '24h';
    let velocityPage = 1;
    let velocityTotal = 0;
    
    async function loadContentVelocity() {
      try {
        const [statsRes, trendingRes, dailyRes] = await Promise.all([
          fetch('/api/admin/content/velocity/stats', { credentials: 'include' }),
          fetch('/api/admin/content/trending?page=' + velocityPage + '&limit=10&timeframe=' + velocityTimeframe, { credentials: 'include' }),
          fetch('/api/admin/content/daily-trends?days=7', { credentials: 'include' })
        ]);
        
        const stats = await statsRes.json();
        const trending = await trendingRes.json();
        const daily = await dailyRes.json();
        
        velocityTotal = trending.total || 0;
        
        let statsHtml = `
          <div class="stat-card">
            <h3>Trending Now</h3>
            <div class="value" style="color: #F59E0B;">${stats.trendingNow || 0}</div>
          </div>
          <div class="stat-card">
            <h3>Viral Today</h3>
            <div class="value" style="color: #EF4444;">${stats.viralToday || 0}</div>
          </div>
          <div class="stat-card">
            <h3>Avg Engagement Rate</h3>
            <div class="value">${(stats.avgEngagementRate || 0).toFixed(1)}%</div>
          </div>
        `;
        document.getElementById('velocityStats').innerHTML = statsHtml;
        
        if (!trending.posts || trending.posts.length === 0) {
          document.getElementById('trendingPostsTable').innerHTML = `
            <div class="empty-state">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path></svg>
              <p>No trending posts found</p>
            </div>
          `;
          document.getElementById('trendingPagination').innerHTML = '';
        } else {
          const formatVelocity = (v) => v >= 1000 ? (v / 1000).toFixed(1) + 'k' : (v || 0);
          
          let tableHtml = `<table>
            <thead>
              <tr>
                <th>Post</th>
                <th>Author</th>
                <th>Likes</th>
                <th>Comments</th>
                <th>Shares</th>
                <th>Velocity</th>
                <th>Peak Time</th>
              </tr>
            </thead>
            <tbody>
          `;
          
          trending.posts.forEach(p => {
            const content = p.content ? (p.content.length > 50 ? p.content.substring(0, 50) + '...' : p.content) : 'No content';
            const peakTime = p.peakTime ? new Date(p.peakTime).toLocaleString() : '-';
            tableHtml += `
              <tr>
                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${content}</td>
                <td>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <img src="${p.author?.profileImageUrl || 'https://via.placeholder.com/32'}" alt="" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover;">
                    <span>${p.author?.displayName || p.author?.username || 'Unknown'}</span>
                  </div>
                </td>
                <td>${p.likesCount || 0}</td>
                <td>${p.commentsCount || 0}</td>
                <td>${p.sharesCount || 0}</td>
                <td><span class="badge badge-warning">${formatVelocity(p.velocity)}/hr</span></td>
                <td style="font-size: 12px; color: rgba(255,255,255,0.6);">${peakTime}</td>
              </tr>
            `;
          });
          
          tableHtml += '</tbody></table>';
          document.getElementById('trendingPostsTable').innerHTML = tableHtml;
          
          const totalPages = Math.ceil(velocityTotal / 10);
          let paginationHtml = '';
          if (totalPages > 1) {
            paginationHtml = `
              <button class="action-btn" ${velocityPage <= 1 ? 'disabled' : ''} onclick="changeVelocityPage(${velocityPage - 1})">Previous</button>
              <span style="padding: 8px 16px;">Page ${velocityPage} of ${totalPages}</span>
              <button class="action-btn" ${velocityPage >= totalPages ? 'disabled' : ''} onclick="changeVelocityPage(${velocityPage + 1})">Next</button>
            `;
          }
          document.getElementById('trendingPagination').innerHTML = paginationHtml;
        }
        
        if (daily && daily.length > 0) {
          const today = daily[0];
          
          if (today.topHashtags && today.topHashtags.length > 0) {
            let hashtagsHtml = '<div style="display: flex; flex-direction: column; gap: 8px;">';
            today.topHashtags.slice(0, 10).forEach((h, idx) => {
              hashtagsHtml += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                  <span style="font-weight: 500;">#${h.tag}</span>
                  <span class="badge badge-primary">${h.count} posts</span>
                </div>
              `;
            });
            hashtagsHtml += '</div>';
            document.getElementById('topHashtagsList').innerHTML = hashtagsHtml;
          } else {
            document.getElementById('topHashtagsList').innerHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">No trending hashtags</p>';
          }
          
          let trendsHtml = '<div style="display: flex; flex-direction: column; gap: 12px;">';
          daily.slice(0, 7).forEach(d => {
            const date = new Date(d.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            const topTag = d.topHashtags && d.topHashtags[0] ? '#' + d.topHashtags[0].tag : '-';
            const topPost = d.topPosts && d.topPosts[0] ? d.topPosts[0].title || 'Post' : '-';
            trendsHtml += `
              <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">
                <span style="font-weight: 500; min-width: 100px;">${date}</span>
                <span style="color: #F59E0B; font-size: 13px;">${topTag}</span>
              </div>
            `;
          });
          trendsHtml += '</div>';
          document.getElementById('dailyTrendsSummary').innerHTML = trendsHtml;
        } else {
          document.getElementById('topHashtagsList').innerHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">No hashtag data</p>';
          document.getElementById('dailyTrendsSummary').innerHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">No trend data</p>';
        }
      } catch (err) {
        console.error('Error loading content velocity:', err);
        document.getElementById('velocityStats').innerHTML = '<div class="error">Failed to load stats</div>';
      }
    }
    
    function changeVelocityPage(page) {
      velocityPage = page;
      loadContentVelocity();
    }
    
    function filterVelocityTimeframe(timeframe) {
      velocityTimeframe = timeframe;
      velocityPage = 1;
      document.querySelectorAll('[data-action="velocity-timeframe"]').forEach(btn => btn.classList.remove('active'));
      document.querySelector('[data-action="velocity-timeframe"][data-timeframe="' + timeframe + '"]').classList.add('active');
      loadContentVelocity();
    }
    
    document.addEventListener('click', function(e) {
      if (e.target.matches('[data-action="velocity-timeframe"]')) {
        filterVelocityTimeframe(e.target.dataset.timeframe);
      }
    });
    
    window.changeVelocityPage = changeVelocityPage;
    window.filterVelocityTimeframe = filterVelocityTimeframe;

    // ===== VIDEO CALLS SECTION =====
    let videoCallsPage = 1;
    let videoCallsTotal = 0;
    let videoCallsFilter = 'all';
    let videoCallsSearchTerm = '';

    async function loadVideoCalls() {
      try {
        const [statsRes, callsRes] = await Promise.all([
          fetch('/api/admin/video-calls/stats', { credentials: 'include' }),
          fetch('/api/admin/video-calls?page=' + videoCallsPage + '&limit=20&status=' + videoCallsFilter + '&search=' + encodeURIComponent(videoCallsSearchTerm), { credentials: 'include' })
        ]);
        
        const stats = await statsRes.json();
        const callsData = await callsRes.json();
        
        videoCallsTotal = callsData.total || 0;
        
        const formatDuration = (seconds) => {
          if (!seconds) return '-';
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          return mins + 'm ' + secs + 's';
        };
        
        let statsHtml = `
          <div class="stat-card">
            <h3>Total Calls</h3>
            <div class="value">${stats.totalCalls || 0}</div>
          </div>
          <div class="stat-card">
            <h3>Active Now</h3>
            <div class="value" style="color: #10B981;">${stats.activeCalls || 0}</div>
          </div>
          <div class="stat-card">
            <h3>Completed Today</h3>
            <div class="value">${stats.completedToday || 0}</div>
          </div>
          <div class="stat-card">
            <h3>Avg Duration</h3>
            <div class="value">${formatDuration(stats.avgDuration)}</div>
          </div>
        `;
        document.getElementById('videoCallsStats').innerHTML = statsHtml;
        
        if (!callsData.calls || callsData.calls.length === 0) {
          document.getElementById('videoCallsTable').innerHTML = `
            <div class="empty-state">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
              <p>No video calls found</p>
            </div>
          `;
          document.getElementById('videoCallsPagination').innerHTML = '';
          return;
        }
        
        let tableHtml = `<table>
          <thead>
            <tr>
              <th>Caller</th>
              <th>Callee</th>
              <th>Type</th>
              <th>Status</th>
              <th>Duration</th>
              <th>Started At</th>
              <th>Ended At</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>`;
        
        const statusBadge = (status) => {
          switch(status) {
            case 'RINGING': return '<span class="badge badge-pending">Ringing</span>';
            case 'ONGOING': return '<span class="badge badge-active">Active</span>';
            case 'ENDED': return '<span class="badge badge-verified">Completed</span>';
            case 'MISSED': return '<span class="badge badge-suspended">Missed</span>';
            case 'DECLINED': return '<span class="badge badge-resolved">Declined</span>';
            case 'CANCELLED': return '<span class="badge badge-resolved">Cancelled</span>';
            default: return '<span class="badge">' + status + '</span>';
          }
        };
        
        const typeBadge = (type) => {
          if (type === 'VIDEO') return '<span class="badge badge-admin">Video</span>';
          return '<span class="badge badge-building">Audio</span>';
        };
        
        for (const call of callsData.calls) {
          const startedAt = call.startedAt ? new Date(call.startedAt).toLocaleString() : '-';
          const endedAt = call.endedAt ? new Date(call.endedAt).toLocaleString() : '-';
          const duration = call.durationSeconds ? formatDuration(call.durationSeconds) : '-';
          const isActive = call.status === 'RINGING' || call.status === 'ONGOING';
          
          tableHtml += `<tr>
            <td>
              <div class="user-cell">
                <div class="avatar">${call.caller?.avatarUrl ? '<img src="' + call.caller.avatarUrl + '">' : (call.caller?.displayName?.charAt(0) || '?')}</div>
                <div class="user-info">
                  <span class="user-name">@${call.caller?.username || 'Unknown'}</span>
                  <span class="user-email">${call.caller?.displayName || ''}</span>
                </div>
              </div>
            </td>
            <td>
              <div class="user-cell">
                <div class="avatar">${call.callee?.avatarUrl ? '<img src="' + call.callee.avatarUrl + '">' : (call.callee?.displayName?.charAt(0) || '?')}</div>
                <div class="user-info">
                  <span class="user-name">@${call.callee?.username || 'Unknown'}</span>
                  <span class="user-email">${call.callee?.displayName || ''}</span>
                </div>
              </div>
            </td>
            <td>${typeBadge(call.callType)}</td>
            <td>${statusBadge(call.status)}</td>
            <td>${duration}</td>
            <td>${startedAt}</td>
            <td>${endedAt}</td>
            <td>
              <button class="action-btn action-btn-primary" onclick="viewVideoCallDetails('${call.id}')">View</button>
              ${isActive ? '<button class="action-btn action-btn-danger" onclick="forceEndVideoCall(\'' + call.id + '\')">End Call</button>' : ''}
            </td>
          </tr>`;
        }
        
        tableHtml += '</tbody></table>';
        document.getElementById('videoCallsTable').innerHTML = tableHtml;
        
        const totalPages = Math.ceil(videoCallsTotal / 20);
        let paginationHtml = '';
        if (totalPages > 1) {
          paginationHtml += '<button class="action-btn" ' + (videoCallsPage <= 1 ? 'disabled' : '') + ' onclick="changeVideoCallsPage(' + (videoCallsPage - 1) + ')">Prev</button>';
          paginationHtml += '<span style="padding: 8px 16px;">Page ' + videoCallsPage + ' of ' + totalPages + '</span>';
          paginationHtml += '<button class="action-btn" ' + (videoCallsPage >= totalPages ? 'disabled' : '') + ' onclick="changeVideoCallsPage(' + (videoCallsPage + 1) + ')">Next</button>';
        }
        document.getElementById('videoCallsPagination').innerHTML = paginationHtml;
      } catch (e) {
        console.error('Failed to load video calls:', e);
        document.getElementById('videoCallsTable').innerHTML = '<p style="color: #EF4444; text-align: center; padding: 20px;">Error loading video calls</p>';
      }
    }

    function filterVideoCalls() {
      videoCallsSearchTerm = document.getElementById('videoCallsSearch').value;
      videoCallsPage = 1;
      loadVideoCalls();
    }

    function changeVideoCallsPage(page) {
      videoCallsPage = page;
      loadVideoCalls();
    }

    async function viewVideoCallDetails(callId) {
      openModal('videoCallDetailModal');
      document.getElementById('videoCallDetailContent').innerHTML = '<div class="loading">Loading call details...</div>';
      
      try {
        const res = await fetch('/api/admin/video-calls/' + callId, { credentials: 'include' });
        const data = await res.json();
        
        if (!data.call) {
          document.getElementById('videoCallDetailContent').innerHTML = '<p>Call not found</p>';
          return;
        }
        
        const call = data.call;
        const isActive = call.status === 'RINGING' || call.status === 'ONGOING';
        
        const formatDuration = (seconds) => {
          if (!seconds) return 'N/A';
          const mins = Math.floor(seconds / 60);
          const secs = seconds % 60;
          return mins + 'm ' + secs + 's';
        };
        
        const statusLabel = {
          'RINGING': 'Ringing',
          'ONGOING': 'Active',
          'ENDED': 'Completed',
          'MISSED': 'Missed',
          'DECLINED': 'Declined',
          'CANCELLED': 'Cancelled'
        };
        
        let html = `
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 16px;">
              <h4 style="color: #8B5CF6; margin-bottom: 12px;">Caller</h4>
              <div style="display: flex; align-items: center; gap: 12px;">
                <div class="avatar" style="width: 48px; height: 48px; font-size: 18px;">
                  ${call.caller?.avatarUrl ? '<img src="' + call.caller.avatarUrl + '">' : (call.caller?.displayName?.charAt(0) || '?')}
                </div>
                <div>
                  <div style="font-weight: 600;">@${call.caller?.username || 'Unknown'}</div>
                  <div style="font-size: 13px; color: rgba(255,255,255,0.6);">${call.caller?.displayName || ''}</div>
                </div>
              </div>
            </div>
            <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 16px;">
              <h4 style="color: #8B5CF6; margin-bottom: 12px;">Callee</h4>
              <div style="display: flex; align-items: center; gap: 12px;">
                <div class="avatar" style="width: 48px; height: 48px; font-size: 18px;">
                  ${call.callee?.avatarUrl ? '<img src="' + call.callee.avatarUrl + '">' : (call.callee?.displayName?.charAt(0) || '?')}
                </div>
                <div>
                  <div style="font-weight: 600;">@${call.callee?.username || 'Unknown'}</div>
                  <div style="font-size: 13px; color: rgba(255,255,255,0.6);">${call.callee?.displayName || ''}</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="detail-grid">
            <div class="detail-item">
              <label>Call Type</label>
              <span>${call.callType === 'VIDEO' ? 'Video Call' : 'Voice Call'}</span>
            </div>
            <div class="detail-item">
              <label>Status</label>
              <span>${statusLabel[call.status] || call.status}</span>
            </div>
            <div class="detail-item">
              <label>Duration</label>
              <span>${formatDuration(call.durationSeconds)}</span>
            </div>
            <div class="detail-item">
              <label>Room ID</label>
              <span style="font-family: monospace; font-size: 12px;">${call.roomId || 'N/A'}</span>
            </div>
            <div class="detail-item">
              <label>Started At</label>
              <span>${call.startedAt ? new Date(call.startedAt).toLocaleString() : 'Not started'}</span>
            </div>
            <div class="detail-item">
              <label>Ended At</label>
              <span>${call.endedAt ? new Date(call.endedAt).toLocaleString() : 'Not ended'}</span>
            </div>
            <div class="detail-item">
              <label>Created At</label>
              <span>${new Date(call.createdAt).toLocaleString()}</span>
            </div>
            <div class="detail-item">
              <label>Call ID</label>
              <span style="font-family: monospace; font-size: 11px;">${call.id}</span>
            </div>
          </div>
          
          ${isActive ? `
            <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
              <button class="action-btn action-btn-danger" onclick="forceEndVideoCall('${call.id}')" style="width: 100%; padding: 12px;">
                Force End Call
              </button>
            </div>
          ` : ''}
        `;
        
        document.getElementById('videoCallDetailContent').innerHTML = html;
      } catch (e) {
        console.error('Failed to load call details:', e);
        document.getElementById('videoCallDetailContent').innerHTML = '<p style="color: #EF4444;">Error loading call details</p>';
      }
    }

    async function forceEndVideoCall(callId) {
      if (!confirm('Are you sure you want to force end this call?')) return;
      
      try {
        const res = await fetch('/api/admin/video-calls/' + callId + '/end', {
          method: 'POST',
          credentials: 'include'
        });
        
        if (res.ok) {
          closeModal('videoCallDetailModal');
          await loadVideoCalls();
        } else {
          alert('Failed to end call');
        }
      } catch (e) {
        console.error('Failed to end call:', e);
        alert('Error ending call');
      }
    }

    // Video call filter handler
    document.addEventListener('click', function(e) {
      if (e.target.matches('[data-action="videocall-filter"]')) {
        document.querySelectorAll('[data-action="videocall-filter"]').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        videoCallsFilter = e.target.dataset.filter;
        videoCallsPage = 1;
        loadVideoCalls();
      }
      
      // Messages tab handler
      if (e.target.matches('[data-action="messages-tab"]')) {
        const tab = e.target.dataset.tab;
        if (tab) {
          setMessagesTab(tab);
        }
      }
    });

    window.loadVideoCalls = loadVideoCalls;
    window.filterVideoCalls = filterVideoCalls;
    window.changeVideoCallsPage = changeVideoCallsPage;
    window.viewVideoCallDetails = viewVideoCallDetails;
    window.forceEndVideoCall = forceEndVideoCall;

    // ===== LOCATIONS SECTION =====
    let venuesPage = 1;
    let venuesTotal = 0;
    let checkinsPage = 1;
    let checkinsTotal = 0;

    async function loadLocationStats() {
      try {
        const res = await fetch('/api/admin/locations/stats', { credentials: 'include' });
        const stats = await res.json();
        
        document.getElementById('statTotalVenues').textContent = stats.totalVenues || 0;
        document.getElementById('statVerifiedVenues').textContent = stats.verifiedVenues || 0;
        document.getElementById('statTotalCheckIns').textContent = stats.totalCheckIns || 0;
        document.getElementById('statActiveLocations').textContent = stats.activeLocations || 0;
      } catch (error) {
        console.error('Failed to load location stats:', error);
      }
    }

    async function loadVenues() {
      try {
        const search = document.getElementById('venueSearch')?.value || '';
        const verifiedOnly = document.getElementById('verifiedOnlyFilter')?.checked;
        
        let url = '/api/admin/venues?page=' + venuesPage + '&limit=20';
        if (search) url += '&search=' + encodeURIComponent(search);
        if (verifiedOnly) url += '&verified=true';
        
        const res = await fetch(url, { credentials: 'include' });
        const data = await res.json();
        
        venuesTotal = data.total || 0;
        
        if (!data.venues || data.venues.length === 0) {
          document.getElementById('venuesTable').innerHTML = `
            <div class="empty-state">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
              <p>No venues found</p>
            </div>
          `;
          document.getElementById('venuesPagination').innerHTML = '';
          return;
        }
        
        let tableHtml = `<table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Address</th>
              <th>City</th>
              <th>Category</th>
              <th>Status</th>
              <th>Check-ins</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>`;
        
        for (const venue of data.venues) {
          const verifiedBadge = venue.isVerified 
            ? '<span class="badge badge-verified">Verified</span>' 
            : '<span class="badge badge-building">Unverified</span>';
          
          tableHtml += `
            <tr>
              <td><strong>${venue.name || 'Unnamed'}</strong></td>
              <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${venue.address || '-'}</td>
              <td>${venue.city || '-'}</td>
              <td>${venue.category || '-'}</td>
              <td>${verifiedBadge}</td>
              <td>${venue.checkInCount || 0}</td>
              <td>
                <button class="action-btn action-btn-primary" onclick="editVenue('${venue.id}')">Edit</button>
                <button class="action-btn action-btn-success" onclick="toggleVerifyVenue('${venue.id}', ${!venue.isVerified})">${venue.isVerified ? 'Unverify' : 'Verify'}</button>
                <button class="action-btn action-btn-danger" onclick="deleteVenue('${venue.id}')">Delete</button>
              </td>
            </tr>
          `;
        }
        
        tableHtml += '</tbody></table>';
        document.getElementById('venuesTable').innerHTML = tableHtml;
        
        const totalPages = Math.ceil(venuesTotal / 20);
        let paginationHtml = '';
        if (totalPages > 1) {
          paginationHtml = `
            <button class="action-btn" ${venuesPage <= 1 ? 'disabled' : ''} onclick="changeVenuesPage(${venuesPage - 1})">Previous</button>
            <span style="padding: 8px 16px;">Page ${venuesPage} of ${totalPages}</span>
            <button class="action-btn" ${venuesPage >= totalPages ? 'disabled' : ''} onclick="changeVenuesPage(${venuesPage + 1})">Next</button>
          `;
        }
        document.getElementById('venuesPagination').innerHTML = paginationHtml;
      } catch (error) {
        console.error('Failed to load venues:', error);
        document.getElementById('venuesTable').innerHTML = '<div class="error-state">Failed to load venues</div>';
      }
    }

    async function loadCheckIns() {
      try {
        const res = await fetch('/api/admin/check-ins?page=' + checkinsPage + '&limit=20', { credentials: 'include' });
        const data = await res.json();
        
        checkinsTotal = data.total || 0;
        
        if (!data.checkIns || data.checkIns.length === 0) {
          document.getElementById('checkinsTable').innerHTML = `
            <div class="empty-state">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
              <p>No check-ins found</p>
            </div>
          `;
          document.getElementById('checkinsPagination').innerHTML = '';
          return;
        }
        
        let tableHtml = `<table>
          <thead>
            <tr>
              <th>User</th>
              <th>Venue</th>
              <th>Location</th>
              <th>Caption</th>
              <th>Time</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>`;
        
        for (const checkIn of data.checkIns) {
          const user = checkIn.user;
          const venue = checkIn.venue;
          const time = new Date(checkIn.createdAt).toLocaleString();
          
          tableHtml += `
            <tr>
              <td>
                <div class="user-cell">
                  <div class="avatar">
                    ${user?.avatarUrl ? '<img src="' + user.avatarUrl + '" alt="">' : (user?.displayName || user?.username || '?').charAt(0).toUpperCase()}
                  </div>
                  <div class="user-info">
                    <span class="user-name">${user?.displayName || 'Unknown'}</span>
                    <span class="user-email">@${user?.username || 'unknown'}</span>
                  </div>
                </div>
              </td>
              <td>${venue?.name || checkIn.customLocationName || 'Unknown'}</td>
              <td style="font-size: 12px; color: rgba(255,255,255,0.6);">
                ${checkIn.latitude?.toFixed(4) || '-'}, ${checkIn.longitude?.toFixed(4) || '-'}
              </td>
              <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                ${checkIn.caption || '-'}
              </td>
              <td style="font-size: 12px; color: rgba(255,255,255,0.6);">${time}</td>
              <td>
                <button class="action-btn action-btn-danger" onclick="deleteCheckIn('${checkIn.id}')">Delete</button>
              </td>
            </tr>
          `;
        }
        
        tableHtml += '</tbody></table>';
        document.getElementById('checkinsTable').innerHTML = tableHtml;
        
        const totalPages = Math.ceil(checkinsTotal / 20);
        let paginationHtml = '';
        if (totalPages > 1) {
          paginationHtml = `
            <button class="action-btn" ${checkinsPage <= 1 ? 'disabled' : ''} onclick="changeCheckinsPage(${checkinsPage - 1})">Previous</button>
            <span style="padding: 8px 16px;">Page ${checkinsPage} of ${totalPages}</span>
            <button class="action-btn" ${checkinsPage >= totalPages ? 'disabled' : ''} onclick="changeCheckinsPage(${checkinsPage + 1})">Next</button>
          `;
        }
        document.getElementById('checkinsPagination').innerHTML = paginationHtml;
      } catch (error) {
        console.error('Failed to load check-ins:', error);
        document.getElementById('checkinsTable').innerHTML = '<div class="error-state">Failed to load check-ins</div>';
      }
    }

    function changeVenuesPage(page) {
      if (page < 1) return;
      venuesPage = page;
      loadVenues();
    }

    function changeCheckinsPage(page) {
      if (page < 1) return;
      checkinsPage = page;
      loadCheckIns();
    }

    function setLocationTab(tab) {
      document.querySelectorAll('#locationTabs .filter-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector('#locationTabs .filter-btn[data-tab="' + tab + '"]').classList.add('active');
      
      document.getElementById('venuesTab').style.display = tab === 'venues' ? 'block' : 'none';
      document.getElementById('checkinsTab').style.display = tab === 'checkins' ? 'block' : 'none';
      
      if (tab === 'venues') {
        loadVenues();
      } else {
        loadCheckIns();
      }
    }

    function openAddVenueModal() {
      document.getElementById('venueNameInput').value = '';
      document.getElementById('venueAddressInput').value = '';
      document.getElementById('venueCityInput').value = '';
      document.getElementById('venueCountryInput').value = '';
      document.getElementById('venueCategoryInput').value = '';
      document.getElementById('venueLatInput').value = '';
      document.getElementById('venueLngInput').value = '';
      document.getElementById('addVenueModal').classList.add('active');
    }

    async function createVenue() {
      const name = document.getElementById('venueNameInput').value.trim();
      const address = document.getElementById('venueAddressInput').value.trim();
      const city = document.getElementById('venueCityInput').value.trim();
      const country = document.getElementById('venueCountryInput').value.trim();
      const category = document.getElementById('venueCategoryInput').value;
      const lat = parseFloat(document.getElementById('venueLatInput').value);
      const lng = parseFloat(document.getElementById('venueLngInput').value);
      
      if (!name || !address || isNaN(lat) || isNaN(lng)) {
        alert('Please fill in all required fields (Name, Address, Latitude, Longitude)');
        return;
      }
      
      try {
        const res = await fetch('/api/admin/venues', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ name, address, city, country, category, lat, lng })
        });
        
        if (!res.ok) throw new Error('Failed to create venue');
        
        document.getElementById('addVenueModal').classList.remove('active');
        loadVenues();
        loadLocationStats();
      } catch (error) {
        console.error('Failed to create venue:', error);
        alert('Failed to create venue');
      }
    }

    let currentEditVenueData = null;

    async function editVenue(venueId) {
      try {
        const res = await fetch('/api/admin/venues?page=1&limit=100', { credentials: 'include' });
        const data = await res.json();
        const venue = data.venues.find(v => v.id === venueId);
        
        if (!venue) {
          alert('Venue not found');
          return;
        }
        
        currentEditVenueData = venue;
        document.getElementById('editVenueId').value = venue.id;
        document.getElementById('editVenueNameInput').value = venue.name || '';
        document.getElementById('editVenueAddressInput').value = venue.address || '';
        document.getElementById('editVenueCityInput').value = venue.city || '';
        document.getElementById('editVenueCountryInput').value = venue.country || '';
        document.getElementById('editVenueCategoryInput').value = venue.category || '';
        document.getElementById('editVenueLatInput').value = venue.latitude || '';
        document.getElementById('editVenueLngInput').value = venue.longitude || '';
        
        document.getElementById('editVenueModal').classList.add('active');
      } catch (error) {
        console.error('Failed to load venue:', error);
        alert('Failed to load venue details');
      }
    }

    async function updateVenue() {
      const venueId = document.getElementById('editVenueId').value;
      const name = document.getElementById('editVenueNameInput').value.trim();
      const address = document.getElementById('editVenueAddressInput').value.trim();
      const city = document.getElementById('editVenueCityInput').value.trim();
      const country = document.getElementById('editVenueCountryInput').value.trim();
      const category = document.getElementById('editVenueCategoryInput').value;
      const latitude = parseFloat(document.getElementById('editVenueLatInput').value);
      const longitude = parseFloat(document.getElementById('editVenueLngInput').value);
      
      if (!name || !address || isNaN(latitude) || isNaN(longitude)) {
        alert('Please fill in all required fields');
        return;
      }
      
      try {
        const res = await fetch('/api/admin/venues/' + venueId, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ name, address, city, country, category, latitude, longitude })
        });
        
        if (!res.ok) throw new Error('Failed to update venue');
        
        document.getElementById('editVenueModal').classList.remove('active');
        loadVenues();
      } catch (error) {
        console.error('Failed to update venue:', error);
        alert('Failed to update venue');
      }
    }

    async function toggleVerifyVenue(venueId, verify) {
      if (!confirm(verify ? 'Verify this venue?' : 'Remove verification from this venue?')) return;
      
      try {
        const res = await fetch('/api/admin/venues/' + venueId + '/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ verified: verify })
        });
        
        if (!res.ok) throw new Error('Failed to update venue');
        
        loadVenues();
        loadLocationStats();
      } catch (error) {
        console.error('Failed to verify venue:', error);
        alert('Failed to update venue verification');
      }
    }

    async function deleteVenue(venueId) {
      if (!confirm('Are you sure you want to delete this venue? This action cannot be undone.')) return;
      
      try {
        const res = await fetch('/api/admin/venues/' + venueId, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (!res.ok) throw new Error('Failed to delete venue');
        
        loadVenues();
        loadLocationStats();
      } catch (error) {
        console.error('Failed to delete venue:', error);
        alert('Failed to delete venue');
      }
    }

    async function deleteCheckIn(checkInId) {
      if (!confirm('Are you sure you want to delete this check-in?')) return;
      
      try {
        const res = await fetch('/api/admin/check-ins/' + checkInId, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (!res.ok) throw new Error('Failed to delete check-in');
        
        loadCheckIns();
        loadLocationStats();
      } catch (error) {
        console.error('Failed to delete check-in:', error);
        alert('Failed to delete check-in');
      }
    }

    document.addEventListener('click', function(e) {
      if (e.target.matches('[data-action="location-tab"]')) {
        setLocationTab(e.target.dataset.tab);
      }
      if (e.target.matches('[data-action="add-venue"]')) {
        openAddVenueModal();
      }
      if (e.target.matches('[data-action="create-venue"]')) {
        createVenue();
      }
      if (e.target.matches('[data-action="update-venue"]')) {
        updateVenue();
      }
    });

    window.loadVenues = loadVenues;
    window.loadCheckIns = loadCheckIns;
    window.changeVenuesPage = changeVenuesPage;
    window.changeCheckinsPage = changeCheckinsPage;
    window.editVenue = editVenue;
    window.toggleVerifyVenue = toggleVerifyVenue;
    window.deleteVenue = deleteVenue;
    window.deleteCheckIn = deleteCheckIn;
    window.loadLocationStats = loadLocationStats;

    // ===== AR FILTERS MANAGEMENT =====
    let arfiltersCurrentPage = 1;

    async function loadARFilterStats() {
      try {
        const res = await fetch('/api/admin/ar-filters/stats', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load stats');
        const data = await res.json();
        document.getElementById('statTotalARFilters').textContent = data.totalFilters.toLocaleString();
        document.getElementById('statActiveARFilters').textContent = data.activeFilters.toLocaleString();
        document.getElementById('statFeaturedARFilters').textContent = data.featuredFilters.toLocaleString();
        document.getElementById('statTotalARUsage').textContent = data.totalUsage.toLocaleString();
      } catch (error) {
        console.error('Failed to load AR filter stats:', error);
      }
    }

    async function loadARFilters(page = 1) {
      arfiltersCurrentPage = page;
      const search = document.getElementById('arfilterSearch')?.value || '';
      const featuredOnly = document.getElementById('featuredOnlyARFilter')?.checked || false;
      
      try {
        let url = '/api/admin/ar-filters?page=' + page + '&limit=20';
        if (search) url += '&search=' + encodeURIComponent(search);
        if (featuredOnly) url += '&featured=true';
        
        const res = await fetch(url, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load filters');
        const data = await res.json();
        
        renderARFiltersTable(data.filters, data.total);
      } catch (error) {
        console.error('Failed to load AR filters:', error);
        document.getElementById('arfiltersTable').innerHTML = '<div class="error">Failed to load AR filters</div>';
      }
    }

    function renderARFiltersTable(filters, total) {
      const container = document.getElementById('arfiltersTable');
      
      if (!filters || filters.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">No AR filters found</div>';
        document.getElementById('arfiltersPagination').innerHTML = '';
        return;
      }
      
      let html = '<table><thead><tr><th>Preview</th><th>Name</th><th>Category</th><th>Status</th><th>Usage</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
      
      filters.forEach(filter => {
        const isActive = filter.isActive;
        const isFeatured = filter.isFeatured;
        const createdDate = filter.createdAt ? new Date(filter.createdAt).toLocaleDateString() : 'N/A';
        
        html += '<tr>';
        html += '<td><div style="width: 50px; height: 50px; border-radius: 8px; overflow: hidden; background: rgba(139,92,246,0.2);"><img src="' + (filter.thumbnailUrl || '') + '" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display=\'none\'"></div></td>';
        html += '<td><div style="font-weight: 500;">' + escapeHtml(filter.name) + '</div>';
        if (filter.description) {
          html += '<div style="font-size: 12px; color: rgba(255,255,255,0.5);">' + escapeHtml(filter.description.substring(0, 50)) + (filter.description.length > 50 ? '...' : '') + '</div>';
        }
        html += '</td>';
        html += '<td>' + (filter.category ? '<span class="badge badge-active">' + escapeHtml(filter.category) + '</span>' : '<span style="color: rgba(255,255,255,0.4);">-</span>') + '</td>';
        html += '<td>';
        if (isActive) html += '<span class="badge badge-active">Active</span> ';
        else html += '<span class="badge badge-suspended">Disabled</span> ';
        if (isFeatured) html += '<span class="badge badge-gold">Featured</span>';
        html += '</td>';
        html += '<td>' + (filter.usageCount || 0).toLocaleString() + '</td>';
        html += '<td>' + createdDate + '</td>';
        html += '<td><div style="display: flex; gap: 8px; flex-wrap: wrap;">';
        html += '<button class="action-btn action-btn-primary" onclick="editARFilter(\'' + filter.id + '\')" style="padding: 6px 12px; font-size: 12px;">Edit</button>';
        html += '<button class="action-btn ' + (isFeatured ? 'action-btn-secondary' : 'action-btn-primary') + '" onclick="toggleFeatureARFilter(\'' + filter.id + '\', ' + !isFeatured + ')" style="padding: 6px 12px; font-size: 12px;">' + (isFeatured ? 'Unfeature' : 'Feature') + '</button>';
        html += '<button class="action-btn ' + (isActive ? 'action-btn-secondary' : 'action-btn-primary') + '" onclick="toggleActiveARFilter(\'' + filter.id + '\', ' + !isActive + ')" style="padding: 6px 12px; font-size: 12px;">' + (isActive ? 'Disable' : 'Enable') + '</button>';
        html += '<button class="action-btn action-btn-danger" onclick="deleteARFilter(\'' + filter.id + '\')" style="padding: 6px 12px; font-size: 12px;">Delete</button>';
        html += '</div></td>';
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
      
      const totalPages = Math.ceil(total / 20);
      let paginationHtml = '';
      if (totalPages > 1) {
        if (arfiltersCurrentPage > 1) {
          paginationHtml += '<button class="action-btn action-btn-secondary" onclick="changeARFiltersPage(' + (arfiltersCurrentPage - 1) + ')">Previous</button>';
        }
        paginationHtml += '<span style="color: rgba(255,255,255,0.6);">Page ' + arfiltersCurrentPage + ' of ' + totalPages + '</span>';
        if (arfiltersCurrentPage < totalPages) {
          paginationHtml += '<button class="action-btn action-btn-secondary" onclick="changeARFiltersPage(' + (arfiltersCurrentPage + 1) + ')">Next</button>';
        }
      }
      document.getElementById('arfiltersPagination').innerHTML = paginationHtml;
    }

    function changeARFiltersPage(page) {
      loadARFilters(page);
    }

    function openAddARFilterModal() {
      document.getElementById('arfilterModalTitle').textContent = 'Add AR Filter';
      document.getElementById('arfilterEditId').value = '';
      document.getElementById('arfilterNameInput').value = '';
      document.getElementById('arfilterDescInput').value = '';
      document.getElementById('arfilterPreviewInput').value = '';
      document.getElementById('arfilterUrlInput').value = '';
      document.getElementById('arfilterCategoryInput').value = '';
      document.getElementById('arfilterModal').classList.add('active');
    }

    async function editARFilter(filterId) {
      try {
        const res = await fetch('/api/admin/ar-filters?page=1&limit=100', { credentials: 'include' });
        const data = await res.json();
        const filter = data.filters.find(f => f.id === filterId);
        
        if (!filter) {
          alert('Filter not found');
          return;
        }
        
        document.getElementById('arfilterModalTitle').textContent = 'Edit AR Filter';
        document.getElementById('arfilterEditId').value = filterId;
        document.getElementById('arfilterNameInput').value = filter.name || '';
        document.getElementById('arfilterDescInput').value = filter.description || '';
        document.getElementById('arfilterPreviewInput').value = filter.thumbnailUrl || '';
        document.getElementById('arfilterUrlInput').value = filter.filterUrl || '';
        document.getElementById('arfilterCategoryInput').value = filter.category || '';
        document.getElementById('arfilterModal').classList.add('active');
      } catch (error) {
        console.error('Failed to load filter:', error);
        alert('Failed to load filter details');
      }
    }

    async function saveARFilter() {
      const editId = document.getElementById('arfilterEditId').value;
      const name = document.getElementById('arfilterNameInput').value.trim();
      const description = document.getElementById('arfilterDescInput').value.trim();
      const previewUrl = document.getElementById('arfilterPreviewInput').value.trim();
      const filterUrl = document.getElementById('arfilterUrlInput').value.trim();
      const category = document.getElementById('arfilterCategoryInput').value.trim();
      
      if (!name || !previewUrl || !filterUrl) {
        alert('Name, Preview URL, and Filter URL are required');
        return;
      }
      
      try {
        const url = editId ? '/api/admin/ar-filters/' + editId : '/api/admin/ar-filters';
        const method = editId ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ name, description, previewUrl, filterUrl, category })
        });
        
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.message || 'Failed to save filter');
        }
        
        document.getElementById('arfilterModal').classList.remove('active');
        loadARFilters();
        loadARFilterStats();
      } catch (error) {
        console.error('Failed to save AR filter:', error);
        alert('Failed to save AR filter: ' + error.message);
      }
    }

    async function toggleFeatureARFilter(filterId, featured) {
      try {
        const res = await fetch('/api/admin/ar-filters/' + filterId + '/feature', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ featured })
        });
        
        if (!res.ok) throw new Error('Failed to update filter');
        
        loadARFilters(arfiltersCurrentPage);
        loadARFilterStats();
      } catch (error) {
        console.error('Failed to toggle feature:', error);
        alert('Failed to update filter');
      }
    }

    async function toggleActiveARFilter(filterId, active) {
      try {
        const res = await fetch('/api/admin/ar-filters/' + filterId + '/toggle', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ active })
        });
        
        if (!res.ok) throw new Error('Failed to update filter');
        
        loadARFilters(arfiltersCurrentPage);
        loadARFilterStats();
      } catch (error) {
        console.error('Failed to toggle active:', error);
        alert('Failed to update filter');
      }
    }

    async function deleteARFilter(filterId) {
      if (!confirm('Are you sure you want to delete this AR filter? This action cannot be undone.')) return;
      
      try {
        const res = await fetch('/api/admin/ar-filters/' + filterId, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (!res.ok) throw new Error('Failed to delete filter');
        
        loadARFilters(arfiltersCurrentPage);
        loadARFilterStats();
      } catch (error) {
        console.error('Failed to delete AR filter:', error);
        alert('Failed to delete AR filter');
      }
    }

    document.addEventListener('click', function(e) {
      if (e.target.matches('[data-action="add-arfilter"]')) {
        openAddARFilterModal();
      }
      if (e.target.matches('[data-action="save-arfilter"]')) {
        saveARFilter();
      }
    });

    window.loadARFilters = loadARFilters;
    window.loadARFilterStats = loadARFilterStats;
    window.changeARFiltersPage = changeARFiltersPage;
    window.editARFilter = editARFilter;
    window.toggleFeatureARFilter = toggleFeatureARFilter;
    window.toggleActiveARFilter = toggleActiveARFilter;
    window.deleteARFilter = deleteARFilter;

    // ===== AI CONTENT MANAGEMENT =====
    let aiAvatarsCurrentPage = 1;
    let aiTranslationsCurrentPage = 1;
    let aiAvatarsCurrentFilter = 'all';
    let currentAIContentTab = 'avatars';

    async function loadAIContentStats() {
      try {
        const res = await fetch('/api/admin/ai/stats', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load stats');
        const data = await res.json();
        document.getElementById('statTotalAIAvatars').textContent = data.totalAvatars.toLocaleString();
        document.getElementById('statTotalAITranslations').textContent = data.totalTranslations.toLocaleString();
        document.getElementById('statAIPendingReview').textContent = data.pendingReview.toLocaleString();
        document.getElementById('statAIFlagged').textContent = data.flaggedContent.toLocaleString();
      } catch (error) {
        console.error('Failed to load AI content stats:', error);
      }
    }

    async function loadAIAvatars(page = 1) {
      aiAvatarsCurrentPage = page;
      
      try {
        let url = '/api/admin/ai/avatars?page=' + page + '&limit=20';
        if (aiAvatarsCurrentFilter && aiAvatarsCurrentFilter !== 'all') {
          url += '&status=' + encodeURIComponent(aiAvatarsCurrentFilter);
        }
        
        const res = await fetch(url, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load avatars');
        const data = await res.json();
        
        renderAIAvatarsTable(data.avatars, data.total);
      } catch (error) {
        console.error('Failed to load AI avatars:', error);
        document.getElementById('aiAvatarsTable').innerHTML = '<div class="error">Failed to load AI avatars</div>';
      }
    }

    function renderAIAvatarsTable(avatars, total) {
      const container = document.getElementById('aiAvatarsTable');
      
      if (!avatars || avatars.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">No AI avatars found</div>';
        document.getElementById('aiAvatarsPagination').innerHTML = '';
        return;
      }
      
      let html = '<table><thead><tr><th>User</th><th>Preview</th><th>Name</th><th>Style</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
      
      avatars.forEach(avatar => {
        const user = avatar.user;
        const isActive = avatar.isActive;
        const createdDate = avatar.createdAt ? new Date(avatar.createdAt).toLocaleDateString() : 'N/A';
        
        html += '<tr>';
        html += '<td><div style="display: flex; align-items: center; gap: 10px;">';
        if (user) {
          html += '<div class="avatar">' + (user.avatarUrl ? '<img src="' + user.avatarUrl + '" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">' : (user.displayName || user.username || '?').charAt(0).toUpperCase()) + '</div>';
          html += '<div><div style="font-weight: 500;">' + escapeHtml(user.displayName || user.username || 'Unknown') + '</div>';
          html += '<div style="font-size: 12px; color: rgba(255,255,255,0.5);">@' + escapeHtml(user.username || 'unknown') + '</div></div>';
        } else {
          html += '<div class="avatar">?</div><div style="color: rgba(255,255,255,0.5);">Unknown User</div>';
        }
        html += '</div></td>';
        html += '<td><div style="width: 50px; height: 50px; border-radius: 8px; overflow: hidden; background: rgba(139,92,246,0.2);"><img src="' + (avatar.avatarUrl || avatar.sourceImageUrl || '') + '" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display=\'none\'"></div></td>';
        html += '<td>' + escapeHtml(avatar.name || 'Unnamed') + '</td>';
        html += '<td>' + (avatar.style ? '<span class="badge badge-active">' + escapeHtml(avatar.style) + '</span>' : '<span style="color: rgba(255,255,255,0.4);">-</span>') + '</td>';
        html += '<td>';
        if (isActive) {
          html += '<span class="badge badge-active">Active</span>';
        } else {
          html += '<span class="badge badge-suspended">Inactive</span>';
        }
        html += '</td>';
        html += '<td>' + createdDate + '</td>';
        html += '<td><div style="display: flex; gap: 8px; flex-wrap: wrap;">';
        html += '<button class="action-btn action-btn-primary" onclick="openAIAvatarReviewModal(\'' + avatar.id + '\')" style="padding: 6px 12px; font-size: 12px;">Review</button>';
        html += '<button class="action-btn action-btn-danger" onclick="deleteAIAvatar(\'' + avatar.id + '\')" style="padding: 6px 12px; font-size: 12px;">Delete</button>';
        html += '</div></td>';
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
      
      const totalPages = Math.ceil(total / 20);
      let paginationHtml = '';
      if (totalPages > 1) {
        if (aiAvatarsCurrentPage > 1) {
          paginationHtml += '<button class="action-btn action-btn-secondary" onclick="changeAIAvatarsPage(' + (aiAvatarsCurrentPage - 1) + ')">Previous</button>';
        }
        paginationHtml += '<span style="color: rgba(255,255,255,0.6);">Page ' + aiAvatarsCurrentPage + ' of ' + totalPages + '</span>';
        if (aiAvatarsCurrentPage < totalPages) {
          paginationHtml += '<button class="action-btn action-btn-secondary" onclick="changeAIAvatarsPage(' + (aiAvatarsCurrentPage + 1) + ')">Next</button>';
        }
      }
      document.getElementById('aiAvatarsPagination').innerHTML = paginationHtml;
    }

    function changeAIAvatarsPage(page) {
      loadAIAvatars(page);
    }

    async function loadAITranslations(page = 1) {
      aiTranslationsCurrentPage = page;
      
      try {
        const res = await fetch('/api/admin/ai/translations?page=' + page + '&limit=20', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load translations');
        const data = await res.json();
        
        renderAITranslationsTable(data.translations, data.total);
      } catch (error) {
        console.error('Failed to load AI translations:', error);
        document.getElementById('aiTranslationsTable').innerHTML = '<div class="error">Failed to load translations</div>';
      }
    }

    function renderAITranslationsTable(translations, total) {
      const container = document.getElementById('aiTranslationsTable');
      
      if (!translations || translations.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">No translations found</div>';
        document.getElementById('aiTranslationsPagination').innerHTML = '';
        return;
      }
      
      let html = '<table><thead><tr><th>Original Text</th><th>Translated Text</th><th>Language Pair</th><th>Content Type</th><th>Created</th></tr></thead><tbody>';
      
      translations.forEach(t => {
        const createdDate = t.createdAt ? new Date(t.createdAt).toLocaleDateString() : 'N/A';
        const sourceText = (t.sourceText || '').substring(0, 100);
        const translatedText = (t.translatedText || '').substring(0, 100);
        
        html += '<tr>';
        html += '<td><div style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="' + escapeHtml(t.sourceText || '') + '">' + escapeHtml(sourceText) + (t.sourceText && t.sourceText.length > 100 ? '...' : '') + '</div></td>';
        html += '<td><div style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="' + escapeHtml(t.translatedText || '') + '">' + escapeHtml(translatedText) + (t.translatedText && t.translatedText.length > 100 ? '...' : '') + '</div></td>';
        html += '<td><span class="badge badge-active">' + escapeHtml((t.sourceLanguage || 'unknown').toUpperCase()) + ' ‚Üí ' + escapeHtml((t.targetLanguage || 'unknown').toUpperCase()) + '</span></td>';
        html += '<td>' + (t.contentType ? escapeHtml(t.contentType) : '<span style="color: rgba(255,255,255,0.4);">-</span>') + '</td>';
        html += '<td>' + createdDate + '</td>';
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
      
      const totalPages = Math.ceil(total / 20);
      let paginationHtml = '';
      if (totalPages > 1) {
        if (aiTranslationsCurrentPage > 1) {
          paginationHtml += '<button class="action-btn action-btn-secondary" onclick="changeAITranslationsPage(' + (aiTranslationsCurrentPage - 1) + ')">Previous</button>';
        }
        paginationHtml += '<span style="color: rgba(255,255,255,0.6);">Page ' + aiTranslationsCurrentPage + ' of ' + totalPages + '</span>';
        if (aiTranslationsCurrentPage < totalPages) {
          paginationHtml += '<button class="action-btn action-btn-secondary" onclick="changeAITranslationsPage(' + (aiTranslationsCurrentPage + 1) + ')">Next</button>';
        }
      }
      document.getElementById('aiTranslationsPagination').innerHTML = paginationHtml;
    }

    function changeAITranslationsPage(page) {
      loadAITranslations(page);
    }

    function setAIContentTab(tab) {
      currentAIContentTab = tab;
      
      document.querySelectorAll('#aiContentTabs .tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector('#aiContentTabs .tab-btn[data-tab="' + tab + '"]')?.classList.add('active');
      
      if (tab === 'avatars') {
        document.getElementById('aiAvatarsContent').style.display = 'block';
        document.getElementById('aiTranslationsContent').style.display = 'none';
        loadAIAvatars();
      } else {
        document.getElementById('aiAvatarsContent').style.display = 'none';
        document.getElementById('aiTranslationsContent').style.display = 'block';
        loadAITranslations();
      }
    }

    function setAIAvatarFilter(filter) {
      aiAvatarsCurrentFilter = filter;
      
      document.querySelectorAll('[data-action="ai-avatar-filter"]').forEach(btn => btn.classList.remove('active'));
      document.querySelector('[data-action="ai-avatar-filter"][data-filter="' + filter + '"]')?.classList.add('active');
      
      loadAIAvatars(1);
    }

    let currentReviewAvatar = null;

    async function openAIAvatarReviewModal(avatarId) {
      try {
        const res = await fetch('/api/admin/ai/avatars?page=1&limit=100', { credentials: 'include' });
        const data = await res.json();
        const avatar = data.avatars.find(a => a.id === avatarId);
        
        if (!avatar) {
          alert('Avatar not found');
          return;
        }
        
        currentReviewAvatar = avatar;
        document.getElementById('reviewAvatarId').value = avatarId;
        document.getElementById('reviewAvatarName').textContent = avatar.name || 'Unnamed';
        document.getElementById('reviewAvatarUser').textContent = avatar.user ? '@' + (avatar.user.username || 'unknown') : 'Unknown User';
        document.getElementById('reviewAvatarReason').value = '';
        
        const previewDiv = document.getElementById('reviewAvatarPreview');
        previewDiv.innerHTML = '<img src="' + (avatar.avatarUrl || avatar.sourceImageUrl || '') + '" style="max-width: 200px; max-height: 200px; border-radius: 12px; object-fit: cover;" onerror="this.style.display=\'none\'">';
        
        document.getElementById('aiAvatarReviewModal').classList.add('active');
      } catch (error) {
        console.error('Failed to load avatar:', error);
        alert('Failed to load avatar details');
      }
    }

    async function reviewAIAvatar(status) {
      const avatarId = document.getElementById('reviewAvatarId').value;
      const reason = document.getElementById('reviewAvatarReason').value.trim();
      
      if (!avatarId) return;
      
      try {
        const res = await fetch('/api/admin/ai/avatars/' + avatarId + '/review', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ status, reason })
        });
        
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.message || 'Failed to review avatar');
        }
        
        document.getElementById('aiAvatarReviewModal').classList.remove('active');
        loadAIAvatars(aiAvatarsCurrentPage);
        loadAIContentStats();
      } catch (error) {
        console.error('Failed to review avatar:', error);
        alert('Failed to review avatar: ' + error.message);
      }
    }

    async function deleteAIAvatar(avatarId) {
      if (!confirm('Are you sure you want to delete this AI avatar? This action cannot be undone.')) return;
      
      try {
        const res = await fetch('/api/admin/ai/avatars/' + avatarId, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (!res.ok) throw new Error('Failed to delete avatar');
        
        loadAIAvatars(aiAvatarsCurrentPage);
        loadAIContentStats();
      } catch (error) {
        console.error('Failed to delete AI avatar:', error);
        alert('Failed to delete AI avatar');
      }
    }

    document.addEventListener('click', function(e) {
      if (e.target.matches('[data-action="ai-content-tab"]')) {
        setAIContentTab(e.target.dataset.tab);
      }
      if (e.target.matches('[data-action="ai-avatar-filter"]')) {
        setAIAvatarFilter(e.target.dataset.filter);
      }
      if (e.target.matches('[data-action="approve-ai-avatar"]')) {
        reviewAIAvatar('approved');
      }
      if (e.target.matches('[data-action="reject-ai-avatar"]')) {
        reviewAIAvatar('rejected');
      }
    });

    window.loadAIContentStats = loadAIContentStats;
    window.loadAIAvatars = loadAIAvatars;
    window.loadAITranslations = loadAITranslations;
    window.changeAIAvatarsPage = changeAIAvatarsPage;
    window.changeAITranslationsPage = changeAITranslationsPage;
    window.openAIAvatarReviewModal = openAIAvatarReviewModal;
    window.deleteAIAvatar = deleteAIAvatar;

    // ===== EXPLORE CATEGORIES MANAGEMENT =====
    let exploreCategoriesData = [];
    let exploreDraggedItem = null;

    async function loadExploreCategoryStats() {
      try {
        const res = await fetch('/api/admin/explore/stats', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load stats');
        const data = await res.json();
        document.getElementById('statTotalExploreCategories').textContent = data.totalCategories.toLocaleString();
        document.getElementById('statActiveExploreCategories').textContent = data.activeCategories.toLocaleString();
        document.getElementById('statFeaturedExploreCategories').textContent = data.featuredCategories.toLocaleString();
      } catch (error) {
        console.error('Failed to load explore category stats:', error);
      }
    }

    async function loadExploreCategories() {
      try {
        const res = await fetch('/api/admin/explore/categories?limit=100', { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load categories');
        const data = await res.json();
        exploreCategoriesData = data.categories || [];
        renderExploreCategoriesTable();
      } catch (error) {
        console.error('Failed to load explore categories:', error);
        document.getElementById('exploreCategoriesTable').innerHTML = '<div class="error">Failed to load categories</div>';
      }
    }

    function renderExploreCategoriesTable() {
      const container = document.getElementById('exploreCategoriesTable');
      
      if (!exploreCategoriesData || exploreCategoriesData.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">No categories found. Click "Add Category" to create one.</div>';
        return;
      }
      
      let html = '<table><thead><tr><th style="width: 40px;"></th><th>Icon</th><th>Name</th><th>Slug</th><th>Description</th><th>Order</th><th>Status</th><th>Actions</th></tr></thead><tbody id="exploreCategoriesBody">';
      
      exploreCategoriesData.forEach((cat, index) => {
        const isActive = cat.isActive;
        const iconName = cat.iconName || 'grid';
        const color = cat.coverUrl || '#8B5CF6';
        
        html += '<tr draggable="true" data-id="' + cat.id + '" data-index="' + index + '" ondragstart="onExploreDragStart(event)" ondragover="onExploreDragOver(event)" ondrop="onExploreDrop(event)" ondragend="onExploreDragEnd(event)" style="cursor: grab;">';
        html += '<td style="cursor: grab;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="2"><circle cx="9" cy="5" r="1"></circle><circle cx="9" cy="12" r="1"></circle><circle cx="9" cy="19" r="1"></circle><circle cx="15" cy="5" r="1"></circle><circle cx="15" cy="12" r="1"></circle><circle cx="15" cy="19" r="1"></circle></svg></td>';
        html += '<td><div style="width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: ' + color + '22; border: 1px solid ' + color + '44;"><span style="font-size: 14px; color: ' + color + ';">' + escapeHtml(iconName.charAt(0).toUpperCase()) + '</span></div></td>';
        html += '<td style="font-weight: 500;">' + escapeHtml(cat.name) + '</td>';
        html += '<td><code style="background: rgba(139,92,246,0.1); padding: 4px 8px; border-radius: 4px; font-size: 12px;">' + escapeHtml(cat.slug) + '</code></td>';
        html += '<td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: rgba(255,255,255,0.6);">' + (cat.description ? escapeHtml(cat.description.substring(0, 50)) + (cat.description.length > 50 ? '...' : '') : '-') + '</td>';
        html += '<td>' + (cat.sortOrder || 0) + '</td>';
        html += '<td>' + (isActive ? '<span class="badge badge-active">Active</span>' : '<span class="badge badge-suspended">Inactive</span>') + '</td>';
        html += '<td><div style="display: flex; gap: 8px;">';
        html += '<button class="action-btn action-btn-primary" onclick="openEditExploreCategoryModal(\'' + cat.id + '\')" style="padding: 6px 12px; font-size: 12px;">Edit</button>';
        html += '<button class="action-btn ' + (isActive ? 'action-btn-secondary' : 'action-btn-success') + '" onclick="toggleExploreCategoryStatus(\'' + cat.id + '\', ' + !isActive + ')" style="padding: 6px 12px; font-size: 12px;">' + (isActive ? 'Deactivate' : 'Activate') + '</button>';
        html += '<button class="action-btn action-btn-danger" onclick="openDeleteExploreCategoryModal(\'' + cat.id + '\', \'' + escapeHtml(cat.name).replace(/'/g, "\\'") + '\')" style="padding: 6px 12px; font-size: 12px;">Delete</button>';
        html += '</div></td>';
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function onExploreDragStart(e) {
      exploreDraggedItem = e.target.closest('tr');
      exploreDraggedItem.style.opacity = '0.5';
      e.dataTransfer.effectAllowed = 'move';
    }

    function onExploreDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const row = e.target.closest('tr');
      if (row && row !== exploreDraggedItem) {
        const tbody = document.getElementById('exploreCategoriesBody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const draggedIndex = rows.indexOf(exploreDraggedItem);
        const targetIndex = rows.indexOf(row);
        if (draggedIndex < targetIndex) {
          row.parentNode.insertBefore(exploreDraggedItem, row.nextSibling);
        } else {
          row.parentNode.insertBefore(exploreDraggedItem, row);
        }
      }
    }

    function onExploreDrop(e) {
      e.preventDefault();
    }

    async function onExploreDragEnd(e) {
      exploreDraggedItem.style.opacity = '1';
      exploreDraggedItem = null;
      
      const tbody = document.getElementById('exploreCategoriesBody');
      const rows = Array.from(tbody.querySelectorAll('tr'));
      const newOrder = rows.map(row => row.dataset.id);
      
      try {
        const res = await fetch('/api/admin/explore/categories/reorder', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ categoryIds: newOrder })
        });
        
        if (!res.ok) throw new Error('Failed to reorder');
        loadExploreCategoryStats();
        loadExploreCategories();
      } catch (error) {
        console.error('Failed to reorder categories:', error);
        alert('Failed to reorder categories');
        loadExploreCategories();
      }
    }

    function openAddExploreCategoryModal() {
      document.getElementById('exploreCategoryModalTitle').textContent = 'Add Category';
      document.getElementById('exploreCategoryId').value = '';
      document.getElementById('exploreCategoryName').value = '';
      document.getElementById('exploreCategorySlug').value = '';
      document.getElementById('exploreCategoryDescription').value = '';
      document.getElementById('exploreCategoryIconUrl').value = '';
      document.getElementById('exploreCategoryColor').value = '';
      document.getElementById('exploreCategoryColorPicker').value = '#8B5CF6';
      document.getElementById('exploreCategoryOrder').value = '';
      document.getElementById('exploreCategoryActive').checked = true;
      document.getElementById('exploreCategoryActiveGroup').style.display = 'none';
      document.getElementById('exploreCategoryModal').classList.add('active');
    }

    function openEditExploreCategoryModal(categoryId) {
      const cat = exploreCategoriesData.find(c => c.id === categoryId);
      if (!cat) return;
      
      document.getElementById('exploreCategoryModalTitle').textContent = 'Edit Category';
      document.getElementById('exploreCategoryId').value = cat.id;
      document.getElementById('exploreCategoryName').value = cat.name || '';
      document.getElementById('exploreCategorySlug').value = cat.slug || '';
      document.getElementById('exploreCategoryDescription').value = cat.description || '';
      document.getElementById('exploreCategoryIconUrl').value = cat.iconName || '';
      document.getElementById('exploreCategoryColor').value = cat.coverUrl || '';
      document.getElementById('exploreCategoryColorPicker').value = cat.coverUrl || '#8B5CF6';
      document.getElementById('exploreCategoryOrder').value = cat.sortOrder || 0;
      document.getElementById('exploreCategoryActive').checked = cat.isActive;
      document.getElementById('exploreCategoryActiveGroup').style.display = 'block';
      document.getElementById('exploreCategoryModal').classList.add('active');
    }

    async function saveExploreCategory() {
      const categoryId = document.getElementById('exploreCategoryId').value;
      const name = document.getElementById('exploreCategoryName').value.trim();
      const slug = document.getElementById('exploreCategorySlug').value.trim();
      const description = document.getElementById('exploreCategoryDescription').value.trim();
      const iconUrl = document.getElementById('exploreCategoryIconUrl').value.trim();
      const color = document.getElementById('exploreCategoryColor').value.trim() || document.getElementById('exploreCategoryColorPicker').value;
      const order = parseInt(document.getElementById('exploreCategoryOrder').value) || 0;
      const isActive = document.getElementById('exploreCategoryActive').checked;
      
      if (!name || !slug) {
        alert('Name and slug are required');
        return;
      }
      
      try {
        const url = categoryId 
          ? '/api/admin/explore/categories/' + categoryId
          : '/api/admin/explore/categories';
        const method = categoryId ? 'PUT' : 'POST';
        
        const body = { name, slug, description, iconUrl, color, order };
        if (categoryId) body.isActive = isActive;
        
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(body)
        });
        
        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.message || 'Failed to save category');
        }
        
        closeModal('exploreCategoryModal');
        loadExploreCategoryStats();
        loadExploreCategories();
      } catch (error) {
        console.error('Failed to save category:', error);
        alert(error.message || 'Failed to save category');
      }
    }

    async function toggleExploreCategoryStatus(categoryId, isActive) {
      try {
        const res = await fetch('/api/admin/explore/categories/' + categoryId, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ isActive })
        });
        
        if (!res.ok) throw new Error('Failed to update status');
        loadExploreCategoryStats();
        loadExploreCategories();
      } catch (error) {
        console.error('Failed to toggle category status:', error);
        alert('Failed to update category status');
      }
    }

    function openDeleteExploreCategoryModal(categoryId, categoryName) {
      document.getElementById('deleteExploreCategoryId').value = categoryId;
      document.getElementById('deleteExploreCategoryName').textContent = categoryName;
      document.getElementById('deleteExploreCategoryModal').classList.add('active');
    }

    async function confirmDeleteExploreCategory() {
      const categoryId = document.getElementById('deleteExploreCategoryId').value;
      
      try {
        const res = await fetch('/api/admin/explore/categories/' + categoryId, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (!res.ok) throw new Error('Failed to delete category');
        
        closeModal('deleteExploreCategoryModal');
        loadExploreCategoryStats();
        loadExploreCategories();
      } catch (error) {
        console.error('Failed to delete category:', error);
        alert('Failed to delete category');
      }
    }

    document.getElementById('exploreCategoryColorPicker').addEventListener('change', function(e) {
      document.getElementById('exploreCategoryColor').value = e.target.value;
    });

    document.getElementById('exploreCategoryColor').addEventListener('input', function(e) {
      const val = e.target.value;
      if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
        document.getElementById('exploreCategoryColorPicker').value = val;
      }
    });

    document.getElementById('exploreCategoryName').addEventListener('input', function(e) {
      const categoryId = document.getElementById('exploreCategoryId').value;
      if (!categoryId) {
        const slug = e.target.value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
        document.getElementById('exploreCategorySlug').value = slug;
      }
    });

    document.addEventListener('click', function(e) {
      if (e.target.matches('[data-action="add-explore-category"]')) {
        openAddExploreCategoryModal();
      }
      if (e.target.matches('[data-action="save-explore-category"]')) {
        saveExploreCategory();
      }
      if (e.target.matches('[data-action="confirm-delete-explore-category"]')) {
        confirmDeleteExploreCategory();
      }
    });

    window.loadExploreCategoryStats = loadExploreCategoryStats;
    window.loadExploreCategories = loadExploreCategories;
    window.openAddExploreCategoryModal = openAddExploreCategoryModal;
    window.openEditExploreCategoryModal = openEditExploreCategoryModal;
    window.toggleExploreCategoryStatus = toggleExploreCategoryStatus;
    window.openDeleteExploreCategoryModal = openDeleteExploreCategoryModal;
    window.onExploreDragStart = onExploreDragStart;
    window.onExploreDragOver = onExploreDragOver;
    window.onExploreDrop = onExploreDrop;
    window.onExploreDragEnd = onExploreDragEnd;

    // ===== DEVELOPER API MANAGEMENT =====
    let developerWebhooksPage = 1;
    let developerDeliveriesPage = 1;
    let developerTokensPage = 1;
    let developerDeliveryFilter = 'all';

    async function loadDeveloperAPIStats() {
      try {
        const res = await fetch('/api/admin/developer/stats', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          document.getElementById('statTotalWebhooks').textContent = formatNumber(data.totalWebhooks || 0);
          document.getElementById('statActiveWebhooks').textContent = formatNumber(data.activeWebhooks || 0);
          document.getElementById('statTotalAPITokens').textContent = formatNumber(data.totalApiTokens || 0);
          document.getElementById('statTotalDeliveries').textContent = formatNumber(data.totalDeliveries || 0);
          document.getElementById('statFailedDeliveries').textContent = formatNumber(data.failedDeliveries || 0);
        }
      } catch (error) {
        console.error('Failed to load developer API stats:', error);
      }
    }

    async function loadDeveloperWebhooks(page = 1) {
      developerWebhooksPage = page;
      const search = document.getElementById('webhookSearch')?.value || '';
      
      try {
        const res = await fetch(`/api/admin/developer/webhooks?page=${page}&limit=20&search=${encodeURIComponent(search)}`, { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          renderDeveloperWebhooksTable(data.webhooks, data.total);
          renderDeveloperWebhooksPagination(data.total, page);
        }
      } catch (error) {
        console.error('Failed to load webhooks:', error);
        document.getElementById('developerWebhooksTable').innerHTML = '<div class="error">Failed to load webhooks</div>';
      }
    }

    function renderDeveloperWebhooksTable(webhooks, total) {
      if (!webhooks || webhooks.length === 0) {
        document.getElementById('developerWebhooksTable').innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 40px;">No webhooks found</div>';
        return;
      }
      
      const html = `
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>URL</th>
              <th>Events</th>
              <th>Status</th>
              <th>Last Delivery</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${webhooks.map(w => `
              <tr>
                <td>
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <img src="${w.user?.avatarUrl || '/default-avatar.png'}" alt="" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                    <div>
                      <div style="font-weight: 500;">${escapeHtml(w.user?.displayName || 'Unknown')}</div>
                      <div style="font-size: 12px; color: rgba(255,255,255,0.5);">@${escapeHtml(w.user?.username || 'unknown')}</div>
                    </div>
                  </div>
                </td>
                <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(w.url)}">${escapeHtml(w.url)}</td>
                <td>
                  <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                    ${(Array.isArray(w.events) ? w.events.slice(0, 3) : []).map(e => `<span class="badge">${escapeHtml(e)}</span>`).join('')}
                    ${(Array.isArray(w.events) && w.events.length > 3) ? `<span class="badge">+${w.events.length - 3}</span>` : ''}
                  </div>
                </td>
                <td>
                  <span class="status-badge ${w.isActive ? 'status-active' : 'status-inactive'}">${w.isActive ? 'Active' : 'Disabled'}</span>
                </td>
                <td style="font-size: 12px; color: rgba(255,255,255,0.6);">${w.lastDeliveredAt ? formatDate(w.lastDeliveredAt) : 'Never'}</td>
                <td>
                  <div style="display: flex; gap: 8px;">
                    <button class="action-btn ${w.isActive ? 'action-btn-warning' : 'action-btn-primary'}" onclick="toggleDeveloperWebhook('${w.id}', ${!w.isActive})" style="padding: 6px 12px; font-size: 12px;">
                      ${w.isActive ? 'Disable' : 'Enable'}
                    </button>
                    <button class="action-btn action-btn-danger" onclick="deleteDeveloperWebhook('${w.id}')" style="padding: 6px 12px; font-size: 12px;">Delete</button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      document.getElementById('developerWebhooksTable').innerHTML = html;
    }

    function renderDeveloperWebhooksPagination(total, currentPage) {
      const totalPages = Math.ceil(total / 20);
      if (totalPages <= 1) {
        document.getElementById('developerWebhooksPagination').innerHTML = '';
        return;
      }
      
      let html = '';
      for (let i = 1; i <= totalPages && i <= 10; i++) {
        html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="loadDeveloperWebhooks(${i})">${i}</button>`;
      }
      document.getElementById('developerWebhooksPagination').innerHTML = html;
    }

    async function toggleDeveloperWebhook(webhookId, enabled) {
      try {
        const res = await fetch(`/api/admin/developer/webhooks/${webhookId}/toggle`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ enabled })
        });
        
        if (res.ok) {
          loadDeveloperAPIStats();
          loadDeveloperWebhooks(developerWebhooksPage);
        } else {
          const error = await res.json();
          alert(error.message || 'Failed to update webhook');
        }
      } catch (error) {
        console.error('Failed to toggle webhook:', error);
        alert('Failed to update webhook');
      }
    }

    async function deleteDeveloperWebhook(webhookId) {
      if (!confirm('Are you sure you want to delete this webhook? This action cannot be undone.')) return;
      
      try {
        const res = await fetch(`/api/admin/developer/webhooks/${webhookId}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (res.ok) {
          loadDeveloperAPIStats();
          loadDeveloperWebhooks(developerWebhooksPage);
        } else {
          const error = await res.json();
          alert(error.message || 'Failed to delete webhook');
        }
      } catch (error) {
        console.error('Failed to delete webhook:', error);
        alert('Failed to delete webhook');
      }
    }

    async function loadDeveloperDeliveries(page = 1) {
      developerDeliveriesPage = page;
      
      try {
        const res = await fetch(`/api/admin/developer/webhook-logs?page=${page}&limit=20&status=${developerDeliveryFilter}`, { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          renderDeveloperDeliveriesTable(data.logs, data.total);
          renderDeveloperDeliveriesPagination(data.total, page);
        }
      } catch (error) {
        console.error('Failed to load deliveries:', error);
        document.getElementById('developerDeliveriesTable').innerHTML = '<div class="error">Failed to load deliveries</div>';
      }
    }

    function renderDeveloperDeliveriesTable(deliveries, total) {
      if (!deliveries || deliveries.length === 0) {
        document.getElementById('developerDeliveriesTable').innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 40px;">No deliveries found</div>';
        return;
      }
      
      const html = `
        <table>
          <thead>
            <tr>
              <th>Webhook</th>
              <th>Event</th>
              <th>Status</th>
              <th>Response Code</th>
              <th>Retries</th>
              <th>Timestamp</th>
            </tr>
          </thead>
          <tbody>
            ${deliveries.map(d => `
              <tr>
                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(d.webhook?.url || d.webhookId)}">${escapeHtml(d.webhook?.url || d.webhookId)}</td>
                <td><span class="badge">${escapeHtml(d.event)}</span></td>
                <td>
                  <span class="status-badge ${d.success ? 'status-active' : 'status-error'}">${d.success ? 'Success' : 'Failed'}</span>
                </td>
                <td>${d.responseStatus || '-'}</td>
                <td>${d.retryCount || 0}</td>
                <td style="font-size: 12px; color: rgba(255,255,255,0.6);">${formatDate(d.createdAt)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      document.getElementById('developerDeliveriesTable').innerHTML = html;
    }

    function renderDeveloperDeliveriesPagination(total, currentPage) {
      const totalPages = Math.ceil(total / 20);
      if (totalPages <= 1) {
        document.getElementById('developerDeliveriesPagination').innerHTML = '';
        return;
      }
      
      let html = '';
      for (let i = 1; i <= totalPages && i <= 10; i++) {
        html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="loadDeveloperDeliveries(${i})">${i}</button>`;
      }
      document.getElementById('developerDeliveriesPagination').innerHTML = html;
    }

    async function loadDeveloperTokens(page = 1) {
      developerTokensPage = page;
      const search = document.getElementById('tokenSearch')?.value || '';
      
      try {
        const res = await fetch(`/api/admin/developer/api-tokens?page=${page}&limit=20&search=${encodeURIComponent(search)}`, { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          renderDeveloperTokensTable(data.tokens, data.total);
          renderDeveloperTokensPagination(data.total, page);
        }
      } catch (error) {
        console.error('Failed to load tokens:', error);
        document.getElementById('developerTokensTable').innerHTML = '<div class="error">Failed to load access tokens</div>';
      }
    }

    function renderDeveloperTokensTable(tokens, total) {
      if (!tokens || tokens.length === 0) {
        document.getElementById('developerTokensTable').innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 40px;">No access tokens found</div>';
        return;
      }
      
      const html = `
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Name</th>
              <th>Token</th>
              <th>Scopes</th>
              <th>Created</th>
              <th>Last Used</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${tokens.map(t => `
              <tr>
                <td>
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <img src="${t.user?.avatarUrl || '/default-avatar.png'}" alt="" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                    <div>
                      <div style="font-weight: 500;">${escapeHtml(t.user?.displayName || 'Unknown')}</div>
                      <div style="font-size: 12px; color: rgba(255,255,255,0.5);">@${escapeHtml(t.user?.username || 'unknown')}</div>
                    </div>
                  </div>
                </td>
                <td>${escapeHtml(t.name)}</td>
                <td style="font-family: monospace; font-size: 12px; color: rgba(255,255,255,0.6);">${maskToken(t.token)}</td>
                <td>
                  <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                    ${(Array.isArray(t.scopes) ? t.scopes.slice(0, 3) : []).map(s => `<span class="badge">${escapeHtml(s)}</span>`).join('')}
                    ${(Array.isArray(t.scopes) && t.scopes.length > 3) ? `<span class="badge">+${t.scopes.length - 3}</span>` : ''}
                  </div>
                </td>
                <td style="font-size: 12px; color: rgba(255,255,255,0.6);">${formatDate(t.createdAt)}</td>
                <td style="font-size: 12px; color: rgba(255,255,255,0.6);">${t.lastUsedAt ? formatDate(t.lastUsedAt) : 'Never'}</td>
                <td>
                  <span class="status-badge ${t.isRevoked ? 'status-error' : 'status-active'}">${t.isRevoked ? 'Revoked' : 'Active'}</span>
                </td>
                <td>
                  ${!t.isRevoked ? `<button class="action-btn action-btn-danger" onclick="revokeDeveloperToken('${t.id}')" style="padding: 6px 12px; font-size: 12px;">Revoke</button>` : '<span style="color: rgba(255,255,255,0.4); font-size: 12px;">Revoked</span>'}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      document.getElementById('developerTokensTable').innerHTML = html;
    }

    function renderDeveloperTokensPagination(total, currentPage) {
      const totalPages = Math.ceil(total / 20);
      if (totalPages <= 1) {
        document.getElementById('developerTokensPagination').innerHTML = '';
        return;
      }
      
      let html = '';
      for (let i = 1; i <= totalPages && i <= 10; i++) {
        html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="loadDeveloperTokens(${i})">${i}</button>`;
      }
      document.getElementById('developerTokensPagination').innerHTML = html;
    }

    function maskToken(token) {
      if (!token || token.length < 12) return '****';
      return token.slice(0, 6) + '****' + token.slice(-4);
    }

    async function revokeDeveloperToken(tokenId) {
      if (!confirm('Are you sure you want to revoke this API token? The user will no longer be able to use it.')) return;
      
      try {
        const res = await fetch(`/api/admin/developer/api-tokens/${tokenId}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        
        if (res.ok) {
          loadDeveloperAPIStats();
          loadDeveloperTokens(developerTokensPage);
        } else {
          const error = await res.json();
          alert(error.message || 'Failed to revoke token');
        }
      } catch (error) {
        console.error('Failed to revoke token:', error);
        alert('Failed to revoke token');
      }
    }

    function switchDeveloperTab(tabId) {
      document.querySelectorAll('#section-developerapi .tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.developer-tab-content').forEach(c => c.style.display = 'none');
      
      document.querySelector(`#section-developerapi .tab-btn[data-tab="${tabId}"]`).classList.add('active');
      
      if (tabId === 'webhooks') {
        document.getElementById('developerWebhooksContent').style.display = 'block';
        loadDeveloperWebhooks();
      } else if (tabId === 'deliveries') {
        document.getElementById('developerDeliveriesContent').style.display = 'block';
        loadDeveloperDeliveries();
      } else if (tabId === 'tokens') {
        document.getElementById('developerTokensContent').style.display = 'block';
        loadDeveloperTokens();
      }
    }

    function setDeveloperDeliveryFilter(filter) {
      developerDeliveryFilter = filter;
      document.querySelectorAll('#developerDeliveriesContent .filter-btn').forEach(b => b.classList.remove('active'));
      document.querySelector(`#developerDeliveriesContent .filter-btn[data-filter="${filter}"]`).classList.add('active');
      loadDeveloperDeliveries(1);
    }

    document.addEventListener('click', function(e) {
      if (e.target.matches('[data-action="developer-tab"]')) {
        const tab = e.target.getAttribute('data-tab');
        switchDeveloperTab(tab);
      }
      if (e.target.matches('#developerDeliveriesContent [data-action="delivery-filter"]')) {
        const filter = e.target.getAttribute('data-filter');
        setDeveloperDeliveryFilter(filter);
      }
    });

    window.loadDeveloperAPIStats = loadDeveloperAPIStats;
    window.loadDeveloperWebhooks = loadDeveloperWebhooks;
    window.toggleDeveloperWebhook = toggleDeveloperWebhook;
    window.deleteDeveloperWebhook = deleteDeveloperWebhook;
    window.loadDeveloperDeliveries = loadDeveloperDeliveries;
    window.loadDeveloperTokens = loadDeveloperTokens;
    window.revokeDeveloperToken = revokeDeveloperToken;
    window.switchDeveloperTab = switchDeveloperTab;
    window.setDeveloperDeliveryFilter = setDeveloperDeliveryFilter;

    // Data Privacy Management
    let privacyExportPage = 1;
    let privacyBackupPage = 1;
    let privacyImportPage = 1;
    let privacyExportFilter = 'all';

    async function loadDataPrivacyStats() {
      try {
        const res = await fetch('/api/admin/privacy/stats', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          document.getElementById('statTotalExportRequests').textContent = formatNumber(data.totalExportRequests || 0);
          document.getElementById('statPendingExports').textContent = formatNumber(data.pendingExports || 0);
          document.getElementById('statCompletedExports').textContent = formatNumber(data.completedExports || 0);
          document.getElementById('statTotalBackups').textContent = formatNumber(data.totalBackups || 0);
          document.getElementById('statTotalImports').textContent = formatNumber(data.totalImports || 0);
        }
      } catch (error) {
        console.error('Failed to load data privacy stats:', error);
      }
    }

    async function loadExportRequests(page = 1) {
      privacyExportPage = page;
      const statusParam = privacyExportFilter !== 'all' ? `&status=${privacyExportFilter}` : '';
      
      try {
        const res = await fetch(`/api/admin/privacy/exports?page=${page}&limit=20${statusParam}`, { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          renderExportRequestsTable(data.requests, data.total);
          renderExportRequestsPagination(data.total, page);
        }
      } catch (error) {
        console.error('Failed to load export requests:', error);
        document.getElementById('exportRequestsTable').innerHTML = '<div class="error">Failed to load export requests</div>';
      }
    }

    function renderExportRequestsTable(requests, total) {
      const container = document.getElementById('exportRequestsTable');
      if (!requests || requests.length === 0) {
        container.innerHTML = '<div class="empty-state">No export requests found</div>';
        return;
      }

      const statusColors = {
        'PENDING': '#f59e0b',
        'PROCESSING': '#3b82f6',
        'COMPLETED': '#22c55e',
        'FAILED': '#ef4444'
      };

      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Request Date</th>
              <th>Format</th>
              <th>Status</th>
              <th>Completed</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${requests.map(req => `
              <tr>
                <td>
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="user-avatar-small" style="background: linear-gradient(135deg, #667eea, #764ba2); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px;">
                      ${req.user?.displayName?.charAt(0) || req.user?.username?.charAt(0) || '?'}
                    </div>
                    <div>
                      <div style="font-weight: 500;">${escapeHtml(req.user?.displayName || 'Unknown')}</div>
                      <div style="font-size: 12px; color: rgba(255,255,255,0.5);">@${escapeHtml(req.user?.username || 'unknown')}</div>
                    </div>
                  </div>
                </td>
                <td>${formatDate(req.createdAt)}</td>
                <td>${req.format || 'JSON'}</td>
                <td>
                  <span class="status-badge" style="background: ${statusColors[req.status] || '#6b7280'}20; color: ${statusColors[req.status] || '#6b7280'};">
                    ${req.status}
                  </span>
                </td>
                <td>${req.completedAt ? formatDate(req.completedAt) : '-'}</td>
                <td>
                  <div style="display: flex; gap: 8px;">
                    ${req.status === 'PENDING' ? `
                      <button class="action-btn action-btn-primary" onclick="processExportRequest('${req.id}')" style="padding: 6px 12px; font-size: 12px;">
                        Process
                      </button>
                    ` : ''}
                    <select onchange="updateExportStatus('${req.id}', this.value)" style="padding: 6px 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: #fff; font-size: 12px;">
                      <option value="" disabled selected>Change Status</option>
                      <option value="PENDING">Pending</option>
                      <option value="PROCESSING">Processing</option>
                      <option value="COMPLETED">Completed</option>
                      <option value="FAILED">Failed</option>
                    </select>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderExportRequestsPagination(total, currentPage) {
      const totalPages = Math.ceil(total / 20);
      const container = document.getElementById('exportRequestsPagination');
      
      if (totalPages <= 1) {
        container.innerHTML = '';
        return;
      }
      
      container.innerHTML = `
        <button class="action-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="loadExportRequests(${currentPage - 1})">Previous</button>
        <span style="color: rgba(255,255,255,0.7);">Page ${currentPage} of ${totalPages}</span>
        <button class="action-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="loadExportRequests(${currentPage + 1})">Next</button>
      `;
    }

    async function processExportRequest(requestId) {
      if (!confirm('Are you sure you want to process this export request?')) return;
      
      try {
        const res = await fetch(`/api/admin/privacy/exports/${requestId}/process`, {
          method: 'POST',
          credentials: 'include'
        });
        
        if (res.ok) {
          showNotification('Export request is being processed', 'success');
          loadExportRequests(privacyExportPage);
          loadDataPrivacyStats();
        } else {
          const error = await res.json();
          showNotification(error.message || 'Failed to process export', 'error');
        }
      } catch (error) {
        console.error('Failed to process export:', error);
        showNotification('Failed to process export request', 'error');
      }
    }

    async function updateExportStatus(requestId, status) {
      if (!status) return;
      
      try {
        const res = await fetch(`/api/admin/privacy/exports/${requestId}/status`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ status })
        });
        
        if (res.ok) {
          showNotification('Export status updated', 'success');
          loadExportRequests(privacyExportPage);
          loadDataPrivacyStats();
        } else {
          const error = await res.json();
          showNotification(error.message || 'Failed to update status', 'error');
        }
      } catch (error) {
        console.error('Failed to update export status:', error);
        showNotification('Failed to update export status', 'error');
      }
    }

    function setPrivacyExportFilter(filter) {
      privacyExportFilter = filter;
      document.querySelectorAll('#privacyExportsContent .filter-btn').forEach(b => b.classList.remove('active'));
      document.querySelector(`#privacyExportsContent .filter-btn[data-filter="${filter}"]`).classList.add('active');
      loadExportRequests(1);
    }

    async function loadAccountBackups(page = 1) {
      privacyBackupPage = page;
      
      try {
        const res = await fetch(`/api/admin/privacy/backups?page=${page}&limit=20`, { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          renderAccountBackupsTable(data.backups, data.total);
          renderAccountBackupsPagination(data.total, page);
        }
      } catch (error) {
        console.error('Failed to load backups:', error);
        document.getElementById('accountBackupsTable').innerHTML = '<div class="error">Failed to load backups</div>';
      }
    }

    function renderAccountBackupsTable(backups, total) {
      const container = document.getElementById('accountBackupsTable');
      if (!backups || backups.length === 0) {
        container.innerHTML = '<div class="empty-state">No backups found</div>';
        return;
      }

      const statusColors = {
        'PENDING': '#f59e0b',
        'IN_PROGRESS': '#3b82f6',
        'COMPLETED': '#22c55e',
        'FAILED': '#ef4444'
      };

      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Size</th>
              <th>Status</th>
              <th>Created</th>
              <th>Completed</th>
            </tr>
          </thead>
          <tbody>
            ${backups.map(backup => `
              <tr>
                <td>
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="user-avatar-small" style="background: linear-gradient(135deg, #667eea, #764ba2); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px;">
                      ${backup.user?.displayName?.charAt(0) || backup.user?.username?.charAt(0) || '?'}
                    </div>
                    <div>
                      <div style="font-weight: 500;">${escapeHtml(backup.user?.displayName || 'Unknown')}</div>
                      <div style="font-size: 12px; color: rgba(255,255,255,0.5);">@${escapeHtml(backup.user?.username || 'unknown')}</div>
                    </div>
                  </div>
                </td>
                <td>${backup.sizeBytes ? formatBytes(backup.sizeBytes) : '-'}</td>
                <td>
                  <span class="status-badge" style="background: ${statusColors[backup.status] || '#6b7280'}20; color: ${statusColors[backup.status] || '#6b7280'};">
                    ${backup.status}
                  </span>
                </td>
                <td>${formatDate(backup.createdAt)}</td>
                <td>${backup.completedAt ? formatDate(backup.completedAt) : '-'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderAccountBackupsPagination(total, currentPage) {
      const totalPages = Math.ceil(total / 20);
      const container = document.getElementById('accountBackupsPagination');
      
      if (totalPages <= 1) {
        container.innerHTML = '';
        return;
      }
      
      container.innerHTML = `
        <button class="action-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="loadAccountBackups(${currentPage - 1})">Previous</button>
        <span style="color: rgba(255,255,255,0.7);">Page ${currentPage} of ${totalPages}</span>
        <button class="action-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="loadAccountBackups(${currentPage + 1})">Next</button>
      `;
    }

    async function loadPlatformImports(page = 1) {
      privacyImportPage = page;
      
      try {
        const res = await fetch(`/api/admin/privacy/imports?page=${page}&limit=20`, { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          renderPlatformImportsTable(data.imports, data.total);
          renderPlatformImportsPagination(data.total, page);
        }
      } catch (error) {
        console.error('Failed to load imports:', error);
        document.getElementById('platformImportsTable').innerHTML = '<div class="error">Failed to load imports</div>';
      }
    }

    function renderPlatformImportsTable(imports, total) {
      const container = document.getElementById('platformImportsTable');
      if (!imports || imports.length === 0) {
        container.innerHTML = '<div class="empty-state">No imports found</div>';
        return;
      }

      const statusColors = {
        'PENDING': '#f59e0b',
        'IN_PROGRESS': '#3b82f6',
        'COMPLETED': '#22c55e',
        'FAILED': '#ef4444',
        'PARTIAL': '#8b5cf6'
      };

      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>User</th>
              <th>Platform</th>
              <th>Items Imported</th>
              <th>Status</th>
              <th>Created</th>
              <th>Completed</th>
            </tr>
          </thead>
          <tbody>
            ${imports.map(imp => `
              <tr>
                <td>
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="user-avatar-small" style="background: linear-gradient(135deg, #667eea, #764ba2); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px;">
                      ${imp.user?.displayName?.charAt(0) || imp.user?.username?.charAt(0) || '?'}
                    </div>
                    <div>
                      <div style="font-weight: 500;">${escapeHtml(imp.user?.displayName || 'Unknown')}</div>
                      <div style="font-size: 12px; color: rgba(255,255,255,0.5);">@${escapeHtml(imp.user?.username || 'unknown')}</div>
                    </div>
                  </div>
                </td>
                <td style="text-transform: capitalize;">${escapeHtml(imp.sourcePlatform || 'Unknown')}</td>
                <td>${imp.itemsImported || 0}</td>
                <td>
                  <span class="status-badge" style="background: ${statusColors[imp.status] || '#6b7280'}20; color: ${statusColors[imp.status] || '#6b7280'};">
                    ${imp.status}
                  </span>
                </td>
                <td>${formatDate(imp.createdAt)}</td>
                <td>${imp.completedAt ? formatDate(imp.completedAt) : '-'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderPlatformImportsPagination(total, currentPage) {
      const totalPages = Math.ceil(total / 20);
      const container = document.getElementById('platformImportsPagination');
      
      if (totalPages <= 1) {
        container.innerHTML = '';
        return;
      }
      
      container.innerHTML = `
        <button class="action-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="loadPlatformImports(${currentPage - 1})">Previous</button>
        <span style="color: rgba(255,255,255,0.7);">Page ${currentPage} of ${totalPages}</span>
        <button class="action-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="loadPlatformImports(${currentPage + 1})">Next</button>
      `;
    }

    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function switchPrivacyTab(tabId) {
      document.querySelectorAll('#section-dataprivacy .tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.privacy-tab-content').forEach(c => c.style.display = 'none');
      
      document.querySelector(`#section-dataprivacy .tab-btn[data-tab="${tabId}"]`).classList.add('active');
      
      if (tabId === 'exports') {
        document.getElementById('privacyExportsContent').style.display = 'block';
        loadExportRequests();
      } else if (tabId === 'backups') {
        document.getElementById('privacyBackupsContent').style.display = 'block';
        loadAccountBackups();
      } else if (tabId === 'imports') {
        document.getElementById('privacyImportsContent').style.display = 'block';
        loadPlatformImports();
      }
    }

    document.addEventListener('click', function(e) {
      if (e.target.matches('[data-action="privacy-tab"]')) {
        const tab = e.target.getAttribute('data-tab');
        switchPrivacyTab(tab);
      }
      if (e.target.matches('#privacyExportsContent [data-action="export-filter"]')) {
        const filter = e.target.getAttribute('data-filter');
        setPrivacyExportFilter(filter);
      }
    });

    window.loadDataPrivacyStats = loadDataPrivacyStats;
    window.loadExportRequests = loadExportRequests;
    window.processExportRequest = processExportRequest;
    window.updateExportStatus = updateExportStatus;
    window.setPrivacyExportFilter = setPrivacyExportFilter;
    window.loadAccountBackups = loadAccountBackups;
    window.loadPlatformImports = loadPlatformImports;
    window.switchPrivacyTab = switchPrivacyTab;

    // ===== PLATFORM SETTINGS MANAGEMENT =====
    let wordFiltersPage = 1;
    let keywordFiltersPage = 1;

    async function loadWordFilters(page = 1) {
      wordFiltersPage = page;
      try {
        const res = await fetch(`/api/admin/settings/word-filters?page=${page}&limit=50`, { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          renderWordFiltersTable(data.filters, data.total);
          renderWordFiltersPagination(data.total, page);
        }
      } catch (error) {
        console.error('Failed to load word filters:', error);
        document.getElementById('wordFiltersTable').innerHTML = '<div class="error">Failed to load word filters</div>';
      }
    }

    function renderWordFiltersTable(filters, total) {
      const container = document.getElementById('wordFiltersTable');
      if (!filters || filters.length === 0) {
        container.innerHTML = '<div class="empty-state">No word filters configured. Add filters to moderate content.</div>';
        return;
      }

      const actionColors = { 'BLOCK': '#ef4444', 'REPLACE': '#f59e0b', 'FLAG': '#3b82f6' };
      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Word</th>
              <th>Action</th>
              <th>Replacement</th>
              <th>Status</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${filters.map(f => `
              <tr>
                <td><code style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px;">${escapeHtml(f.word)}</code></td>
                <td><span class="status-badge" style="background: ${actionColors[f.action]}20; color: ${actionColors[f.action]};">${f.action}</span></td>
                <td>${f.replacement ? escapeHtml(f.replacement) : '-'}</td>
                <td><span class="status-badge" style="background: ${f.isActive !== false ? '#22c55e' : '#6b7280'}20; color: ${f.isActive !== false ? '#22c55e' : '#6b7280'};">${f.isActive !== false ? 'Active' : 'Inactive'}</span></td>
                <td>${formatDate(f.createdAt)}</td>
                <td>
                  <div style="display: flex; gap: 8px;">
                    <button class="action-btn action-btn-secondary" onclick="editWordFilter('${f.id}')" style="padding: 6px 12px; font-size: 12px;">Edit</button>
                    <button class="action-btn action-btn-danger" onclick="deleteWordFilter('${f.id}')" style="padding: 6px 12px; font-size: 12px;">Delete</button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderWordFiltersPagination(total, currentPage) {
      const totalPages = Math.ceil(total / 50);
      const container = document.getElementById('wordFiltersPagination');
      if (totalPages <= 1) { container.innerHTML = ''; return; }
      container.innerHTML = `
        <button class="action-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="loadWordFilters(${currentPage - 1})">Previous</button>
        <span style="color: rgba(255,255,255,0.7);">Page ${currentPage} of ${totalPages}</span>
        <button class="action-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="loadWordFilters(${currentPage + 1})">Next</button>
      `;
    }

    let wordFiltersData = [];
    async function editWordFilter(id) {
      const filter = wordFiltersData.find(f => f.id === id);
      if (!filter) {
        try {
          const res = await fetch(`/api/admin/settings/word-filters?page=1&limit=100`, { credentials: 'include' });
          if (res.ok) {
            const data = await res.json();
            wordFiltersData = data.filters;
            const found = wordFiltersData.find(f => f.id === id);
            if (found) openWordFilterModal(found);
          }
        } catch (error) { showError('Failed to load filter'); }
      } else {
        openWordFilterModal(filter);
      }
    }

    function openWordFilterModal(filter = null) {
      document.getElementById('wordFilterModalTitle').textContent = filter ? 'Edit Word Filter' : 'Add Word Filter';
      document.getElementById('wordFilterId').value = filter?.id || '';
      document.getElementById('wordFilterWord').value = filter?.word || '';
      document.getElementById('wordFilterAction').value = filter?.action || 'BLOCK';
      document.getElementById('wordFilterReplacement').value = filter?.replacement || '';
      document.getElementById('wordFilterActive').checked = filter?.isActive !== false;
      document.getElementById('wordFilterModal').classList.add('active');
    }

    async function saveWordFilter() {
      const id = document.getElementById('wordFilterId').value;
      const word = document.getElementById('wordFilterWord').value.trim();
      const action = document.getElementById('wordFilterAction').value;
      const replacement = document.getElementById('wordFilterReplacement').value.trim();
      const isActive = document.getElementById('wordFilterActive').checked;

      if (!word) { showError('Word is required'); return; }

      try {
        const url = id ? `/api/admin/settings/word-filters/${id}` : '/api/admin/settings/word-filters';
        const method = id ? 'PUT' : 'POST';
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ word, action, replacement: replacement || null, isActive })
        });
        if (res.ok) {
          closeModal('wordFilterModal');
          loadWordFilters(wordFiltersPage);
          showSuccess(id ? 'Word filter updated' : 'Word filter created');
        } else {
          const err = await res.json();
          showError(err.message || 'Failed to save filter');
        }
      } catch (error) {
        showError('Failed to save word filter');
      }
    }

    async function deleteWordFilter(id) {
      if (!confirm('Are you sure you want to delete this word filter?')) return;
      try {
        const res = await fetch(`/api/admin/settings/word-filters/${id}`, { method: 'DELETE', credentials: 'include' });
        if (res.ok) {
          loadWordFilters(wordFiltersPage);
          showSuccess('Word filter deleted');
        } else {
          showError('Failed to delete filter');
        }
      } catch (error) { showError('Failed to delete word filter'); }
    }

    async function loadKeywordFilters(page = 1) {
      keywordFiltersPage = page;
      try {
        const res = await fetch(`/api/admin/settings/keyword-filters?page=${page}&limit=50`, { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          renderKeywordFiltersTable(data.filters, data.total);
          renderKeywordFiltersPagination(data.total, page);
        }
      } catch (error) {
        console.error('Failed to load keyword filters:', error);
        document.getElementById('keywordFiltersTable').innerHTML = '<div class="error">Failed to load keyword filters</div>';
      }
    }

    function renderKeywordFiltersTable(filters, total) {
      const container = document.getElementById('keywordFiltersTable');
      if (!filters || filters.length === 0) {
        container.innerHTML = '<div class="empty-state">No keyword filters configured.</div>';
        return;
      }

      const actionColors = { 'BLOCK': '#ef4444', 'FLAG': '#3b82f6', 'HIDE': '#f59e0b', 'WARN': '#eab308' };
      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Keyword</th>
              <th>Action</th>
              <th>Applies To</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${filters.map(f => {
              const appliesTo = [];
              if (f.filterPosts) appliesTo.push('Posts');
              if (f.filterComments) appliesTo.push('Comments');
              if (f.filterMessages) appliesTo.push('Messages');
              if (f.filterUsernames) appliesTo.push('Usernames');
              if (f.filterBios) appliesTo.push('Bios');
              return `
              <tr>
                <td><code style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px;">${escapeHtml(f.keyword)}</code></td>
                <td><span class="status-badge" style="background: ${actionColors[f.action]}20; color: ${actionColors[f.action]};">${f.action}</span></td>
                <td style="font-size: 12px;">${appliesTo.join(', ') || 'None'}</td>
                <td><span class="status-badge" style="background: ${f.isActive !== false ? '#22c55e' : '#6b7280'}20; color: ${f.isActive !== false ? '#22c55e' : '#6b7280'};">${f.isActive !== false ? 'Active' : 'Inactive'}</span></td>
                <td>
                  <div style="display: flex; gap: 8px;">
                    <button class="action-btn action-btn-secondary" onclick="editKeywordFilter('${f.id}')" style="padding: 6px 12px; font-size: 12px;">Edit</button>
                    <button class="action-btn action-btn-danger" onclick="deleteKeywordFilter('${f.id}')" style="padding: 6px 12px; font-size: 12px;">Delete</button>
                  </div>
                </td>
              </tr>
            `}).join('')}
          </tbody>
        </table>
      `;
    }

    function renderKeywordFiltersPagination(total, currentPage) {
      const totalPages = Math.ceil(total / 50);
      const container = document.getElementById('keywordFiltersPagination');
      if (totalPages <= 1) { container.innerHTML = ''; return; }
      container.innerHTML = `
        <button class="action-btn" ${currentPage === 1 ? 'disabled' : ''} onclick="loadKeywordFilters(${currentPage - 1})">Previous</button>
        <span style="color: rgba(255,255,255,0.7);">Page ${currentPage} of ${totalPages}</span>
        <button class="action-btn" ${currentPage === totalPages ? 'disabled' : ''} onclick="loadKeywordFilters(${currentPage + 1})">Next</button>
      `;
    }

    let keywordFiltersData = [];
    async function editKeywordFilter(id) {
      const filter = keywordFiltersData.find(f => f.id === id);
      if (!filter) {
        try {
          const res = await fetch(`/api/admin/settings/keyword-filters?page=1&limit=100`, { credentials: 'include' });
          if (res.ok) {
            const data = await res.json();
            keywordFiltersData = data.filters;
            const found = keywordFiltersData.find(f => f.id === id);
            if (found) openKeywordFilterModal(found);
          }
        } catch (error) { showError('Failed to load filter'); }
      } else {
        openKeywordFilterModal(filter);
      }
    }

    function openKeywordFilterModal(filter = null) {
      document.getElementById('keywordFilterModalTitle').textContent = filter ? 'Edit Keyword Filter' : 'Add Keyword Filter';
      document.getElementById('keywordFilterId').value = filter?.id || '';
      document.getElementById('keywordFilterKeyword').value = filter?.keyword || '';
      document.getElementById('keywordFilterAction').value = filter?.action || 'BLOCK';
      document.getElementById('keywordFilterPosts').checked = filter?.filterPosts !== false;
      document.getElementById('keywordFilterComments').checked = filter?.filterComments !== false;
      document.getElementById('keywordFilterMessages').checked = filter?.filterMessages || false;
      document.getElementById('keywordFilterUsernames').checked = filter?.filterUsernames || false;
      document.getElementById('keywordFilterBios').checked = filter?.filterBios || false;
      document.getElementById('keywordFilterActive').checked = filter?.isActive !== false;
      document.getElementById('keywordFilterModal').classList.add('active');
    }

    async function saveKeywordFilter() {
      const id = document.getElementById('keywordFilterId').value;
      const keyword = document.getElementById('keywordFilterKeyword').value.trim();
      const action = document.getElementById('keywordFilterAction').value;
      const filterPosts = document.getElementById('keywordFilterPosts').checked;
      const filterComments = document.getElementById('keywordFilterComments').checked;
      const filterMessages = document.getElementById('keywordFilterMessages').checked;
      const filterUsernames = document.getElementById('keywordFilterUsernames').checked;
      const filterBios = document.getElementById('keywordFilterBios').checked;
      const isActive = document.getElementById('keywordFilterActive').checked;

      if (!keyword) { showError('Keyword is required'); return; }

      try {
        const url = id ? `/api/admin/settings/keyword-filters/${id}` : '/api/admin/settings/keyword-filters';
        const method = id ? 'PUT' : 'POST';
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ keyword, action, filterPosts, filterComments, filterMessages, filterUsernames, filterBios, isActive })
        });
        if (res.ok) {
          closeModal('keywordFilterModal');
          loadKeywordFilters(keywordFiltersPage);
          showSuccess(id ? 'Keyword filter updated' : 'Keyword filter created');
        } else {
          const err = await res.json();
          showError(err.message || 'Failed to save filter');
        }
      } catch (error) { showError('Failed to save keyword filter'); }
    }

    async function deleteKeywordFilter(id) {
      if (!confirm('Are you sure you want to delete this keyword filter?')) return;
      try {
        const res = await fetch(`/api/admin/settings/keyword-filters/${id}`, { method: 'DELETE', credentials: 'include' });
        if (res.ok) {
          loadKeywordFilters(keywordFiltersPage);
          showSuccess('Keyword filter deleted');
        } else { showError('Failed to delete filter'); }
      } catch (error) { showError('Failed to delete keyword filter'); }
    }

    async function loadAppSettings() {
      try {
        const res = await fetch('/api/admin/settings/app', { credentials: 'include' });
        if (res.ok) {
          const settings = await res.json();
          renderAppSettingsList(settings);
        }
      } catch (error) {
        console.error('Failed to load app settings:', error);
        document.getElementById('appSettingsList').innerHTML = '<div class="error">Failed to load app settings</div>';
      }
    }

    let appSettingsData = [];
    function renderAppSettingsList(settings) {
      appSettingsData = settings;
      const container = document.getElementById('appSettingsList');
      if (!settings || settings.length === 0) {
        container.innerHTML = '<div class="empty-state">No app settings configured.</div>';
        return;
      }

      container.innerHTML = settings.map(s => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 8px;">
          <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px;">${escapeHtml(s.key)}</div>
            <div style="font-size: 12px; color: rgba(255,255,255,0.5);">${s.description || 'No description'}</div>
            <div style="margin-top: 8px;">
              <code style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px; font-size: 12px;">${escapeHtml(s.value)}</code>
              <span style="font-size: 11px; color: rgba(255,255,255,0.4); margin-left: 8px;">(${s.type || 'string'})</span>
            </div>
          </div>
          <button class="action-btn action-btn-secondary" onclick="openAppSettingModal('${s.key}')" style="padding: 8px 16px;">Edit</button>
        </div>
      `).join('');
    }

    function openAppSettingModal(key = null) {
      const setting = key ? appSettingsData.find(s => s.key === key) : null;
      const isNew = !setting;
      document.getElementById('appSettingModalTitle').textContent = isNew ? 'Add App Setting' : 'Edit App Setting';
      document.getElementById('appSettingKey').value = setting?.key || '';
      document.getElementById('appSettingIsNew').value = isNew ? '1' : '';
      document.getElementById('appSettingKeyInput').value = setting?.key || '';
      document.getElementById('appSettingValue').value = setting?.value || '';
      document.getElementById('appSettingType').value = setting?.type || 'string';
      document.getElementById('appSettingDescription').value = setting?.description || '';
      document.getElementById('appSettingKeyGroup').style.display = isNew ? 'block' : 'none';
      document.getElementById('appSettingTypeGroup').style.display = isNew ? 'block' : 'none';
      document.getElementById('appSettingDescGroup').style.display = isNew ? 'block' : 'none';
      document.getElementById('appSettingModal').classList.add('active');
    }

    async function saveAppSetting() {
      const isNew = document.getElementById('appSettingIsNew').value === '1';
      const key = isNew ? document.getElementById('appSettingKeyInput').value.trim() : document.getElementById('appSettingKey').value;
      const value = document.getElementById('appSettingValue').value;
      const type = document.getElementById('appSettingType').value;
      const description = document.getElementById('appSettingDescription').value.trim();

      if (!key) { showError('Key is required'); return; }

      try {
        const url = isNew ? '/api/admin/settings/app' : `/api/admin/settings/app/${encodeURIComponent(key)}`;
        const method = isNew ? 'POST' : 'PUT';
        const body = isNew ? { key, value, type, description } : { value };
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(body)
        });
        if (res.ok) {
          closeModal('appSettingModal');
          loadAppSettings();
          showSuccess(isNew ? 'Setting created' : 'Setting updated');
        } else {
          const err = await res.json();
          showError(err.message || 'Failed to save setting');
        }
      } catch (error) { showError('Failed to save app setting'); }
    }

    async function loadNotificationDefaults() {
      try {
        const res = await fetch('/api/admin/settings/notifications', { credentials: 'include' });
        if (res.ok) {
          const defaults = await res.json();
          renderNotificationDefaultsList(defaults);
        }
      } catch (error) {
        console.error('Failed to load notification defaults:', error);
        document.getElementById('notificationDefaultsList').innerHTML = '<div class="error">Failed to load notification defaults</div>';
      }
    }

    function renderNotificationDefaultsList(defaults) {
      const container = document.getElementById('notificationDefaultsList');
      if (!defaults || defaults.length === 0) {
        container.innerHTML = '<div class="empty-state">No notification types configured.</div>';
        return;
      }

      const grouped = {};
      defaults.forEach(d => {
        const cat = d.category || 'other';
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(d);
      });

      container.innerHTML = Object.entries(grouped).map(([cat, items]) => `
        <div style="margin-bottom: 24px;">
          <h3 style="font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: rgba(255,255,255,0.5); margin-bottom: 12px;">${escapeHtml(cat)}</h3>
          ${items.map(n => `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 8px;">
              <div style="flex: 1;">
                <div style="font-weight: 500;">${escapeHtml(n.name)}</div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.5);">${n.description || 'No description'}</div>
                ${!n.canUserDisable ? '<span style="font-size: 11px; color: #f59e0b; margin-top: 4px; display: inline-block;">Users cannot disable</span>' : ''}
              </div>
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" ${n.defaultEnabled ? 'checked' : ''} onchange="toggleNotificationDefault('${n.id}', this.checked)" style="width: 18px; height: 18px;">
                <span style="font-size: 12px; color: rgba(255,255,255,0.6);">${n.defaultEnabled ? 'Enabled' : 'Disabled'}</span>
              </label>
            </div>
          `).join('')}
        </div>
      `).join('');
    }

    async function toggleNotificationDefault(id, enabled) {
      try {
        const res = await fetch(`/api/admin/settings/notifications/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ enabled })
        });
        if (res.ok) {
          showSuccess('Notification default updated');
        } else {
          loadNotificationDefaults();
          showError('Failed to update notification default');
        }
      } catch (error) {
        loadNotificationDefaults();
        showError('Failed to update notification default');
      }
    }

    function openNotificationDefaultModal() {
      document.getElementById('notificationDefaultId').value = '';
      document.getElementById('notificationDefaultKey').value = '';
      document.getElementById('notificationDefaultName').value = '';
      document.getElementById('notificationDefaultCategory').value = 'social';
      document.getElementById('notificationDefaultDescription').value = '';
      document.getElementById('notificationDefaultEnabled').checked = true;
      document.getElementById('notificationDefaultCanDisable').checked = true;
      document.getElementById('notificationDefaultModal').classList.add('active');
    }

    async function saveNotificationDefault() {
      const key = document.getElementById('notificationDefaultKey').value.trim();
      const name = document.getElementById('notificationDefaultName').value.trim();
      const category = document.getElementById('notificationDefaultCategory').value;
      const description = document.getElementById('notificationDefaultDescription').value.trim();
      const defaultEnabled = document.getElementById('notificationDefaultEnabled').checked;
      const canUserDisable = document.getElementById('notificationDefaultCanDisable').checked;

      if (!key || !name) { showError('Key and name are required'); return; }

      try {
        const res = await fetch('/api/admin/settings/notifications', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ key, name, category, description, defaultEnabled, canUserDisable })
        });
        if (res.ok) {
          closeModal('notificationDefaultModal');
          loadNotificationDefaults();
          showSuccess('Notification type created');
        } else {
          const err = await res.json();
          showError(err.message || 'Failed to create notification type');
        }
      } catch (error) { showError('Failed to create notification type'); }
    }

    function switchPlatformSettingsTab(tabId) {
      document.querySelectorAll('#section-platformsettings .tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.platform-settings-tab-content').forEach(c => c.style.display = 'none');
      
      document.querySelector(`#section-platformsettings .tab-btn[data-tab="${tabId}"]`)?.classList.add('active');
      
      if (tabId === 'word-filters') {
        document.getElementById('platformWordFiltersContent').style.display = 'block';
        loadWordFilters();
      } else if (tabId === 'keyword-filters') {
        document.getElementById('platformKeywordFiltersContent').style.display = 'block';
        loadKeywordFilters();
      } else if (tabId === 'app-settings') {
        document.getElementById('platformAppSettingsContent').style.display = 'block';
        loadAppSettings();
      } else if (tabId === 'notifications') {
        document.getElementById('platformNotificationsContent').style.display = 'block';
        loadNotificationDefaults();
      }
    }

    document.addEventListener('click', function(e) {
      if (e.target.matches('[data-action="platform-settings-tab"]')) {
        const tab = e.target.getAttribute('data-tab');
        switchPlatformSettingsTab(tab);
      }
      if (e.target.matches('[data-action="add-word-filter"]')) {
        openWordFilterModal();
      }
      if (e.target.matches('[data-action="save-word-filter"]')) {
        saveWordFilter();
      }
      if (e.target.matches('[data-action="add-keyword-filter"]')) {
        openKeywordFilterModal();
      }
      if (e.target.matches('[data-action="save-keyword-filter"]')) {
        saveKeywordFilter();
      }
      if (e.target.matches('[data-action="add-app-setting"]')) {
        openAppSettingModal();
      }
      if (e.target.matches('[data-action="save-app-setting"]')) {
        saveAppSetting();
      }
      if (e.target.matches('[data-action="add-notification-default"]')) {
        openNotificationDefaultModal();
      }
      if (e.target.matches('[data-action="save-notification-default"]')) {
        saveNotificationDefault();
      }
    });

    window.loadWordFilters = loadWordFilters;
    window.editWordFilter = editWordFilter;
    window.deleteWordFilter = deleteWordFilter;
    window.loadKeywordFilters = loadKeywordFilters;
    window.editKeywordFilter = editKeywordFilter;
    window.deleteKeywordFilter = deleteKeywordFilter;
    window.loadAppSettings = loadAppSettings;
    window.openAppSettingModal = openAppSettingModal;
    window.loadNotificationDefaults = loadNotificationDefaults;
    window.toggleNotificationDefault = toggleNotificationDefault;
    window.switchPlatformSettingsTab = switchPlatformSettingsTab;

    // ===== ECONOMY DASHBOARD FUNCTIONS =====
    // Note: economyConfigData, wealthClubsData, battlesData, battlesFilter 
    // are declared at the top of this script to avoid TDZ issues

    async function loadEconomyOverview() {
      try {
        const [statsRes, configRes, stakingRes] = await Promise.all([
          fetch('/api/admin/economy/stats', { credentials: 'include' }),
          fetch('/api/admin/economy-config', { credentials: 'include' }),
          fetch('/api/admin/staking-tiers', { credentials: 'include' })
        ]);

        if (statsRes.ok) {
          const stats = await statsRes.json();
          document.getElementById('statTotalCoins').textContent = formatNumber(stats.totalCoins || 0);
          document.getElementById('statCoinsPurchased').textContent = formatNumber(stats.coinsPurchased || 0);
          document.getElementById('statCoinsPurchasedValue').textContent = 'R' + formatNumber(stats.purchasedValue || 0, 2);
          document.getElementById('statCoinsWithdrawn').textContent = formatNumber(stats.coinsWithdrawn || 0);
          document.getElementById('statCoinsWithdrawnValue').textContent = 'R' + formatNumber(stats.withdrawnValue || 0, 2);
          document.getElementById('statPlatformRevenue').textContent = 'R' + formatNumber(stats.platformRevenue || 0, 2);
        }

        if (configRes.ok) {
          const configObj = await configRes.json();
          const configsArray = Object.entries(configObj).map(([key, value]) => ({ key, value }));
          economyConfigData = configsArray;
          renderEconomyConfig(configsArray);
          updateEmergencyToggles(configsArray);
          updateEconomyRateInputs(configsArray);
        }

        if (stakingRes.ok) {
          const tiers = await stakingRes.json();
          renderStakingPools(tiers);
        }
      } catch (error) {
        console.error('Failed to load economy overview:', error);
      }
    }

    function renderEconomyConfig(configs) {
      const container = document.getElementById('economyConfigDisplay');
      if (!configs || configs.length === 0) {
        container.innerHTML = '<div class="empty-state">No economy configuration found.</div>';
        return;
      }

      container.innerHTML = configs.map(c => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 8px;">
          <div>
            <div style="font-weight: 500;">${escapeHtml(c.key)}</div>
            <div style="font-size: 12px; color: rgba(255,255,255,0.5);">${c.description || ''}</div>
          </div>
          <code style="background: rgba(255,255,255,0.1); padding: 4px 12px; border-radius: 4px;">${escapeHtml(c.value)}</code>
        </div>
      `).join('');
    }

    function renderStakingPools(tiers) {
      const container = document.getElementById('economyStakingPools');
      const activeTiers = tiers.filter(t => t.isActive);
      
      if (!activeTiers || activeTiers.length === 0) {
        container.innerHTML = '<div class="empty-state">No active staking tiers.</div>';
        return;
      }

      container.innerHTML = activeTiers.map(t => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 8px; margin-bottom: 8px;">
          <div>
            <div style="font-weight: 600; color: #8B5CF6;">${escapeHtml(t.name)}</div>
            <div style="font-size: 12px; color: rgba(255,255,255,0.5);">${t.durationDays} days ‚Ä¢ Min: ${t.minCoins} coins</div>
          </div>
          <div style="text-align: right;">
            <div style="font-size: 20px; font-weight: 700; color: #10B981;">${t.bonusPercent}%</div>
            <div style="font-size: 11px; color: rgba(255,255,255,0.5);">bonus</div>
          </div>
        </div>
      `).join('');
    }

    function updateEmergencyToggles(configs) {
      const featureKeys = ['withdrawals_enabled', 'purchases_enabled', 'gifts_enabled', 'staking_enabled', 'battles_enabled', 'daily_rewards_enabled'];
      featureKeys.forEach(key => {
        const config = configs.find(c => c.key === key);
        const toggle = document.getElementById(`toggle-${key}`);
        if (toggle) {
          const isEnabled = config && config.value === 'true';
          toggle.classList.toggle('active', isEnabled);
          toggle.style.background = isEnabled ? '#10B981' : 'rgba(255,255,255,0.1)';
        }
      });
    }

    function updateEconomyRateInputs(configs) {
      const rateMap = {
        'coin_to_rand_rate': 'economyRateCoinToRand',
        'platform_fee_percent': 'economyRatePlatformFee',
        'min_withdrawal_coins': 'economyRateMinWithdraw',
        'daily_reward_coins': 'economyRateDailyReward'
      };
      Object.entries(rateMap).forEach(([key, inputId]) => {
        const config = configs.find(c => c.key === key);
        const input = document.getElementById(inputId);
        if (input && config) {
          input.value = config.value;
        }
      });
    }

    async function toggleEconomyFeature(key) {
      const config = economyConfigData.find(c => c.key === key);
      const currentValue = config ? config.value === 'true' : false;
      const newValue = !currentValue;
      const featureName = key.replace(/_enabled$/, '').replace(/_/g, ' ');

      if (!newValue) {
        const confirmed = confirm(`Warning: Disabling ${featureName} will immediately affect all users. Are you sure you want to disable this feature?`);
        if (!confirmed) return;
      }

      try {
        const res = await fetch(`/api/admin/economy-config/${key}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ value: String(newValue) })
        });

        if (res.ok) {
          const toggle = document.getElementById(`toggle-${key}`);
          toggle.classList.toggle('active', newValue);
          toggle.style.background = newValue ? '#10B981' : 'rgba(255,255,255,0.1)';
          
          const idx = economyConfigData.findIndex(c => c.key === key);
          if (idx >= 0) {
            economyConfigData[idx].value = String(newValue);
          } else {
            economyConfigData.push({ key, value: String(newValue) });
          }
          
          showSuccess(`${featureName} ${newValue ? 'enabled' : 'disabled'}`);
        } else {
          showError('Failed to update feature');
        }
      } catch (error) {
        showError('Failed to update feature');
      }
    }

    async function saveEconomyRates() {
      const rates = [
        { key: 'coin_to_rand_rate', value: document.getElementById('economyRateCoinToRand').value },
        { key: 'platform_fee_percent', value: document.getElementById('economyRatePlatformFee').value },
        { key: 'min_withdrawal_coins', value: document.getElementById('economyRateMinWithdraw').value },
        { key: 'daily_reward_coins', value: document.getElementById('economyRateDailyReward').value }
      ];

      try {
        for (const rate of rates) {
          await fetch(`/api/admin/economy-config/${rate.key}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ value: rate.value })
          });
        }
        showSuccess('Economy rates saved');
      } catch (error) {
        showError('Failed to save rates');
      }
    }

    async function loadWealthClubs() {
      try {
        const res = await fetch('/api/admin/wealth-clubs', { credentials: 'include' });
        if (res.ok) {
          const clubs = await res.json();
          wealthClubsData = clubs;
          renderWealthClubStats(clubs);
          renderWealthClubsTable(clubs);
        }
      } catch (error) {
        console.error('Failed to load wealth clubs:', error);
        document.getElementById('wealthClubsTable').innerHTML = '<div class="error">Failed to load wealth clubs</div>';
      }
    }

    function renderWealthClubStats(clubs) {
      const container = document.getElementById('wealthClubStats');
      const totalMembers = clubs.reduce((sum, c) => sum + (c.memberCount || 0), 0);
      
      container.innerHTML = `
        <div class="stat-card">
          <h3>Total Clubs</h3>
          <div class="value" style="font-size: 28px; font-weight: 700; color: #8B5CF6;">${clubs.length}</div>
        </div>
        <div class="stat-card">
          <h3>Total Members</h3>
          <div class="value" style="font-size: 28px; font-weight: 700; color: #10B981;">${formatNumber(totalMembers)}</div>
        </div>
        <div class="stat-card">
          <h3>Highest Tier</h3>
          <div class="value" style="font-size: 28px; font-weight: 700; color: #F59E0B;">${clubs[clubs.length - 1]?.name || 'N/A'}</div>
        </div>
      `;
    }

    function renderWealthClubsTable(clubs) {
      const container = document.getElementById('wealthClubsTable');
      if (!clubs || clubs.length === 0) {
        container.innerHTML = '<div class="empty-state">No wealth clubs configured.</div>';
        return;
      }

      const tierColors = {
        'BRONZE': '#CD7F32',
        'SILVER': '#C0C0C0',
        'GOLD': '#FFD700',
        'PLATINUM': '#E5E4E2',
        'DIAMOND': '#B9F2FF'
      };

      container.innerHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Tier</th>
              <th>Name</th>
              <th>Net Worth Range</th>
              <th>Members</th>
              <th>Discount %</th>
              <th>Bonus Coins %</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${clubs.map(club => `
              <tr>
                <td>
                  <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background: ${tierColors[club.tier] || '#8B5CF6'}; margin-right: 8px;"></span>
                  ${escapeHtml(club.tier)}
                </td>
                <td>${escapeHtml(club.name)}</td>
                <td>${formatNumber(club.minNetWorth)} - ${club.maxNetWorth ? formatNumber(club.maxNetWorth) : '‚àû'}</td>
                <td>${formatNumber(club.memberCount || 0)}</td>
                <td><span style="color: #10B981; font-weight: 600;">${club.discountPercent}%</span></td>
                <td><span style="color: #F59E0B; font-weight: 600;">${club.bonusCoinPercent}%</span></td>
                <td>
                  <button class="action-btn action-btn-secondary" onclick="openWealthClubModal('${club.id}')" style="padding: 6px 12px;">Edit</button>
                  <button class="action-btn action-btn-info" onclick="viewClubMembers('${club.id}')" style="padding: 6px 12px;">Members</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function openWealthClubModal(clubId) {
      const club = wealthClubsData.find(c => c.id === clubId);
      if (!club) return;

      const modal = document.createElement('div');
      modal.className = 'modal-overlay active';
      modal.id = 'wealthClubEditModal';
      modal.innerHTML = `
        <div class="modal" style="max-width: 500px;">
          <div class="modal-header">
            <h2 class="modal-title">Edit ${escapeHtml(club.name)}</h2>
            <button class="modal-close" onclick="closeModal('wealthClubEditModal')">&times;</button>
          </div>
          <div class="modal-body" style="padding: 24px;">
            <input type="hidden" id="editClubId" value="${club.id}">
            <div class="form-group">
              <label>Discount Percent</label>
              <input type="number" id="editClubDiscount" value="${club.discountPercent}" min="0" max="100" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
              <span style="font-size: 12px; color: rgba(255,255,255,0.5);">Discount on coin purchases</span>
            </div>
            <div class="form-group">
              <label>Bonus Coins Percent</label>
              <input type="number" id="editClubBonus" value="${club.bonusCoinPercent}" min="0" max="100" style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #fff;">
              <span style="font-size: 12px; color: rgba(255,255,255,0.5);">Extra coins on purchases</span>
            </div>
            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="editClubPrioritySupport" ${club.prioritySupport ? 'checked' : ''} style="width: 18px; height: 18px;">
                Priority Support
              </label>
            </div>
            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="editClubExclusiveContent" ${club.exclusiveContent ? 'checked' : ''} style="width: 18px; height: 18px;">
                Exclusive Content Access
              </label>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 20px;">
              <button class="action-btn action-btn-secondary" onclick="closeModal('wealthClubEditModal')" style="flex: 1;">Cancel</button>
              <button class="action-btn action-btn-primary" onclick="saveWealthClub()" style="flex: 1;">Save Changes</button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function saveWealthClub() {
      const clubId = document.getElementById('editClubId').value;
      const discountPercent = parseInt(document.getElementById('editClubDiscount').value) || 0;
      const bonusCoinPercent = parseInt(document.getElementById('editClubBonus').value) || 0;
      const prioritySupport = document.getElementById('editClubPrioritySupport').checked;
      const exclusiveContent = document.getElementById('editClubExclusiveContent').checked;

      try {
        const res = await fetch(`/api/admin/wealth-clubs/${clubId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ discountPercent, bonusCoinPercent, prioritySupport, exclusiveContent })
        });

        if (res.ok) {
          closeModal('wealthClubEditModal');
          loadWealthClubs();
          showSuccess('Wealth club updated');
        } else {
          showError('Failed to update wealth club');
        }
      } catch (error) {
        showError('Failed to update wealth club');
      }
    }

    async function viewClubMembers(clubId) {
      try {
        const res = await fetch(`/api/admin/wealth-clubs/${clubId}/members`, { credentials: 'include' });
        if (res.ok) {
          const members = await res.json();
          const club = wealthClubsData.find(c => c.id === clubId);
          
          const modal = document.createElement('div');
          modal.className = 'modal-overlay active';
          modal.id = 'clubMembersModal';
          modal.innerHTML = `
            <div class="modal" style="max-width: 600px;">
              <div class="modal-header">
                <h2 class="modal-title">${escapeHtml(club?.name || 'Club')} Members</h2>
                <button class="modal-close" onclick="closeModal('clubMembersModal')">&times;</button>
              </div>
              <div class="modal-body" style="padding: 24px; max-height: 60vh; overflow-y: auto;">
                ${members.length === 0 ? '<div class="empty-state">No members in this club.</div>' : `
                  <table class="data-table">
                    <thead>
                      <tr>
                        <th>User</th>
                        <th>Net Worth</th>
                        <th>Joined</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${members.map(m => `
                        <tr>
                          <td style="display: flex; align-items: center; gap: 8px;">
                            <img src="${m.user?.avatarUrl || '/api/placeholder/32/32'}" style="width: 32px; height: 32px; border-radius: 50%;">
                            ${escapeHtml(m.user?.displayName || m.user?.username || 'Unknown')}
                          </td>
                          <td>${formatNumber(m.user?.netWorth || 0)} coins</td>
                          <td>${new Date(m.joinedAt).toLocaleDateString()}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                `}
              </div>
            </div>
          `;
          document.body.appendChild(modal);
        }
      } catch (error) {
        showError('Failed to load club members');
      }
    }

    async function loadBattles() {
      try {
        const res = await fetch('/api/admin/battles', { credentials: 'include' });
        if (res.ok) {
          battlesData = await res.json();
          renderBattlesStats(battlesData);
          renderBattlesTable(battlesData);
        }
      } catch (error) {
        console.error('Failed to load battles:', error);
        document.getElementById('battlesTable').innerHTML = '<div class="error">Failed to load battles</div>';
      }
    }

    function renderBattlesStats(battles) {
      const activeBattles = battles.filter(b => b.status === 'ACTIVE').length;
      const completedBattles = battles.filter(b => b.status === 'ENDED').length;
      const totalPrizePool = battles.filter(b => b.status === 'ACTIVE').reduce((sum, b) => sum + (b.prizePoolCoins || 0), 0);

      document.getElementById('statActiveBattles').textContent = activeBattles;
      document.getElementById('statTotalPrizePool').textContent = formatNumber(totalPrizePool);
      document.getElementById('statCompletedBattles').textContent = completedBattles;
    }

    function renderBattlesTable(battles) {
      const container = document.getElementById('battlesTable');
      let filtered = battles;
      
      if (battlesFilter !== 'all') {
        filtered = battles.filter(b => b.status === battlesFilter);
      }

      if (!filtered || filtered.length === 0) {
        container.innerHTML = '<div class="empty-state">No battles found.</div>';
        return;
      }

      const statusColors = {
        'PENDING': '#F59E0B',
        'ACTIVE': '#10B981',
        'ENDED': '#6B7280'
      };

      container.innerHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Status</th>
              <th>Entry Fee</th>
              <th>Prize Pool</th>
              <th>Participants</th>
              <th>Starts</th>
              <th>Ends</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.map(battle => `
              <tr>
                <td>${escapeHtml(battle.name)}</td>
                <td>
                  <span style="padding: 4px 12px; border-radius: 20px; background: ${statusColors[battle.status]}22; color: ${statusColors[battle.status]}; font-size: 12px; font-weight: 500;">
                    ${battle.status}
                  </span>
                </td>
                <td>${formatNumber(battle.entryFeeCoins)} coins</td>
                <td>${formatNumber(battle.prizePoolCoins)} coins</td>
                <td>${battle.participantCount || 0}${battle.maxParticipants ? `/${battle.maxParticipants}` : ''}</td>
                <td>${new Date(battle.startsAt).toLocaleDateString()}</td>
                <td>${new Date(battle.endsAt).toLocaleDateString()}</td>
                <td>
                  <button class="action-btn action-btn-info" onclick="viewBattleDetails('${battle.id}')" style="padding: 6px 12px;">View</button>
                  ${battle.status === 'ACTIVE' ? `<button class="action-btn action-btn-danger" onclick="endBattle('${battle.id}')" style="padding: 6px 12px;">End</button>` : ''}
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function endBattle(battleId) {
      if (!confirm('Are you sure you want to end this battle? This will trigger prize distribution.')) return;

      try {
        const res = await fetch(`/api/admin/battles/${battleId}/end`, {
          method: 'POST',
          credentials: 'include'
        });

        if (res.ok) {
          loadBattles();
          showSuccess('Battle ended and prizes distributed');
        } else {
          const err = await res.json();
          showError(err.message || 'Failed to end battle');
        }
      } catch (error) {
        showError('Failed to end battle');
      }
    }

    async function viewBattleDetails(battleId) {
      try {
        const res = await fetch(`/api/admin/battles/${battleId}`, { credentials: 'include' });
        if (res.ok) {
          const battle = await res.json();
          
          const modal = document.createElement('div');
          modal.className = 'modal-overlay active';
          modal.id = 'battleDetailsModal';
          modal.innerHTML = `
            <div class="modal" style="max-width: 700px;">
              <div class="modal-header">
                <h2 class="modal-title">${escapeHtml(battle.name)}</h2>
                <button class="modal-close" onclick="closeModal('battleDetailsModal')">&times;</button>
              </div>
              <div class="modal-body" style="padding: 24px; max-height: 70vh; overflow-y: auto;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                  <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; color: #8B5CF6;">${formatNumber(battle.prizePoolCoins)}</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.5);">Prize Pool</div>
                  </div>
                  <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; color: #10B981;">${battle.participants?.length || 0}</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.5);">Participants</div>
                  </div>
                  <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; color: #F59E0B;">${battle.platformFeePercent}%</div>
                    <div style="font-size: 12px; color: rgba(255,255,255,0.5);">Platform Fee</div>
                  </div>
                </div>
                
                <h3 style="margin-bottom: 12px;">Leaderboard</h3>
                ${!battle.participants || battle.participants.length === 0 ? '<div class="empty-state">No participants yet.</div>' : `
                  <table class="data-table">
                    <thead>
                      <tr>
                        <th>Rank</th>
                        <th>User</th>
                        <th>Gifts Received</th>
                        <th>Coins Received</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${battle.participants.sort((a, b) => b.totalCoinsReceived - a.totalCoinsReceived).map((p, idx) => `
                        <tr>
                          <td><span style="font-weight: 700; color: ${idx === 0 ? '#FFD700' : idx === 1 ? '#C0C0C0' : idx === 2 ? '#CD7F32' : '#fff'};">#${idx + 1}</span></td>
                          <td style="display: flex; align-items: center; gap: 8px;">
                            <img src="${p.user?.avatarUrl || '/api/placeholder/32/32'}" style="width: 32px; height: 32px; border-radius: 50%;">
                            ${escapeHtml(p.user?.displayName || p.user?.username || 'Unknown')}
                          </td>
                          <td>${formatNumber(p.totalGiftsReceived)}</td>
                          <td>${formatNumber(p.totalCoinsReceived)}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                `}
              </div>
            </div>
          `;
          document.body.appendChild(modal);
        }
      } catch (error) {
        showError('Failed to load battle details');
      }
    }

    function switchEconomyTab(tabId) {
      document.querySelectorAll('#section-economy .tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.economy-tab-content').forEach(c => c.style.display = 'none');
      
      document.querySelector(`#section-economy .tab-btn[data-tab="${tabId}"]`)?.classList.add('active');
      
      if (tabId === 'economy-overview') {
        document.getElementById('economyOverviewContent').style.display = 'block';
        loadEconomyOverview();
      } else if (tabId === 'economy-emergency') {
        document.getElementById('economyEmergencyContent').style.display = 'block';
        loadEconomyOverview();
      } else if (tabId === 'economy-wealthclubs') {
        document.getElementById('economyWealthClubsContent').style.display = 'block';
        loadWealthClubs();
      } else if (tabId === 'economy-battles') {
        document.getElementById('economyBattlesContent').style.display = 'block';
        loadBattles();
      }
    }

    document.addEventListener('click', function(e) {
      if (e.target.matches('[data-action="economy-tab"]')) {
        const tab = e.target.getAttribute('data-tab');
        switchEconomyTab(tab);
      }
      if (e.target.matches('[data-action="battle-filter"]')) {
        document.querySelectorAll('[data-action="battle-filter"]').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        battlesFilter = e.target.getAttribute('data-filter');
        renderBattlesTable(battlesData);
      }
    });

    window.loadEconomyOverview = loadEconomyOverview;
    window.toggleEconomyFeature = toggleEconomyFeature;
    window.saveEconomyRates = saveEconomyRates;
    window.loadWealthClubs = loadWealthClubs;
    window.openWealthClubModal = openWealthClubModal;
    window.saveWealthClub = saveWealthClub;
    window.viewClubMembers = viewClubMembers;
    window.loadBattles = loadBattles;
    window.endBattle = endBattle;
    window.viewBattleDetails = viewBattleDetails;
    window.switchEconomyTab = switchEconomyTab;

    // ===== ACHIEVEMENTS FUNCTIONS =====
    // Note: achievementsData and achievementFilter are declared at the top of this script

    async function loadAchievements() {
      try {
        const res = await fetch('/api/admin/achievements', { credentials: 'include' });
        if (res.ok) {
          achievementsData = await res.json();
          renderAchievementsStats(achievementsData);
          renderAchievementsTable(achievementsData);
        }
      } catch (error) {
        console.error('Failed to load achievements:', error);
        document.getElementById('achievementsTable').innerHTML = '<div class="error">Failed to load achievements</div>';
      }
    }

    function renderAchievementsStats(achievements) {
      document.getElementById('totalAchievements').textContent = achievements.length;
      document.getElementById('activeAchievements').textContent = achievements.filter(a => a.isActive).length;
      document.getElementById('achievementsAwarded').textContent = achievements.reduce((sum, a) => sum + (a.awardedCount || 0), 0);
      document.getElementById('achievementCoinsAwarded').textContent = achievements.reduce((sum, a) => sum + ((a.awardedCount || 0) * a.rewardCoins), 0).toLocaleString();
    }

    function renderAchievementsTable(achievements) {
      const filtered = achievementFilter === 'all' ? achievements : achievements.filter(a => a.category === achievementFilter);
      
      const container = document.getElementById('achievementsTable');
      if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state">No achievements found</div>';
        return;
      }

      container.innerHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Category</th>
              <th>Requirement</th>
              <th>Reward</th>
              <th>Awarded</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.map(a => `
              <tr>
                <td>
                  <div style="font-weight: 500;">${a.name}</div>
                  <div style="font-size: 12px; color: #666;">${a.description || ''}</div>
                </td>
                <td><span class="badge badge-${a.category.toLowerCase()}">${a.category}</span></td>
                <td style="font-size: 12px;">${a.requirement}</td>
                <td>${a.rewardCoins.toLocaleString()} coins</td>
                <td>${a.awardedCount || 0}</td>
                <td>${a.isActive ? '<span class="status-badge status-active">Active</span>' : '<span class="status-badge status-inactive">Inactive</span>'}</td>
                <td>
                  <button class="btn btn-sm btn-secondary" onclick="window.toggleAchievementStatus('${a.id}', ${!a.isActive})">
                    ${a.isActive ? 'Disable' : 'Enable'}
                  </button>
                  <button class="btn btn-sm btn-primary" onclick="window.editAchievement('${a.id}')">Edit</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function toggleAchievementStatus(id, isActive) {
      try {
        const res = await fetch('/api/admin/achievements/' + id, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ isActive })
        });
        if (res.ok) {
          loadAchievements();
          showToast('Achievement ' + (isActive ? 'enabled' : 'disabled'));
        }
      } catch (error) {
        showError('Failed to update achievement');
      }
    }

    function openAchievementModal(achievement = null) {
      const modal = document.getElementById('achievementModal');
      const form = document.getElementById('achievementForm');
      
      if (achievement) {
        document.getElementById('achievementModalTitle').textContent = 'Edit Achievement';
        document.getElementById('achievementId').value = achievement.id;
        document.getElementById('achievementName').value = achievement.name;
        document.getElementById('achievementDescription').value = achievement.description || '';
        document.getElementById('achievementCategory').value = achievement.category;
        document.getElementById('achievementRequirement').value = achievement.requirement;
        document.getElementById('achievementRewardCoins').value = achievement.rewardCoins;
        document.getElementById('achievementIsSecret').checked = achievement.isSecret;
      } else {
        document.getElementById('achievementModalTitle').textContent = 'Add Achievement';
        form.reset();
        document.getElementById('achievementId').value = '';
      }
      
      modal.classList.add('active');
    }

    function editAchievement(id) {
      const achievement = achievementsData.find(a => a.id === id);
      if (achievement) {
        openAchievementModal(achievement);
      }
    }

    async function saveAchievement(e) {
      e.preventDefault();
      const id = document.getElementById('achievementId').value;
      const data = {
        name: document.getElementById('achievementName').value,
        description: document.getElementById('achievementDescription').value,
        category: document.getElementById('achievementCategory').value,
        requirement: document.getElementById('achievementRequirement').value,
        rewardCoins: parseInt(document.getElementById('achievementRewardCoins').value),
        isSecret: document.getElementById('achievementIsSecret').checked
      };

      try {
        const url = id ? '/api/admin/achievements/' + id : '/api/admin/achievements';
        const res = await fetch(url, {
          method: id ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data)
        });
        if (res.ok) {
          document.getElementById('achievementModal').classList.remove('active');
          loadAchievements();
          showToast('Achievement ' + (id ? 'updated' : 'created'));
        } else {
          const error = await res.json();
          showError(error.message || 'Failed to save achievement');
        }
      } catch (error) {
        showError('Failed to save achievement');
      }
    }

    function filterAchievements(filter) {
      achievementFilter = filter;
      document.querySelectorAll('#section-achievements [data-action="achievement-filter"]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
      });
      renderAchievementsTable(achievementsData);
    }

    // ===== KYC & WITHDRAWALS FUNCTIONS =====
    // Note: kycData, withdrawalsData, currentKycTab are declared at the top of this script

    async function loadPendingKyc() {
      try {
        const res = await fetch('/api/admin/kyc?status=PENDING', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          kycData = data.applications || [];
          renderKycStats(kycData);
          renderPendingKycTable(kycData);
        }
      } catch (error) {
        console.error('Failed to load KYC:', error);
        document.getElementById('pendingKycTable').innerHTML = '<div class="error">Failed to load KYC applications</div>';
      }
    }

    async function loadAllKyc(filter = 'all') {
      try {
        const url = filter === 'all' ? '/api/admin/kyc' : '/api/admin/kyc?status=' + filter;
        const res = await fetch(url, { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          renderAllKycTable(data.applications || []);
        }
      } catch (error) {
        console.error('Failed to load KYC:', error);
      }
    }

    function renderKycStats(applications) {
      const pending = applications.filter(a => a.status === 'PENDING').length;
      const approved = applications.filter(a => a.status === 'APPROVED').length;
      const rejected = applications.filter(a => a.status === 'REJECTED').length;
      
      document.getElementById('pendingKycCount').textContent = pending;
      document.getElementById('approvedKycCount').textContent = approved;
      document.getElementById('rejectedKycCount').textContent = rejected;
    }

    function renderPendingKycTable(applications) {
      const container = document.getElementById('pendingKycTable');
      if (applications.length === 0) {
        container.innerHTML = '<div class="empty-state">No pending KYC applications</div>';
        return;
      }

      container.innerHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th>User</th>
              <th>ID Type</th>
              <th>Full Name</th>
              <th>Submitted</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${applications.map(a => `
              <tr>
                <td>
                  <div style="font-weight: 500;">${a.user?.displayName || a.user?.username || 'Unknown'}</div>
                  <div style="font-size: 12px; color: #666;">@${a.user?.username || 'unknown'}</div>
                </td>
                <td>${a.idType || 'N/A'}</td>
                <td>${a.fullName || 'N/A'}</td>
                <td>${new Date(a.submittedAt || a.createdAt).toLocaleDateString()}</td>
                <td>
                  <button class="btn btn-sm btn-primary" onclick="window.viewKycDetails('${a.id}')">Review</button>
                  <button class="btn btn-sm btn-success" onclick="window.approveKyc('${a.id}')">Approve</button>
                  <button class="btn btn-sm btn-danger" onclick="window.rejectKyc('${a.id}')">Reject</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderAllKycTable(applications) {
      const container = document.getElementById('allKycTable');
      if (applications.length === 0) {
        container.innerHTML = '<div class="empty-state">No KYC applications found</div>';
        return;
      }

      container.innerHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Status</th>
              <th>ID Type</th>
              <th>Full Name</th>
              <th>Submitted</th>
              <th>Reviewed</th>
            </tr>
          </thead>
          <tbody>
            ${applications.map(a => `
              <tr>
                <td>${a.user?.displayName || a.user?.username || 'Unknown'}</td>
                <td><span class="status-badge status-${a.status.toLowerCase()}">${a.status}</span></td>
                <td>${a.idType || 'N/A'}</td>
                <td>${a.fullName || 'N/A'}</td>
                <td>${new Date(a.submittedAt || a.createdAt).toLocaleDateString()}</td>
                <td>${a.reviewedAt ? new Date(a.reviewedAt).toLocaleDateString() : '-'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function approveKyc(id) {
      if (!confirm('Approve this KYC application?')) return;
      try {
        const res = await fetch('/api/admin/kyc/' + id + '/approve', {
          method: 'POST',
          credentials: 'include'
        });
        if (res.ok) {
          loadPendingKyc();
          showToast('KYC approved');
        }
      } catch (error) {
        showError('Failed to approve KYC');
      }
    }

    async function rejectKyc(id) {
      const reason = prompt('Rejection reason:');
      if (!reason) return;
      try {
        const res = await fetch('/api/admin/kyc/' + id + '/reject', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ reason })
        });
        if (res.ok) {
          loadPendingKyc();
          showToast('KYC rejected');
        }
      } catch (error) {
        showError('Failed to reject KYC');
      }
    }

    function viewKycDetails(id) {
      const kyc = kycData.find(k => k.id === id);
      if (kyc) {
        alert('KYC Details:\n\nName: ' + kyc.fullName + '\nID Type: ' + kyc.idType + '\nID Number: ' + kyc.idNumber + '\nDate of Birth: ' + kyc.dateOfBirth);
      }
    }

    async function loadPendingWithdrawals() {
      try {
        const res = await fetch('/api/admin/withdrawals?status=PENDING', { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          withdrawalsData = data.withdrawals || [];
          renderWithdrawalStats(withdrawalsData);
          renderPendingWithdrawalsTable(withdrawalsData);
        }
      } catch (error) {
        console.error('Failed to load withdrawals:', error);
        document.getElementById('pendingWithdrawalsTable').innerHTML = '<div class="error">Failed to load withdrawals</div>';
      }
    }

    async function loadAllWithdrawals(filter = 'all') {
      try {
        const url = filter === 'all' ? '/api/admin/withdrawals' : '/api/admin/withdrawals?status=' + filter;
        const res = await fetch(url, { credentials: 'include' });
        if (res.ok) {
          const data = await res.json();
          renderAllWithdrawalsTable(data.withdrawals || []);
        }
      } catch (error) {
        console.error('Failed to load withdrawals:', error);
      }
    }

    function renderWithdrawalStats(withdrawals) {
      const pending = withdrawals.filter(w => w.status === 'PENDING');
      const pendingAmount = pending.reduce((sum, w) => sum + (w.amountRands || 0), 0);
      
      document.getElementById('pendingWithdrawalsCount').textContent = pending.length;
      document.getElementById('pendingWithdrawalsAmount').textContent = 'R' + pendingAmount.toLocaleString();
      document.getElementById('todayWithdrawals').textContent = withdrawals.filter(w => {
        const today = new Date().toDateString();
        return new Date(w.createdAt).toDateString() === today;
      }).length;
    }

    function renderPendingWithdrawalsTable(withdrawals) {
      const pending = withdrawals.filter(w => w.status === 'PENDING');
      const container = document.getElementById('pendingWithdrawalsTable');
      
      if (pending.length === 0) {
        container.innerHTML = '<div class="empty-state">No pending withdrawal requests</div>';
        return;
      }

      container.innerHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Amount</th>
              <th>Bank</th>
              <th>Requested</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${pending.map(w => `
              <tr>
                <td>
                  <div style="font-weight: 500;">${w.user?.displayName || w.user?.username || 'Unknown'}</div>
                </td>
                <td>
                  <div>${w.amountCoins?.toLocaleString() || 0} coins</div>
                  <div style="font-size: 12px; color: #666;">R${(w.amountRands || 0).toLocaleString()}</div>
                </td>
                <td>${w.bankAccount?.bankName || 'Unknown'} - ${w.bankAccount?.accountNumber?.slice(-4) || '****'}</td>
                <td>${new Date(w.createdAt).toLocaleDateString()}</td>
                <td>
                  <button class="btn btn-sm btn-success" onclick="window.approveWithdrawal('${w.id}')">Approve</button>
                  <button class="btn btn-sm btn-danger" onclick="window.rejectWithdrawal('${w.id}')">Reject</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    function renderAllWithdrawalsTable(withdrawals) {
      const container = document.getElementById('allWithdrawalsTable');
      
      if (withdrawals.length === 0) {
        container.innerHTML = '<div class="empty-state">No withdrawal requests found</div>';
        return;
      }

      container.innerHTML = `
        <table class="data-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Bank</th>
              <th>Requested</th>
              <th>Processed</th>
            </tr>
          </thead>
          <tbody>
            ${withdrawals.map(w => `
              <tr>
                <td>${w.user?.displayName || w.user?.username || 'Unknown'}</td>
                <td>R${(w.amountRands || 0).toLocaleString()}</td>
                <td><span class="status-badge status-${w.status.toLowerCase()}">${w.status}</span></td>
                <td>${w.bankAccount?.bankName || '-'}</td>
                <td>${new Date(w.createdAt).toLocaleDateString()}</td>
                <td>${w.processedAt ? new Date(w.processedAt).toLocaleDateString() : '-'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    async function approveWithdrawal(id) {
      const paymentRef = prompt('Enter payment reference (optional):');
      try {
        const res = await fetch('/api/admin/withdrawals/' + id + '/approve', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ paymentReference: paymentRef || undefined })
        });
        if (res.ok) {
          loadPendingWithdrawals();
          showToast('Withdrawal approved');
        }
      } catch (error) {
        showError('Failed to approve withdrawal');
      }
    }

    async function rejectWithdrawal(id) {
      const reason = prompt('Rejection reason:');
      if (!reason) return;
      try {
        const res = await fetch('/api/admin/withdrawals/' + id + '/reject', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ reason })
        });
        if (res.ok) {
          loadPendingWithdrawals();
          showToast('Withdrawal rejected');
        }
      } catch (error) {
        showError('Failed to reject withdrawal');
      }
    }

    function switchKycTab(tabId) {
      currentKycTab = tabId;
      document.querySelectorAll('#section-kycwithdrawals .tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.kyc-tab-content').forEach(c => c.style.display = 'none');
      
      document.querySelector(`#section-kycwithdrawals .tab-btn[data-tab="${tabId}"]`)?.classList.add('active');
      
      if (tabId === 'kyc-pending') {
        document.getElementById('kycPendingContent').style.display = 'block';
        loadPendingKyc();
      } else if (tabId === 'kyc-all') {
        document.getElementById('kycAllContent').style.display = 'block';
        loadAllKyc();
      } else if (tabId === 'withdrawals-pending') {
        document.getElementById('withdrawalsPendingContent').style.display = 'block';
        loadPendingWithdrawals();
      } else if (tabId === 'withdrawals-all') {
        document.getElementById('withdrawalsAllContent').style.display = 'block';
        loadAllWithdrawals();
      }
    }

    // Export new functions
    window.loadAchievements = loadAchievements;
    window.toggleAchievementStatus = toggleAchievementStatus;
    window.openAchievementModal = openAchievementModal;
    window.editAchievement = editAchievement;
    window.saveAchievement = saveAchievement;
    window.filterAchievements = filterAchievements;
    window.loadPendingKyc = loadPendingKyc;
    window.loadAllKyc = loadAllKyc;
    window.approveKyc = approveKyc;
    window.rejectKyc = rejectKyc;
    window.viewKycDetails = viewKycDetails;
    window.loadPendingWithdrawals = loadPendingWithdrawals;
    window.loadAllWithdrawals = loadAllWithdrawals;
    window.approveWithdrawal = approveWithdrawal;
    window.rejectWithdrawal = rejectWithdrawal;
    window.switchKycTab = switchKycTab;

    // Add section handlers for new sections
  </script>
</body>
</html>
